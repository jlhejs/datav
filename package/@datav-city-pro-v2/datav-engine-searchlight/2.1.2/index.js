// env=undefined => env=publish 
Cube("datav:/com/@datav-city-pro-v2/datav-engine-searchlight/2.1.2/src/shader/spotvolume.frag.glsl",[],function(n,o,e,t,i,a){return n.exports="#define GLSLIFY 1\n#include <common>\n#include <logdepthbuf_pars_fragment>\n#include <packing>\n\nuniform vec3 lightColor;\nuniform float opacity;\nuniform float distPower;\nuniform float anglePower;\n\nin vec2 vUv;\n//in vec3 vLightPosition;\nin vec3 vViewNormal;\n\nvec4 rayMarch(vec3 lightColor2) {\n  float intensity = 1.0;\n  intensity *= saturate(pow(vUv.y, distPower));\n  vec3 normal = vViewNormal;\n  normal.z = abs(normal.z);\n\n  float cosAngle = dot(normal, vec3(0.0, 0.0, 1.0));\n  float angleIntensity = pow(cosAngle, anglePower);\n  intensity *= angleIntensity;\n\n  return vec4(lightColor2, intensity * opacity);\n}\n\nvoid main() {\n  #include <logdepthbuf_fragment>\n\n  //后期渲染模块会统一做gamma校正，\n  //为了图元渲染颜色和配置项设置颜色保持一致，需要做以下处理以抵消\n\tvec3 lightColor2 = pow(lightColor, vec3(2.2));\n\n  gl_FragColor = rayMarch(lightColor2);\n}",n.exports});;
Cube("datav:/com/@datav-city-pro-v2/datav-engine-searchlight/2.1.2/src/shader/spotvolume.vert.glsl",[],function(n,t,o,a,e,i){return n.exports="precision highp float;\n#define GLSLIFY 1\n#include <logdepthbuf_pars_vertex>\n\nattribute vec4 translation;\nattribute vec4 rotation;\n\nuniform vec3 origin;\nuniform float radius;\n\nout vec2 vUv;\nout vec3 vViewNormal;\n//out vec3 vLightPosition;\n\nmat4 compose(vec3 trans, vec3 axis, float angle, vec3 scale) {\n  float c = cos(angle);\n  float s = sin(angle);\n  float t = 1.0 - c;\n  float x = axis.x, y = axis.y, z = axis.z;\n  float tx = t * x, ty = t * y;\n\n  vec3 col0 = vec3(tx * x + c, tx * y + s * z, tx * z - s * y) * scale.x;\n  vec3 col1 = vec3(tx * y - s * z, ty * y + c, ty * z + s * x) * scale.y;\n  vec3 col2 = vec3(tx * z + s * y, ty * z - s * x, t * z * z + c) * scale.z;\n  return mat4(col0.x, col0.y, col0.z, 0.0,\n              col1.x, col1.y, col1.z, 0.0,\n              col2.x, col2.y, col2.z, 0.0,\n              trans.x, trans.y, trans.z, 1.0);\n}\n\nvoid main() {\n  vec4 transformed = vec4(position, 1.0);\n  mat4 matrix = compose(translation.xyz, rotation.xyz, rotation.w, vec3(radius, translation.w, radius));\n  transformed = matrix * transformed;\n  gl_Position = projectionMatrix * modelViewMatrix * transformed;\n  vUv = uv;\n  //vLightPosition = translation.xyz + origin;\n  vViewNormal = normalize(normalMatrix * mat3(transpose(inverse(matrix))) * normal);\n#include <logdepthbuf_vertex>\n}",n.exports});;
Cube("datav:/com/@datav-city-pro-v2/datav-engine-searchlight/2.1.2/src/searchlight",[],function(t,e,S,r,o,n){function a(t){return(a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function j(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var r=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=r){var o,n,a=[],i=!0,s=!1;try{for(r=r.call(t);!(i=(o=r.next()).done)&&(a.push(o.value),!e||a.length!==e);i=!0);}catch(t){s=!0,n=t}finally{try{i||null==r.return||r.return()}finally{if(s)throw n}}return a}}(t,e)||function(t,e){var r;if(t)return"string"==typeof t?i(t,e):"Map"===(r="Object"===(r=Object.prototype.toString.call(t).slice(8,-1))&&t.constructor?t.constructor.name:r)||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?i(t,e):void 0}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function i(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,o=new Array(e);r<e;r++)o[r]=t[r];return o}function s(t,e){for(var r=0;r<e.length;r++){var o=e[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function l(){return(l="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(t,e,r){var o=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=h(t)););return t}(t,e);if(o)return(o=Object.getOwnPropertyDescriptor(o,e)).get?o.get.call(arguments.length<3?t:r):o.value}).apply(this,arguments)}function c(t,e){return(c=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t})(t,e)}function u(r){var o=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(t){return!1}}();return function(){var t,e=h(r),e=(t=o?(t=h(this).constructor,Reflect.construct(e,arguments,t)):e.apply(this,arguments),this);if(t&&("object"===a(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}}function h(t){return(h=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}return t.exports=function(t){var g=t.THREE,m=t.Utils,r=t.VG,e=t.FormatTransformer,v=t.coordHelper,t=r.Layer,b=((new g.ImageLoader).setCrossOrigin("*"),new g.Vector3),w=new g.Vector3,O=new g.Vector3,A=new g.Vector3,x=new g.Vector3,P=new g.Vector3,o=i;if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");o.prototype=Object.create(t&&t.prototype,{constructor:{value:o,writable:!0,configurable:!0}}),Object.defineProperty(o,"prototype",{writable:!1}),t&&c(o,t);var n,a=u(i);function i(t){var e;if(this instanceof i)return(e=a.call(this)).classNameAlias="SearchlightLayer",e.layerName=e.classNameAlias,e.renderQueue=r.Transparent,e.options=m.mergeOptions({visible:!0,opacity:1},t||{}),e;throw new TypeError("Cannot call a class as a function")}return o=i,(t=[{key:"opacity",set:function(t){this.searchlight&&(this.searchlight.material.uniforms.opacity.value=t)}},{key:"color",set:function(t){this.searchlight&&(t=m.Chroma(t).gl(),this.searchlight.material.uniforms.lightColor.value.setRGB(t[0],t[1],t[2]))}},{key:"addTo",value:function(t){l(h(i.prototype),"addTo",this).call(this,t),this.formatTransformer=new e}},{key:"show",value:function(){this.options.visible=!0,l(h(i.prototype),"show",this).call(this)}},{key:"hide",value:function(){this.options.visible=!1,l(h(i.prototype),"hide",this).call(this)}},{key:"setData",value:function(t){if(this.clear(),!t)return this.emit("rendered"),console.error("".concat(this.classNameAlias,": no data."));var e=t;if(!Array.isArray(t)){if("FeatureCollection"!==t.type)return this.emit("rendered"),console.error("".concat(this.classNameAlias,": invalid data format, ").concat(t,"."));e=this.formatTransformer.geojson2datav(t)}if(!e.length)return this.emit("rendered"),console.warn("".concat(this.classNameAlias,": the length of data is 0."));var r=[],o=[],t=new g.ConeBufferGeometry(1,1,32,8,!0),n=(t.translate(0,-.5,0),new g.InstancedBufferGeometry),a=(n.index=t.index,n.attributes=t.attributes,0);b.set(1/0,1/0,1/0),w.set(-1/0,-1/0,-1/0);for(var i=0,s=e.length;i<s;i++){var l,c=e[i];c.geometry&&c.geometry.coordinates[0]&&c.geometry.coordinates[1]&&(l=(c=j(c.geometry.coordinates,2))[0],c=c[1],l[2]=l[2]||0,c[2]=c[2]||0,v.setFromArray(l),v.toXYZ(A),v.setFromArray(c),v.toXYZ(x),x.sub(A),b.x=Math.min(b.x,A.x),b.y=Math.min(b.y,A.y),b.z=Math.min(b.z,A.z),w.x=Math.max(w.x,A.x),w.y=Math.max(w.y,A.y),w.z=Math.max(w.z,A.z),l=4*a,P.set(0,-1,0),r[l]=A.x,r[1+l]=A.y,r[2+l]=A.z,r[3+l]=x.length(),x.normalize(),o[3+l]=P.angleTo(x),P.cross(x).normalize(),o[l]=P.x,o[1+l]=P.y,o[2+l]=P.z,++a)}r.length=4*a,o.length=r.length,O.addVectors(b,w).multiplyScalar(.5);for(var u=3;u<r.length;u+=4)r[u-3]-=O.x,r[u-2]-=O.y,r[u-1]-=O.z;n.instanceCount=a,n.setAttribute("translation",new g.InstancedBufferAttribute(new Float32Array(r),4)),n.setAttribute("rotation",new g.InstancedBufferAttribute(new Float32Array(o),4));var t=this.options.options.graph,h=t.size,f=t.color,y=t.opacity,t=t.fadeFactor,p=h.radius,h=h.radiusFactor,d=t.distPower,t=t.anglePower,f=m.Chroma(f).gl(),p=new g.ShaderMaterial({uniforms:{origin:{value:O},radius:{value:p*h},distPower:{value:d},anglePower:{value:t},opacity:{value:y},lightColor:{value:new g.Color(f[0],f[1],f[2])}},vertexShader:S("datav:/com/@datav-city-pro-v2/datav-engine-searchlight/2.1.2/src/shader/spotvolume.vert.glsl"),fragmentShader:S("datav:/com/@datav-city-pro-v2/datav-engine-searchlight/2.1.2/src/shader/spotvolume.frag.glsl"),transparent:!0,depthWrite:!1,blending:g.AdditiveBlending,side:g.DoubleSide});this.searchlight=new g.Mesh(n,p),this.searchlight.position.copy(O),this.searchlight.frustumCulled=!1,this.group.ignoreWaterReflection=!0,this.add(this.searchlight)}},{key:"updateOptions",value:function(t){var e,r,o,n,a,i,s,l=m.deepClone(this.options);this.options=m.mergeOptions(this.options,t||{}),this.searchlight&&(e=this.searchlight.material.uniforms,a=(s=this.options.options.graph).size,r=s.color,o=s.opacity,s=s.fadeFactor,n=a.radius,a=a.radiusFactor,i=s.distPower,s=s.anglePower,e.radius.value=n*a,this.color=r,this.opacity=o,e.distPower.value=i,e.anglePower.value=s),m.easyDiff(l.sceneId.length,t.sceneId.length)&&m.deepDiff(l.sceneId,t.sceneId)||this.updateSceneId()}},{key:"clear",value:function(){l(h(i.prototype),"clear",this).call(this),this.searchlight=null}},{key:"destroy",value:function(){this.clear(),l(h(i.prototype),"destroy",this).call(this)}}])&&s(o.prototype,t),n&&s(o,n),Object.defineProperty(o,"prototype",{writable:!1}),i},t.exports});;
Cube("datav:/com/@datav-city-pro-v2/datav-engine-searchlight/2.1.2",["datav:/npm/eventemitter3/3.0.0"],function(t,e,r,o,n,i){function a(t){return(a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function c(t,e){for(var r=0;r<e.length;r++){var o=e[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function u(t,e){return(u=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t})(t,e)}function y(r){var o=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(t){return!1}}();return function(){var t,e=l(r),e=(t=o?(t=l(this).constructor,Reflect.construct(e,arguments,t)):e.apply(this,arguments),this);if(t&&("object"===a(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}}function l(t){return(l=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}var s=r("datav:/npm/eventemitter3/3.0.0"),f=r("datav:/com/@datav-city-pro-v2/datav-engine-searchlight/2.1.2/src/searchlight"),r=function(){var t=n,e=s;if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&u(t,e);var r,o=y(n);function n(t,e){var r;if(this instanceof n)return(r=o.call(this)).options=e,r.comId="",r;throw new TypeError("Cannot call a class as a function")}return t=n,(e=[{key:"addTo",value:function(t,e){this.cityproCore=t,this.comId=e,this.initLayer()}},{key:"initLayer",value:function(){var t=f(this.cityproCore);this.layer=new t(this.options),this.cityproCore.viewer.addLayer(this.comId,this.layer)}},{key:"setData",value:function(t){this.layer&&this.layer.setData(t)}},{key:"setOpacity",value:function(t){this.layer&&(this.layer.opacity=t)}},{key:"setColor",value:function(t){this.layer&&(this.layer.color=t)}},{key:"show",value:function(){this.layer&&this.layer.show&&this.layer.show()}},{key:"hide",value:function(){this.layer&&this.layer.hide&&this.layer.hide()}},{key:"updateOptions",value:function(t){this.layer&&this.layer.updateOptions&&this.layer.updateOptions(t)}},{key:"clear",value:function(){this.layer&&this.layer.clear&&this.layer.clear()}},{key:"destroy",value:function(){this.layer&&this.layer.destroy&&this.layer.destroy()}}])&&c(t.prototype,e),r&&c(t,r),Object.defineProperty(t,"prototype",{writable:!1}),n}();return t.exports=r,t.exports});