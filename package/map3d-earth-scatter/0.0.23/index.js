// env=undefined => env=publish 
Cube("datav:/com/map3d-earth-scatter/0.0.23/shader/scatter.frag.glsl",[],function(n,t,o,e,i,r){return n.exports="#define GLSLIFY 1\nvarying vec3 vColor;\nvarying float vStartTime;\nuniform float uTimeCounter;\nuniform float uOpacity;\nuniform sampler2D uTexture;\nvoid main() {\n  vec2 uvCenter = vec2(0.5, 0.5);\n\n  float opacity = 0.0;\n  float pixiCoordDistance = distance(gl_PointCoord, uvCenter);\n\n  float counterAngle = (1.0 + sin((vStartTime + uTimeCounter) * 3.1415926)) / 2.0; //calculate opacity, 0~1;\n\n  if (pixiCoordDistance < (counterAngle / 2.0) && pixiCoordDistance < 0.5) {\n    opacity = counterAngle;\n  };\n\n  opacity *= uOpacity;  \n  if(opacity < 0.001 || pixiCoordDistance > 0.5) discard;        \n  gl_FragColor = vec4(vColor, opacity) * texture2D(uTexture, gl_PointCoord);\n}",n.exports});;
Cube("datav:/com/map3d-earth-scatter/0.0.23/shader/scatter.vert.glsl",[],function(e,n,t,i,o,r){return e.exports="#define GLSLIFY 1\nattribute vec3 aColor;\nattribute float aSize;\nattribute float aStartTime;\nattribute vec3 plane_position;\nattribute vec3 sphere_position;\n\nvarying vec3 vColor;\nvarying float vStartTime;\n\nuniform float u_proj_type;\nuniform float u_ease_index;\n\nvec3 real_position() {\n  if(u_proj_type == 0.){\n    return mix(plane_position, sphere_position, u_ease_index);\n  } else if(u_proj_type == 1.){\n     return mix(sphere_position, plane_position, u_ease_index);\n  } else {\n    return vec3(0);\n  }\n}\n\nvoid main() {\n  vColor  = aColor;\n  vStartTime = aStartTime;\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(real_position(), 1.0 );\n  gl_PointSize = aSize;\n \n}",e.exports});;
Cube("datav:/com/map3d-earth-scatter/0.0.23",["datav:/npm/eventemitter3/2.0.3","datav:/npm/safely-merge/1.0.1","datav:/npm/chroma-js/1.3.4","datav:/npm/geoclassify/0.0.4"],function(t,e,i,r,a,s){var o=function(t,e,i){return e&&n(t.prototype,e),i&&n(t,i),t};function n(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}var l=null,h=null,u=i("datav:/npm/eventemitter3/2.0.3"),p=i("datav:/npm/safely-merge/1.0.1"),c=i("datav:/npm/chroma-js/1.3.4"),y=i("datav:/npm/geoclassify/0.0.4"),o=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(f,u),o(f,[{key:"addTo",value:function(t){if(!t)return console.log("scatter layer needs map layer");l=t.THREE,this.map=t,h=t.Utils,this.scene=t.scene,this.init(),this.initEvent()}},{key:"init",value:function(){this.material=this.getMaterial(),this.geoclassify=new y({type:"Jenks",level:this.options.level})}},{key:"initColorSeries",value:function(){var a=this;this.colorSeries={},this.options.scatterTypeSeries.forEach(function(t){var e=t.scatterType,i=c(t.scatterColor).gl(),r=i[0],t=i[1],i=i[2];a.colorSeries[e]||(a.colorSeries[e]=[r,t,i])})}},{key:"getMaterial",value:function(){var t=this.options,e=t.textureUrl,t=t.opacity,e=(new l.TextureLoader).setCrossOrigin("anonymous").load(e);return e.flipY=!1,new l.ShaderMaterial({uniforms:{uTimeCounter:{value:-.5},uOpacity:{value:t},uTexture:{value:e},u_ease_index:{value:1},u_proj_type:{value:this.map.projType}},vertexShader:i("datav:/com/map3d-earth-scatter/0.0.23/shader/scatter.vert.glsl"),fragmentShader:i("datav:/com/map3d-earth-scatter/0.0.23/shader/scatter.frag.glsl"),side:l.DoubleSide,blending:l.NormalBlending,depthTest:!0,depthWrite:!1,transparent:!0})}},{key:"render",value:function(t){if(!t)return console.log("scatter layer no data");if(Array.isArray(t)&&!t.length)return this.dispose(),console.log("scatter layer no data");this.dispose(),this.initColorSeries(),this.ds=t;this.options;var e=t.length,t=this.geometry=new l.BufferGeometry;t.addAttribute("sphere_position",new l.BufferAttribute(new Float32Array(3*e),3).setDynamic(!0)),t.addAttribute("plane_position",new l.BufferAttribute(new Float32Array(3*e),3).setDynamic(!0)),t.addAttribute("aColor",new l.BufferAttribute(new Float32Array(3*e),3).setDynamic(!0)),t.addAttribute("aSize",new l.BufferAttribute(new Float32Array(+e),1).setDynamic(!0)),t.addAttribute("aStartTime",new l.BufferAttribute(new Float32Array(+e),1)),t.setDrawRange(0,e),this.createPositionArray(),this.createColorArray(),this.createSizeArray(),this.createStartTimeArray();t=this.points=new l.Points(t,this.material);t.renderOrder=5e3+Math.round(100*Math.random()),this.scene.add(t),this.checkVisible()}},{key:"initEvent",value:function(){this.map.on("animationFrame",this.animation.bind(this)),this.map.on("projChanged",this.updatePostions.bind(this))}},{key:"createPositionArray",value:function(){for(var t=this.ds,e=this.options,i=e.getLat,r=e.getLng,a=e.height+200,s=this.geometry.attributes.sphere_position.array,o=this.geometry.attributes.plane_position.array,n=0;n<t.length;n++){var l=t[n],u=h.ll2sphere(r(l),i(l),a),l=h.ll2plane(r(l),i(l),a);s[3*n+0]=u.x,s[3*n+1]=u.y,s[3*n+2]=u.z,o[3*n+0]=l.x,o[3*n+1]=l.y,o[3*n+2]=l.z}this.geometry.attributes.sphere_position.needsUpdate=!0,this.geometry.attributes.plane_position.needsUpdate=!0}},{key:"createColorArray",value:function(){var t=this.ds;if(t){for(var e=this.options,i=e.getType,e=c(e.defaulColor).gl(),r=[e[0],e[1],e[2]],a=this.geometry.attributes.aColor.array,s=0;s<t.length;s++){var o=i(t[s]),n=void 0,n=this.colorSeries[o]||r;a[3*s+0]=n[0],a[3*s+1]=n[1],a[3*s+2]=n[2]}this.geometry.attributes.aColor.needsUpdate=!0}}},{key:"createSizeArray",value:function(){var t=this.ds;if(t){this.rawArray=[];var e=this.options,i=(e.level,e.getValue);this.initScatterSizeArray();for(var r=0;r<t.length;r++){var a=i(t[r]);isNaN(a)||this.rawArray.push(a)}this.geoclassify.setLevel(this.options.level),this.geoclassify.setData(this.rawArray),this.geoclassify.setPattern(this.scatterSizeArray);for(var s=this.geometry.attributes.aSize.array,o=0;o<t.length;o++){var n=i(t[o]),n=this.geoclassify.getPattern(n);s[o]=n}this.geometry.attributes.aSize.needsUpdate=!0}}},{key:"initScatterSizeArray",value:function(){var e=this;this.scatterSizeArray=[],this.options.scatterSizeSeries.forEach(function(t){e.scatterSizeArray.push(t.levelSize)})}},{key:"createStartTimeArray",value:function(){var t=this.ds;if(t){for(var e=this.geometry.attributes.aStartTime.array,i=0;i<t.length;i++)e[i]=Math.random()-.5;this.geometry.attributes.aStartTime.needsUpdate=!0}}},{key:"updatePostions",value:function(t){var e=t.projType,t=t.index;this.material.uniforms.u_ease_index.value=t,this.material.uniforms.u_proj_type.value=e}},{key:"updateOptions",value:function(t){this.options=p(this.options,t||{}),this.initColorSeries(),this.createSizeArray(),this.createColorArray(),this.createPositionArray(),this.updateMaterial(),this.checkVisible()}},{key:"updateMaterial",value:function(){var t=this.options;this.material.uniforms.uOpacity.value=this.options.opacity,this.material.uniforms.uTexture.value=(new l.TextureLoader).setCrossOrigin("anonymous").load(t.textureUrl),this.material.needsUpdate=!0}},{key:"checkVisible",value:function(){this.options.visible?this.show():this.hide()}},{key:"hide",value:function(){this.options.visible=!1,this.points&&(this.points.visible=!1)}},{key:"show",value:function(){this.options.visible=!0,this.points&&(this.points.visible=!0)}},{key:"animation",value:function(){var t=this.options;this.points&&this.options.visible&&((.5<this.points.material.uniforms.uTimeCounter.value||this.points.material.uniforms.uTimeCounter.value<-.5)&&(this.flag*=-1),this.points.material.uniforms.uTimeCounter.value+=t.speed*this.flag)}},{key:"dispose",value:function(){this.points&&this.scene.remove(this.points),this.points&&this.points.dispose&&this.points.dispose(),this.geometry&&this.geometry.dispose&&this.geometry.dispose(),this.colorSeries={},this.flag=1,this.ds=null,this.points=null,this.geometry=null}},{key:"remove",value:function(){this.map.off("animationFrame",this.animation),this.map.off("projChanged",this.updatePostions),this.material&&this.material.dispose&&this.material.dispose(),this.material=null,this.dispose()}}]),f);function f(t,e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,f);var i=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(f.__proto__||Object.getPrototypeOf(f)).call(this));return i.options=p({visible:!0,height:4,level:3,opacity:1,speed:.002,defaulColor:"#F286C4",getLat:function(t){return+t.lat},getLng:function(t){return+t.lng},getType:function(t){return t.type||"ok"},getValue:function(t){return+t.value},textureUrl:"https://img.alicdn.com/tfs/TB1uBGvSpXXXXcCXpXXXXXXXXXX-170-170.png"},e||{}),i.flag=1,i.scatterSizeArray=[],i}return t.exports=o,t.exports});