// env=undefined => env=publish 
Cube("datav:/com/map3d-earth-scatter-linear/0.0.5/shader/scatter.frag.glsl",[],function(a){return a.exports="#define GLSLIFY 1\nvarying vec3 vColor;\nvarying float vStartTime;\nuniform float uTimeCounter;\nuniform float uOpacity;\nuniform float u_stop_anim;\nuniform sampler2D uTexture;\nvoid main() {\n  vec2 uvCenter = vec2(0.5, 0.5);\n\n  float opacity = uTimeCounter + 0.5 + vStartTime;\n  float pixiCoordDistance = distance(gl_PointCoord, uvCenter);\n\n  opacity *= uOpacity;  \n  if(u_stop_anim == 0.0) opacity = uOpacity;\n  if(opacity < 0.001 || pixiCoordDistance > 0.5) discard;\n  gl_FragColor = vec4(vColor, opacity) * texture2D(uTexture, gl_PointCoord);\n}",a.exports});;
Cube("datav:/com/map3d-earth-scatter-linear/0.0.5/shader/scatter.vert.glsl",[],function(a){return a.exports="#define GLSLIFY 1\nattribute vec3 aColor;\nattribute float aSize;\nattribute float aStartTime;\nattribute vec3 plane_position;\nattribute vec3 sphere_position;\n\nvarying vec3 vColor;\nvarying float vStartTime;\n\nuniform float u_proj_type;\nuniform float u_ease_index;\n\nvec3 real_position() {\n  if(u_proj_type == 0.){\n    return mix(plane_position, sphere_position, u_ease_index);\n  } else if(u_proj_type == 1.){\n     return mix(sphere_position, plane_position, u_ease_index);\n  } else {\n    return vec3(0);\n  }\n}\n\nvoid main() {\n  vColor  = aColor;\n  vStartTime = aStartTime;\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(real_position(), 1.0 );\n  gl_PointSize = aSize;\n}",a.exports});;
Cube("datav:/com/map3d-earth-scatter-linear/0.0.5",["datav:/npm/eventemitter3/3.0.0","datav:/npm/safely-merge/1.0.1","datav:/npm/chroma-js/1.3.4"],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"===typeof b||"function"===typeof b)?b:a}function f(a,b){if("function"!==typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=null,j=null,i=c("datav:/npm/eventemitter3/3.0.0"),k=c("datav:/npm/safely-merge/1.0.1"),l=c("datav:/npm/chroma-js/1.3.4"),m=function(a){function b(a,c){d(this,b);var f=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return f.options=k({visible:!0,height:4,maxOpacity:1,speed:2e-3,defaulColor:"#F286C4",getLat:function(a){return+a.lat},getLng:function(a){return+a.lng},getType:function(a){return a.type||"ok"},getValue:function(a){return+a.value},textureUrl:"https://img.alicdn.com/tfs/TB1uBGvSpXXXXcCXpXXXXXXXXXX-170-170.png"},c||{}),f.flag=1,f.scatterSizeArray=[],f}return f(b,a),g(b,[{key:"addTo",value:function(a){return a?void(h=a.THREE,this.map=a,j=a.Utils,this.scene=a.scene,this.init(),this.initEvent()):console.log("scatter layer needs map layer")}},{key:"init",value:function(){this.material=this.getMaterial()}},{key:"initColorSeries",value:function(){var a=this;this.colorSeries={};var b=this.options.scatterTypeSeries;b.forEach(function(c){var d=c.scatterType,e=l(c.scatterColor).gl(),f=e[0],h=e[1],g=e[2];a.colorSeries[d]||(a.colorSeries[d]=[f,h,g])})}},{key:"getMaterial",value:function(){var a=this.options,b=a.speed,d=a.maxOpacity,e=a.textureUrl;return new h.ShaderMaterial({uniforms:{uTimeCounter:{value:-0.5},uOpacity:{value:d},uTexture:{value:new h.TextureLoader().setCrossOrigin("anonymous").load(e)},u_ease_index:{value:1},u_proj_type:{value:this.map.projType},u_stop_anim:{value:b}},vertexShader:c("datav:/com/map3d-earth-scatter-linear/0.0.5/shader/scatter.vert.glsl"),fragmentShader:c("datav:/com/map3d-earth-scatter-linear/0.0.5/shader/scatter.frag.glsl"),side:h.DoubleSide,blending:h.NormalBlending,depthTest:!0,depthWrite:!1,transparent:!0})}},{key:"render",value:function(a){if(!a)return console.log("scatter layer no data");if(Array.isArray(a)&&!a.length)return this.dispose(),console.log("scatter layer no data");this.dispose(),this.initColorSeries(),this.ds=a;var b=a.length,c=this.geometry=new h.BufferGeometry;c.addAttribute("sphere_position",new h.BufferAttribute(new Float32Array(3*b),3).setDynamic(!0)),c.addAttribute("plane_position",new h.BufferAttribute(new Float32Array(3*b),3).setDynamic(!0)),c.addAttribute("aColor",new h.BufferAttribute(new Float32Array(3*b),3).setDynamic(!0)),c.addAttribute("aSize",new h.BufferAttribute(new Float32Array(1*b),1).setDynamic(!0)),c.addAttribute("aStartTime",new h.BufferAttribute(new Float32Array(1*b),1)),c.setDrawRange(0,b),this.createPositionArray(),this.createColorArray(),this.createSizeArray(),this.createStartTimeArray();var d=this.points=new h.Points(c,this.material);d.renderOrder=5e3+Math.round(100*Math.random()),this.scene.add(d),this.checkVisible()}},{key:"initEvent",value:function(){this.map.on("animationFrame",this.animation.bind(this)),this.map.on("projChanged",this.updatePostions.bind(this))}},{key:"createPositionArray",value:function(){for(var a=this.ds,b=this.options,c=b.getLat,e=b.getLng,f=b.height,g=f+200,h=this.geometry.attributes.sphere_position.array,k=this.geometry.attributes.plane_position.array,l=0;l<a.length;l++){var i=a[l],d=j.ll2sphere(e(i),c(i),g),m=j.ll2plane(e(i),c(i),g);h[3*l+0]=d.x,h[3*l+1]=d.y,h[3*l+2]=d.z,k[3*l+0]=m.x,k[3*l+1]=m.y,k[3*l+2]=m.z}this.geometry.attributes.sphere_position.needsUpdate=!0,this.geometry.attributes.plane_position.needsUpdate=!0}},{key:"createColorArray",value:function(){var a=this.ds;if(a){for(var b=this.options,e=b.getType,f=l(b.defaulColor).gl(),c=[f[0],f[1],f[2]],g=this.geometry.attributes.aColor.array,h=0;h<a.length;h++){var i=a[h],d=e(i),j=void 0;j=this.colorSeries[d]?this.colorSeries[d]:c,g[3*h+0]=j[0],g[3*h+1]=j[1],g[3*h+2]=j[2]}this.geometry.attributes.aColor.needsUpdate=!0}}},{key:"createSizeArray",value:function(){var a=this.ds;if(a){this.rawArray=[];var b=this.options,c=b.getValue,e=b.maxSize,f=b.minSize;if(f>e){var g=[f,e];e=g[0],f=g[1]}for(var h=+Infinity,j=-Infinity,k=0;k<a.length;k++){var i=a[k],d=c(i);isNaN(d)||(d>j&&(j=d),d<h&&(h=d))}for(var l,m=this.geometry.attributes.aSize.array,n=0,o=0;o<a.length;o++){l=c(a[o]),n=0,n=j===h?0.5:(l-h)/(j-h);var p=n*(e-f)+f;m[o]=p}this.geometry.attributes.aSize.needsUpdate=!0}}},{key:"createStartTimeArray",value:function(){var a=this.ds;if(a){for(var b=this.geometry.attributes.aStartTime.array,c=0;c<a.length;c++)b[c]=0;this.geometry.attributes.aStartTime.needsUpdate=!0}}},{key:"updatePostions",value:function(a){var b=a.projType,c=a.index;this.material.uniforms.u_ease_index.value=c,this.material.uniforms.u_proj_type.value=b}},{key:"updateOptions",value:function(a){this.options=k(this.options,a||{}),this.initColorSeries(),this.createSizeArray(),this.createColorArray(),this.createPositionArray(),this.updateMaterial(),this.checkVisible()}},{key:"updateMaterial",value:function(){var a=this.options,b=a.speed,c=a.maxOpacity,d=a.textureUrl;this.material.uniforms.u_stop_anim.value=b,this.material.uniforms.uOpacity.value=c,this.material.uniforms.uTexture.value=new h.TextureLoader().setCrossOrigin("anonymous").load(d),this.material.needsUpdate=!0}},{key:"checkVisible",value:function(){this.options.visible?this.show():this.hide()}},{key:"hide",value:function(){this.options.visible=!1,this.points&&(this.points.visible=!1)}},{key:"show",value:function(){this.options.visible=!0,this.points&&(this.points.visible=!0)}},{key:"animation",value:function(){var a=this.options,b=a.visible,c=a.speed;this.points&&b&&((0.5<this.points.material.uniforms.uTimeCounter.value||-0.5>this.points.material.uniforms.uTimeCounter.value)&&(this.flag*=-1),this.points.material.uniforms.uTimeCounter.value+=c*this.flag)}},{key:"dispose",value:function(){this.points&&this.scene.remove(this.points),this.points&&this.points.dispose&&this.points.dispose(),this.geometry&&this.geometry.dispose&&this.geometry.dispose(),this.colorSeries={},this.flag=1,this.ds=null,this.points=null,this.geometry=null}},{key:"remove",value:function(){this.map.off("animationFrame",this.animation),this.map.off("projChanged",this.updatePostions),this.material&&this.material.dispose&&this.material.dispose(),this.material=null,this.dispose()}}]),b}(i);return a.exports=m,a.exports});