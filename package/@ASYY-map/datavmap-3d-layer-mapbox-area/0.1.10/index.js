// env=undefined => env=publish 
Cube("datav:/com/datavmap-3d-layer-mapbox-area/0.1.10/mareaLayer.js",["datav:/npm/eventemitter3/2.0.3","datav:/npm/safely-merge/1.0.1","datav:/npm/polylabel/1.0.2","datav:/npm/geojson-bbox/0.0.0"],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"===typeof b||"function"===typeof b)?b:a}function f(a,b){if("function"!==typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=c("datav:/npm/eventemitter3/2.0.3"),i=c("datav:/npm/safely-merge/1.0.1"),j=c("datav:/npm/polylabel/1.0.2"),k=c("datav:/npm/geojson-bbox/0.0.0");return a.exports=function(a){var b=a.datavgl,c={};return function(h){function l(b){d(this,l);var f=e(this,(l.__proto__||Object.getPrototypeOf(l)).call(this));return b=i(c,b),f.options=i(f.options,b),f.onclick=f.onclick.bind(f),f.onmousemove=f.onmousemove.bind(f),f.tagIndex=a.submtags.fill.length-1,f.init(),f}return f(l,h),g(l,[{key:"init",value:function(){this.data=[],this.interactiveLayers=[],this.geojson={type:"FeatureCollection",features:[]},this.new_geojson={type:"FeatureCollection",features:[]},this.label_geojson={type:"FeatureCollection",features:[]},a.getSource(this.options.id)||a.addSource(this.options.id,{type:"geojson",data:this.json2url({type:"FeatureCollection",features:[]})}),a.getSource(this.options.id+"_label")||a.addSource(this.options.id+"_label",{type:"geojson",data:this.json2url({type:"FeatureCollection",features:[]})}),this.updateLayers(),a.on("mousemove",this.onmousemove),a.on("mouseup",this.onclick)}},{key:"json2url",value:function(a){var b=JSON.stringify(a),c=new Blob([b],{type:"application/json"}),d=URL.createObjectURL(c);return d}},{key:"onmousemove",value:function(b){var c=this;if(this.options.interactive.interactive){var d=a.tolerance||1,e=[[b.point.x-d/2,b.point.y-d/2],[b.point.x+d/2,b.point.y+d/2]],f=this.interactiveLayers.filter(function(b){return a.getLayer(b)}),g=a.queryRenderedFeatures(b.point,{layers:f});return g.length?void(a.fillHover=!0,setTimeout(function(){return a.circleHover||a.lineHover||!a.fillHover?(a.getLayer(c.options.id+"_layer_hover")&&a.setFilter(c.options.id+"_layer_hover",["==","datavid",""]),void(a.fillHover=!1)):void(a.fillHover=!1,a.getCanvas().style.cursor=c.options.interactive.clickPopup?"pointer":"",a.getLayer(c.options.id+"_layer_hover")&&a.setFilter(c.options.id+"_layer_hover",["==","datavid",void 0==g[0].properties.datavid?"":g[0].properties.datavid]))},3-0.1*this.tagIndex)):(a.getLayer(this.options.id+"_layer_hover")&&a.setFilter(this.options.id+"_layer_hover",["==","datavid",""]),void(a.getCanvas().style.cursor=""))}}},{key:"onclick",value:function(c){var d=this;if(this.options.interactive.interactive){var e=this.interactiveLayers.filter(function(b){return a.getLayer(b)}),f=a.tolerance||1,g=[[c.point.x-f/2,c.point.y-f/2],[c.point.x+f/2,c.point.y+f/2]],h=a.queryRenderedFeatures(c.point,{layers:e});h.length&&(a.fillClick=!0,setTimeout(function(){if(a.circleClick||a.lineClick||!a.fillClick)return void(a.fillClick=!1);if(a.fillClick=!1,d.options.interactive.clickZoom){var e=k(h[0]),f=Math.abs(e[1]-e[3])*(d.options.interactive.zoomPad-1),g=Math.abs(e[0]-e[2])*(d.options.interactive.zoomPad-1);a.fitBounds([[e[0]-g,e[1]-f],[e[2]+g,e[3]+f]],{pitch:30})}d.emit("click",h[0].properties),d.options.interactive.clickPopup&&h[0].properties.info&&new b.Popup().setLngLat(c.lngLat).setHTML(h[0].properties.info).addTo(a)},3-0.1*this.tagIndex))}}},{key:"setGeojson",value:function(a){this.geojson=a,this.genGeojson()}},{key:"setData",value:function(a){this.data=a,this.genGeojson()}},{key:"area",value:function(a){for(var b,c=0,d=0;d<a.length;d++){b=a[d];for(var e=0,f=b.length,g=f-1;e<f;g=e++)c+=(b[e][0]-b[g][0])*(b[e][1]+b[g][1])*(d?-1:1)}return Math.abs(c)/2}},{key:"calLabelPos",value:function(a,b){var c=this;if(a.geometry&&"Polygon"===a.geometry.type)return j(a.geometry.coordinates,b);if(a.geometry&&"MultiPolygon"===a.geometry.type){var d=a.geometry.coordinates.reduce(function(d,a){return c.area(d)>=c.area(a)?d:a},{});return j(d,b)}}},{key:"genGeojson",value:function(){var b=this;if(this.data.length){var c="";this.geojson&&this.geojson.features&&this.geojson.features.map(function(a){return delete a.properties.value}),this.new_geojson.features=this.geojson.features.map(function(a){c=c||a.properties.area_id&&"area_id",c=c||a.properties.ad_code&&"ad_code",c=c||a.properties.adcode&&"adcode",c=c||a.properties.id&&"id",c=c||a.properties.name&&"name";var d=b.data.find(function(b){return b.area_id==a.properties[c]});return d&&(d.area_id=""+d.area_id),Object.assign(a.properties,d),a})}else this.new_geojson=this.geojson;this.minValue=Math.min.apply([],this.new_geojson.features.filter(function(a){return void 0!=a.properties.value}).map(function(a){return+a.properties.value})),this.maxValue=Math.max.apply([],this.new_geojson.features.filter(function(a){return void 0!=a.properties.value}).map(function(a){return+a.properties.value})),isFinite(this.minValue)&&isFinite(this.maxValue)||(this.minValue=0,this.maxValue=0),this.label_geojson.features=this.new_geojson.features.map(function(a,c){a.properties.datavid=c+1;var d=b.calLabelPos(a,0.5);return{type:"Feature",properties:a.properties,geometry:{type:"Point",coordinates:d}}}),a.getSource(this.options.id)&&a.getSource(this.options.id).setData(this.json2url(this.new_geojson)),a.getSource(this.options.id+"_label")&&a.getSource(this.options.id+"_label").setData(this.json2url(this.label_geojson)),this.updateData()}},{key:"removeLayers",value:function(){var b=this;Object.keys(a.style._layers).forEach(function(c){-1!==c.indexOf(b.options.id)&&a.getLayer(c)&&a.removeLayer(c)})}},{key:"findCorrectInsertIndex",value:function(){var b=a.submtags,c=void 0;return 1<b.fill.length&&(c=this.findInsertIndexByLayerTag(b.fill),-1!==c)?c:b.line.length&&(c=this.findBeforeIndexByLayerTag(b.line[0]),-1!==c)?c:b.circle.length&&(c=this.findBeforeIndexByLayerTag(b.circle[0]),-1!==c)?c:b.basemap.length&&(c=this.findAfterIndexByLayerTag(b.basemap[b.basemap.length-1]),-1!==c)?c:a.getStyle().layers.length}},{key:"findInsertIndexByLayerTag",value:function(a){var b=this,c=a.findIndex(function(a){return-1!==a.indexOf(b.options.id)});return c===a.length-1?this.findAfterIndexByLayerTag(a[c-1]):this.findBeforeIndexByLayerTag(a[c+1])}},{key:"findAfterIndexByLayerTag",value:function(b){var c=a.getStyle(),e=-1;return c.layers.forEach(function(a,c){-1!==a.id.indexOf(b)&&(e=c+1)}),e}},{key:"findBeforeIndexByLayerTag",value:function(b){var c=a.getStyle();return c.layers.findIndex(function(a){return-1!==a.id.indexOf(b)})}},{key:"findInsertIndex",value:function(){var b=a.getStyle(),c=-1,e=-1,f=-1,g=-1;if(b.layers.forEach(function(a,b){-1!==a.id.indexOf("datav_fill")&&(c=b+1),-1!==a.id.indexOf("datav_line")&&(f=b+1),-1!==a.id.indexOf("datav_basemap")&&(e=b+1),-1!==a.id.indexOf("datav_circle")&&(g=b+1)}),-1!==c)return c;if(-1!==e)return e;if(-1!==f)for(var d=0;d<b.layers.length;d++)if(-1!==b.layers[d].id.indexOf("datav_line"))return d;if(-1!==g)for(var h=0;h<b.layers.length;h++)if(-1!==b.layers[h].id.indexOf("datav_circle"))return h;return b.layers.length}},{key:"updateLayers",value:function(){var a=this;this.removeLayers(),this.interactiveLayers=[];var b=[],c=this.layers=[],d=this.options.fill;c.push({id:this.options.id+"_layer_area",type:"fill",source:this.options.id,paint:{"fill-color":{default:d.fillColor,property:"value",type:"exponential",stops:[[this.minValue||0,d.minFillColor],[this.maxValue||0,d.maxFillColor]]}}}),b.push(this.options.id+"_layer_area");var e=this.options.stroke;c.push(JSON.parse(JSON.stringify({id:this.options.id+"_layer_line",type:"line",source:this.options.id,paint:{"line-color":e["line-color"],"line-width":e["line-width"],"line-blur":e["line-blur"],"line-dasharray":e["line-dasharray"]?e["line-dasharray"].split(",").map(function(a){return+a||0}):void 0}}))),b.push(this.options.id+"_layer_line"),this.options.interactive.isHover.show&&c.push({id:this.options.id+"_layer_hover",type:"line",source:this.options.id,layout:{},paint:{"line-color":this.options.interactive.isHover["hover-color"],"line-width":this.options.interactive.isHover["hover-width"],"line-blur":2},filter:["==","datavid",""]});var f=this.options.label;f.show&&f["text-field"]&&c.push({id:this.options.id+"_layer_symbol_label",type:"symbol","symbol-placement":"point",source:this.options.id+"_label",layout:{"text-anchor":f["text-anchor"],"text-field":f["text-field"],"text-justify":f["text-justify"],"text-rotate":f["text-rotate"],"text-size":f["text-size"]},paint:{"text-color":f["text-color"],"text-halo-blur":f["text-halo-blur"],"text-halo-color":f["text-halo-color"],"text-halo-width":f["text-halo-width"],"text-translate":f["text-translate"]?f["text-translate"].split(",").map(function(a){return+a||0}):[0,0]}}),this.updateStyle(),this.interactiveLayers=b,this.endID=setTimeout(function(){a.resetID&&clearTimeout(a.resetID)},100000)}},{key:"updateStyle",value:function(){var b=this;if(a.loaded()&&a.isStyleLoaded()){this.resetID&&clearTimeout(this.resetID);var c=this.findCorrectInsertIndex(),d=a.getStyle(),e=this.layers;e.forEach(function(a){a.layout&&(a.layout.visibility=b.options.visible?"visible":"none"),a.layout||(a.layout={visibility:b.options.visible?"visible":"none"})}),[].splice.apply(d.layers,[c,0].concat(e)),a.setStyle(d),this.updateData()}else this.resetID&&clearTimeout(this.resetID),this.resetID=setTimeout(function(){b.updateStyle()},200)}},{key:"updateData",value:function(){var b=this.options.fill;a.getLayer(this.options.id+"_layer_area")&&a.setPaintProperty(this.options.id+"_layer_area","fill-color",{default:b.fillColor,property:"value",type:"exponential",stops:[[this.minValue||0,b.minFillColor],[this.maxValue||0,b.maxFillColor]]})}},{key:"updateOptions",value:function(a){this.options=i(this.options,a),this.updateLayers()}},{key:"show",value:function(){var b=this;this.options.visible=!0,Object.keys(a.style._layers).forEach(function(c){-1!==c.indexOf(b.options.id)&&a.getLayer(c)&&a.setLayoutProperty(c,"visibility","visible")})}},{key:"hide",value:function(){var b=this;this.options.visible=!1,Object.keys(a.style._layers).forEach(function(c){-1!==c.indexOf(b.options.id)&&a.getLayer(c)&&a.setLayoutProperty(c,"visibility","none")})}},{key:"remove",value:function(){this.endID&&clearTimeout(this.endID),this.resetID&&clearTimeout(this.resetID),this.interactiveLayers=[],a.off("mousemove",this.onmousemove),a.off("mouseup",this.onclick),this.removeLayers(),a.getSource(this.options.id)&&a.removeSource(this.options.id),a.getSource(this.options.id+"_label")&&a.removeSource(this.options.id+"_label")}}]),l}(h)},a.exports});;
Cube("datav:/com/datavmap-3d-layer-mapbox-area/0.1.10",["datav:/npm/eventemitter3/2.0.3","datav:/npm/safely-merge/1.0.1"],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"===typeof b||"function"===typeof b)?b:a}function f(a,b){if("function"!==typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=c("datav:/npm/eventemitter3/2.0.3"),i=c("datav:/npm/safely-merge/1.0.1"),j=c("datav:/com/datavmap-3d-layer-mapbox-area/0.1.10/mareaLayer.js"),k={},l=function(a){function b(a,c){d(this,b);var f=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return f.container="string"===typeof a?document.querySelector(a):a,f.apis=c.apis,f.map=null,f._data=null,f.config=c,f}return f(b,a),g(b,[{key:"initLayer",value:function(){var a=this,b=this.getOptions(),c=j(this.map);this.layer=new c(b),this.layer.on("click",function(b){var c=a.getOptions();a.emit("mapbox-area-map-click",b),""!==c.interactive["click-key"]&&a.emit("global_var",c.interactive["click-key"],b[c.interactive["click-key"]])})}},{key:"addTo",value:function(a){var b=this;this.map=a,this.config.id=this.mtag=this.id+"_datav_fill",this.init(),this.endID=setTimeout(function(){b.resetID&&clearTimeout(b.resetID)},100000)}},{key:"init",value:function(){var a=this;this.map.loaded()&&this.map.isStyleLoaded()?(this.resetID&&clearTimeout(this.resetID),this.initLayer(),this.setGeojson(this.geojson),this.data&&this.setData(this.data)):(this.resetID&&clearTimeout(this.resetID),this.resetID=setTimeout(function(){a.init()},100))}},{key:"getOptions",value:function(){return this.config=i(k,this.config),this.config}},{key:"show",value:function(){this.config.visible=!0,this.layer&&this.layer.show&&this.layer.show()}},{key:"hide",value:function(){this.config.visible=!1,this.layer&&this.layer.hide&&this.layer.hide()}},{key:"remove",value:function(){this.resetID&&clearTimeout(this.resetID),this.endID&&clearTimeout(this.endID),this.layer&&this.layer.remove&&this.layer.remove(),this.layer=null,this._data=null}},{key:"setGeojson",value:function(a){var b=this,c=null;c=Array.isArray(a)&&a.length?a[0]:a,c&&c.type&&"featurecollection"===c.type.toLowerCase()&&c.features&&0<c.features.length?(this.geojson=c,this.layer&&this.layer.setGeojson(c)):void 0==c?(this.geojson={type:"FeatureCollection",features:[]},this.layer&&this.layer.setGeojson(this.geojson)):this.defaultGeojson?(this.geojson=this.defaultGeojson,console.log("\u4F7F\u7528\u9ED8\u8BA4\u7684geojson"),this.layer&&this.layer.setGeojson(this.defaultGeojson)):fetch(this.config.mapData).then(function(a){return a.json()}).then(function(a){b.defaultGeojson=a,b.geojson=a,console.log("\u4F7F\u7528\u9ED8\u8BA4\u7684geojson"),b.layer&&b.layer.setGeojson(b.defaultGeojson)}).catch(function(a){return console.log("fetch error",a)})}},{key:"setData",value:function(a){a&&(this.data=a,this.layer&&this.layer.setData(a))}},{key:"updateOptions",value:function(a){this.config=i(this.config,a),a=this.getOptions(),this.layer&&this.layer.updateOptions(a)}}]),b}(h);return a.exports=l,a.exports});