// env=undefined => env=publish 
Cube("datav:/com/ml-event-line/0.5.10",["datav:/npm/bcore/0.0.21/event","datav:/npm/jquery/2.1.4","datav:/npm/lodash/4.6.1","datav:/npm/d3/4.7.1/build/d3.min.js"],function(e,t,i,l,s,a){var n=i("datav:/npm/bcore/0.0.21/event"),m=i("datav:/npm/jquery/2.1.4"),b=i("datav:/npm/lodash/4.6.1"),p=i("datav:/npm/d3/4.7.1/build/d3.min.js");return e.exports=n.extend(function(e,t){this.config={global:{loop:!0,duration:2e3,stopTime:2e3,pad:40},node:{category:"time",format:"%Y",shape:"symbolDiamond",size:64,fill:"#fff",stroke:"#fff",strokeWidth:1},textLabel:{dy:-28,rotate:0,defaultStyle:{fontSize:12,color:"rgba(255,255,255,0.6)",fontWeight:"normal"},choseStyle:{fontSize:12,color:"#ffffff",fontWeight:"normal"}},background:{color:"rgba(0,0,0,.5)"}},this.container=m(e),this.scale,this.shape,this.isFirst=!0,this.index=0,this.__autoIndex=0,this.isTurnTo=!1,this.init(t)},{init:function(e){this.apis=e.apis,this.mergeConfig(e);e=this.container;this.__width=e.width(),this.__height=e.height(),this.svg=p.select(e[0]).append("svg").attr("width",this.__width).attr("height",this.__height).append("g").attr("transform","translate("+this.config.global.pad+", 0)")},massageTimeData:function(e,t){return b.sortBy(b.uniqBy(e,"value"),function(e){return new Date(p.timeParse(t.node.dataFormat)(""+e.value)).getTime()})},render:function(e){if(e&&!b.isEqual(e,this._data)&&(this.isFirst=!0,this.index=0),this.isFirst){var t=this.config;if((e=this.data(e))&&e.length){var i,l=2*t.global.pad,s=this,n=t.node.size,a=[n/10,this.__width-l-n/10],c=t.node.shape,o=t.node.category;switch(this.svg.attr("transform","translate("+this.config.global.pad+", 0)"),o){case"time":e=this.massageTimeData(e,t),i=p.extent(e,function(e){return p.timeParse(t.node.dataFormat)(""+e.value)}),this.scale=p.scaleTime().range(a).domain(i);break;case"category":i=b.map(e,function(e){return e.value+""}),this.scale=p.scalePoint().domain(i).range(a);break;default:i=p.extent(e,function(e){return e.value}),this.scale=p.scaleLinear().range(a).domain(i)}function d(e,t){e.attr("d",p.symbol().type(p[v.v3shapeToV4(c)]).size(n)).style("fill",f.defaultStyle.fill).style("stroke",f.defaultStyle.stroke).style("stroke-width",f.defaultStyle.strokeWidth)}function r(e,i,t,l){e._groups&&e.attr("y",t.dy).attr("dy",t.defaultStyle.fontSize).attr("width",function(e,t){return i[t].width||s.__width}).attr("height",function(e,t){return i[t].height||s.__height/2}).attr("transform",function(e,t){return"translate("+-(i[t].width||s.__width)/2+", 0)"}).html(function(e,t){return i[t][l]||""}).style("color",t.defaultStyle.color).style("font-size",t.defaultStyle.fontSize+"px").style("font-weight",t.defaultStyle.fontWeight).style("text-align","center").style("rotate",(t.rotate||0)+"deg").style("transform-origin","top left")}var f=t.node,u=t.label,y=t.textLabel,v=this,h=t.background,l=((this.svg.select(".event-line-backline")._groups[0][0]?this.svg.select(".event-line-backline"):this.svg.append("line").attr("class","event-line-backline")).attr("x1",n/10).attr("x2",this.__width-l-n/10).attr("y1",this.__height/2).attr("y2",this.__height/2).style("stroke",h.defaultStyle.color).style("stroke-width",h.colorWidth),this.backChosenLine||(this.backChosenLine=this.svg.append("line").attr("class","event-line-backchosenline")),this.backChosenLine.attr("x1",n/10).attr("x2",n/10).attr("y1",this.__height/2).attr("y2",this.__height/2).style("stroke",h.choseStyle.color).style("stroke-width",h.colorWidth),this.svg.selectAll(".event-line-shape").data(e)),h=(l.attr("transform",function(e){return"translate("+s.scale("time"===o&&p.timeParse(t.node.dataFormat)(""+e.value)||e.value)+","+s.__height/2+")"}),this.svg.selectAll(".event-symbol-series").data(e).attr("transform",function(e){return"translate("+s.scale("time"===o&&p.timeParse(t.node.dataFormat)(""+e.value)||e.value)+","+s.__height/2+")"}).exit().remove(),d(this.svg.selectAll(".event-line-serie")),r(l.select(".event-line-label"),e,u,"name"),r(l.select(".event-line-text-label"),e,y,"text"),l.enter().append("g").attr("class","event-line-shape").attr("transform",function(e){return"translate("+s.scale("time"===o&&p.timeParse(t.node.dataFormat)(""+e.value)||e.value)+","+s.__height/2+")"})),g=l.enter().append("g").attr("class","event-symbol-series").attr("transform",function(e){return"translate("+s.scale("time"===o&&p.timeParse(t.node.dataFormat)(""+e.value)||e.value)+","+s.__height/2+")"}),u=(r(h.append("foreignObject").attr("class",function(e,t){return"event-line-label event-line-label"+t}),e,u,"name"),r(h.append("foreignObject").attr("class",function(e,t){return"event-line-text-label event-line-text-label"+t}),e,y,"text"),d(g.append("path").attr("class",function(e,t){return"event-line-serie event-line-serie"+t})),l.exit().remove(),this.svg.selectAll("foreignObject").attr("font-family",'"'.concat(t.global.fontFamily,'"')||"Microsoft Yahei"),this.clear(),this.loop(this.index),this.isFirst=!1,b.get(this.svg.selectAll(".event-line-serie"),["_groups","0"]));b.each(u,function(e,t){m(e).on("click",null),m(e).on("click",function(){t!==s.index&&(s.loop(t),s.stop())})})}}},v3shapeToV4:function(e){var t={diamond:"symbolDiamond",circle:"symbolCircle","triangle-up":"symbolTriangle","triangle-down":"symbolTriangle",square:"symbolSquare",cross:"symbolCross"};return t[e]||e},recoverFn:function(){function e(e,t){var i=l.svg.selectAll("."+e);i.style("color",t.defaultStyle.color).style("font-size",t.defaultStyle.fontSize+"px").style("font-weight",t.defaultStyle.fontWeight),i.classed(e,!1)}var l=this,t=this.config,i=t.node,s=t.label,n=t.textLabel;e("event-line-active-label",s),e("event-line-active-text-label",n),m(".event-line-serie").each(function(e){var t;e>=l._index&&((t=l.svg.select(".event-line-serie"+e)).style("fill",i.defaultStyle.fill).style("stroke",i.defaultStyle.stroke).style("stroke-width",i.defaultStyle.strokeWidth),t.classed("event-line-active-serie",!0),t.transition(),(t=function(e,t,i){e.style("color",i.defaultStyle.color).style("font-size",i.defaultStyle.fontSize+"px").style("font-weight",i.defaultStyle.fontWeight),e.classed(t,!0),e.transition()})(l.svg.select(".event-line-label"+e),"event-line-active-label",s),t(l.svg.select(".event-line-text-label"+e),"event-line-active-text-label",n))})},loop:function(t){var i=this.data(),l=this.config,s=("time"==l.node.category&&(i=this.massageTimeData(i,l)),this.index=t>i.length-1?i.length-1:t,this),c=0!==t&&l.global.duration||0,n=Math.min(c/4,500),d=c-n,a=l.node,o=l.label,r=l.textLabel,e=a.category,f=i[t],u=(this._index=t,this.svg.select(".event-line-serie"+this._index));this.backChosenLine&&this.backChosenLine.transition().duration(d).ease(p.easeLinear).attr("x2",this.scale("time"===e&&p.timeParse(a.dataFormat)(""+f.value)||f.value)).on("end",function(){s.__autoOriginIndex=t});for(var h=t+1;h<i.length;h++)this.svg.select(".event-line-serie"+h).style("fill",a.defaultStyle.fill).style("stroke",a.defaultStyle.stroke).style("stroke-width",a.defaultStyle.strokeWidth);for(h=0;h<t;h++)this.svg.select(".event-line-serie"+h).style("fill",a.choseStyle.fill).style("stroke",a.choseStyle.stroke).style("stroke-width",a.choseStyle.strokeWidth);this.isTurnTo?(this.isTurnTo=!1,this.recoverFn(),e=s.svg.select(".event-line-serie"+s._index),s.__autoOriginIndex>=s._index&&(e.style("fill",a.choseStyle.fill),e.style("stroke",a.choseStyle.stroke),e.style("stroke-width",a.choseStyle.strokeWidth)),e.transition().delay(d).duration(n).ease(p.easeLinear).style("fill",a.choseStyle.fill).style("stroke",a.choseStyle.stroke).style("stroke-width",a.choseStyle.strokeWidth),e.classed("event-line-active-serie",!0),(f=function(e,t,i){e.transition().delay(d).duration(n).ease(p.easeLinear).attr("dy",i.choseStyle.fontSize).style("color",i.choseStyle.color).style("font-size",i.choseStyle.fontSize+"px").style("font-weight",i.choseStyle.fontWeight),e.classed(t,!0)})(s.svg.select(".event-line-label"+s._index),"event-line-active-label",o),f(s.svg.select(".event-line-text-label"+s._index),"event-line-active-text-label",r)):(this.__autoOriginIndex=t,u.transition().delay(d).duration(n).ease(p.easeLinear).style("fill",a.choseStyle.fill).style("stroke",a.choseStyle.stroke).style("stroke-width",a.choseStyle.strokeWidth),u.classed("event-line-active-serie",!0),(e=function(e,t){var i=s.svg.selectAll("."+e);i.transition().delay(d).duration(n).ease(p.easeLinear).attr("dy",t.defaultStyle.fontSize).style("font-size",t.defaultStyle.fontSize+"px").style("color",t.defaultStyle.color).style("font-weight",t.defaultStyle.fontWeight),i.classed(e,!1)})("event-line-active-label",o),e("event-line-active-text-label",r),(f=function(e,t,i){e.transition().delay(d).duration(n).attr("dy",i.choseStyle.fontSize).style("color",i.choseStyle.color).style("font-weight",i.choseStyle.fontWeight).style("font-size",i.choseStyle.fontSize+"px"),e.classed(t,!0)})(this.svg.select(".event-line-label"+t),"event-line-active-label",o),f(this.svg.select(".event-line-text-label"+t),"event-line-active-text-label",r)),setTimeout(function(){s.emit("event-line-changed",i[t]),b.get(l,"interactive.cbID","")&&(s.emit("global_var",l.interactive.cbID,i[t]&&i[t][l.interactive.cbID]),s.emit("event-line-change",i[t],l.interactive.cbID))},c),clearTimeout(this.timer),this.timer=setTimeout(function(){var e=(t+1)%i.length;0!=e||l.global.loop?(t+1>=i.length&&(s.svg.selectAll(".event-line-active-serie").classed("event-line-active-serie",!1).style("fill",a.defaultStyle.fill).style("stroke",a.defaultStyle.stroke).style("stroke-width",a.defaultStyle.strokeWidth),s.svg.selectAll(".event-line-active-label .event-line-label").classed("event-line-active-label",!1).attr("dy",o.defaultStyle.fontSize).style("color",o.defaultStyle.color).style("font-size",o.defaultStyle.fontSize+"px").style("font-weight",o.defaultStyle.fontWeight),s.svg.selectAll(".event-line-active-text-label .event-line-text-label").classed("event-line-active-text-label",!1).attr("dy",r.defaultStyle.fontSize).style("color",r.defaultStyle.color).style("font-size",r.defaultStyle.fontSize+"px").style("font-weight",r.defaultStyle.fontWeight),s.backChosenLine.attr("x2",l.node.size/10)),s.loop(e)):s.clear()},c+l.global.stopTime)},stop:function(){this.timer&&clearTimeout(this.timer)},turnTo:function(e){e=b.findIndex(this._data,{value:e.value});-1!==e&&this.__autoOriginIndex!==e&&(this.isTurnTo=!0,this.loop(e))},updateStyle:function(){},setColors:function(){},data:function(e){return e&&(this._data=b.clone(e)),this._data},mergeConfig:function(e){return e&&(this.config.theme=b.defaultsDeep(e.theme||{},this.config.theme),this.setColors(),e.series&&(this.config.series=e.series),this.config=b.defaultsDeep(e||{},this.config)),this.config},resize:function(e,t){var i=p.select(this.svg._groups[0][0].parentNode);i.attr("width",e),i.attr("height",t),this.__width=e,this.__height=t,this.isFirst=!0,this.render()},updateOptions:function(e){this.mergeConfig(e),this.isFirst=!0,this.render()},clear:function(){this.stop()},destroy:function(){this.stop(),this.container&&this.container.empty(),this._data=null,clearTimeout(this.timer),this.timer=null,this.off&&this.off()},clearAnimate:function(){this.stop()},startAnimate:function(){this.loop(this.index)}}),e.exports});