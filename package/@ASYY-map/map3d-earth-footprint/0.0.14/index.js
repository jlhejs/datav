// env=undefined => env=publish 
Cube("datav:/com/map3d-earth-footprint/0.0.14/shader/footprint.frag.glsl",[],function(a){return a.exports="#define GLSLIFY 1\nuniform float uTime;\nvarying float vIndex;\nvarying vec4 vColor;\n\nuniform float uMaxOpacity;\nuniform float uMinOpacity;\nuniform float uOpacityFactor;\n\nuniform float uLength;\n\nfloat enlargeOpacity(float opacity, float factor){\n  return pow( opacity, factor);\n}\n\nfloat calculateTimeContrlOpacity(float timeCounter) {\n  float halfTrajLength = uLength / 2.0;\n  float opacity = uMinOpacity;\n\n  float _start = timeCounter - halfTrajLength;\n  float _end = timeCounter + halfTrajLength;\n\n  if(_start < 0.0) {\n    if((0.0 <= vIndex) && (vIndex <= _end)) {\n      opacity = (vIndex - .0);\n    }\n    \n    if(((1.0 - abs(_start)) <= vIndex) && (vIndex <= 1.0)) {\n      opacity = vIndex - (1.0 - abs(_start));\n    }\n  } if(_end > 1.0) {\n    if((_start <= vIndex) && (vIndex <= 1.0)) {\n      opacity = (vIndex - _start);\n    }\n    // \u4FDD\u8BC1\u7B2C\u4E8C\u6BB5\u9AD8\u4EAE\n    if((0.0 <= vIndex) && (vIndex <= (_end - 1.0))) {\n      // opacity = vIndex - .0;\n      opacity = (1. - _start);\n    }\n\n  } else {\n    if((_start <= vIndex) && (vIndex <= _end)) {\n      opacity = (vIndex - _start);\n    }\n\n  }\n\n  opacity = enlargeOpacity(opacity, uOpacityFactor);\n  \n  return opacity;\n}\n\nvoid main() {\n  float currentOpacity = calculateTimeContrlOpacity(uTime);\n  gl_FragColor = vec4(vColor.xyz, currentOpacity * uMaxOpacity); \n}",a.exports});;
Cube("datav:/com/map3d-earth-footprint/0.0.14/shader/footprint.vert.glsl",[],function(a){return a.exports="#define GLSLIFY 1\nattribute float aSize;\n\nattribute float aIndex;\nvarying float vIndex;\n\nuniform float uMaxSize;//\u6700\u5927\u5BBD\u5EA6\nuniform float uMaxSizeValue;\nuniform float uMinSizeValue;\n\nvarying vec4 vColor;\n// uniform sampler2D uColorTexture;\n\nattribute vec3 plane_position;\nattribute vec3 sphere_position;\nattribute vec4 aColor;\n\nuniform float u_proj_type;\nuniform float u_ease_index;\n\nvec3 real_position() {\n  if(u_proj_type == 0.){\n    return mix(plane_position, sphere_position, u_ease_index);\n  } else if(u_proj_type == 1.){\n     return mix(sphere_position, plane_position, u_ease_index);\n  } else {\n    return vec3(0);\n  }\n}\n\nvoid main() {\n  vIndex = aIndex;\n  float i = 0.0;\n\n  if(uMaxSizeValue == uMinSizeValue) {\n    i = 1.0;\n  } else {\n    if( aSize == uMinSizeValue ){\n      // Note: avoid i to be 0.\n      i = 0.5 / (uMaxSizeValue - uMinSizeValue);\n    } else {\n      i = (aSize - uMinSizeValue) / (uMaxSizeValue - uMinSizeValue);\n    }\n   \n  }\n\n  // vec2 pos = vec2(fract(16.0 * i), floor(16.0 * i) / 16.0);\n  // vColor = texture2D(uColorTexture, pos);\n  vColor = aColor;\n\n  gl_PointSize = i * uMaxSize;\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(real_position(), 1.);\n}",a.exports});;
Cube("datav:/com/map3d-earth-footprint/0.0.14/footprint-layer.js",["datav:/npm/eventemitter3/2.0.3"],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"===typeof b||"function"===typeof b)?b:a}function f(a,b){if("function"!==typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=c("datav:/npm/eventemitter3/2.0.3");return a.exports=function(a){var b=a.THREE,i=a.Utils,j=a.scene;return function(h){function k(a){d(this,k);var b=e(this,(k.__proto__||Object.getPrototypeOf(k)).call(this));return b.options=Object.assign({},a),b.animation=b.animation.bind(b),b.init(),b}return f(k,h),g(k,[{key:"init",value:function(){this.initMaterial(),a.on("animationFrame",this.animation),a.on("projChanged",this.updatePostions.bind(this))}},{key:"createColorTexture",value:function(){var a=this.options,c=a.fromColor,d=a.toColor,e=i.Chroma.scale([c,d]).colors(6),f=document.createElement("canvas"),g=f.getContext("2d");f.width=256,f.height=1;var h=g.createLinearGradient(0,0,256,0);["0.0","0.2","0.4","0.6","0.8","1.0"].map(function(a,b){h.addColorStop(+a,e[b])}),g.fillStyle=h,g.fillRect(0,0,256,1);var j=new Uint8Array(g.getImageData(0,0,256,1).data),k=new b.DataTexture(j,16,16,b.RGBAFormat,b.UnsignedByteType);return k.needsUpdate=!0,k}},{key:"animation",value:function(){1<=this.material.uniforms.uTime.value&&(this.material.uniforms.uTime.value=0),this.material.uniforms.uTime.value+=this.options.speed}},{key:"setData",value:function(a){this.data=a,this.geometry=this.genGeometry(a),this.footprint=new b.Points(this.geometry,this.material),this.footprint.renderOrder=100+Math.round(3e3*Math.random()),j.add(this.footprint)}},{key:"initMaterial",value:function(){var d=this.options,e=d.fromColor,f=d.toColor,g=d.maxSize,h=d.length,j=d.opacityFactor,k=i.Chroma(e).gl(),l=i.Chroma(f).gl(),m={uTime:{value:Math.random()},uMaxSizeValue:{value:1},uMinSizeValue:{value:1},uMaxSize:{value:g},uLength:{value:h},uMaxOpacity:{value:k[3]},uMinOpacity:{value:l[3]},uOpacityFactor:{value:j},u_ease_index:{value:1},u_proj_type:{value:a.projType}};this.material=new b.ShaderMaterial({uniforms:m,vertexShader:c("datav:/com/map3d-earth-footprint/0.0.14/shader/footprint.vert.glsl"),fragmentShader:c("datav:/com/map3d-earth-footprint/0.0.14/shader/footprint.frag.glsl"),blending:b.AdditiveBlending,depthTest:!0,depthWrite:!1,transparent:!0}),this.material.needsUpdate=!0,this.material.extensions.derivatives=!0}},{key:"genGeometry",value:function(a){return this.geometry=new b.BufferGeometry,this.geometry.addAttribute("sphere_position",new b.BufferAttribute(new Float32Array(a.spherePositions),3).setDynamic(!0)),this.geometry.addAttribute("plane_position",new b.BufferAttribute(new Float32Array(a.planePositions),3).setDynamic(!0)),this.geometry.addAttribute("aColor",new b.BufferAttribute(new Float32Array(a.color),4).setDynamic(!0)),this.geometry.addAttribute("aTime",new b.BufferAttribute(new Float32Array(a.timeStamp),1)),this.geometry.addAttribute("aSize",new b.BufferAttribute(new Float32Array(a.size),1)),this.geometry.addAttribute("aIndex",new b.BufferAttribute(new Float32Array(a.index),1)),this.geometry.addAttribute("aStartTime",new b.BufferAttribute(new Float32Array(a.startTime),1)),this.geometry.setDrawRange(0,a.spherePositions.length/3),this.updateUniformsSize(a.size),this.geometry.computeBoundingBox(),this.geometry.computeBoundingSphere(),this.geometry.computeVertexNormals(),this.geometry}},{key:"updateUniformsSize",value:function(a){if(!a)return console.log("footprint update uniforms failed");var b=+Infinity,c=-Infinity;a.forEach(function(a){a>c&&(c=a),a<b&&(b=a)}),this.material.uniforms.uMaxSizeValue.value=c,this.material.uniforms.uMinSizeValue.value=b}},{key:"updateMaterial",value:function(){var a=this.options,b=a.fromColor,c=a.toColor,d=a.maxSize,e=a.length,f=a.opacityFactor,g=i.Chroma(b).gl(),h=i.Chroma(c).gl();this.material.uniforms.uLength.value=e,this.material.uniforms.uMaxSize.value=d,this.material.uniforms.uMaxOpacity.value=g[3],this.material.uniforms.uMinOpacity.value=h[3],this.material.uniforms.uOpacityFactor.value=f}},{key:"updatePostions",value:function(a){var b=a.projType,c=a.index;this.material.uniforms.u_ease_index.value=c,this.material.uniforms.u_proj_type.value=b}},{key:"updateOptions",value:function(a){this.options=i.mergeOptions(this.options,a),this.updateMaterial()}},{key:"hide",value:function(){this.footprint&&(this.footprint.visible=!1)}},{key:"show",value:function(){this.footprint&&(this.footprint.visible=!0)}},{key:"clean",value:function(){j.remove(this.footprint),this.footprint&&this.footprint.dispose&&this.footprint.dispose(),this.geometry&&this.geometry.dispose&&this.geometry.dispose(),this.footprint=null,this.geometry=null,this.data=null}},{key:"remove",value:function(){a.off("animationFrame",this.animation),a.off("projChanged",this.updatePostions),this.clean(),this.material&&this.material.dispose&&this.material.dispose(),this.material=null}}]),k}(h)},a.exports});;
Cube("datav:/com/map3d-earth-footprint/0.0.14/processor",["datav:/npm/cheap-ruler/2.5.1","datav:/npm/geoclassify/0.0.4"],function(a,b,c){function d(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)}function e(a,b){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:200,d=(90-b)*(Math.PI/180),e=(0<=a?a:360+a)*(Math.PI/180),f=c*Math.sin(d)*Math.sin(e),g=c*Math.cos(d),h=c*Math.sin(d)*Math.cos(e);return{x:f,y:g,z:h}}function f(a,b){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:200,d=3<arguments.length&&void 0!==arguments[3]?arguments[3]:2;return{x:a*d,y:b*d,z:c}}function g(a,b,c,g){if(!a.features||!Array.isArray(a.features)||!a.features.length)return console.log("footprint parse geojson failed");var j={size:[],spherePositions:[],planePositions:[],index:[],color:[]},k="Jenks";3>a.features.length&&(k="EqInterval");var l=new i({type:k,level:10});l.setData(a.features.map(function(a){return void 0===a.properties.value?1:+a.properties.value})),l.setPattern([1,2,3,4,5,6,7,8,9,10]);var m=[];a.features.forEach(function(a){var b=l.getPattern(a.properties.value||0);-1===m.indexOf(b)&&m.push(b)}),m.sort();var n=g.fromColor,o=g.toColor,q=g.Chroma,r=q.scale([o,n]).colors(m.length||2);return a.features.forEach(function(a){for(var g=a.geometry.coordinates,k=h(g[0][1],"kilometers"),n=k.lineDistance(g),o=Math.ceil(n/c),s=l.getPattern(a.properties.value),t=q(r[m.indexOf(s)]).gl(),u=0;u<o;u++){var i,v=k.along(g,u*c);j.index.push(u/o),j.size.push(s);var w=e(v[0],v[1],b),p=f(v[0],v[1],b);j.spherePositions.push(w.x,w.y,w.z),j.planePositions.push(p.x,p.y,p.z),(i=j.color).push.apply(i,d(t))}}),j}var h=c("datav:/npm/cheap-ruler/2.5.1"),i=c("datav:/npm/geoclassify/0.0.4");return a.exports={geojson:g},a.exports});;
Cube("datav:/com/map3d-earth-footprint/0.0.14",["datav:/npm/eventemitter3/2.0.3"],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"===typeof b||"function"===typeof b)?b:a}function f(a,b){if("function"!==typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=null,i=c("datav:/com/map3d-earth-footprint/0.0.14/processor"),j=c("datav:/npm/eventemitter3/2.0.3"),k=c("datav:/com/map3d-earth-footprint/0.0.14/footprint-layer.js");return a.exports=function(a){function b(a,c){d(this,b);var f=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return f.options=Object.assign({visible:!0,maxSize:1.5,height:3,length:0.3,speed:4e-3,maxOpacity:1,minOpacity:0.04,toColor:"RGBA(0, 200, 0, 0.6)",fromColor:"RGBA(232, 0, 0, 0.8)",pointGap:1},c||{}),f}return f(b,a),g(b,[{key:"init",value:function(){var a=k(this.map);this.footPrintLayer=new a(this.options)}},{key:"addTo",value:function(a){return a?void(h=a.Utils,this.map=a,this.init()):console.log("FootPrint layer needs map layer")}},{key:"setData",value:function(a){if(this.cleanComByEmptyArray(a),a&&a.features&&Array.isArray(a.features)&&0<a.features.length){this.data=a;var b=this.options,c=b.height,d=b.pointGap,e=b.fromColor,f=b.toColor;this.footPrintLayer.clean();var g={fromColor:e,toColor:f,Chroma:this.map.Utils.Chroma},h=i.geojson(a,200+c,d,g);this.footPrintLayer.setData(h)}this.checkVisible()}},{key:"checkVisible",value:function(){var a=this.options;a.visible?this.show():this.hide()}},{key:"show",value:function(){this.options.visible=!0,this.footPrintLayer&&this.footPrintLayer.show()}},{key:"hide",value:function(){this.options.visible=!1,this.footPrintLayer&&this.footPrintLayer.hide()}},{key:"cleanComByEmptyArray",value:function(a){a&&Array.isArray(a)&&!a.length&&this.footPrintLayer.clean()}},{key:"updateOptions",value:function(a){if(a){var b=this.options,c=b.height,d=b.pointGap,e=b.fromColor,f=b.toColor;this.options=h.mergeOptions(this.options,a),(c!==a.height||d!==a.pointGap||e!==a.fromColor||f!==a.toColor)&&this.setData(this.data),this.footPrintLayer.updateOptions(this.options),this.checkVisible()}}},{key:"remove",value:function(){this.footPrintLayer&&this.footPrintLayer.remove(),this.footPrintLayer=null}}]),b}(j),a.exports});