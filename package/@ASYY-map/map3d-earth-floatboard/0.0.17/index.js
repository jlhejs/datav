// env=undefined => env=publish 
Cube("datav:/com/map3d-earth-floatboard/0.0.17",["datav:/npm/eventemitter3/2.0.3"],function(t,e,i,n,o,r){function a(t){return(a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function s(t,e,i){return(s=u()?Reflect.construct:function(t,e,i){var n=[null];n.push.apply(n,e);e=new(Function.bind.apply(t,n));return i&&h(e,i.prototype),e}).apply(null,arguments)}function g(t){return function(t){if(Array.isArray(t))return l(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||function(t,e){if(t){if("string"==typeof t)return l(t,e);var i=Object.prototype.toString.call(t).slice(8,-1);return"Map"===(i="Object"===i&&t.constructor?t.constructor.name:i)||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?l(t,e):void 0}}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function l(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=new Array(e);i<e;i++)n[i]=t[i];return n}function c(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function h(t,e){return(h=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function p(i){var n=u();return function(){var t,e=d(i),e=(t=n?(t=d(this).constructor,Reflect.construct(e,arguments,t)):e.apply(this,arguments),this);if(t&&("object"===a(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}}function u(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(t){return!1}}function d(t){return(d=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}var f=200,v=null,y=null,b=i("datav:/npm/eventemitter3/2.0.3"),i=function(){var t=o,e=b;if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&h(t,e);var i,n=p(o);function o(t,e){var i;if(this instanceof o)return(i=n.call(this)).options=Object.assign({visible:!0,opacity:1,scale:50,height:5,enableInteractive:!1,activeColor:"#ff0000",getLat:function(t){return void 0===t.lat?0:t.lat},getLng:function(t){return void 0===t.lng?0:t.lng},getContent:function(t){return void 0===t.content?{}:t.content}},e||{}),i.boardCollection=[],i;throw new TypeError("Cannot call a class as a function")}return t=o,(e=[{key:"addTo",value:function(t){if(!t)return console.log("float board layer needs map layer");v=t.THREE,y=t.Utils,this.map=t,this.scene=t.scene,this.map.on("projChanged",this.updatePostions.bind(this)),this.initInteract()}},{key:"initInteract",value:function(){this.gpuPicker=this.map.interactiveGPU,this.pickScene=new v.Scene,this.pickSprites=[],this.pickedData=[],this.pick=this.pick.bind(this),this.gpuPicker.on("interactived",this.pick)}},{key:"pick",value:function(){var t;this.options.enableInteractive&&this.options.visible&&(this.gpuPicker.render(this.pickScene,!0),0<(t=this.gpuPicker.pickedId)?(this.inactive(),this.active(t-1,!0),this.actived=!0):(this.inactive(),this.actived&&this.emit("inactive"),this.actived=!1))}},{key:"active",value:function(t){var e,t=this.boardCollection[t]||{},i=t.sprite,t=t.data;i&&t&&(e=this.options.activeColor,i.material.color=s(v.Color,g(y.Chroma(void 0===e?16711680:e).gl())),this.activeSprite=i,this.emit("active",t))}},{key:"inactive",value:function(){this.activeSprite&&(this.activeSprite.material.color=new v.Color(16777215),this.activeSprite=null,this.emit("inactive"))}},{key:"renderPickingSprites",value:function(){var o=this;this.pickSprites.length=0,this.boardCollection.forEach(function(t,n){var t=t.sprite,e=new v.SpriteMaterial,e=(e.onBeforeCompile=function(t){var e=t.uniforms,i=o.gpuPicker.encode(n+1);e.encodedId={value:s(v.Vector3,g(i))},t.fragmentShader="\n          uniform vec3 encodedId;\n\n          void main() {\n            gl_FragColor = vec4(encodedId, 1.0);\n          }\n        "},new v.Sprite(e));e.scale.copy(t.scale),e.position.copy(t.position),o.pickSprites.push(e),o.pickScene.add(e)})}},{key:"setData",value:function(t){return t&&Array.isArray(t)?(this.clean(),Array.isArray(t)&&!t.length?console.log("flyingline layer no data"):(this.data=t,void this.render())):console.log("float board layer no data")}},{key:"render",value:function(){for(var t=this.data,e=0,i=t.length;e<i;e++){var n=t[e],o=this.createBoard(n);this.scene.add(o),this.boardCollection.push({sprite:o,data:n})}this.renderPickingSprites(),this.checkVisible()}},{key:"createBoard",value:function(t){var e=this.options,i=e.opacity,n=e.getLat,o=e.getLng,r=e.getContent,a=e.scale,o=o(t),n=n(t),r=r(t),t=r.width||900,s=r.height||300,l=document.createElement("canvas"),c=l.getContext("2d"),l=(l.width=t,l.height=s,new v.CanvasTexture(l)),i=(l.anisotropy=this.map.renderer.getMaxAnisotropy(),l.minFilter=v.NearestMipmapNearestFilter,l.encoding=v.sRGBEncoding,new v.SpriteMaterial({map:l,opacity:i,transparent:!0,depthTest:!0})),c=(this.drawContent(c,r,l),this.sprite=new v.Sprite(i)),r=(c.renderOrder=1e4+Math.floor(100*Math.random()),c.scale.set(a,a*s/t,1),this.map.Projection(o,n,f+e.height));return c.userData.spherePostion=y.ll2sphere(o,n,f+e.height),c.userData.planePostion=y.ll2plane(o,n,f+e.height),c.position.set(r.x,r.y,r.z),c}},{key:"drawContent",value:function(o,r,a){var s,t,l,e,c,h,p;r.bgImgUrl?(s=this,t=r.bgImgUrl,l=r.width||400,e=r.height||300,c=r.titleFontSize||0,p=l/(h=e-c),(new v.ImageLoader).setCrossOrigin("*").load(t,function(t){var e=t.width,i=t.height,n=e/i;n<p?e=(i=h)*n:i=(e=l)/n,o.drawImage(t,0,c,e,i),s.drawText(o,r,a)})):this.drawText(o,r,a)}},{key:"drawText",value:function(i,t,e){var n=this,o=t.title||"",r=t.content||"",a=t.titleColor||"#FF0000",s=t.contentColor||"#000",l=t.width||400,c=(t.height,t.titleFontSize||0),h=t.contentFontSize||0,p=t.fontFamily||"serif",u=t.paddingLeft||0,d=(t.paddingRight,t.paddingTop||0),f=t.titleLetterSpace||0,v=t.letterSpace||0,t=(i.font=c+"px "+p,i.fillStyle=a,this.drawTextLine(o,0,c,f,i,c,l),i.font="".concat(h,"px ").concat(p),i.fillStyle=s,r.split("\n")),a=Math.max.apply(Math,g(t.map(function(t){return i.measureText(t).width}))),o=Math.round(a/h),y=(0<o&&(a+=(o-1)*v),l<a&&console.log("浮框层：请减小正文单行文字数量、字体大小、字间距或增加整体宽度!"),c+h+d);t.forEach(function(t,e){n.drawTextLine(t,u,h,v,i,y,l),y+=1.2*h}),e.image=i.canvas,e.needsUpdate=!0}},{key:"getContentLength",value:function(t){if("string"!=typeof t)return 0;for(var e=0,i=0,n=t.length;i<n;i++){var o=t[i];this.isChinese(o)?e+=1:e+=.5}return e}},{key:"isChinese",value:function(t){return null!==t.match(/[^\x00-\xff]/gi)}},{key:"drawTextLine",value:function(t,e,i,n,o,r,a){for(var s=t.split(""),l=e,c=!0,h=!0,p=0,u=s.length;p<u;p++){var d=i;this.isChinese(s[p])?(c=!0,h&&(h=!1,p&&(d=.5*i))):(h=!0,c?c=!1:d=.5*i),l+=d,p&&(l+=n),o.fillText(s[p],l,r,a)}}},{key:"updatePostions",value:function(t){var e=t.projType,i=t.index;if(0===e){if(this.boardCollection.length)for(var n=0;n<this.boardCollection.length;n++){var o=this.boardCollection[n].sprite,r=o.userData.spherePostion,a=o.userData.planePostion,s=r.x*i+(1-i)*a.x,l=r.y*i+(1-i)*a.y,r=r.z*i+(1-i)*a.z;o.position.set(s,l,r),this.pickSprites[n].position.set(s,l,r)}}else if(1===e&&this.boardCollection.length)for(var c=0;c<this.boardCollection.length;c++){var h=this.boardCollection[c].sprite,p=h.userData.spherePostion,u=h.userData.planePostion,d=u.x*i+(1-i)*p.x,f=u.y*i+(1-i)*p.y,u=u.z*i+(1-i)*p.z;h.position.set(d,f,u),this.pickSprites[c].position.set(d,f,u)}}},{key:"updateOptions",value:function(t){this.options=y.mergeOptions(this.options,t||{}),this.updateFloatBoard(),this.checkVisible()}},{key:"updateFloatBoard",value:function(){var t=this.options,e=t.scale,i=t.getLat,n=t.getLng,o=t.height,r=t.opacity,a=t.getContent;if(this.boardCollection.length)for(var s=0;s<this.boardCollection.length;s++){var l=this.boardCollection[s].sprite,c=this.boardCollection[s].data,h=a(c),p=h.width||900,h=h.height||300,c=this.map.Projection(n(c),i(c),o+f);l.position.set(c.x,c.y,c.z),l.scale.set(e,e*h/p,1),l.material.opacity=r,l.material.needsUpdate=!0}}},{key:"checkVisible",value:function(){this.options.visible?this.show():this.hide()}},{key:"show",value:function(){if(this.options.visible=!0,this.boardCollection.length)for(var t=0;t<this.boardCollection.length;t++)this.boardCollection[t].sprite.visible=!0}},{key:"hide",value:function(){if(this.options.visible=!1,this.boardCollection.length)for(var t=0;t<this.boardCollection.length;t++)this.boardCollection[t].sprite.visible=!1}},{key:"clean",value:function(){if(this.boardCollection.length){for(var t=0;t<this.boardCollection.length;t++){var e=this.boardCollection[t].sprite;this.scene.remove(e),e.dispose&&e.dispose(),e.material&&e.material.dispose&&e.material.dispose(),this.boardCollection[t].data=null}this.boardCollection=[]}}},{key:"remove",value:function(){this.map.off("projChanged",this.updatePostions),this.clean(),this.data=null}}])&&c(t.prototype,e),i&&c(t,i),Object.defineProperty(t,"prototype",{writable:!1}),o}();return t.exports=i,t.exports});