// env=undefined => env=publish 
Cube("datav:/com/datav-2dmap-text-label/3.0.5/src/label",[],function(t,e,i,o,n,a){function l(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return t.exports=function(t){var e,r=t.map,h=t.L,i=t.Utils,v=(t.GuiUtils,i._,i.Chroma),o=i.RBush,tt=i.measureText,n=i.mergeOptions,s=i.geojsonBBox,S=i.getDashArray,f=r.options.offset;return t=a,(i=[{key:"setData",value:function(t){for(var e,i,o=t.features,n=[],a=0,r=o.length;a<r;a++)e=o[a],i=s(e),n.push({minX:i[0],minY:i[1],maxX:i[2],maxY:i[3],feature:e});this.rbush.dirty=n.length,this.rbush.total=n.length,this.rbush.clear(),0<n.length&&this.rbush.load(n)}},{key:"setOptions",value:function(t){this.options.mappingStyle={},this.options=n(this.options,t);var e,i,o=this.options.mappingStyle,s=this,f=[];for(e in o)(i=o[e]).icon.iconUrl&&f.push(i.icon.iconUrl);f=Array.from(new Set(f)),new Promise(function(e,i){for(var t,o=[],a=f.length,r=0,h=0;h<a;h++)!function(){var n=f[h];t=new Promise(function(i,t){s.imageUrls[n]&&i(!0);var o=new Image;o.crossOrigin="anonymous",o.onload=function(){var t=document.createElement("canvas"),e=t.getContext("2d");t.width=o.width,t.height=o.height,e.imageSmoothingQuality="high",e.drawImage(o,0,0,o.width,o.height),s.imageUrls[n]={canvas:t,colorCanvas:{}},i(!0)},o.onerror=function(){t(new Error("Could not load image at "+n))},o.src=n}),o.push(t),Promise.all(o).then(function(t){++r==a&&e(!0)}).catch(function(t){++r==a&&i(!1)})}()}).then(function(t){t&&s.layer.onRender()}).catch(function(t){})}},{key:"onRender",value:function(t,e){e&&(this.getFeaturesInBounds(),this.getFeatures()),this.draw(t)}},{key:"draw",value:function(t){var e,i=this.options,o=(i.graph,i.label),n=i.mappingStyle,i=o.backgroundStyle;for(t.lineCap="round",e=0;e<this.features.length;e++){var a,r,h,s,f,l,g=n[(a=this.features[e]).properties.data_index];g&&g.line.show&&(r=(g=g.line).endpointOffset,h=g.xScale,g=g.lineStyle,s=S(g.dashArray),t.setLineDash(s),t.beginPath(),t.lineWidth=g.weight,s=g.strokeColor,g=g.weight,(f=document.createElement("canvas")).width=2*g,f.height=2*g,f.style.height=2*g+"px",f.style.height=2*g+"px",(l=f.getContext("2d")).fillStyle=v(s).brighten().css(),l.beginPath(),l.arc(g,g,g,0,2*Math.PI),l.fill(),d=a.geometry._coordinates,t.moveTo(d[0],d[1]),0!=r.offsetX&&0!=r.offsetY&&t.lineTo(d[0]+r.offsetX*(1-.01*h),d[1]-r.offsetY),t.lineTo(d[0]+r.offsetX,d[1]-r.offsetY),t.drawImage(f,d[0]-g,d[1]-g),t.strokeStyle=s,t.stroke())}for(e=0;e<this.features.length;e++){var d,c,u,m,p,w,b=n[(a=this.features[e]).properties.data_index];b&&b.icon.show&&this.imageUrls[b.icon.iconUrl]&&(d=a.geometry._coordinates,c=+b.icon.iconSize.width,u=+b.icon.iconSize.height,m=d[0],p=d[1],w=b.line.endpointOffset,b.line.show?(m+=w.offsetX,p-=w.offsetY,0<w.offsetX?p-=u/2:w.offsetX<0?(m-=c,p-=u/2):0==w.offsetX&&(0<w.offsetY?(m-=c/2,p-=u):w.offsetY<0?m-=c/2:(m-=c/2,p-=u/2))):(m=d[0]-c/2,p=d[1]-u/2),t.drawImage(this.imageUrls[b.icon.iconUrl].canvas,m,p,c,u))}var y,x=this;"vector"===i.backgroundType||x.imageUrls[i.imageUrl]?x.drawLabels(t):"image"!==i.backgroundType||x.imageUrls[i.imageUrl]||(y=[i.imageUrl],new Promise(function(e,i){for(var t,o=[],a=y.length,r=0,h=0;h<a;h++)!function(){var n=y[h];t=new Promise(function(i,t){var o=new Image;o.onload=function(){var t=document.createElement("canvas"),e=t.getContext("2d");t.width=o.width,t.height=o.height,e.drawImage(o,0,0,t.width,t.height),x.imageUrls[n]=t,i(!0)},o.onerror=function(){t(new Error("Could not load image at "+n))},o.src=n}),o.push(t),Promise.all(o).then(function(t){++r==a&&e(!0)}).catch(function(t){++r==a&&i(!1)})}()}).then(function(t){t&&x.layer.onRender()}).catch(function(t){}))}},{key:"drawLabels",value:function(A){for(var t=this.options,t=(t.graph,t.label),e=t.textLabelWidth,i=t.titleStyle,o=t.contentStyle,n=t.backgroundStyle,a=o.lineSeries,r=o.lineHeight,M=(o.textBorder,A.textAlign="left",A.textBaseline="middle",Object.assign({},t.offset),0);M<this.features.length;M++){var h,s=(h=this.features[M]).geometry,f=h.properties;if((h=this.options.mappingStyle[f.data_index])&&(i.show||o.show)){var l=h.line.endpointOffset,g=+h.icon.iconSize.width,d=+h.icon.iconSize.height,s=s._coordinates,c=s[0],s=s[1],u=void 0,m=0,p=0,w=0;if(o.show&&0<a.length)for(var O=0;O<a.length;O++){var b=u=a[O],y=b.content,x=b.prefix,b=b.suffix,v=tt(f[u.fieldName],y.fontFamily,y.fontWeight,y.fontSize).width;switch(e.widthAdapt){case"adapt":v=Math.min(v,e.maxWidth);break;case"fixedWidth":v=e.fixedWidth}p=v+o.background.margin.left+o.background.margin.right,x.show&&(p+=+x.padding+tt(x.name,x.fontFamily,x.fontWeight,x.fontSize).width),b.show&&(p+=+b.padding+tt(b.name,b.fontFamily,b.fontWeight,b.fontSize).width),m=Math.max(p,m),w+=Math.max(x.fontSize,y.fontSize,b.fontSize)}var S={left:0,right:0,top:0,bottom:0},S=n.show?n.margin:{top:0,right:0,bottom:0,left:0},k=document.createElement("canvas"),z=k.getContext("2d"),W=(k.width=200,k.height=200,k.style.width="100px",k.style.height="100px",z.scale(2,2),0),T=0,U=void 0;if(i.show){var F=i.textStyle,I=i.background;if(i.fieldName&&f[i.fieldName]){var U=f[i.fieldName],E=z.measureText(U,F.fontFamily,F.fontWeight,F.fontSize).width;switch(e.widthAdapt){case"adapt":W=Math.min(E,e.maxWidth);break;case"fixedWidth":W=e.fixedWidth}if(W<E){for(var R=0,_=0,N=z.measureText("...",F.fontFamily,F.fontWeight,F.fontSize).width,j=0;j<U.length;j++)(R+=~~z.measureText(U[j],F.fontFamily,F.fontWeight,F.fontSize).width)<W-N&&_++;U=U.substring(0,_)+"..."}}W+=I.margin.left+I.margin.right+z.measureText("..",F.fontFamily,F.fontWeight,F.fontSize).width,T=I.margin.top+I.margin.bottom+F.fontSize}var D,I={width:(m=Math.max(W,m))+S.left+S.right,height:w*r+S.top+S.bottom},B=(o.show&&o.show&&0<a.length&&(I.height+=+o.background.margin.top+o.background.margin.bottom),n.border),C=(I.height+=T,i.show&&o.show&&(I.height+=5),"vector"===n.backgroundType?(k.width=2*(I.width+B.weight),k.height=2*(I.height+B.weight),k.style.width=I.width+B.weight+"px",k.style.height=I.height+B.weight+"px"):"image"==n.backgroundType&&(k.width=2*I.width,k.height=2*I.height,k.style.width=I.width+"px",k.style.height=I.height+"px"),z.scale(2,2),n.show&&("vector"===n.backgroundType?z.roundRect(0,0,I.width,I.height,n):"image"==n.backgroundType&&this.imageUrls[n.imageUrl]&&(z.globalAlpha=.01*n.opacity,z.drawImage(this.imageUrls[n.imageUrl],0,0,I.width,I.height))),z.globalAlpha=1,o.show&&o.show&&0<a.length&&(z.textBaseline="bottom",o.background.background=o.background.backgroundColor,i.show?z.roundRect(S.left,S.top+T+5,m,w*r+o.background.margin.top+o.background.margin.bottom,o.background):z.roundRect(S.left,S.top,m,w*r+o.background.margin.top+o.background.margin.bottom,o.background)),z.textBaseline="top",i.show&&(i.background.background=i.background.backgroundColor,z.roundRect(S.left,S.top,m,i.textStyle.fontSize+i.background.margin.top+i.background.margin.bottom,i.background),i.fieldName&&f[i.fieldName]&&(z.font=i.textStyle.fontWeight+" "+i.textStyle.fontSize+"px "+i.textStyle.fontFamily,z.fillStyle=i.textStyle.color,T=i.background.margin.left+S.left,D=i.background.margin.top+S.top,z.fillText(U,T,D))),z.textBaseline="bottom",S.top+o.background.margin.top);if(i.show&&(C+=i.background.margin.top+i.background.margin.bottom+i.textStyle.fontSize+5),o.show&&0<a.length)for(var G=0;G<a.length;G++){var P=u=a[G],X=P.content,Y=P.prefix,P=P.suffix,H=(C+=Math.max(Y.fontSize,X.fontSize,P.fontSize)*r,Y.show&&(z.font=Y.fontWeight+" "+Y.fontSize+"px "+Y.fontFamily,z.fillStyle=Y.color,z.fillText(Y.name,S.left+o.background.margin.left,C)),z.font=X.fontWeight+" "+X.fontSize+"px "+X.fontFamily,z.fillStyle=X.color,f[u.fieldName]),Q=tt(H,X.fontFamily,X.fontWeight,X.fontSize).width,L=0;switch(e.widthAdapt){case"adapt":L=Math.min(Q,e.maxWidth);break;case"fixedWidth":L=e.fixedWidth}if(L<Q){for(var q=0,J=0,K=z.measureText("...",X.fontFamily,X.fontWeight,X.fontSize).width,V=""+H,Z=0;Z<V.length;Z++)(q+=~~z.measureText(V[Z],X.fontFamily,X.fontWeight,X.fontSize).width)<L-K&&J++;H=V.substring(0,J)+"..."}var $=S.left+o.background.margin.left;Y.show&&($+=Y.padding+tt(Y.name,Y.fontFamily,Y.fontWeight,Y.fontSize).width),z.fillText(H,$,C),P.show&&(z.font=P.fontWeight+" "+P.fontSize+"px "+P.fontFamily,z.fillStyle=P.color,L=Math.min(L,Q),z.fillText(P.name,$+L+P.padding,C))}h&&h.line.show&&(c+=l.offsetX,s-=l.offsetY);h&&h.icon.show&&h.line.show?0<l.offsetX?(c+=2+g,s-=d/2):l.offsetX<0?(c-=g+I.width+2,s-=d/2):0==l.offsetX&&(0<l.offsetY?(c+=g/2,s-=d):l.offsetY<0?c+=g/2:(c+=g/2,s-=d/2),c+=2):h&&h.icon.show&&(c+=g/2+2,s-=d/2),A.drawImage(k,c,s,I.width+B.weight,I.height+B.weight)}}}},{key:"getFeaturesInBounds",value:function(){for(var t=r.options.paddingBoundsExtent,e=this.rbush.search(t),i=0;i<e.length;i++){o=(n=e[i].feature).geometry.coordinates,a=[],"Point"===n.geometry.type&&(o=r.latLngToContainerPoint([o[1],o[0]]))&&(a=[o.x-f.x,o.y-f.y]),e[i].feature.geometry._coordinates=a;var o=n.properties.radius||5,n=h.point(a[0]-o,a[1]+o),a=h.point(a[0]+o,a[1]-o),o=r.containerPointToLatLng(n),n=r.containerPointToLatLng(a);e[i].minX=o.lng,e[i].minY=o.lat,e[i].maxX=n.lng,e[i].maxY=n.lat}this.rbushInBounds.clear(),this.rbushInBounds.load(e),this.featuresInBounds=e}},{key:"getFeatures",value:function(){for(var t=[],e=this.featuresInBounds,i=0;i<e.length;i++){var o=e[i].feature;t.push(o)}return this.features=t,this.features}}])&&l(t.prototype,i),e&&l(t,e),Object.defineProperty(t,"prototype",{writable:!1}),a;function a(t){if(!(this instanceof a))throw new TypeError("Cannot call a class as a function");this.options=n({zIndex:0,tolerance:3,smoothFactor:1,mappingStyle:{}},t),this.rbush=new o,this.rbush.dirty=0,this.rbush.total=0,this.rbushInBounds=new o,this.featuresInBounds=[],this.features=[],this.imageUrls={},this.draw=this.draw.bind(this)}},t.exports});;
Cube("datav:/com/datav-2dmap-text-label/3.0.5/config",[],function(a,e,o,t,n,r){return a.exports={DEFAULT_OPTIONS:{renderer:"canvas",visibility:!0,general:{zoomRange:[0,20],minZoom:0,maxZoom:22,opacity:1},graph:{},label:{}}},a.exports});;
Cube("datav:/com/datav-2dmap-text-label/3.0.5/src/labelLayer",[],function(t,e,p,n,o,r){function i(t){return(i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function a(e,t){var n,o=Object.keys(e);return Object.getOwnPropertySymbols&&(n=Object.getOwnPropertySymbols(e),t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),o.push.apply(o,n)),o}function h(o){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?a(Object(r),!0).forEach(function(t){var e,n;e=o,n=r[t=t],t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n}):Object.getOwnPropertyDescriptors?Object.defineProperties(o,Object.getOwnPropertyDescriptors(r)):a(Object(r)).forEach(function(t){Object.defineProperty(o,t,Object.getOwnPropertyDescriptor(r,t))})}return o}function y(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function b(){return(b="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,n){var o=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=O(t)););return t}(t,e);if(o)return o=Object.getOwnPropertyDescriptor(o,e),o.get?o.get.call(arguments.length<3?t:n):o.value}).apply(this,arguments)}function g(t,e){return(g=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function d(n){var o=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(t){return!1}}();return function(){var t,e=O(n),e=(t=o?(t=O(this).constructor,Reflect.construct(e,arguments,t)):e.apply(this,arguments),this);if(t&&("object"===i(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return v(e)}}function v(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function O(t){return(O=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}return t.exports=function(t){t.L;var n=t.map,e=t.Utils,o=t.Layer,u=t.GuiUtils,f=e._,r=e.arr2geojson,i=e.mergeOptions,a=p("datav:/com/datav-2dmap-text-label/3.0.5/src/label")(t),e=c,t=o;if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&g(e,t);var l,s=d(c);function c(t){var e;if(this instanceof c)return(e=s.call(this)).addTo(n),e.options=i({},t),e.options.general.minZoom=t.general.zoomRange[0],e.options.general.maxZoom=t.general.zoomRange[1],e.options.visibility=!0,e.getMappingStyle=e.getMappingStyle.bind(v(e)),e.init(),e;throw new TypeError("Cannot call a class as a function")}return e=c,(t=[{key:"init",value:function(){this.data=[],this.popups={},this.label=new a(h(h({},this.options),{},{zIndex:0})),(this.label.layer=this).addLayer(this.label)}},{key:"render",value:function(t){if(this.data=[],t&&0<t.length)for(var e=0;e<t.length;e++){var n=t[e];n.data_index=e+1,this.data.push(n)}this.options.mappingStyle=this.getMappingStyle(),this.label.setOptions(this.options);var o=r(this.data);this.label.setData(o),this.onRender(!0)}},{key:"updateOptions",value:function(t){this.options=i(this.options,t),this.options.general.minZoom=t.general.zoomRange[0],this.options.general.maxZoom=t.general.zoomRange[1],this.options.mappingStyle=this.getMappingStyle(),this.label.setOptions(this.options),this.onRender()}},{key:"getMappingStyle",value:function(){for(var t,e,n=this.options.graph,o=this.data,r=u.validateCustomStyle,i=f.get(this.options,"condition.condition"),a={},l=0;l<o.length;l++){var s,c,p={};if((c=r({config:i,data:s=o[l],ruleKey:"rules"}))&&c.length){for(t=c.length-1;0<=t&&(e=c[t]).graph.show;t--)if(e.graph.line.show){p.line=e.graph.line;break}for(t=c.length-1;0<=t&&(e=c[t]).graph.show;t--)if(e.graph.icon.show){p.icon=e.graph.icon;break}}p.hasOwnProperty("line")||(p.line=n.line),p.hasOwnProperty("icon")||(p.icon=n.icon),a[s.data_index]=p}return a}},{key:"draw",value:function(t){var e=this.options.general;t.globalAlpha=.01*e.opacity,this.container&&t.drawImage(this.container,0,0,this.container.width,this.container.height)}},{key:"show",value:function(){this.onRender(!0),this.options.visibility=!0}},{key:"hide",value:function(){b(O(c.prototype),"hide",this).call(this),this.options.visibility=!1}},{key:"destroy",value:function(){this.options=null,this.data=null,this.group=null,delete this.options,this.data,this.group}}])&&y(e.prototype,t),l&&y(e,l),Object.defineProperty(e,"prototype",{writable:!1}),c},t.exports});;
Cube("datav:/com/datav-2dmap-text-label/3.0.5",["datav:/npm/eventemitter3/3.0.0","datav:/npm/safely-merge/1.0.1"],function(e,t,o,r,n,i){function a(e){return(a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function l(e,t){for(var o=0;o<t.length;o++){var r=t[o];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function s(e,t){return(s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function u(o){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=y(o),t=(e=r?(e=y(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),this);if(e&&("object"===a(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");if(void 0!==t)return t;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}}function y(e){return(y=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var c=o("datav:/npm/eventemitter3/3.0.0"),f=o("datav:/npm/safely-merge/1.0.1"),p=o("datav:/com/datav-2dmap-text-label/3.0.5/src/labelLayer"),h=o("datav:/com/datav-2dmap-text-label/3.0.5/config").DEFAULT_OPTIONS,o=function(){var e=n,t=c;if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&s(e,t);var o,r=u(n);function n(e,t){if(!(this instanceof n))throw new TypeError("Cannot call a class as a function");var o=r.call(this),t=t.options;return o.options=f(h,t),o.options.general.minZoom=t.general.zoomRange[0],o.options.general.maxZoom=t.general.zoomRange[1],o.options.visibility=!0,o}return e=n,(t=[{key:"addTo",value:function(e,t){this.options.id=t;t=p(e);return this.layer=new t(this.options),this}},{key:"onRender",value:function(e){this.layer&&this.layer.onRender&&this.layer.onRender(e)}},{key:"resize",value:function(e,t){this.layer&&this.layer.resize&&this.layer.resize(e,t)}},{key:"render",value:function(e){var t=[];if(e&&e.length){for(var o,r=0,n=0;n<e.length;n++)o=e[n],Number.isFinite(parseFloat(o.lng))&&Number.isFinite(parseFloat(o.lat))?t.push(o):r++;0<r&&console.log("信息标签层：有 "+r+" 条异常数据。")}this.layer&&this.layer.render&&this.layer.render(t)}},{key:"updateOptions",value:function(e){e=e.options;this.options=f(this.options,e),this.options.general.minZoom=e.general.zoomRange[0],this.options.general.maxZoom=e.general.zoomRange[1],this.layer&&this.layer.updateOptions&&this.layer.updateOptions(this.options)}},{key:"draw",value:function(e){this.layer&&this.layer.draw&&this.layer.draw(e)}},{key:"show",value:function(){this.options.visibility=!0,this.layer&&this.layer.show&&this.layer.show()}},{key:"hide",value:function(){this.options.visibility=!1,this.layer&&this.layer.hide&&this.layer.hide()}},{key:"destroy",value:function(){this.layer&&this.layer.destroy&&this.layer.destroy(),this.layer=null,delete this.layer}}])&&l(e.prototype,t),o&&l(e,o),Object.defineProperty(e,"prototype",{writable:!1}),n}();return e.exports=o,e.exports});