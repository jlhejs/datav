// env=undefined => env=publish 
Cube("datav:/com/event-dashboard/0.1.11",["datav:/npm/eventemitter3/3.0.0","datav:/npm/safely-merge/1.0.1","datav:/npm/three/0.99.0","datav:/npm/tween.js/16.6.0","datav:/npm/chroma-js/1.3.4"],function(t,e,a,o,i,r){var n=function(t,e,a){return e&&s(t.prototype,e),a&&s(t,a),t};function s(t,e){for(var a=0;a<e.length;a++){var o=e[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}var h=a("datav:/npm/eventemitter3/3.0.0"),w=a("datav:/npm/safely-merge/1.0.1"),C=a("datav:/npm/three/0.99.0"),d=a("datav:/npm/tween.js/16.6.0"),M=a("datav:/npm/chroma-js/1.3.4"),c={},n=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(l,h),n(l,[{key:"init",value:function(){var t=this.container.clientWidth,e=this.container.clientHeight;this.scene=new C.Scene,this.camera=new C.PerspectiveCamera(45,t/e,1,1e5),this.camera.position.z=550,this.canvas=document.createElement("canvas"),this.container.appendChild(this.canvas);var a=this.renderer=new C.WebGLRenderer({canvas:this.canvas,alpha:!0,antialias:!0});a.setClearColor(new C.Color(this.options.backgroundStyle.backgroundColor),M(this.options.backgroundStyle.backgroundColor).alpha()),a.setSize(t,e),this.render=this.render.bind(this),this.onContainerMouseDown=this.onContainerMouseDown.bind(this),this.onContainerMouseMove=this.onContainerMouseMove.bind(this),this.onContainerMouseUp=this.onContainerMouseUp.bind(this),this.onContainerMouseOut=this.onContainerMouseOut.bind(this),this.onContainerTouchStart=this.onContainerTouchStart.bind(this),this.onContainerTouchMove=this.onContainerTouchMove.bind(this)}},{key:"ratioChange",value:function(t){this.scaleX=t.ratioX,this.scaleY=t.ratioY}},{key:"addEventListeners",value:function(){this.container.addEventListener("mousedown",this.onContainerMouseDown,!1),this.container.addEventListener("mousemove",this.onContainerMouseMove,!1),this.container.addEventListener("touchstart",this.onContainerTouchStart,!1),this.container.addEventListener("touchmove",this.onContainerTouchMove,!1)}},{key:"onContainerMouseDown",value:function(t){var e,a,o;this.touchEventState||((e=this.container).addEventListener("mouseup",this.onContainerMouseUp,!1),e.addEventListener("mouseout",this.onContainerMouseOut,!1),o=e.parentNode,a=t.pageX/this.scaleX-o.offsetLeft,o=t.pageY/this.scaleY-o.offsetTop,this.mouseXOnMouseDown=a-e.clientWidth/2,this.mouseYOnMouseDown=o-e.clientHeight/2,this.mouse.x=a/e.clientWidth*2-1,this.mouse.y=2*-(o/e.clientHeight)+1,this.raycaster.setFromCamera(this.mouse,this.camera),o=this.raycaster.intersectObjects(this.objects,!0),this.grabbeddashboard=!1,0<o.length&&("dashboard"!=o[0].object.userData.type&&"dashboard"!=o[0].object.parent.userData.type&&"dashboard"!=o[0].object.parent.parent.userData.type||(this.targetRotationOnMouseDownX=this.targetRotationX,this.grabbeddashboard=!0),"dashboard_hotspot"!=o[0].object.userData.type&&"dashboard_hotspot"!=o[0].object.parent.userData.type||(e.style.cursor="pointer",0<=o[0].object.userData.index&&(this.finishedDrift=!1,this.targetRotationX=-this.getHotSpotRot(o[0].object.userData.index-1)))))}},{key:"onContainerTouchStart",value:function(t){var e,a,o=this.container;this.touchEventState=!0,1==t.touches.length&&(a=o.parentNode,e=t.touches[0].pageX/this.scaleX-a.offsetLeft,a=t.touches[0].pageY/this.scaleY-a.offsetTop,this.mouseXOnMouseDown=e-o.clientWidth/2,this.mouseYOnMouseDown=a-o.clientHeight/2,this.mouse.x=e/o.clientWidth*2-1,this.mouse.y=2*-(a/o.clientHeight)+1,this.raycaster.setFromCamera(this.mouse,this.camera),a=this.raycaster.intersectObjects(this.objects,!0),this.grabbeddashboard=!1,0<a.length&&("dashboard"!=a[0].object.userData.type&&"dashboard"!=a[0].object.parent.userData.type&&"dashboard"!=a[0].object.parent.parent.userData.type||(this.targetRotationOnMouseDownX=this.targetRotationX,this.grabbeddashboard=!0),"dashboard_hotspot"!=a[0].object.userData.type&&"dashboard_hotspot"!=a[0].object.parent.userData.type&&"dashboard_hotspot"!=a[0].object.parent.parent.userData.type||(o.style.cursor="pointer",0<=a[0].object.userData.index&&(this.finishedDrift=!1,this.targetRotationX=-this.getHotSpotRot(a[0].object.userData.index-1)))))}},{key:"onContainerTouchMove",value:function(t){var e,a,o;1==t.touches.length&&(o=(e=this.container).parentNode,a=t.touches[0].pageX/this.scaleX-o.offsetLeft,o=t.touches[0].pageY/this.scaleY-o.offsetTop,this.mouseX=a-e.clientWidth/2,this.mouseY=o-e.clientHeight/2,this.grabbeddashboard&&(this.targetRotationX=this.targetRotationOnMouseDownX+.002*(this.mouseX-this.mouseXOnMouseDown)),this.mouse.x=a/e.clientWidth*2-1,this.mouse.y=2*-(o/e.clientHeight)+1,this.raycaster.setFromCamera(this.mouse,this.camera),o=this.raycaster.intersectObjects(this.objects,!0),e.style.cursor="default",0<o.length&&("dashboard"!=o[0].object.userData.type&&"dashboard"!=o[0].object.parent.userData.type&&"dashboard"!=o[0].object.parent.parent.userData.type||(e.style.cursor="ew-resize"),"dashboard_hotspot"!=o[0].object.userData.type&&"dashboard_hotspot"!=o[0].object.parent.userData.type&&"dashboard_hotspot"!=o[0].object.parent.parent.userData.type||(e.style.cursor="pointer")))}},{key:"onContainerMouseMove",value:function(t){var e,a,o;this.touchEventState||(o=(e=this.container).parentNode,a=t.pageX/this.scaleX-o.offsetLeft,o=t.pageY/this.scaleY-o.offsetTop,this.mouseX=a-e.clientWidth/2,this.mouseY=o-e.clientHeight/2,this.grabbeddashboard&&(this.targetRotationX=this.targetRotationOnMouseDownX+.002*(this.mouseX-this.mouseXOnMouseDown)),this.mouse.x=a/e.clientWidth*2-1,this.mouse.y=2*-(o/e.clientHeight)+1,this.raycaster.setFromCamera(this.mouse,this.camera),o=this.raycaster.intersectObjects(this.objects,!0),e.style.cursor="default",0<o.length&&("dashboard"!=o[0].object.userData.type&&"dashboard"!=o[0].object.parent.userData.type&&"dashboard"!=o[0].object.parent.parent.userData.type||(e.style.cursor="ew-resize"),"dashboard_hotspot"!=o[0].object.userData.type&&"dashboard_hotspot"!=o[0].object.parent.userData.type&&"dashboard_hotspot"!=o[0].object.parent.parent.userData.type||(e.style.cursor="pointer")))}},{key:"onContainerMouseUp",value:function(t){var e=this;this.container.removeEventListener("mouseup",function(){return e.onContainerMouseUp},!1),this.container.removeEventListener("mouseout",function(){return e.onContainerMouseOut},!1),this.container.removeEventListener("touchend",function(){return e.onContainerMouseUp},!1),this.grabbeddashboard&&(this.finishedDrift=!1),this.grabbeddashboard=!1}},{key:"onContainerMouseOut",value:function(t){var e=this;this.container.removeEventListener("mouseup",function(){return e.onContainerMouseUp},!1),this.container.removeEventListener("mouseout",function(){return e.onContainerMouseOut},!1),this.grabbeddashboard&&(this.finishedDrift=!1),this.grabbeddashboard=!1}},{key:"getHotSpotRot",value:function(t){return Math.floor(12*t+6)*(2*Math.PI/360)+90*this.radian}},{key:"addTextAndImage",value:function(t){for(var e=this.dashboard,a=0,o=0;o<360;o++)if((o-36)%12==0&&o<360){var i="",r="";if(!(a<t.length))break;i=t[a].context,r=t[a].url,a++;var n=document.createElement("canvas");n.width=250,n.height=46;var s=n.getContext("2d"),h=this.options.textStyle.fontSize,d=this.options.textStyle.fontWeight,c=this.options.textStyle.fontFamily,l=this.options.textStyle.color;s.font=d+" "+h+"px "+c,s.textAlign="center",s.textBaseline="bottom",s.fillStyle=l,s.fillText(i,n.width/2,n.height-h/2);h=new C.Texture(n);h.needsUpdate=!0,h.wrapS=h.wrapT=C.RepeatWrapping,h.repeat.set(1,1);n=new C.PlaneGeometry(25,4.5,1,1);n.computeBoundingBox(),n.center();h=new C.Mesh(n,new C.MeshBasicMaterial({map:h,transparent:!0,side:C.DoubleSide,opacity:1}));h.position.x=(this.radius+2)*Math.cos(this.radian*(o+6)),h.position.z=(this.radius+2)*Math.sin(this.radian*(o+6)),h.position.y=.85,h.scale.set(1,1,1),h.lookAt(new C.Vector3(0,2e4,0)),h.dashboardType="context",h.textValue=i,h.userData={type:"dashboard_hotspot",index:a},e.dial.add(h);h=new C.PlaneGeometry(this.options.imageStyle.imageWidth,this.options.imageStyle.imageHeight,1,1),r=new C.MeshBasicMaterial({map:(new C.TextureLoader).load(r),transparent:!0,name:"url",opacity:this.options.imageOpacity}),r=new C.Mesh(h,r);r.position.x=(this.radius-4)*Math.cos(this.radian*(o+6)),r.position.z=(this.radius-4)*Math.sin(this.radian*(o+6)),r.position.y=0,r.lookAt(new C.Vector3(0,2e4,0)),r.dashboardType="image",r.userData={type:"dashboard_hotspot",index:a},e.dial.add(r)}}},{key:"addCircle",value:function(){var t=new C.CylinderGeometry(this.radius+9,this.radius+9,1,200,2,!0),e=this.options.backgroundStyle.circleOuterColor,a=new C.MeshBasicMaterial({transparent:!0,color:new C.Color(e),opacity:M(e).alpha(),side:C.DoubleSide}),e=new C.Mesh(t,a);e.dashboardType="circleOuter",this.dashboard.outerDial.add(e);t=new C.CylinderGeometry(this.radius+4,this.radius+8,1,200,2,!0),e=this.options.backgroundStyle.circleCenterColor,a=new C.MeshBasicMaterial({transparent:!0,color:new C.Color(e),opacity:M(e).alpha(),side:C.DoubleSide}),e=new C.Mesh(t,a);e.dashboardType="circleCenter",this.dashboard.outerDial.add(e),t=new C.CylinderGeometry(this.radius-6.5,this.radius-7,1,200,2,!0);e=this.options.backgroundStyle.circleInnerColor;a=new C.MeshBasicMaterial({transparent:!0,color:new C.Color(e),opacity:M(e).alpha(),side:C.DoubleSide});a=new C.Mesh(t,a);a.dashboardType="circleInner",this.dashboard.outerDial.add(a)}},{key:"addGraduation",value:function(){for(var t,e,a=new C.Geometry,o=new C.Geometry,i=new C.Geometry,r=this.options.backgroundStyle.graduationOuterColor,n=new C.LineBasicMaterial({linewidth:1,transparent:!0,color:new C.Color(r),opacity:M(r).alpha()}),r=this.options.backgroundStyle.graduationInnerColor,r=new C.LineBasicMaterial({linewidth:1,transparent:!0,color:new C.Color(r),opacity:M(r).alpha()}),s=0,h=0;h<360;h++)h%4==0&&(t=(this.radius+9)*Math.cos(this.radian*h),e=(this.radius+9)*Math.sin(this.radian*h),a.vertices.push(new C.Vector3(1.02*t,0,1.02*e)),a.vertices.push(new C.Vector3(t,0,e)));for(var d=0;d<360;d++){var c=this.radius*Math.cos(this.radian*d),l=this.radius*Math.sin(this.radian*d);if((d-36)%12!=0&&(o.vertices.push(new C.Vector3(.985*c,0,.985*l)),o.vertices.push(new C.Vector3(c,0,l))),(d-36)%12==0&&d<360){if(i.vertices.push(new C.Vector3(.96*c,0,.96*l)),i.vertices.push(new C.Vector3(c,0,l)),!(s<this.data.length))break;s++}}n=new C.LineSegments(a,n);n.dashboardType="graduationOuter",this.dashboard.outerDial.add(n);n=new C.LineSegments(o,r);n.dashboardType="graduationInner",this.dashboard.dial.add(n);r=new C.LineSegments(i,r);r.dashboardType="graduationInner",this.dashboard.dial.add(r)}},{key:"addArrow",value:function(){var t=new C.Shape;t.moveTo(-1.5,1),t.lineTo(0,-1.8),t.lineTo(1.5,1),t.lineTo(-1.5,1);var e=new C.ShapeGeometry(t),a=this.options.backgroundStyle.arrowColor,t=M(a).get("rgba.a"),a=new C.MeshBasicMaterial({transparent:!0,opacity:t,color:new C.Color(a),side:C.DoubleSide}),a=new C.Mesh(e,a);a.position.y=this.radius-9,a.rotation.z=180*this.radian,a.position.z-=4,a.dashboardType="arrow",this.dashboard.pointer.add(a),this.dashboard.pointer.rotation.x=-90*this.radian}},{key:"render",value:function(){var t,e=this;this.requestAnimationFrame=window.requestAnimationFrame(this.render),this.dashboard&&(!this.grabbeddashboard&&this.finishedDrift||(this.dashboard.dial.rotation.y+=.05*(-this.targetRotationX-this.dashboard.dial.rotation.y),this.finishedDrift||Math.abs(.05*(-this.targetRotationX-this.dashboard.dial.rotation.y))<1e-5&&(this.finishedDrift=!0,-1<=(t=Math.floor((this.dashboard.dial.rotation.y/this.radian-90)/12))&&this.data&&this.data.length&&t<=this.data.length&&(-1==t?t+=1:t==this.data.length&&--t,t=this.data[t],this.emit("dashboard-click",t),this.touchEventState&&(this.touchEventState=!1,this.container.addEventListener("touchend",function(){return e.onContainerMouseUp},!1))))),-this.targetRotationX<this.minRot&&(this.targetRotationX=-this.minRot),-this.targetRotationX>this.maxRot&&(this.targetRotationX=-this.maxRot),this.dashboard.outerDial.rotation.y=.5*this.dashboard.dial.rotation.y,this.dashboard.position.x=0,this.dashboard.position.y=-117,this.dashboard.position.z=507,this.dashboard.rotation.x=90*this.radian,this.dashboard.rotation.y=0,this.dashboard.rotation.z=0),d.update(),this.renderer.render(this.scene,this.camera)}},{key:"resize",value:function(t,e){this.renderer.setSize(t,e),this.camera.aspect=t/e,this.camera.updateProjectionMatrix()}},{key:"setData",value:function(t){t&&t.length&&(this.data=t,this.dashboard&&(this.scene.remove(this.dashboard),this.removeDashboard()),this.objects=[],(t=this.dashboard=new C.Object3D).dial=new C.Object3D,t.outerDial=new C.Object3D,t.pointer=new C.Object3D,t.add(t.dial),t.add(t.outerDial),t.add(t.pointer),t.position.y=-117,t.position.z=507,t.userData={type:"dashboard"},this.objects.push(t),this.scene.add(this.dashboard),this.maxRot=this.minRot+12*this.data.length*this.radian,this.addCircle(),this.addGraduation(),this.addArrow(),this.addTextAndImage(this.data),this.setIndex(Math.floor(this.data.length/2)),this.render(),this.addEventListeners())}},{key:"setIndex",value:function(t){var e=this,a={val:this.dashboard.dial.rotation.y},t=this.radian*(96+12*t);new d.Tween(a).to({val:t},1e3).easing(d.Easing.Linear.None).onStart(function(){}).onComplete(function(){}).onUpdate(function(){e.dashboard.dial.rotation.y=a.val,e.dashboard.outerDial.rotation.y=a.val}).start()}},{key:"updateOptions",value:function(t){var e=Object.assign({},this.options);this.options=w(this.options,t||{}),e.backgroundStyle.backgroundColor!=this.options.backgroundStyle.backgroundColor&&this.renderer.setClearColor(new C.Color(this.options.backgroundStyle.backgroundColor),M(this.options.backgroundStyle.backgroundColor).alpha());for(var a=this.dashboard.dial,o=0;o<a.children.length;o++){var i,r=a.children[o];if(r.dashboardType){switch(r.dashboardType){case"context":var n=document.createElement("canvas");n.width=250,n.height=46;var s=n.getContext("2d"),h=this.options.textStyle.fontSize,d=this.options.textStyle.fontWeight,c=this.options.textStyle.fontFamily,l=this.options.textStyle.color;s.font=d+" "+h+"px "+c,s.textAlign="center",s.textBaseline="bottom",s.fillStyle=l,s.fillText(r.textValue,n.width/2,n.height/2+h/2+5);n=new C.Texture(n);n.needsUpdate=!0,n.wrapS=n.wrapT=C.RepeatWrapping,n.repeat.set(1,1),a.children[o].material.map=n;break;case"image":e.imageStyle.imageWidth==this.options.imageStyle.imageWidth&&e.imageStyle.imageHeight==this.options.imageStyle.imageHeight||(i=new C.PlaneGeometry(this.options.imageStyle.imageWidth,this.options.imageStyle.imageHeight,1,1),a.children[o].geometry.dispose(),a.children[o].geometry=i),e.imageStyle.imageOpacity!=this.options.imageStyle.imageOpacity&&(a.children[o].material.opacity=this.options.imageStyle.imageOpacity);break;case"graduationInner":e.backgroundStyle.graduationInnerColor!=this.options.backgroundStyle.graduationInnerColor&&(i=this.options.backgroundStyle.graduationInnerColor,a.children[o].material.color=new C.Color(i),a.children[o].material.opacity=M(i).alpha())}a.children[o].material.needsUpdate=!0}}for(var u=this.dashboard.outerDial,p=0;p<u.children.length;p++){var b,y,m=u.children[p];if(m.dashboardType){switch(m.dashboardType){case"circleOuter":e.backgroundStyle.circleOuterColor!=this.options.backgroundStyle.circleOuterColor&&(b=this.options.backgroundStyle.circleOuterColor,u.children[p].material.color=new C.Color(b),u.children[p].material.opacity=M(b).alpha());break;case"circleCenter":e.backgroundStyle.circleCenterColor!=this.options.backgroundStyle.circleCenterColor&&(b=this.options.backgroundStyle.circleCenterColor,u.children[p].material.color=new C.Color(b),u.children[p].material.opacity=M(b).alpha());break;case"circleInner":e.backgroundStyle.circleInnerColor!=this.options.backgroundStyle.circleInnerColor&&(y=this.options.backgroundStyle.circleInnerColor,u.children[p].material.color=new C.Color(y),u.children[p].material.opacity=M(y).alpha());break;case"graduationOuter":e.backgroundStyle.graduationOuterColor!=this.options.backgroundStyle.graduationOuterColor&&(y=this.options.backgroundStyle.graduationOuterColor,u.children[p].material.color=new C.Color(y),u.children[p].material.opacity=M(y).alpha())}u.children[p].material.needsUpdate=!0}}for(var g=this.dashboard.pointer,v=0;v<g.children.length;v++){var f=g.children[v];f.dashboardType&&"arrow"==f.dashboardType&&e.backgroundStyle.arrowColor!=this.options.backgroundStyle.arrowColor&&(f=this.options.backgroundStyle.arrowColor,g.children[v].material.color=new C.Color(f),g.children[v].material.opacity=M(f).alpha(),g.children[v].material.needsUpdate=!0)}}},{key:"removeDashboard",value:function(){this.dashboard&&this.scene.remove(this.dashboard);for(var t=0;t<this.dashboard.dial.children.length;t++)this.dashboard.dial.children[t].geometry.dispose(),this.dashboard.dial.children[t].material.dispose();for(var e=0;e<this.dashboard.outerDial.children.length;e++)this.dashboard.outerDial.children[e].geometry.dispose(),this.dashboard.outerDial.children[e].material.dispose();for(var a=0;a<this.dashboard.pointer.children.length;a++)this.dashboard.pointer.children[a].geometry.dispose(),this.dashboard.pointer.children[a].material.dispose();this.dashboard=null}},{key:"remove",value:function(){this.requestAnimationFrame&&window.cancelAnimationFrame(this.requestAnimationFrame),this.onContainerMouseDown&&this.container.removeEventListener("mousedown",this.onContainerMouseDown,!1),this.onContainerTouchStar&&this.container.removeEventListener("touchstart",this.onContainerTouchStar,!1),this.onContainerTouchMove&&this.container.removeEventListener("touchmove",this.onContainerTouchMove,!1),this.onContainerMouseMove&&this.container.removeEventListener("mousemove",this.onContainerMouseMove,!1),this.removeDashboard(this.dashboard),this.camera.dispose(),this.renderer.dispose(),this.scene.dispose(),this.camera=null,this.renderer=null,this.scene=null,this.objects=[],this.canvas=null}}]),l);function l(t,e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,l);var a=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(l.__proto__||Object.getPrototypeOf(l)).call(this));return a.options=w(c,e),a.container="string"==typeof t?document.querySelector(t):t,a.mouseX=0,a.mouseY=0,a.mouseXOnMouseDown=0,a.mouseYOnMouseDown=0,a.radius=120,a.radian=Math.PI/180,a.targetRotationX=-90*a.radian,a.targetRotationOnMouseDownX=0,a.minRot=90*a.radian,a.maxRot=360*a.radian,a.dashboard=null,a.hotspot=null,a.raycaster=new C.Raycaster,a.mouse=new C.Vector2,a.objects=[],a.grabbeddashboard=!1,a.finishedDrift=!0,a.scaleX=a.scaleY=1,a.ratioChange=a.ratioChange.bind(a),window.share.event&&window.share.event.on("ratio-change",a.ratioChange.bind(a)),a.touchEventState=!1,a.init(),a}return t.exports=n,t.exports});