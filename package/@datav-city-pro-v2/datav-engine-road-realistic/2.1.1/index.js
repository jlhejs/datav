// env=undefined => env=publish 
Cube("datav:/com/@datav-city-pro-v2/datav-engine-road-realistic/2.1.1",["datav:/npm/eventemitter3/3.0.0"],function(n,r,i,e,t,a){function d(e){return(d="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}return function(e,t){"object"==(void 0===r?"undefined":d(r))&&"object"==(void 0===n?"undefined":d(n))?n.exports=t(i("datav:/npm/eventemitter3/3.0.0")):"function"==typeof define&&define.amd?define(["eventemitter3"],t):"object"==(void 0===r?"undefined":d(r))?r.Chart=t(i("datav:/npm/eventemitter3/3.0.0")):e.Chart=t(e.eventemitter3)}(window,function(n){return function(n){var r={};function i(e){if(r[e])return r[e].exports;var t=r[e]={i:e,l:!1,exports:{}};return n[e].call(t.exports,t,t.exports,i),t.l=!0,t.exports}return i.m=n,i.c=r,i.d=function(e,t,n){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==d(t)&&t&&t.__esModule)return t;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)i.d(n,r,function(e){return t[e]}.bind(null,r));return n},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=1)}([function(e,t){e.exports=function(e){var n=[[],[],[],[],[],[]],r=[[],[],[],[],[],[]],i=[];return[e.matL,e.matJ,e.matS].forEach(function(e){i.push(e.uvScale.x,e.uvScale.y),n[0].push(e.map),r[0].push(e.color),n[1].push(e.normalMap),r[1].push("rgb(255, 255, 255)"),n[2].push(e.emissiveMap),r[2].push(e.emissive);var t=parseInt(255*e.aoMapIntensity,10);n[3].push(e.aoMap),r[3].push("rgb(".concat(t,", ").concat(t,", ").concat(t,")")),n[4].push(e.roughnessMap),t=parseInt(255*e.roughness,10),r[4].push("rgb(".concat(t,", ").concat(t,", ").concat(t,")")),n[5].push(e.metalnessMap),t=parseInt(255*e.metalness,10),r[5].push("rgb(".concat(t,", ").concat(t,", ").concat(t,")"))}),{imageUrlArr:n,pbrMatCoeffArr:r,uvScaleData:i}}},function(e,t,n){function i(e){return(i="function"==typeof Symbol&&"symbol"==d(Symbol.iterator)?function(e){return d(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":d(e)})(e)}function a(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function o(e,t){return(o=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function s(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=l(n);return function(e,t){if(t&&("object"===i(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}(this,r?(e=l(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))}}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var u=n(2),c=n(3),p=n(0),n=function(){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&o(e,t)}(i,u);var e,t,r=s(i);function i(e,t){var n;return function(e){if(!(e instanceof i))throw new TypeError("Cannot call a class as a function")}(this),(n=r.call(this)).options=t,n.visible=!0,n.comId="",n.type="RoadRS",n.isBasicFeature=!0,n}return t=[{key:"editBeforePublish",value:function(e,t,n){var s=e.componentData,l=n.UI,e=s.config.options.graphic,n=p(e),e=(n.vtbuffer=e.vtbuffer,i.pack(t,n));return e.then(function(e){if(e.isError||!e.data||!e.data.url)return Promise.reject(new Error(e.message));l.Notify.success("".concat(s.alias," 材质打包成功"));var t=JSON.parse(JSON.stringify(s.config)),n=t.sceneId,t=t.options,r=t.general,i=t.graphic,a=t.model,t=t.interaction,o=i.vtbuffer,i=i.matSW;return o.url=e.data.url,{config:{sceneId:n,options:{general:r,graphic:{matSW:i,vtbuffer:o},model:a,interaction:t}}}})}},{key:"pack",value:function(e,t){return fetch(e.staticPackingEndpoint,{method:"POST",headers:{"content-type":"application/json","X-Auth-Token":"datav","xsrf-token":e.csrf,"from-app":e.fromApp},body:JSON.stringify({comConfig:t})}).then(function(e){return e.json()})}}],a((e=i).prototype,[{key:"addTo",value:function(e,t){return this.cityproCore=e,this.comId=t,this.initLayer()}},{key:"setEnvMap",value:function(e){this.layer&&(this.layer.envMapIntensity=e.properties,this.layer.envMap=e.value)}},{key:"initLayer",value:function(){var t=this,e=c(this.cityproCore);this.layer=new e(this.options),this.cityproCore.viewer.addLayer(this.comId,this.layer),this.visible?this.layer.show():this.layer.hide(),this.layer.on("rendered",function(){t.emit("rendered","道路L2渲染完成")}),this.layer.on("leftClick",function(e){t.emit("leftClick",e)})}},{key:"setData",value:function(e){var t=this;this.layer&&(e instanceof ArrayBuffer?this.layer.setData(e):e&&e.url&&""!==e.url&&(this.layer.hide(),fetch(e.url,{headers:{"accept-encoding":"deflate,gzip"}}).then(function(e){return e.arrayBuffer()}).then(function(e){t.layer&&(t.visible?t.layer.show():t.layer.hide(),t.layer.setData(e))})))}},{key:"errorRender",value:function(){console.log("道路L2组件数据错误"),this.layer&&this.layer.dataErrorHandler()}},{key:"updateEmissiveIntensity",value:function(e){this.layer&&(this.layer.emissiveIntensity=e)}},{key:"emissiveIntensityInOption",value:function(){return this.layer.getEmissiveIntensityInOption()}},{key:"updateOptions",value:function(e){this.layer&&this.layer.updateOptions&&this.layer.updateOptions(e)}},{key:"show",value:function(){this.visible=!0,this.layer&&this.layer.show()}},{key:"hide",value:function(){this.visible=!1,this.layer&&this.layer.hide()}},{key:"destroy",value:function(){this.layer&&(this.layer.destroy&&this.layer.destroy(),this.layer=null)}}]),a(e,t),Object.defineProperty(e,"prototype",{writable:!1}),i}();e.exports=n},function(e,t){e.exports=n},function(e,t,r){function i(e){return(i="function"==typeof Symbol&&"symbol"==d(Symbol.iterator)?function(e){return d(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":d(e)})(e)}function h(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function y(){return(y="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=b(e)););return e}(e,t);if(r)return(r=Object.getOwnPropertyDescriptor(r,t)).get?r.get.call(arguments.length<3?e:n):r.value}).apply(this,arguments)}function m(e,t){return(m=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function v(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=b(n);return function(e,t){if(t&&("object"===i(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}(this,r?(e=b(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))}}function b(e){return(b=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var M=r(4),S=r(5);e.exports=function(e){var a=e.VG,t=e.THREE,o=e.Utils,n=t.Mesh,s=t.Group,l=t.PlaneBufferGeometry,e=t.TextureLoader,u=t.RepeatWrapping,c=t.sRGBEncoding,p=r(6)(a),f=r(0),d=new e;return d.setCrossOrigin("anonymous"),function(){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&m(e,t)}(i,a.CityBaseLayer);var e,r=v(i);function i(e){!function(e){if(!(e instanceof i))throw new TypeError("Cannot call a class as a function")}(this),(t=r.call(this,"RoadRSLayer")).options=Object.assign({isSceneGroup:!1,sceneId:["scene1"]},e||{});var t,e=t.options.options,n=e.graphic,e=e.interaction,n=n.vtbuffer;return t.resolution.set(256*Math.pow(2,n.resExp),256*Math.pow(2,n.resExp),n.styleNum),t.allowGPUPicking=e.enableInteractive,t}return h((e=i).prototype,[{key:"getEmissiveIntensityInOption",value:function(){return this.options.options.general.light.emissiveIntensity}},{key:"initialize",value:function(){this.emitWorldVaried=this.emitWorldVaried.bind(this);var e=new l(1,1),t=(e.rotateX(.5*-Math.PI),this.sideWalkAsset=new s,this.sideWalkMaterial=new a.CustomMeshStandardMaterial,this.sideWalkCustomGBufferMaterial=a.getGBufferMaterial(this.sideWalkMaterial),this.sideWalkMaterial.vertexShader),t=(this.sideWalkMaterial.vertexShader=t.replace("#include <project_vertex>",M),t=this.sideWalkCustomGBufferMaterial.vertexShader,this.sideWalkCustomGBufferMaterial.vertexShader=t.replace("#include <dp/gbuffer_instanced_vertex>  ",S),new n(e,this.sideWalkMaterial));t.customGBufferMaterial=this.sideWalkCustomGBufferMaterial,this.sideWalkAsset.add(t),y(b(i.prototype),"initialize",this).call(this),this.hismAssets.canCastShadow=!0,this.hismAssets.canReceiveShadow=!1}},{key:"setData",value:function(e){this.setMeshBuffer(e),this.updateSideWalk(),this.emitWorldVaried(),this.resolve(),this.emit("rendered")}},{key:"dataErrorHandler",value:function(){this.needsWait&&(this.needsWait=!1),this.emit("rendered")}},{key:"emitWorldVaried",value:function(){this.viewer.onWorldVaried()}},{key:"updateSideWalk",value:function(){this.disposeHISMAssets("sidewalk");var e,t=this.hismData.get("0");t&&0<t.length&&((e=new p(this.center)).parseData(this.sideWalkAsset,t,12),e.group.renderOrder=1,this.hismAssets.set("sidewalk",e),this.envMap=this.material.envMap,this.updateEnvMapIntensity(),this.updateShadow(),this.add(e.group))}},{key:"updateHISMAssets",value:function(r){var i=this;this.options.options.model.asset.forEach(function(t,e){var n,e=r?r.asset[e]:null;e&&JSON.stringify(e)===JSON.stringify(t)||(n=i.hismData.get(t.type))&&(i.disposeHISMAssets(t.type),i.emitWorldVaried(),t.url&&0<n.length&&i.fetchModel(t.url).then(function(e){i.addHISMAsset(t.type,e,n,t.scale.x,t.scale.y,t.scale.z),i.emitWorldVaried()}))})}},{key:"updateMaterialRuntime",value:function(e){var t=this;fetch(e.vtbuffer.url,{headers:{"accept-encoding":"deflate,gzip"}}).then(function(e){return e.arrayBuffer()}).then(function(e){t.setVTBuffer(e),t.emitWorldVaried()})}},{key:"updateMaterialEditor",value:function(e){var e=f(e),t=e.uvScaleData,n=e.imageUrlArr,e=e.pbrMatCoeffArr;this.updateVT(t,n,e,this.emitWorldVaried)}},{key:"updateMaterial",value:function(e){var t;this.updateLight(),this.material&&(""!==(t=this.options.options.graphic).vtbuffer.url?this.updateMaterialRuntime(t):this.updateMaterialEditor(t),this.updateSideWalkMaterial(e,t))}},{key:"updateSideWalkMaterial",value:function(e,t){var n;this.sideWalkMaterial&&(n=o.Chroma(t.matSW.color).gl(),this.sideWalkMaterial.opacity=t.matSW.opacity,this.sideWalkMaterial.color.setRGB(n[0],n[1],n[2]),this.sideWalkMaterial.roughness=t.matSW.roughness,this.sideWalkMaterial.metalness=t.matSW.metalness,this.sideWalkMaterial.aoMapIntensity=t.matSW.aoMapIntensity,e&&e.matSW.map!==t.matSW.map&&(o.disposeTexture(this.sideWalkMaterial.map),this.sideWalkMaterial.map=null),e&&e.matSW.roughnessMap!==t.matSW.roughnessMap&&(o.disposeTexture(this.sideWalkMaterial.roughnessMap),this.sideWalkMaterial.roughnessMap=null),e&&e.matSW.metalnessMap!==t.matSW.metalnessMap&&(o.disposeTexture(this.sideWalkMaterial.metalnessMap),this.sideWalkMaterial.metalnessMap=null),e&&e.matSW.normalMap!==t.matSW.normalMap&&(o.disposeTexture(this.sideWalkMaterial.ormalMap),this.sideWalkMaterial.normalMap=null),e&&e.matSW.aoMap!==t.matSW.aoMap&&(o.disposeTexture(this.sideWalkMaterial.aoMap),this.sideWalkMaterial.aoMap=null),t.matSW.map&&((n=d.load(t.matSW.map,this.emitWorldVaried)).repeat.copy(t.matSW.uvScale),n.encoding=c,n.wrapS=u,n.wrapT=u,this.sideWalkMaterial.map=n),t.matSW.roughnessMap&&((e=d.load(t.matSW.roughnessMap,this.emitWorldVaried)).repeat.copy(t.matSW.uvScale),e.wrapS=u,e.wrapT=u,this.sideWalkMaterial.roughnessMap=e),t.matSW.metalnessMap&&((n=d.load(t.matSW.metalnessMap,this.emitWorldVaried)).repeat.copy(t.matSW.uvScale),n.wrapS=u,n.wrapT=u,this.sideWalkMaterial.metalnessMap=n),t.matSW.normalMap&&((e=d.load(t.matSW.normalMap,this.emitWorldVaried)).repeat.copy(t.matSW.uvScale),e.wrapS=u,e.wrapT=u,this.sideWalkMaterial.normalMap=e),t.matSW.aoMap&&((n=d.load(t.matSW.aoMap,this.emitWorldVaried)).repeat.copy(t.matSW.uvScale),n.wrapS=u,n.wrapT=u,this.sideWalkMaterial.aoMap=n),a.updateGBufferMaterial(this.sideWalkMaterial,this.sideWalkCustomGBufferMaterial),this.sideWalkCustomGBufferMaterial.needsUpdate=!0,this.sideWalkMaterial.needsUpdate=!0,this.emitWorldVaried())}},{key:"updateShadow",value:function(){this.mesh&&(this.mesh.canCastShadow=!0,this.mesh.canReceiveShadow=!0);var e=this.options.options.general;this.castShadow=e.shadow.castShadow,this.receiveShadow=e.shadow.receiveShadow,this.emitWorldVaried()}},{key:"updateLight",value:function(){var e=this.options.options.general;this.envMapIntensityFactor=e.light.envMapIntensityFactor,this.emissiveIntensity=e.light.emissiveIntensity,this.emitWorldVaried()}},{key:"updateOptions",value:function(e){var t=o.deepClone(this.options),e=(this.options=o.mergeOptions(this.options,e||{}),e=this.options.options,this.updateMaterial(t.options.graphic),this.updateHISMAssets(t.options.model),this.updateShadow(),o.easyDiff(t.sceneId.length,this.options.sceneId.length)&&o.deepDiff(t.sceneId,this.options.sceneId)||this.updateSceneId(),this.options.options.interaction);this.allowGPUPicking=e.enableInteractive}},{key:"disposeMaterial",value:function(){y(b(i.prototype),"disposeMaterial",this).call(this),this.sideWalkMaterial&&(this.sideWalkMaterial.dispose(),o.disposeTexture(this.sideWalkMaterial.map),o.disposeTexture(this.sideWalkMaterial.roughnessMap),o.disposeTexture(this.sideWalkMaterial.metalnessMap),o.disposeTexture(this.sideWalkMaterial.ormalMap),o.disposeTexture(this.sideWalkMaterial.aoMap),this.sideWalkMaterial.dispose())}}]),Object.defineProperty(e,"prototype",{writable:!1}),i}()}},function(e,t){e.exports="#define GLSLIFY 1\n#define GLSLIFY 1\nvec4 mvPosition = vec4( transformed, 1.0 );\n\n#ifdef USE_INSTANCING\n\n\tfloat vScalar = instanceMatrix[3][3];\n\n  mat4 mat = instanceMatrix;\n\n  mat[3][3] = 1.0;\n  \n\tmvPosition = mat * mvPosition;\n\n  #ifdef USE_UV\n\n\t  vUv.y *= vScalar * 0.4;\n\n  #endif\n\n#endif\n\nmvPosition = modelViewMatrix * mvPosition;\n\ngl_Position = projectionMatrix * mvPosition;"},function(e,t){e.exports="#define GLSLIFY 1\n#define GLSLIFY 1\n#ifdef USE_INSTANCING\n\n\tfloat vScalar = instanceMatrix[3][3];\n\n  mat4 mat = instanceMatrix;\n\n  mat[3][3] = 1.0;\n  \n\tmvPosition = mat * mvPosition;\n\n  #ifdef USE_UV\n\n\t  vUv.y *= vScalar * 0.4;\n\n  #endif\n\n#endif"},function(e,t){function i(e){return(i="function"==typeof Symbol&&"symbol"==d(Symbol.iterator)?function(e){return d(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":d(e)})(e)}function c(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function p(e,t){return(p=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function f(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=a(n);return function(e,t){if(t&&("object"===i(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}(this,r?(e=a(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))}}function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}e.exports=function(r){var e=r.THREE,t=e.Vector3,e=e.Matrix4,a=new t,o=new t,s=new t,l=new e,u=new e;return function(){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&p(e,t)}(n,r.CityBaseAsset);var e,t=f(n);function n(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,n),t.apply(this,arguments)}return c((e=n).prototype,[{key:"computeIMatrix",value:function(e,t){var n=e[t+3],r=e[t+4],i=e[t+5];return s.fromArray(e,t+6),o.fromArray(e,t+9),a.crossVectors(o,s).normalize(),u.makeBasis(a,o,s),u.setPosition(n,r,i),l.makeScale(e[t+2],1,e[t]),l.premultiply(u),l.elements[12]-=this.center.x,l.elements[13]-=this.center.y,l.elements[14]-=this.center.z,l.elements[15]=e[t],l}}]),Object.defineProperty(e,"prototype",{writable:!1}),n}()}}])}),n.exports});