// env=undefined => env=publish 
Cube("datav:/com/datavmap-2d-layer-drill/0.4.23/ChinaDrillLayer.js",["datav:/com/datavmap-2d-layer-area/0.2.26","datav:/npm/topojson-client/3.0.0"],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"===typeof b||"function"===typeof b)?b:a}function f(a,b){if("function"!==typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=c("datav:/npm/topojson-client/3.0.0"),i=c("datav:/com/datavmap-2d-layer-area/0.2.26");return a.exports=function(a){var b=a.datavUtils,c=a.BaseLayer,j=a.DomEvent,k={pane:"fillPane",opacity:1,dblClickZoomPad:1.5,isOpenPopup:!0};return function(a){function c(a){d(this,c);var f=e(this,(c.__proto__||Object.getPrototypeOf(c)).call(this));return f.ondblclick=f.ondblclick.bind(f),a=b.mergeOptions(k,a),f.options=b.mergeOptions(f.options,a),f.options.visibility=!0,f.alltopo={},f}return f(c,a),g(c,[{key:"init",value:function(){var a=this;this.data=null;var b=document.createElement("div"),c=this.area=new i(b,this.options);c.addTo(this.map),c.layer.on("click",function(b){a.options.visibility&&a.emit("click",b)}),this.isFirstLoaded=!0}},{key:"setDefalutArea",value:function(a){a&&a[0]&&a[0].adcode&&(this.adcode=a[0].adcode),this.isFirstLoaded?this.isFirstLoaded=!1:(this.geojson=this.getGeojson(this.adcode),this.area.layer.setGeojson(this.geojson),this.setData(this.data||[]),this.fitBounds())}},{key:"setCustomAreaData",value:function(a){var b=this;if(a&&a[0]&&a[0].area_tree&&a[0].area_topo_json){this.keyword="area_id",this.geojson_keyword="adcode";var c=a[0].area_tree,d=a[0].area_topo_json;fetch(c).then(function(a){return a.json()}).then(function(a){b.area_tree=a,b.area_tree_map={},b.initAreaTreeMap(b.area_tree,b.adcode),fetch(d).then(function(a){return a.json()}).then(function(a){b.alltopo=a,b.renderer=b.area.layer.renderer,b.geojson=b.getGeojson(b.adcode),b.area.layer.setGeojson(b.geojson),b.setData(b.data||[]),b.fitBounds(),b.map.on("dblclick",b.ondblclick)})})}}},{key:"getGeojson",value:function(a){var b=this,c=h.feature(this.alltopo[a],this.alltopo[a].objects.collection);return c.features=c.features.filter(function(a){var c=!0;return"district"===a.properties.level&&(c=!(""+a.properties.adcode).endsWith("00")),a.geometry&&("Polygon"===a.geometry.type||"MultiPolygon"===a.geometry.type)&&a.properties.adcode!=b.adcode&&c}),c}},{key:"ondblclick",value:function(a){if(this.options.visibility){this.map.getContainer().style.pointerEvents="none";var b=this.renderer._drawnLayers,c=null;Object.keys(b).some(function(d){if(b[d]._containsPoint(a.layerPoint))return c=b[d].feature,!0});var d;if(c){var e=c.properties[this.geojson_keyword]||c.properties[this.keyword];if(d=this.area_tree_map[e],null==e||!d||0==d.childrenNum)return this.map.getContainer().style.pointerEvents="auto",void this.emit("dblclick",c.properties);this.adcode=e}else{if(this.parentId=this.area_tree_map[this.adcode].parent,!this.parentId)return void(this.map.getContainer().style.pointerEvents="auto");d=this.area_tree_map[this.adcode],this.adcode=d.parent}if(this.geojson=this.getGeojson(this.adcode),this.area&&this.geojson)this.area.layer.setGeojson(this.geojson),this.setData(this.data||[]);else return;if(this.parentId=this.adcode,this.fitBounds(),c)this.emit("dblclick",c.properties);else{var f=this.options.interactive["dblclick-key"]||"adcode",g={};g[f]=this.adcode,this.emit("dblclick",g)}}}},{key:"setData",value:function(a){var b=this;this.data=a||[];var c=[];this.geojson&&this.geojson.features.map(function(b){for(var c=0;c<a.length;c++)if(b.properties.adcode==a[c].area_id&&a[c].customLabelPosition&&a[c].customLabelPosition[0]&&a[c].customLabelPosition[1])return b.properties.customLabelPosition=a[c].customLabelPosition,b}),this.geojson&&this.geojson.features.map(function(d){function e(a,b,c){for(var d,g=0;g<a.length&&!f;g++)if(d=a[g],d&&d[c])if(d[c]==b){f=d;break}else if(d.children)e(d.children,b,c);else continue;return f}var f=null;f=Object.assign({},e(b.area_tree,d.properties[b.geojson_keyword],b.keyword));var g=0,h=void 0;a.some(function(a){function d(b,c){if(b.children&&0<b.children.length)for(var e,f=0;f<b.children.length;f++)e=b.children[f],a[c]==e[c]?g+=a.value:d(e,c)}return a[b.keyword]==f[b.keyword]?(c.push(a),!1):void(d(f,b.keyword),h=Object.assign({},a))}),0<g&&(h[b.keyword]=d.properties[b.geojson_keyword],h.value=g,c.push(h))}),this.area&&this.area.layer&&(this.area.layer.setData(c),this.area.layer.render())}},{key:"onUpdateOptions",value:function(a){this.area&&this.area.updateOptions(a)}},{key:"remove",value:function(){this.map.off("dblclick",this.ondblclick,this),this.area&&this.area.remove()}},{key:"show",value:function(){this.options.visibility=!0,this.area&&this.area.layer.show()}},{key:"hide",value:function(){this.options.visibility=!1,this.area&&this.area.layer.hide()}},{key:"getIndex",value:function(){this.area&&this.area.layer.getIndex()}},{key:"setZIndex",value:function(){this.area&&this.area.layer.setZIndex()}},{key:"fitBounds",value:function(){var a=this;this.map.isFly=!0,this.map.flyToBounds(this.area.layer.geojsonLayer.getBounds().pad(this.options.interactive.dblClickZoomPad-1),{duration:0.5}),setTimeout(function(){a.map.getContainer().style.pointerEvents="auto"},500)}},{key:"initAreaTreeMap",value:function(a,b){for(var c=0;c<a.length;c++){var d=a[c],e=b;d[this.keyword]==b&&(e=null);var f=0;d.children&&0<d.children.length&&(f=d.children.length),this.area_tree_map[d[this.keyword]]={parent:e,childrenNum:f,value:0},d.children&&this.initAreaTreeMap(d.children,d[this.keyword])}}}]),c}(c)},a.exports});;
Cube("datav:/com/datavmap-2d-layer-drill/0.4.23",["datav:/npm/bcore/0.0.21/event"],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"===typeof b||"function"===typeof b)?b:a}function f(a,b){if("function"!==typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=c("datav:/npm/bcore/0.0.21/event"),i=c("datav:/com/datavmap-2d-layer-drill/0.4.23/ChinaDrillLayer.js"),j=void 0,k={},l=function(a){function b(a,c){d(this,b);var f=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return f.container="string"===typeof a?document.querySelector(a):a,f.apis=c.apis,f.map=null,f._data=null,f.config=c,f.config.visibility=!0,f.config.isOpenPopup=!0,f.isDblclick=!1,f}return f(b,a),g(b,[{key:"init",value:function(){var a=this,b=this.getOptions(),c=i(this.map.L);this.layer=new c(b),this.layer.addTo(this.map),this.layer.on("dblclick",function(b){if(a.config.visibility){a.isDblclick=!0;var c=a.getOptions();a.emit("drill-map-dblclick",b),""!==c.interactive["dblclick-key"]&&a.emit("global_var",c.interactive["dblclick-key"],b[c.interactive["click-key"]]||b.adcode)}}),this.layer.on("click",function(b){a.config.visibility&&(setTimeout(function(){if(!a.isDblclick){var c=a.getOptions();a.emit("drill-map-click",b),""!==c.interactive["click-key"]&&a.emit("global_var",c.interactive["click-key"],b[c.interactive["click-key"]]||b.adcode)}},300),setTimeout(function(){a.isDblclick=!1},500))})}},{key:"addTo",value:function(a){this.map=a,j=a.L.datavUtils,this.init()}},{key:"getOptions",value:function(){var a=this.config=j&&j.mergeOptions(k,this.config);return a}},{key:"show",value:function(){this.config.visibility=!0,this.layer&&this.layer.show&&this.layer.show()}},{key:"hide",value:function(){this.config.visibility=!1,this.layer&&this.layer.hide&&this.layer.hide()}},{key:"remove",value:function(){this.layer&&this.layer.remove&&this.layer.remove(),this.layer=null,this._data=null}},{key:"setDefalutArea",value:function(a){this.layer&&this.layer.setDefalutArea(a)}},{key:"setCustomAreaData",value:function(a){this.layer&&this.layer.setCustomAreaData(a)}},{key:"setData",value:function(a){this.layer&&this.layer.setData(a)}},{key:"updateOptions",value:function(a){this.config=j.mergeOptions(this.config,a),a=this.getOptions(),this.layer&&this.layer.updateOptions(a)}}]),b}(h);return a.exports=l,a.exports});