// env=undefined => env=publish 
Cube("datav:/com/map3d-earth-bar-3d/0.1.9/shader/frag.glsl",[],function(a){return a.exports="#define GLSLIFY 1\nuniform float uOpacity;\nvarying vec3 vColor;\n\nvoid main() {\n  gl_FragColor = vec4(vColor, uOpacity);\n}",a.exports});;
Cube("datav:/com/map3d-earth-bar-3d/0.1.9/shader/vert.glsl",[],function(a){return a.exports="#define GLSLIFY 1\nattribute vec3 plane_position;\nattribute vec3 sphere_position;\nattribute vec3 color;\n\nuniform float u_proj_type;\nuniform float u_ease_index;\n\nvarying vec2 vUv;\nvarying vec3 vColor;\n\nvec3 real_position() {\n  if(u_proj_type == 0.){\n    return mix(plane_position, sphere_position, u_ease_index);\n  } else if(u_proj_type == 1.){\n    return mix(sphere_position, plane_position, u_ease_index);\n  } else {\n    return vec3(0);\n  }\n}\n\nvoid main() {\n  vUv  = uv;\n  vColor = color;\n  gl_Position = projectionMatrix * modelViewMatrix * vec4( real_position(), 1.0 );\n}",a.exports});;
Cube("datav:/com/map3d-earth-bar-3d/0.1.9",["datav:/npm/eventemitter3/2.0.3","datav:/npm/safely-merge/1.0.1","datav:/npm/chroma-js/1.3.4"],function(a,b,f){function c(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function d(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"===typeof b||"function"===typeof b)?b:a}function e(a,b){if("function"!==typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=null,i=f("datav:/npm/eventemitter3/2.0.3"),j=f("datav:/npm/safely-merge/1.0.1"),k=f("datav:/npm/chroma-js/1.3.4"),l={visible:!0,style:{radiusTop:0.5,radiusBottom:0.5,edges:6,minFillColor:"green",maxFillColor:"yellow",fillColor:"gray",fillColorNumber:6,opacity:1,heightScale:1}},m=function(a){function b(a,e){c(this,b);var f=d(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return f.options=j(l,e),f}return e(b,a),g(b,[{key:"addTo",value:function(a){return a?void(h=a.THREE,this.Utils=a.Utils,this.map=a,this.scene=a.scene,this.initEvent()):console.log("barline layer needs map layer")}},{key:"initEvent",value:function(){this.map.on("projChanged",this.updatePostions.bind(this))}},{key:"setData",value:function(a){this.cleanComByEmptyArray(),a&&Array.isArray(a)&&(this._data=a,this.render())}},{key:"cleanComByEmptyArray",value:function(a){a&&Array.isArray(a)&&!a.length&&(this._data=null,this.hide())}},{key:"render",value:function(){this.material&&this.material.dispose&&this.material.dispose(),this.mesh&&this.scene.remove(this.mesh);for(var a,b=this._data,d=[],g=0;g<b.length;g++)a=b[g],a.value&&d.push(a.value);var i=this.options.style.fillColorMode,l=this.options.style.fillColorNumber,m=this.options.style.minFillColor,n=this.options.style.maxFillColor;this.range=this.getRange();for(var o,p=k.scale([m,n]).mode(i).colors(l),q=[],r=[],s=0;s<l;s++){o=new h.Geometry,q.push(o);var t=new h.Geometry;r.push(t)}var u=!this.options.style.isRadiusTopOpen,v=this.options.style.radiusTop,w=this.options.style.radiusBottom,x=this.options.style.edges,y=this.options.style.heightScale,z=this.options.style.angles,A=200,B=new h.CylinderGeometry(w,v,1,x,1,u);B.rotateY(z*Math.PI/180),B.rotateX(Math.PI/2);var C=new h.Mesh(B);C.renderOrder=5e3+Math.round(100*Math.random()),C.frustumCulled=!1;var D=new h.CylinderGeometry(v,w,1,x,1,u);D.rotateY(z*Math.PI/180),D.rotateX(Math.PI/2);var E=new h.Mesh(D);E.renderOrder=5e3+Math.round(100*Math.random()),E.frustumCulled=!1;for(var F,G=0;G<b.length;G++)if(F=b[G],F.value){var H=F.value*A/6371*y,I=this.Utils.ll2sphere(+F.lng,+F.lat,A+H/2);C.position.x=I.x,C.position.y=I.y,C.position.z=I.z,C.scale.z=H,C.lookAt(new h.Vector3),C.updateMatrix();var e=this.Utils.ll2plane(+F.lng,+F.lat,200);E.position.x=e.x,E.position.y=e.y,E.position.z=e.z+H/2,E.scale.z=H,E.updateMatrix();var J=(this.range[1]-this.range[0])/l,K=Math.floor(+(F.value-this.range[0])/J);0<=K&&K<=l&&(K==l&&(K-=1),q[K].merge(C.geometry,C.matrix),r[K].merge(E.geometry,E.matrix))}for(var L,M=[],N=[],O=[],P=[],Q=[],R=0;R<q.length;R++){L=R,L>=l-1&&(L=l-1);var S=new h.BufferGeometry;if(S.fromGeometry(q[R]),!!S.attributes.color){for(var T=new h.Color(p[R]),c=0;c<S.attributes.color.count;c++)M.push(T.r,T.g,T.b);for(var j=0;j<S.attributes.normal.array.length;j++)N.push(S.attributes.normal.array[j]);for(var U=0;U<S.attributes.position.array.length;U++)O.push(S.attributes.position.array[U]);for(var V=0;V<S.attributes.uv.array.length;V++)Q.push(S.attributes.uv.array[V]);var W=new h.BufferGeometry;W.fromGeometry(r[R]);for(var X=0;X<W.attributes.position.array.length;X++)P.push(W.attributes.position.array[X])}}var Y=new h.BufferGeometry;Y.addAttribute("position",new h.Float32BufferAttribute(O,3).setDynamic(!0)),Y.addAttribute("sphere_position",new h.Float32BufferAttribute(O,3).setDynamic(!0)),Y.addAttribute("plane_position",new h.Float32BufferAttribute(P,3).setDynamic(!0)),Y.addAttribute("normal",new h.Float32BufferAttribute(N,3)),Y.addAttribute("color",new h.Float32BufferAttribute(M,3)),Y.addAttribute("uv",new h.Float32BufferAttribute(Q,2));var Z=this.material=new h.ShaderMaterial({uniforms:{uOpacity:{type:"f",value:this.options.style.opacity},u_ease_index:{value:1},u_proj_type:{value:this.map.projType}},vertexShader:f("datav:/com/map3d-earth-bar-3d/0.1.9/shader/vert.glsl"),fragmentShader:f("datav:/com/map3d-earth-bar-3d/0.1.9/shader/frag.glsl"),side:h.DoubleSide,blending:h.NormalBlending,depthTest:!0,depthWrite:!1,transparent:!0});this.material.needsUpdate=!0;var $=this.mesh=new h.Mesh(Y,Z);$.renderOrder=5e3+Math.round(100*Math.random()),this.scene.add($),this.checkVisible()}},{key:"checkVisible",value:function(){var a=this.options;a.visible?this.show():this.hide()}},{key:"getRange",value:function(){if(!this._data.length)return null;var a=this._data.filter(function(a){return void 0!=a.value&&!isNaN(+a.value)&&""!==a.value});if(2>a.length)return null;var b=a.reduce(function(c,a){return+c.value<=+a.value?c:a},{}),c=a.reduce(function(c,a){return+c.value>=+a.value?c:a},{});return[+b.value,+c.value]}},{key:"hide",value:function(){this.options.visible=!1,this.mesh&&(this.mesh.visible=!1)}},{key:"show",value:function(){this.options.visible=!0,this.mesh&&(this.mesh.visible=!0)}},{key:"getColor",value:function(a){var b=this.options.barline,c=void 0;return c=this.colorSeries[a]?this.colorSeries[a]:b.defaulColor,c}},{key:"updatePostions",value:function(a){var b=a.projType,c=a.index;this.material&&(this.material.uniforms.u_ease_index.value=c,this.material.uniforms.u_proj_type.value=b)}},{key:"updateOptions",value:function(a){this.options=j(this.options,a||{}),this._data&&this._data.length&&this.render()}},{key:"checkVisible",value:function(){var a=this.options;a.visible?this.show():this.hide()}},{key:"remove",value:function(){this.material&&this.material.dispose&&this.material.dispose(),this.mesh&&this.scene.remove(this.mesh),this.map.off("projChanged",this.updatePostions)}}]),b}(i);return a.exports=m,a.exports});