// env=undefined => env=publish 
Cube("datav:/com/@datav-3d-v3/datav-3dplane-scatter-image/3.1.4/src/dataprocess/canvasTexture",[],function(t,e,i,o,a,h){function O(t,e,i,o){return n.font="".concat(i," ").concat(o,"px ").concat(e),{width:Math.ceil(n.measureText(t).width),height:o}}var n=document.createElement("canvas").getContext("2d"),R=Math.max(devicePixelRatio,2);return t.exports={getLabelTexture:function(t){var e=t.properties,i=t.labelStyle,t=t.imageUrls,o=i.contentStyle,a=i.backgroundStyle,h=o.lineSeries,n=o.fieldWidth,d=o.lineHeight,l=o.textBorder,o=document.createElement("canvas");if(o.width=0,(o.height=0)!=h.length){for(var f=h[0].content,r=h[0].fieldName,g=(Object.assign({},i.offset),e[r],O(e[r]).width,f.fontSize,0),m=0,s=0,c=0;c<h.length;c++){var w,x=w=h[c],p=x.content,y=x.prefix,x=x.suffix,u=p.fontSize*R,T=y.fontSize*R,W=x.fontSize*R,v=O(e[w.fieldName],p.fontFamily,p.fontWeight,u).width;switch(n.widthAdapt){case"adapt":v=Math.min(v,n.maxWidth);break;case"fixedWidth":v=n.fixedWidth}m=v,y.show&&(m+=+y.padding+O(y.name,y.fontFamily,y.fontWeight,T).width),x.show&&(m+=+x.padding+O(x.name,x.fontFamily,x.fontWeight,W).width),g=Math.max(m,g),s+=Math.max(T,u,W)}for(var b={left:0,right:0,top:0,bottom:0},i={width:g+(b=a.show?a.margin:b).left+b.right,height:s*d+b.top+b.bottom},r=a.border,S=("vector"===a.backgroundType?(o.width=2*(i.width+r.weight),o.height=2*(i.height+r.weight),o.style.width=i.width+r.weight+"px",o.style.height=i.height+r.weight+"px"):"image"==a.backgroundType&&(o.width=2*i.width,o.height=2*i.height,o.style.width=i.width+"px",o.style.height=i.height+"px"),o.getContext("2d")),k=(S.imageSmoothingQuality="high",a.show&&("vector"===a.backgroundType?S.roundRect(0,0,i.width,i.height,a):"image"==a.backgroundType&&t[a.imageUrl]&&S.drawImage(t[a.imageUrl],0,0,i.width,i.height)),S.strokeStyle=l.color,S.lineWidth=l.weight,S.textBaseline="bottom",b.top),c=0;c<h.length;c++){var F=w=h[c],M=F.content,z=F.prefix,F=F.suffix,u=M.fontSize*R,T=z.fontSize*R,W=F.fontSize*R,N=(k+=Math.max(T,u,W)*d,O(e[w.fieldName],M.fontFamily,M.fontWeight,u).width,z.show&&(S.font=z.fontWeight+" "+T+"px "+z.fontFamily,S.fillStyle=z.color,l.show&&S.strokeText(z.name,b.left,k),S.fillText(z.name,b.left,k)),S.font=M.fontWeight+" "+u+"px "+M.fontFamily,S.fillStyle=M.color,e[w.fieldName]),C=O(N,M.fontFamily,M.fontWeight,u).width,v=0;switch(n.widthAdapt){case"adapt":v=Math.min(C,n.maxWidth);break;case"fixedWidth":v=n.fixedWidth}if(v<C){for(var P=0,U=0,A=S.measureText("...",M.fontFamily,M.fontWeight,u).width,B=0;B<N.length;B++)(P+=S.measureText(N[B],M.fontFamily,M.fontWeight,u).width)<v-A&&U++;N=N.substring(0,U)+"..."}var E=b.left;z.show&&(E+=z.padding+O(z.name,z.fontFamily,z.fontWeight,T).width),l.show&&S.strokeText(N,E,k),S.fillText(N,E,k),F.show&&(S.font=F.fontWeight+" "+W+"px "+F.fontFamily,S.fillStyle=F.color,v=Math.min(v,C),l.show&&S.strokeText(F.name,E+v+F.padding,k),S.fillText(F.name,E+v+F.padding,k))}}return o},drawOuterline:function(t,e,i,o,a,h,n){t.beginPath(),t.moveTo(e+h/2,i+h/2),t.lineTo(e+o-h/2,i+h/2),t.lineTo(e+o-h/2,i+a-h/2),t.lineTo(e+h/2,i+a-h/2),t.lineTo(e+h/2,i),t.closePath(),t.lineWidth=h,t.strokeStyle=n,t.lineJoin="round",t.stroke()}},t.exports});;
Cube("datav:/com/@datav-3d-v3/datav-3dplane-scatter-image/3.1.4/src/scatterImageLayer.js",[],function(t,e,a,r,i,n){function o(t){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function P(t){return function(t){if(Array.isArray(t))return s(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||function(t,e){var r;if(t)return"string"==typeof t?s(t,e):"Map"===(r="Object"===(r=Object.prototype.toString.call(t).slice(8,-1))&&t.constructor?t.constructor.name:r)||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?s(t,e):void 0}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function s(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,i=new Array(e);r<e;r++)i[r]=t[r];return i}function l(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function c(){return(c="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(t,e,r){var i=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=d(t)););return t}(t,e);if(i)return(i=Object.getOwnPropertyDescriptor(i,e)).get?i.get.call(arguments.length<3?t:r):i.value}).apply(this,arguments)}function h(t,e){return(h=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t})(t,e)}function u(r){var i=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(t){return!1}}();return function(){var t,e=d(r),e=(t=i?(t=d(this).constructor,Reflect.construct(e,arguments,t)):e.apply(this,arguments),this);if(t&&("object"===o(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return p(e)}}function p(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function d(t){return(d=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}var T=Math.max(devicePixelRatio,2);return t.exports=function(S){var k=S.THREE,t=S.Utils,g=S.GuiUtils,y=t._,O=t.mergeOptions,m=t.BASE_HEIGHT_SCALE,t=a("datav:/com/@datav-3d-v3/datav-3dplane-scatter-image/3.1.4/src/dataprocess/canvasTexture"),U=t.getLabelTexture,x=t.drawOuterline,j=.36/T,t=S.Layer,e=n;if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&h(e,t);var r,i=u(n);function n(t){var e;if(this instanceof n)return(e=i.call(this)).options=O(e.options,{visible:!0,renderOrder:500}),e.options=O(e.options,t||{}),e.renderQueue=S.VOGO.geometry,e.needsAutoUpdate=!1,e.group.renderOrder=e.options.renderOrder,e.eventsType={click:!0},e.selectFeatures=[],e.draw=e.draw.bind(p(e)),e.getMappingData=e.getMappingData.bind(p(e)),e.drawMarkers=e.drawMarkers.bind(p(e)),e.checkVisible=e.checkVisible.bind(p(e)),e.min=-1/0,e.max=1/0,e.data=[],e.mappingData={},e.imageUrls={},e;throw new TypeError("Cannot call a class as a function")}return e=n,(t=[{key:"onClick",value:function(t){this.options.interaction.graph.multiSelection||this.deSelect(),this.selectFeatures.push(t.userData),this.emit("click",this.selectFeatures),this.draw()}},{key:"deSelect",value:function(){this.selectFeatures=[];var t=this.options.label;t.isShow&&"all"==t.eventType||this.draw()}},{key:"render",value:function(t){if(this.data=[],t&&0<t.length)for(var e=0;e<t.length;e++){var r,i=t[e];i.hasOwnProperty("lng")&&i.hasOwnProperty("lat")&&(r=S.proj.proj([+i.lng,+i.lat,0]),i.xyz=[~~r[0],~~r[1],0],this.data.push(i))}for(var n=0;n<this.data.length;n++)this.data[n].data_index=n;this.draw()}},{key:"draw",value:function(){var o=this,t=o.options.label;this.mappingData=this.getMappingData();var e,r,s=[];for(e in this.mappingData)(r=this.mappingData[e]).iconUrl&&s.push(r.iconUrl);"image"!==t.backgroundStyle.backgroundType||o.imageUrls[t.backgroundStyle.imageUrl]||s.push(t.backgroundStyle.imageUrl),s=Array.from(new Set(s)),new Promise(function(e,r){for(var t,i=[],n=s.length,a=0;a<n;a++)!function(){var n=s[a];t=new Promise(function(r,t){o.imageUrls[n]&&r(!0);var i=new Image;i.crossOrigin="anonymous",i.onload=function(){var t=document.createElement("canvas"),e=t.getContext("2d");t.width=i.width,t.height=i.height,e.imageSmoothingQuality="high",e.drawImage(i,0,0,i.width,i.height),o.imageUrls[n]=t,r(!0)},i.onerror=function(){t(new Error("Could not load image at "+n))},i.src=n}),i.push(t)}();Promise.all(i).then(function(t){e(!0)}).catch(function(t){r(!1)})}).then(function(t){t&&o.drawMarkers()}).catch(function(t){})}},{key:"drawMarkers",value:function(){this.clear();var t,e=this.options,r=e.general,i=e.label,n=e.interaction,a=e.renderOrder,o=n.graph.clickStyle,s=.01*r.opacity,l=!1;for(t in this.mappingData){var c=this.mappingData[t],h=document.createElement("canvas"),u=h.getContext("2d");u.imageSmoothingQuality="high";var p=c.iconSize,d=this.mappingData[c.data_index].iconUrl,f=p.width*T,p=p.height*T,g=f,y=p,l=!1;if(n.graph.show&&o.show)for(var m=0;m<this.selectFeatures.length;m++)if(this.selectFeatures[m].data_index==c.data_index){l=!0;break}var v,w=void 0,b=void 0,b=i.isShow&&("all"==i.eventType||l&&"click"==i.eventType)?(0<(v=U({properties:c,labelStyle:i,imageUrls:this.imageUrls})).width&&0<v.height&&(g=Math.max(v.width/2,f),y=v.height/2+p),h.width=g,h.height=y,h.style.width=g+"px",h.style.height=y+"px",0<v.width&&0<v.height&&u.drawImage(v,(g-v.width/2)/2,0),w=(g-f)/2,v.height/2):(h.width=g,h.height=y,h.style.width=g+"px",h.style.height=y+"px",w=0),g=(this.imageUrls[d]&&(v=this.imageUrls[d],u.drawImage(v,w,b,f,p)),l&&x(u,w,b,f,p,o.weight,o.strokeColor),new k.CanvasTexture(h)),y=(g.minFilter=k.LinearFilter,g.wrapS=g.wrapT=k.MirroredRepeatWrapping,g.repeat.set(1,1),g.anisotropy=16,g.needsUpdate=!0,new k.SpriteMaterial({map:g,opacity:s,transparent:!0,depthWrite:!0,depthTest:!0,sizeAttenuation:!1,alphaTest:.05})),d=new k.Sprite(y),p=(d.center.set(.5,0),(u=d.position).set.apply(u,P(c.xyz)),j/(null!=(f=null==(w=S.constants)||null==(b=w.size)?void 0:b.height)?f:S.container.clientHeight)),g=h.width*p,y=h.height*p;d.scale.set(g,y,1),d.userData=O(c,{isBar:!0,isClick:!0}),this.add(d),d.renderOrder=a}this.checkVisible()}},{key:"getMappingData",value:function(){for(var t,e,r,i=this.options.graph,n=S.baseHeightScale,a=S.drawScale,o=(this.group.position.z=~~(a*m*n),~~(a*m*.04)),s=this.data,l=g.validateCustomStyle,c=y.get(this.options,"condition.condition"),h=y.get(g,"scale.marker")({config:y.get(this.options,"graph.iconUrlMapping"),data:s,field:"iconField"}),u={},p=0;p<s.length;p++){var d,f={};if((d=s[p]).iconUrl&&(f.iconUrl=d.iconUrl),(r=l({config:c,data:d,ruleKey:"rules"}))&&r.length){if(!f.iconUrl)for(t=r.length-1;0<=t&&(e=r[t]).graph.show;t--)if(e.graph.iconUrl.show){f.iconUrl=e.graph.iconUrl.value;break}for(t=r.length-1;0<=t&&(e=r[t]).graph.show;t--)if(e.graph.iconSize.show){f.iconSize=e.graph.iconSize;break}}f.hasOwnProperty("iconUrl")||(f.iconUrl=h(d.iconField)),f.hasOwnProperty("iconSize")||(f.iconSize=i.iconSize),d.xyz[2]=o,u[d.data_index]=O(d,f)}return u}},{key:"updateOptions",value:function(t){this.options=O(this.options,t||{}),this.draw()}},{key:"updateBaseHeight",value:function(){var t=S.baseHeightScale,e=S.drawScale;this.group.position.z=~~(e*t*m)}},{key:"checkVisible",value:function(){var t=this.options.visible;c(d(n.prototype),t?"show":"hide",this).call(this)}},{key:"show",value:function(){this.options.visible=!0,c(d(n.prototype),"show",this).call(this)}},{key:"hide",value:function(){this.options.visible=!1,c(d(n.prototype),"hide",this).call(this)}},{key:"destroy",value:function(){c(d(n.prototype),"remove",this).call(this),this.clear(),this.min=null,this.max=null,this.data=null,this.options=null,this.imageUrls=null}}])&&l(e.prototype,t),r&&l(e,r),Object.defineProperty(e,"prototype",{writable:!1}),n},t.exports});;
Cube("datav:/com/@datav-3d-v3/datav-3dplane-scatter-image/3.1.4",["datav:/npm/eventemitter3/3.0.0","datav:/npm/safely-merge/1.0.1"],function(t,e,r,n,o,i){function a(t){return(a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function s(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function l(t,e){return(l=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t})(t,e)}function u(r){var n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(t){return!1}}();return function(){var t,e=y(r),e=(t=n?(t=y(this).constructor,Reflect.construct(e,arguments,t)):e.apply(this,arguments),this);if(t&&("object"===a(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return c(e)}}function c(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function y(t){return(y=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}var f=r("datav:/npm/eventemitter3/3.0.0"),p=r("datav:/npm/safely-merge/1.0.1"),h=r("datav:/com/@datav-3d-v3/datav-3dplane-scatter-image/3.1.4/src/scatterImageLayer.js"),r=function(){var t=o,e=f;if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&l(t,e);var r,n=u(o);function o(t,e){var r;if(this instanceof o)return(r=n.call(this)).classNameAlias="ScatterImageLayer",r.options=p({},e.options||{}),r.visible=!0,r.updateArea&&r.updateArea.bind(c(r)),r;throw new TypeError("Cannot call a class as a function")}return t=o,(e=[{key:"addTo",value:function(t,e){var r=this,e=(this.layerId=e,h(t));this.layer=new e(this.options),t.addLayer(this.layerId+"_layer",this.layer),this.visible?this.layer.show():this.layer.hide(),this.layer.on("click",function(t){r.emit("click",t)})}},{key:"updateArea",value:function(){this.data&&this.render(this.data)}},{key:"render",value:function(t){var e=[],r=0;if(t&&t.length){for(var n,o=0;o<t.length;o++)n=t[o],Number.isFinite(parseFloat(n.lng))&&Number.isFinite(parseFloat(n.lat))?e.push(n):r++;0<r&&console.log("二维图标层：有 "+r+" 条异常数据。")}this.data=e,this.layer&&this.layer.render&&this.layer.render(e)}},{key:"updateOptions",value:function(t){this.options=p(this.options,t.options),this.layer&&this.layer.updateOptions&&this.layer.updateOptions(this.options)}},{key:"updateBaseHeight",value:function(){this.layer&&this.layer.updateBaseHeight&&this.layer.updateBaseHeight()}},{key:"show",value:function(){this.visible=!0,this.layer&&this.layer.show()}},{key:"hide",value:function(){this.visible=!1,this.layer&&this.layer.hide()}},{key:"destroy",value:function(){this.layer&&(this.layer.destroy(),this.layer=null)}}])&&s(t.prototype,e),r&&s(t,r),Object.defineProperty(t,"prototype",{writable:!1}),o}();return t.exports=r,t.exports});