// env=undefined => env=publish 
Cube("datav:/com/datavmap-canvas2d-image/2.0.28/src/imageLayer",["datav:/npm/eventemitter3/3.0.0","datav:/npm/safely-merge/1.0.1"],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"===typeof b||"function"===typeof b)?b:a}function f(a,b){if("function"!==typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=c("datav:/npm/eventemitter3/3.0.0"),i=c("datav:/npm/safely-merge/1.0.1"),j=function(a){function b(a,c){d(this,b);var f=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return f.options=i({zoomRange:[0,18],minZoom:0,maxZoom:22,defaultStyle:{imageUrl:{type:"image",name:"\u56FE\u7247\u8DEF\u5F84",default:"https://img.alicdn.com/tps/TB1guWTPVXXXXXCaXXXXXXXXXXX-3840-2160.jpg"},opacity:1,bounds:{minX:85,minY:10,maxX:140,maxY:45}}},c),f.options.minZoom=c.zoomRange[0],f.options.maxZoom=c.zoomRange[1],f.options.visibility=!0,f.map=a,f.init(),f}return f(b,a),g(b,[{key:"init",value:function(){this.container=document.createElement("canvas");var a=this.padding=this.map.canvasLayer&&this.map.canvasLayer.options&&this.map.canvasLayer.options.padding?this.map.canvasLayer.options.padding:0.1,b=this.map.getSize();this.offset=b.multiplyBy(-a).round();var c=b.x-2*this.offset.x,d=b.y-2*this.offset.y,e=this.map.devicePixelRatio||1;this.container.width=c*e,this.container.height=d*e,this.container.style.width=c+"px",this.container.style.height=d+"px",this.ctx=this.container.getContext("2d"),this.ctx.imageSmoothingQuality="high",this.ctx.scale(e,e),this.imageIndex=0,this._data=[]}},{key:"onRender",value:function(){this.ctx.clearRect(0,0,this.container.width,this.container.height),this.data&&this.data.length&&this.draw()}},{key:"onResize",value:function(a,b){var c=this.map.devicePixelRatio||1;this.container.width=a*c,this.container.height=b*c,this.container.style.width=a+"px",this.container.style.height=b+"px",this.ctx.imageSmoothingQuality="high",this.ctx.scale(c,c)}},{key:"render",value:function(a,b){"updateOptions"===b?a=[].concat(this._data):this._data=a,this.imageIndex=0;var c=Object.assign({},this.options.defaultStyle),d=c.bounds,e={minX:Math.min(d.minX,d.maxX),minY:Math.min(d.minY,d.maxY),maxX:Math.max(d.minX,d.maxX),maxY:Math.max(d.minY,d.maxY)},f=[{imageUrl:c.imageUrl,opacity:c.opacity,bounds:e}];a&&a.length&&1===a.length&&a[0].url?f[0].imageUrl=a[0].url:a&&a.length&&a.length&&a[0].imageUrl&&(f=a),this.data=f;for(var g=0;g<this.data.length;g++)this.getImage(this.data[g])}},{key:"draw",value:function(){for(var a=this.map.getBounds(),b=a.pad(this.padding),c={minX:b.getWest(),minY:b.getSouth(),maxX:b.getEast(),maxY:b.getNorth()},e=0;e<this.data.length;e++){var f=this.data[e],d=!0;if((f.bounds.maxX<c.minX||f.bounds.minX>c.maxX||f.bounds.maxY<c.minY||f.bounds.minY>c.maxY)&&(d=!1),d&&f.image){var g=this.map.latLngToContainerPoint([f.bounds.minY,f.bounds.minX]),h=this.map.latLngToContainerPoint([f.bounds.maxY,f.bounds.maxX]),i=Math.abs(h.x-g.x),j=Math.abs(h.y-g.y);this.ctx.globalAlpha=f.opacity||this.options.defaultStyle.opacity,this.ctx.drawImage(f.image,g.x-this.offset.x,h.y-this.offset.y,i,j)}}}},{key:"getImage",value:function(a){var b=this,c=new Image;c.src=a.imageUrl,c.onload=function(){a.image=c,b.imageIndex++,b.imageIndex===b.data.length&&b.onRender()},c.onerror=function(){a.image=null,b.imageIndex++,b.imageIndex===b.data.length&&b.onRender()}}},{key:"updateOptions",value:function(a){this.options=i(this.options,a),this.options.minZoom=a.zoomRange[0],this.options.maxZoom=a.zoomRange[1],this.render([],"updateOptions")}},{key:"show",value:function(){this.options.visibility=!0,this.onRender()}},{key:"hide",value:function(){this.options.visibility=!1,this.ctx.clearRect(0,0,this.container.width,this.container.height)}},{key:"destroy",value:function(){this.options=null,this.imageIndex=null,delete this.options,this.imageIndex}}]),b}(h);return a.exports=j,a.exports});;
Cube("datav:/com/datavmap-canvas2d-image/2.0.28",["datav:/npm/eventemitter3/3.0.0","datav:/npm/safely-merge/1.0.1"],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"===typeof b||"function"===typeof b)?b:a}function f(a,b){if("function"!==typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=c("datav:/npm/eventemitter3/3.0.0"),i=c("datav:/npm/safely-merge/1.0.1"),j=c("datav:/com/datavmap-canvas2d-image/2.0.28/src/imageLayer"),k=function(a){function b(a,c){d(this,b);var f=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return f.options=i({renderer:"canvas"},c),f.options.minZoom=c.zoomRange[0],f.options.maxZoom=c.zoomRange[1],f.options.visibility=!0,f}return f(b,a),g(b,[{key:"addTo",value:function(a){this.layer=new j(a,this.options)}},{key:"onRender",value:function(){this.layer&&this.layer.onRender&&this.layer.onRender()}},{key:"onResize",value:function(a,b){this.layer&&this.layer.onResize&&this.layer.onResize(a,b)}},{key:"render",value:function(a){this.layer&&this.layer.render&&this.layer.render(a)}},{key:"updateOptions",value:function(a){this.options=i(this.options,a),this.options.minZoom=a.zoomRange[0],this.options.maxZoom=a.zoomRange[1],this.layer&&this.layer.updateOptions&&this.layer.updateOptions(a)}},{key:"show",value:function(){this.options.visibility=!0,this.layer&&this.layer.show&&this.layer.show()}},{key:"hide",value:function(){this.options.visibility=!1,this.layer&&this.layer.hide&&this.layer.hide()}},{key:"destroy",value:function(){this.layer&&this.layer.destroy&&this.layer.destroy(),this.layer=null,this.options=null,delete this.layer,this.options}}]),b}(h);return a.exports=k,a.exports});