// env=undefined => env=publish 
Cube("datav:/com/@datav-city-pro-v2/datav-engine-model-motion/1.1.1/model",[],function(t,e,i,n,o,a){function s(t){return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function r(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function h(t,e){return(h=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t})(t,e)}function c(i){var n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(t){return!1}}();return function(){var t,e=l(i),e=(t=n?(t=l(this).constructor,Reflect.construct(e,arguments,t)):e.apply(this,arguments),this);if(t&&("object"===s(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}}function l(t){return(l=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}return t.exports=function(t){var f=t.THREE,u=t.Utils,e=t.VG,l=t.coordHelper,t=e.ModelViewerLayer,e=o;if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&h(e,t);var i,n=c(o);function o(t){if(this instanceof o)return(t=n.call(this,t)).classNameAlias="MotionModelLayer",t.pathData=new Map,t.pathMeshes=new f.Group,t.offsetAlt=t.options.renderEffect.offsetAlt,t.pathMovingSpeed=0,t.matrix=new f.Matrix4,t.quaternion=new f.Quaternion,t.totalLength=0,t.pathPercent=[],t.movingAtomAnime=t.timeline.createAtomAnime({from:{value:0},to:{value:1},delay:0,duration:1e3,loop:1}),t;throw new TypeError("Cannot call a class as a function")}return e=o,(t=[{key:"dataErrorHandler",value:function(){this.needsWait&&(this.needsWait=!1),this.emit("rendered")}},{key:"setData",value:function(t){var e=this;if(!t||!Array.isArray(t))throw new Error("路径数据非数组, 格式错误");var i,n,o=this.options,a=o.pathMoving,o=o.renderEffect,s=(this.generatePathCurve(t,"data",a),a.duration),a=a.loopMode;this.movingAtomAnime&&(this.movingAtomAnime.stop(),this.movingAtomAnime.updateOptions({duration:s,loop:"loop"===a?0:1})),this.initOffsetAlt=o.offsetAlt,0<this.pathData.size?(a=(s=this.pathData.get(t[0].id)).startPoint,o=s.pathCurve,s=s.normal,this.position={offsetX:a.x,offsetY:a.y,offsetZ:a.z},o=o.getPointAt(1e-4),this.matrix.lookAt(o,a,s),this.romat=this.matrix.clone(),this.model?(this.setModelStartStatus(),this.pathAnimation()):(this.add(this.pathMeshes),this.modelUrl=this.options.url,this.encrypted=this.options.encrypted,o=this.options.transform,i=t.rotation||o.rotation,n=t.scale||o.scale,Object.keys(i).forEach(function(t){e.rotation["rotation".concat(t.toUpperCase())]=i[t]}),Object.keys(n).forEach(function(t){e.scale["scale".concat(t.toUpperCase())]=n[t]}),this.loadModel())):(this.model&&(this.position={offsetX:0,offsetY:0,offsetZ:0},this.setModelStartStatus()),this.emit("rendered"))}},{key:"setModelStartStatus",value:function(){var t=this.scale,e=t.scaleX,i=t.scaleY,t=t.scaleZ,n=this.rotation,o=n.rotationX,a=n.rotationY,n=n.rotationZ,s=this.position,r=s.offsetX,h=s.offsetY,s=s.offsetZ;this.actionsManager.setScale(e,i,t),this.actionsManager.setRotation(o,a,n,this.romat),this.actionsManager.setPosition(r,h,s)}},{key:"generatePathCurve",value:function(t,e,i){if(this.pathData.clear(),this.pathMeshes&&this.pathMeshes.children){for(var n=this.pathMeshes.children,o=n.length-1;0<=o;o--)n[o]instanceof f.Line&&(u.disposeNode(n[o]),this.pathMeshes.remove(n[o]));this.pathMeshes.children=[]}var a=i.height,s=i.tension,i=i.showPath;this.convertPathDatas(t,e,a,s,i)}},{key:"convertPathDatas",value:function(t,e,i,n,o){var a=this,s=new f.Vector3;this.totalLength=0,this.pathPercent=[],"data"===e?(t.forEach(function(t){var e=t.id,t=t.geometry;a.convertSinglePathData(t.coordinates,e,i,n,s)}),t.forEach(function(t){a.pathPercent.push([t.id,a.pathData.get(t.id).length/a.totalLength])})):(this.convertSinglePathData(t,0,i,n,s),this.pathPercent.push([0,this.pathData.get(0).length/this.totalLength])),this.pathMeshes.visible=o}},{key:"convertSinglePathData",value:function(t,e,i,n,o){for(var a,s=[],r=0;r<t.length;++r){var h=t[r],c=void 0===h[2]?i:h[2]+i;l.setFromValues(h[0],h[1],c+this.offsetAlt),l.toXYZ(o),s.push(o.clone()),0===r&&(a=l.normal.clone().normalize())}n=new f.CatmullRomCurve3(s,!1,"catmullrom",n),this.totalLength+=n.getLength(),this.pathData.set(e,{startPoint:s[0],pathCurve:n,length:n.getLength(),normal:a}),n=new f.Line((new f.BufferGeometry).setFromPoints(n.getPoints(50)),new f.LineBasicMaterial({color:16711680}));n.name=e,this.pathMeshes.add(n)}},{key:"pathAnimation",value:function(){var n,o,a,s,r=this,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:this.options.pathMoving.enable,e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:this.options.pathMoving.play;this.model&&(t?(e?this.movingAtomAnime.play():this.movingAtomAnime.pause(),n=0,o=this.pathData.get(this.pathPercent[n][0]).pathCurve.clone(),s=a=0,this.movingAtomAnime.on("update",function(t){var e,i,t=t.value;0===t&&(n=s=0,o=r.pathData.get(r.pathPercent[n][0]).pathCurve.clone()),t<=r.pathPercent[n][1]+s?(a=(t-s)/r.pathPercent[n][1],t=o.getPointAt(Math.min(1,a)),e=o.getPointAt(Math.min(1,a+1e-4)),l.fromXYZ(t.x,t.y,t.z),i=l.normal.clone().normalize(),r.matrix.lookAt(e,t,i),r.actionsManager.setRotationFromMatrix(r.matrix),r.actionsManager.setPosition(t.x,t.y,t.z)):(s=r.pathPercent[n][1],++n===r.pathPercent.length&&(n=s=0),o=r.pathData.get(r.pathPercent[n][0]).pathCurve.clone())}),this.movingAtomAnime.on("finished",function(){var t=o.getPointAt(1),e=o.getPointAt(Math.min(.9999,a)),i=(l.fromXYZ(e.x,e.y,e.z),l.normal.clone().normalize());r.matrix.lookAt(t,e,i),r.actionsManager.setRotationFromMatrix(r.matrix),r.actionsManager.setPosition(t.x,t.y,t.z)})):(this.movingAtomAnime.stop(),this.setModelStartStatus()))}},{key:"updatePathMovingOpts",value:function(t){var e=this.options.pathMoving,i=t.enable,n=t.play,o=t.duration,a=t.loopMode,s=t.showPath,r=t.tension,h=t.height;if(this.pathMeshes.visible=s,!u.easyDiff(e.tension,r))for(var c,l=this.pathMeshes.children,p=l.length-1;0<=p;p--)l[p]instanceof f.Line&&(c=l[p].name,(c=this.pathData.get(c).pathCurve).tension=r,l[p].geometry.setFromPoints(c.getPoints(50)));u.easyDiff(e.duration,o)&&u.easyDiff(e.loopMode,a)||(this.movingAtomAnime.stop(),this.movingAtomAnime.updateOptions({duration:o,loop:"loop"===a?0:1}),this.movingAtomAnime.restart()),u.easyDiff(e.height,h)||this.updatePathCurve(h-e.height,1),this.pathAnimation(i,n),this.options.pathMoving=u.mergeOptions(e,t)}},{key:"updatePathCurve",value:function(e,t){for(var i,n=this,o=this.pathMeshes.children,a=o.length-1;0<=a;a--)o[a]instanceof f.Line&&(i=o[a].name,(i=this.pathData.get(i).pathCurve).points.forEach(function(t){n.updatePosition(t,t,e)}),1===t&&o[a].geometry.setFromPoints(i.getPoints(50)))}},{key:"updateTransform",value:function(t,e){var i=t.rotation,t=t.scale;this.offsetAlt=e,this.updatePosition(this.actionsManager.position.add(this.actionsManager.center),this.actionsManager.position,this.offsetAlt-this.initOffsetAlt),this.updatePathCurve(this.offsetAlt-this.initOffsetAlt,2),this.actionsManager.setScale(t.x,t.y,t.z),this.actionsManager.setRotation(i.x,i.y,i.z,this.matrix),this.actionsManager.setPosition(this.actionsManager.position.x,this.actionsManager.position.y,this.actionsManager.position.z),this.initOffsetAlt=this.offsetAlt,this.scale={scaleX:t.x,scaleY:t.y,scaleZ:t.z},this.rotation={rotationX:i.x,rotationY:i.y,rotationZ:i.z}}},{key:"updatePosition",value:function(t,e,i){l.fromXYZ(t.x,t.y,t.z),l.setFromValues(l.longitude,l.latitude,l.altitude+i),l.toXYZ(e)}},{key:"updateOptions",value:function(t){var e=u.deepClone(this.options);this.setRenderEffect(t.renderEffect),this.updateTransform(t.transform,t.renderEffect.offsetAlt),u.easyObjDiff(e.animation,t.animation)||this.updateAnimationOpts(t.animation),u.easyDiff(e.url,t.url)||(this.position.offsetX=this.actionsManager.position.x+this.actionsManager.center.x,this.position.offsetY=this.actionsManager.position.y+this.actionsManager.center.y,this.position.offsetZ=this.actionsManager.position.z+this.actionsManager.center.z,this.dispose(),this.add(this.pathMeshes),this.modelUrl=t.url,this.romat.copy(this.matrix),this.loadModel()),u.easyObjDiff(e.scanner,t.scanner)||this.updateScannerOpts(t.scanner),u.easyObjDiff(e.interactiveStyle,t.interactiveStyle)||this.updateInteraction(t.interactiveStyle),u.easyDiff(e.sceneId.length,t.sceneId.length)&&u.deepDiff(e.sceneId,t.sceneId)||(this.options.sceneId=t.sceneId,this.updateSceneId(t.sceneId)),this.options=u.mergeOptions(this.options,t||{})}},{key:"updateInteraction",value:function(t){this.resetMaterial(),this.currentObj={},t.enable?(this.allowGPUPicking=!0,this.currentObj&&this.updateInteractiveStyle(t,this.currentObj)):this.allowGPUPicking=!1}},{key:"updateExpandOpts",value:function(t){u.easyDiff(this.options.expand.length,t.length)&&u.deepDiff(this.options.expand,t)||this.checkExpansion(t),this.options.expand=t}},{key:"expand",value:function(t){this.actionsManager&&this.actionsManager.translateById(t)}},{key:"startMoving",value:function(t){var e=t.path,i=t.duration,n=t.loop,o=t.tension,t=t.showPath;this.generatePathCurve(e,{height:0,tension:o,showPath:t}),this.movingAtomAnime.stop(),this.movingAtomAnime.updateOptions({duration:i,loop:"loop"===n?0:1}),this.movingAtomAnime.restart(),this.pathAnimation(!0,!0)}},{key:"stopMoving",value:function(){this.movingAtomAnime.stop()}},{key:"restartMoving",value:function(){this.movingAtomAnime.restart()}},{key:"pauseMoving",value:function(){this.movingAtomAnime.pause()}},{key:"playMoving",value:function(){this.movingAtomAnime.play()}},{key:"playAllAnimation",value:function(){var e=this;Object.keys(this.animationManager.actions).forEach(function(t){e.animationManager.actions[t].play(),e.animationManager.setActionWeight(e.animationManager.actions[t],1)})}},{key:"setAnimation",value:function(t,e){switch(e){case 1:this.animationManager.activateAllActions(),this.animationManager.activateActionByName(t);break;case 0:this.animationManager.deactivateActionByName(t)}}},{key:"stopAllAnimation",value:function(){this.animationManager.autoPlay=!1}}])&&r(e.prototype,t),i&&r(e,i),Object.defineProperty(e,"prototype",{writable:!1}),o},t.exports});;
Cube("datav:/com/@datav-city-pro-v2/datav-engine-model-motion/1.1.1",["datav:/npm/eventemitter3/3.0.0"],function(e,t,n,i,r,a){function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function l(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function s(e,t){return(s=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function c(n){var i=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=y(n),t=(e=i?(e=y(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),this);if(e&&("object"===o(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");if(void 0!==t)return t;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}}function y(e){return(y=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var u=n("datav:/npm/eventemitter3/3.0.0"),f=n("datav:/com/@datav-city-pro-v2/datav-engine-model-motion/1.1.1/model"),n=function(){var e=r,t=u;if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&s(e,t);var n,i=c(r);function r(e,t){var n;if(this instanceof r)return(n=i.call(this)).options=Object.assign({enableGBuffer:!0,url:""},t),n.comId="",n.type="MotionModel",n;throw new TypeError("Cannot call a class as a function")}return e=r,(t=[{key:"addTo",value:function(e,t){this.cityproCore=e,this.comId=t,this.initLayer()}},{key:"initLayer",value:function(){var e=new f(this.cityproCore),t=this.refractOptions(this.options);this.layer=new e(t),this.cityproCore.viewer.addLayer(this.comId,this.layer),this.initEvents()}},{key:"setData",value:function(e){var t=this;this.layer&&this.layer.setData(e),this.layer.on("loaded",function(){t.layer.pathAnimation(),t.emit("loaded")})}},{key:"errorRender",value:function(){console.log("路径运动模型组件数据错误"),this.layer&&this.layer.dataErrorHandler()}},{key:"initEvents",value:function(){var n=this;this.layer.on("pick",function(e){var t={name:e.name,instanceId:e.instanceId,mesh:e.mesh};switch(e.button){case 0:n.emit("leftClick",t);break;case 1:n.emit("middleClick",t);break;case 2:n.emit("rightClick",t);break;default:n.emit("leftClick",t)}}),this.layer.on("rendered",function(){n.emit("rendered","路径动画模型加载完成")})}},{key:"updateInteraction",value:function(e){this.layer&&this.layer.updateInteraction(e)}},{key:"setEnvMap",value:function(e){this.layer&&this.layer.setEnvMap(e)}},{key:"updateOptions",value:function(e){e=this.refractOptions(e);this.layer&&this.layer.updateOptions(e)}},{key:"refractOptions",value:function(e){var t,n,i,r,a,o=Object.assign({renderEffect:{shadow:!1,depthWrite:!0,wireframe:!1,opacity:1,offsetAlt:0},interactiveStyle:{enable:!1,clickType:"click",interactiveColor:"RGBA(79, 240, 252, 0.2)",interactiveExt:"local"},animation:{autoPlay:!1,showSkeleton:!1,defaultLoopMode:"LoopRepeat",timeScale:1},light:{envMapIntensityFactor:1,emissiveIntensity:0}},e);return o.options&&delete o.options,e.options&&(e=e.options,t=e.general,n=e.graphic,a=e.animate,e=e.interaction,o.url=n.url,Object.keys(o.renderEffect).forEach(function(e){return o.renderEffect[e]=t[e]}),Object.keys(o.light).forEach(function(e){return o.light[e]=t.light[e]}),i=a.modelAnimate,r=a.scanner,a=a.pathMoving,o.animation=i,o.scanner=r,o.pathMoving=a,o.interactiveStyle=e,o.transform={rotation:{x:n.rotation.x/180,y:n.rotation.y/180,z:n.rotation.z/180},scale:n.scale}),o}},{key:"updatePathMovingOpts",value:function(e){this.layer&&this.layer.updatePathMovingOpts(e)}},{key:"updateExpandOpts",value:function(e){this.layer&&this.layer.updateExpandOpts(e)}},{key:"updateScanner",value:function(e){this.layer&&this.layer.updateScannerOpts(e)}},{key:"expand",value:function(e){this.layer&&this.layer.expand(e)}},{key:"expandByArray",value:function(e){var t=this;Array.isArray(e)&&e.length&&e.forEach(function(e){t.layer&&t.layer.expand(e)})}},{key:"resetExpansion",value:function(){this.layer&&this.layer.resetExpansion()}},{key:"startMoving",value:function(e){this.layer&&this.layer.startMoving(e)}},{key:"stopMoving",value:function(){this.layer&&this.layer.stopMoving()}},{key:"restartMoving",value:function(){this.layer&&this.layer.restartMoving()}},{key:"pauseMoving",value:function(){this.layer&&this.layer.pauseMoving()}},{key:"playMoving",value:function(){this.layer&&this.layer.playMoving()}},{key:"playAllAnimation",value:function(){this.layer&&this.layer.playAllAnimation()}},{key:"playSpecifiedAnimation",value:function(e){this.layer&&this.layer.setAnimation(e,1)}},{key:"stopAllAnimation",value:function(){this.layer&&this.layer.stopAllAnimation()}},{key:"stopSpecifiedAnimation",value:function(e){this.layer&&this.layer.setAnimation(e,0)}},{key:"show",value:function(){this.layer&&this.layer.show&&this.layer.show()}},{key:"hide",value:function(){this.layer&&this.layer.hide&&this.layer.hide()}},{key:"clear",value:function(){this.layer&&this.layer.clear&&this.layer.clear()}},{key:"destroy",value:function(){this.layer&&this.layer.destroy&&this.layer.destroy()}}])&&l(e.prototype,t),n&&l(e,n),Object.defineProperty(e,"prototype",{writable:!1}),r}();return e.exports=n,e.exports});