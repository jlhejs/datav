// env=undefined => env=publish 
Cube("datav:/com/map3d-earth-globe/0.1.1",["datav:/npm/eventemitter3/2.0.3"],function(e,t,s,i,o,n){function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function a(e,t){for(var s=0;s<t.length;s++){var i=t[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function h(s){var i=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=u(s),t=(e=i?(e=u(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),this);if(e&&("object"===r(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");if(void 0!==t)return t;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}}function u(e){return(u=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var p=null,S=null,c=s("datav:/npm/eventemitter3/2.0.3"),b=null,f=null,d=null,m=null,s=function(){var e=o,t=c;if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&l(e,t);var s,i=h(o);function o(e,t){var s;if(this instanceof o)return(s=i.call(this)).options=Object.assign({visible:!0,specular:"#868686",globeColor:"#47576A",emissive:"#23232A",lightColor:4210752,lightIntensity:2,radius:200,scale:1,mapUrl:"//datavmap-public.oss-cn-hangzhou.aliyuncs.com/mapping/1/earth.topo.bathy.200407.3x4096x2048.jpg",bumpMapUrl:"//img.alicdn.com/tfs/TB1Jp7dbsjI8KJjSsppXXXbyVXa-9000-4500.jpg"},t||{}),s;throw new TypeError("Cannot call a class as a function")}return e=o,(t=[{key:"addTo",value:function(e){if(!e)return console.log("globe layer needs map layer");this.map=e,p=e.THREE,S=e.Utils,this.scene=e.scene,this.init(),this.initEvent()}},{key:"initEvent",value:function(){this.map.on("projChanged",this.updatePostions.bind(this))}},{key:"init",value:function(){var e=this.options,t=e.lightColor,s=e.lightIntensity,t=new p.Color(t),t=this.ambient=new p.AmbientLight(t,s),s=(this.scene.add(t),this.createDoubleGeometry(),this.material=new p.MeshStandardMaterial({roughness:e.roughness,metalness:e.metalness,bumpScale:e.bumpScale,side:p.FrontSide,depthTest:!0,transparent:!0})),t=this.backMaterial=new p.MeshStandardMaterial({roughness:e.roughness,metalness:e.metalness,bumpScale:e.bumpScale,side:p.BackSide,depthTest:!0,transparent:!0}),i=(this.updateMaterial(s,t),this.backGlobeMesh=new p.Mesh(this.backGlobeGeometry,t)),i=(i.scale.set(e.scale,e.scale,e.scale),i.renderOrder=1,this.scene.add(i),this.frontGlobeMesh=new p.Mesh(this.globeGeometry,s));i.scale.set(e.scale,e.scale,e.scale),this.scene.add(i),s.needsUpdate=!0,t.needsUpdate=!0,this.checkVisible()}},{key:"createSphereGeometry",value:function(e,t,s){for(var i=Math.floor(e),o=Math.floor(t),n=360/i,r=180/o,a=[],l=[],h=[],u=[],p=0,c=[],b=0;b<=o;b++){for(var f=[],d=0;d<=i;d++){var m=d*r-90,y=b*n-180,v=S.ll2sphere(y,m,s),v=(h.push(v.x,v.y,v.z),S.ll2plane(y,m,s));u.push(v.x,v.y,v.z),a.push(b/i,d/o),f.push(p++)}c.push(f)}for(var G=0;G<o;G++)for(var M=0;M<i;M++){var k=c[G][M+1],g=c[G][M],w=c[G+1][M],j=c[G+1][M+1];l.push(k,g,j),l.push(g,w,j)}this.uvs=new Float32Array(a),this.indexs=new Uint16Array(l),this.planePositionArray=new Float32Array(u),this.spherePositionArray=new Float32Array(h)}},{key:"createDoubleGeometry",value:function(){var e=this.options.radius,e=(this.createSphereGeometry(64,64,e),this.globeGeometry=new p.BufferGeometry);e.setIndex(new p.BufferAttribute(this.indexs,1)),e.addAttribute("uv",new p.BufferAttribute(this.uvs,2).setDynamic(!0)),0===this.map.projType?e.addAttribute("position",new p.BufferAttribute(this.spherePositionArray.slice(),3).setDynamic(!0)):1===this.map.projType?e.addAttribute("position",new p.BufferAttribute(this.planePositionArray.slice(),3).setDynamic(!0)):console.error(" Projection type error in globe "),e.computeVertexNormals(),this.backGlobeGeometry=e.clone()}},{key:"updatePostions",value:function(e){var t=e.projType,s=e.index,i=this.globeGeometry.attributes.position.array,o=this.backGlobeGeometry.attributes.position.array,n=this.spherePositionArray,r=this.planePositionArray;if(0===t)for(var a=0;a<i.length;a+=3)i[a+0]=n[a+0]*s+(1-s)*r[a+0],i[a+1]=n[a+1]*s+(1-s)*r[a+1],i[a+2]=n[a+2]*s+(1-s)*r[a+2],o[a+0]=n[a+0]*s+(1-s)*r[a+0],o[a+1]=n[a+1]*s+(1-s)*r[a+1],o[a+2]=n[a+2]*s+(1-s)*r[a+2];else if(1===t)for(var l=0;l<i.length;l+=3)i[l+0]=r[l+0]*s+(1-s)*n[l+0],i[l+1]=r[l+1]*s+(1-s)*n[l+1],i[l+2]=r[l+2]*s+(1-s)*n[l+2],o[l+0]=r[l+0]*s+(1-s)*n[l+0],o[l+1]=r[l+1]*s+(1-s)*n[l+1],o[l+2]=r[l+2]*s+(1-s)*n[l+2];this.globeGeometry.attributes.position.needsUpdate=!0,this.backGlobeGeometry.attributes.position.needsUpdate=!0}},{key:"updateMaterial",value:function(e,t){var s,i,o,n;e&&t&&(i=null,i="customMap"===(s=this.options).mapUrl?s.customMapUrl:s.mapUrl,o=s.bumpMapUrl,n=(new p.TextureLoader).setCrossOrigin("*"),f===i&&b||(b=n.load(i,function(){b.needsUpdate=!0}),f=i),m===o&&d||(d=n.load(o,function(){d.needsUpdate=!0}),m=o),e.map=b,e.bumpMap=d,e.roughness=s.roughness,e.metalness=s.metalness,e.bumpScale=s.bumpScale,t.map=b,t.bumpMap=d,t.roughness=s.roughness,t.metalness=s.metalness,t.bumpScale=s.bumpScale,e.needsUpdate=!0,t.needsUpdate=!0)}},{key:"updateLight",value:function(){var e=this.options.lightIntensity;this.ambient.intensity=e}},{key:"updateGlobe",value:function(){var e=this.options.scale;this.updateMaterial(this.material,this.backMaterial),this.backGlobeMesh&&this.backGlobeMesh.scale.set(e,e,e),this.frontGlobeMesh&&this.frontGlobeMesh.scale.set(e,e,e),this.material.needsUpdate=!0,this.backMaterial.needsUpdate=!0}},{key:"checkVisible",value:function(){this.options.visible?this.show():this.hide()}},{key:"hide",value:function(){this.options.visible=!1,this.backGlobeMesh&&(this.backGlobeMesh.visible=!1),this.frontGlobeMesh&&(this.frontGlobeMesh.visible=!1)}},{key:"show",value:function(){this.options.visible=!0,this.backGlobeMesh&&(this.backGlobeMesh.visible=!0),this.frontGlobeMesh&&(this.frontGlobeMesh.visible=!0)}},{key:"updateOptions",value:function(e){this.options=S.mergeOptions(this.options,e||{}),this.updateLight(),this.updateGlobe(),this.checkVisible()}},{key:"remove",value:function(){this.map.off("projChanged",this.updatePostions),this.ambient&&this.scene.remove(this.ambient),this.backGlobeMesh&&this.scene.remove(this.backGlobeMesh),this.frontGlobeMesh&&this.scene.remove(this.frontGlobeMesh),this.backGlobeMesh&&this.backGlobeMesh.dispose&&this.backGlobeMesh.dispose(),this.backMaterial&&this.backMaterial.dispose&&this.backMaterial.dispose(),this.backGlobeGeometry&&this.backGlobeGeometry.dispose&&this.backGlobeGeometry.dispose(),this.frontGlobeMesh&&this.frontGlobeMesh.dispose&&this.frontGlobeMesh.dispose(),this.material&&this.material.dispose&&this.material.dispose(),this.globeGeometry&&this.globeGeometry.dispose&&this.globeGeometry.dispose(),this.ambient&&this.ambient.dispose&&this.ambient.dispose(),this.ambient=null,this.backGlobeMesh=null,this.backMaterial=null,this.backGlobeGeometry=null,this.frontGlobeMesh=null,this.material=null,this.globeGeometry=null,d=b=m=f=null}}])&&a(e.prototype,t),s&&a(e,s),Object.defineProperty(e,"prototype",{writable:!1}),o}();return e.exports=s,e.exports});