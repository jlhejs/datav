// env=undefined => env=publish 
Cube("datav:/com/@datav-city-pro-v2/datav-engine-models/1.1.1/models",["datav:/npm/eventemitter3/3.0.0"],function(t,e,n,i,o,r){function s(t){return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function a(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function l(t,e){return(l=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function c(n){var i=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(t){return!1}}();return function(){var t,e=f(n),e=(t=i?(t=f(this).constructor,Reflect.construct(e,arguments,t)):e.apply(this,arguments),this);if(t&&("object"===s(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}}function f(t){return(f=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}var u=n("datav:/npm/eventemitter3/3.0.0"),y=null,h=null,p=null,d=null,v=null,n=function(){var t=o,e=u;if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&l(t,e);var n,i=c(o);function o(t,e){var n;if(this instanceof o)return(n=i.call(this)).classNameAlias="ModelsLayer",n.cityproCore=t,y=t.THREE,h=t.Utils,p=t.VG,d=t.viewer,v=t.coordHelper,n.layerName=n.classNameAlias,n.renderQueue=p.Geometry,n.options=e,n.comId=e.comId,n.options.classNameAlias=n.classNameAlias,n.position=new y.Vector3,n.layers=[],n.promiselist=[],n;throw new TypeError("Cannot call a class as a function")}return t=o,(e=[{key:"setData",value:function(i){var o=this;if(this.dispose(),Array.isArray(i))for(var t=0;t<i.length;++t)!function(t){var e=i[t],e=o.convertData(e,t),n=new p.ModelViewerLayer(o.options),t=(n.needsWait=!1,"".concat(o.comId,"_").concat(t.toString())),t=(d.addLayer(t,n),n.id=o.comId,new Promise(function(t){n.on("loaded",function(){return t()})}));o.promiselist.push(t),n.on("pick",function(t){o.emit("pick",t)}),n.setData(e),o.layers.push(n)}(t);Promise.all(this.promiselist||[]).then(function(){o.emit("rendered","精模加载完成"),o.promiselist.length=0,o.emit("loaded")})}},{key:"dataErrorHandler",value:function(){this.emit("rendered")}},{key:"convertData",value:function(t,e){var n=t.position,i=t.rotation,o=t.scale,r=void 0!==this.options.renderEffect.offsetAlt?this.options.renderEffect.offsetAlt+parseFloat(n.alt):parseFloat(n.alt),s=(v.setFromValues(n.lng,n.lat,r),v.toXYZ(this.position),v.transform.clone());return{name:t.name,url:t.url,position:{x:this.position.x,y:this.position.y,z:this.position.z},rotation:{x:i.x/180,y:i.y/180,z:i.z/180},scale:{x:parseFloat(o.x),y:parseFloat(o.y),z:parseFloat(o.z)},animationNames:t.animationNames,lod:t.lod,groups:t.groups,encrypted:t.encrypted,romat:s,layerIndex:e,offsetAlt:r-n.alt}}},{key:"updateInteractiveStyle",value:function(e){this.layers.forEach(function(t){t.updateInteractiveStyle(e),t.resetMaterial()})}},{key:"updateInteraction",value:function(t){this.options.interactiveStyle=h.mergeOptions(this.options.interactiveStyle,t||{}),this.layers&&0<this.layers.length&&(t.enable?(this.allowGPUPicking=!0,this.layers.forEach(function(t){t.allowGPUPicking=!0}),this.updateInteractiveStyle(t)):(this.allowGPUPicking=!1,this.layers.forEach(function(t){t.allowGPUPicking=!1,t.resetMaterial()})))}},{key:"setEnvMap",value:function(e){this.layers&&0<this.layers.length&&this.layers.forEach(function(t){t.setEnvMap(e)})}},{key:"emissiveIntensity",set:function(e){this.options.light.emissiveIntensity=e,this.layers.forEach(function(t){t.materialsManager.emissiveIntensity=e})}},{key:"getEmissiveIntensityInOption",value:function(){return this.options.light.emissiveIntensity}},{key:"updateHeight",value:function(o){var r=this;this.layers&&0<this.layers.length&&this.layers.forEach(function(t){var e=t.position,n=e.offsetX,i=e.offsetY,e=e.offsetZ;v.fromXYZ(n,i,e),v.setFromValues(v.longitude,v.latitude,v.altitude+o-t.initOffsetAlt),v.toXYZ(r.position),t.actionsManager.setPosition(r.position.x,r.position.y,r.position.z)})}},{key:"updateOptions",value:function(e){var n=this,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"default",o=h.deepClone(this.options);this.options=h.mergeOptions(this.options,e||{}),"default"===i&&(h.easyDiff(o.renderEffect.offsetAlt,e.renderEffect.offsetAlt)||this.updateHeight(e.renderEffect.offsetAlt),h.easyObjDiff(o.interactiveStyle,e.interactiveStyle)||this.updateInteraction(e.interactiveStyle)),this.layers&&0<this.layers.length&&this.layers.forEach(function(t){switch(i){case"animation":t.updateAnimationOpts(e);break;case"scanner":t.updateScannerOpts(e);break;default:t.updateOptions(e),h.easyDiff(o.sceneId.length,e.sceneId.length)&&h.deepDiff(o.sceneId,e.sceneId)||(n.options.sceneId=e.sceneId,t.updateSceneId(e.sceneId))}})}},{key:"show",value:function(){this.options.visible=!0,this.layers&&0<this.layers.length&&this.layers.forEach(function(t){t.show()})}},{key:"hide",value:function(){this.options.visible=!1,this.layers&&0<this.layers.length&&this.layers.forEach(function(t){t.hide()})}},{key:"dispose",value:function(){if(this.layers&&0<this.layers.length)for(var t=0;t<this.layers.length;++t){var e="".concat(this.comId,"_").concat(t.toString());this.layers[t].destroy(),d.removeLayer(e)}this.layers=[]}},{key:"clear",value:function(){this.layers&&0<this.layers.length&&this.layers.forEach(function(t){t.clear()}),this.layers=[]}},{key:"destroy",value:function(){if(this.layers&&0<this.layers.length)for(var t=0;t<this.layers.length;++t){var e="".concat(this.comId,"_").concat(t.toString());this.layers[t].destroy(),d.removeLayer(e)}this.layers=[],this.position=null}}])&&a(t.prototype,e),n&&a(t,n),Object.defineProperty(t,"prototype",{writable:!1}),o}();return t.exports=n,t.exports});;
Cube("datav:/com/@datav-city-pro-v2/datav-engine-models/1.1.1",["datav:/npm/eventemitter3/3.0.0"],function(e,t,n,i,r,o){function a(e){return(a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function s(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function c(e,t){return(c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(n){var i=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=y(n),t=(e=i?(e=y(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),this);if(e&&("object"===a(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");if(void 0!==t)return t;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}}function y(e){return(y=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var u=n("datav:/npm/eventemitter3/3.0.0"),f=n("datav:/com/@datav-city-pro-v2/datav-engine-models/1.1.1/models"),n=function(){var e=r,t=u;if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&c(e,t);var n,i=l(r);function r(e,t){var n;if(this instanceof r)return(n=i.call(this)).options=Object.assign({enableGBuffer:!0},t),n.comId="",n.type="Models",n;throw new TypeError("Cannot call a class as a function")}return e=r,(t=[{key:"addTo",value:function(e,t){this.cityproCore=e,this.comId=t,this.initLayer()}},{key:"initLayer",value:function(){this.options.comId=this.comId;var e=this.refractOptions(this.options);this.layer=new f(this.cityproCore,e),this.initEvents()}},{key:"setData",value:function(e){this.layer&&this.layer.setData(e)}},{key:"errorRender",value:function(){console.log("精模组件数据错误"),this.layer&&this.layer.dataErrorHandler()}},{key:"initEvents",value:function(){var n=this;this.layer.on("pick",function(e){var t={name:e.name,instanceId:e.instanceId,mesh:e.mesh};switch(e.button){case 0:n.emit("leftClick",t);break;case 1:n.emit("middleClick",t);break;case 2:n.emit("rightClick",t);break;default:n.emit("leftClick",t)}}),this.layer.on("rendered",function(){n.emit("rendered","精模加载完成")}),this.layer.on("loaded",function(){n.emit("loaded")})}},{key:"refractOptions",value:function(e){var t,n,i,r,o=Object.assign({renderEffect:{shadow:!1,depthWrite:!0,wireframe:!1,opacity:1,offsetAlt:0},interactiveStyle:{enable:!1,clickType:"click",interactiveColor:"RGBA(79, 240, 252, 0.2)",interactiveExt:"local"},animation:{autoPlay:!1,showSkeleton:!1,defaultLoopMode:"LoopRepeat",timeScale:1},light:{envMapIntensityFactor:1,emissiveIntensity:0},enableCache:!1},e);return o.options&&delete o.options,e.options&&(e=e.options,t=e.general,n=e.animate,i=e.interaction,Object.keys(o.renderEffect).forEach(function(e){t&&void 0!==t[e]&&(o.renderEffect[e]=t[e])}),Object.keys(o.light).forEach(function(e){t.light&&void 0!==t.light[e]&&(o.light[e]=t.light[e])}),Object.keys(o.interactiveStyle).forEach(function(e){i&&void 0!==i[e]&&(o.interactiveStyle[e]=i[e])}),n&&(e=n.modelAnimate,r=n.scanner,e?o.animation=e:Object.keys(o.animation).forEach(function(e){n&&void 0!==n[e]&&(o.animation[e]=n[e])}),o.scanner=r)),o}},{key:"updateInteraction",value:function(e){this.layer&&this.layer.updateInteraction(e)}},{key:"setEnvMap",value:function(e){this.layer&&this.layer.setEnvMap(e)}},{key:"updateAnimation",value:function(e){this.layer&&this.layer.updateOptions(e,"animation")}},{key:"updateScanner",value:function(e){this.layer&&this.layer.updateOptions(e,"scanner")}},{key:"updateOptions",value:function(e){e=this.refractOptions(e);this.layer&&this.layer.updateOptions(e)}},{key:"updateLightOpts",value:function(e){e=e.emissiveIntensity;void 0!==e&&this.updateEmissiveIntensity(e)}},{key:"updateEmissiveIntensity",value:function(e){this.layer&&(this.layer.emissiveIntensity=e)}},{key:"emissiveIntensityInOption",value:function(){return this.layer.getEmissiveIntensityInOption()}},{key:"expand",value:function(e){this.layer&&this.layer.expand(e)}},{key:"expandByArray",value:function(e){var t=this;Array.isArray(e)&&e.length&&e.forEach(function(e){t.layer&&t.layer.expand(e)})}},{key:"easeOpacity",value:function(e){this.layer&&this.layer.easeOpacity(e)}},{key:"show",value:function(){this.layer&&this.layer.show&&this.layer.show()}},{key:"hide",value:function(){this.layer&&this.layer.hide&&this.layer.hide()}},{key:"clear",value:function(){this.layer&&this.layer.clear&&this.layer.clear()}},{key:"destroy",value:function(){this.layer&&this.layer.destroy&&this.layer.destroy()}}])&&s(e.prototype,t),n&&s(e,n),Object.defineProperty(e,"prototype",{writable:!1}),r}();return e.exports=n,e.exports});