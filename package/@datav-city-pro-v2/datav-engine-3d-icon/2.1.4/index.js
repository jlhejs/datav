// env=undefined => env=publish 
Cube("datav:/com/@datav-city-pro-v2/datav-engine-3d-icon/2.1.4/shader/physical.frag.glsl",[],function(n,e,t,i,a,r){return n.exports="#define GLSLIFY 1\n#define STANDARD\n\n#ifdef PHYSICAL\n\t#define REFLECTIVITY\n\t#define CLEARCOAT\n\t// #define TRANSPARENCY\n#endif\n\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\n\n#ifdef USE_TRANSMISSION\n\tuniform float transmission;\n\tuniform float thickness;\n\tuniform vec3 attenuationColor;\n\tuniform float attenuationDistance;\n#endif\n\n// #ifdef TRANSPARENCY\n// \tuniform float transparency;\n// #endif\n#ifdef REFLECTIVITY\n\tuniform float reflectivity;\n#endif\n#ifdef CLEARCOAT\n\tuniform float clearcoat;\n\tuniform float clearcoatRoughness;\n#endif\n#ifdef USE_SHEEN\n\tuniform vec3 sheen;\n#endif\n\nvarying vec3 vViewPosition;\n\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif\n\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <bsdfs>\n#include <transmission_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_physical_pars_fragment>\n#include <fog_pars_fragment>\n#include <lights_pars_begin>\n#include <lights_physical_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <clearcoat_pars_fragment>\n#include <roughnessmap_pars_fragment>\n#include <metalnessmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\nflat varying float picked;\nflat varying float highlighted;\nuniform vec3 activeColor;\n\n// ShaderChunk/encodings_pars_fragment.glsl.js 中移除了 sRGBToLinear \nvec4 sRGBToLinear( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.a );\n}\n\nvoid main() {\n\t#include <clipping_planes_fragment>\n\n\t// vec4 diffuseColor = vec4( diffuse, opacity );\n\n\t// 由于配置项显示的颜色已经是经过gamma校正的，而后期渲染模块会统一做gamma校正，\n    // 为了图元渲染颜色和配置项设置颜色保持一致，需要做以下处理以抵消\n\tvec4 diffuseColor = vec4(pow(diffuse.r, 2.2), pow(diffuse.g, 2.2),pow(diffuse.b, 2.2), opacity);\n\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\n\t#ifdef USE_TRANSMISSION\n\t\tfloat totalTransmission = transmission;\n\t\tfloat thicknessFactor = thickness;\n\t#endif\n\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <roughnessmap_fragment>\n\t#include <metalnessmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <clearcoat_normal_fragment_begin>\n\t#include <clearcoat_normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\n\tvec3 rawDiffuseColor = diffuseColor.rgb;\n\n\t#include <lights_physical_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\t// #ifdef TRANSPARENCY\n\t// \tdiffuseColor.a *= saturate( 1. - transparency + linearToRelativeLuminance( reflectedLight.directSpecular + reflectedLight.indirectSpecular ) );\n\t// #endif\n\n    if(picked > 0.0 || highlighted > 0.0){\n\t\tvec3 activeColor2 = vec3(sRGBToLinear(vec4(activeColor, 1.0)).xyz);\n\t\toutgoingLight = activeColor2 + totalEmissiveRadiance;\n\t}\n\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\n\t// #include <tonemapping_fragment>\n\t// #include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n\n}",n.exports});;
Cube("datav:/com/@datav-city-pro-v2/datav-engine-3d-icon/2.1.4/shader/physical.vert.glsl",[],function(n,e,i,t,r,a){return n.exports="#define GLSLIFY 1\n#define STANDARD\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\nvarying vec3 vNormal;\n#ifdef USE_TANGENT\nvarying vec3 vTangent;\nvarying vec3 vBitangent;\n#endif\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n\nuniform float radY;\nuniform vec3 scale;\nuniform int pickedInstanceId;\n\nflat varying float picked;\nflat varying float highlighted;\n\n#include <clipping_planes_pars_vertex>\n#include <color_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <skinning_pars_vertex>\n#include <uv2_pars_vertex>\n\n#ifdef highlightCount\n  uniform int highlightInstanceIds[highlightCount];\n#endif\n\nvoid main() {\n\n  if(pickedInstanceId == gl_InstanceID){\n    picked = 1.0;\n  }else{\n    picked = 0.0;\n  }\n\n  highlighted = 0.0;\n\n  #ifdef highlightCount\n    for(int i=0; i<highlightCount; i++){\n        if(gl_InstanceID == highlightInstanceIds[i]){\n          highlighted = 1.0;\n          break;\n        }\n    }\n  #endif\n\n  #include <uv_vertex>\n\n  float c = cos(radY * PI);\n  float s = sin(radY * PI);\n  \n  mat4 matSR = mat4(c * scale.x, 0, -s * scale.x, 0, \n                    0, scale.y, 0, 0,\n                    s * scale.z, 0, c * scale.z, 0,\n                    0, 0, 0, 1);\n\n#include <beginnormal_vertex>\n#include <color_vertex>\n#include <morphnormal_vertex>\n#include <skinbase_vertex>\n#include <skinnormal_vertex>\n#include <uv2_vertex>\n\n// #include <defaultnormal_vertex>\n\n  vec3 transformedNormal = objectNormal;\n\n#ifdef USE_INSTANCING\n\n  // this is in lieu of a per-instance normal-matrix\n  // shear transforms in the instance matrix are not supported\n\n  mat3 m = mat3(instanceMatrix * matSR);\n\n  transformedNormal /= vec3(dot(m[0], m[0]), dot(m[1], m[1]), dot(m[2], m[2]));\n\n  transformedNormal = m * transformedNormal;\n\n#endif\n\n  transformedNormal = normalMatrix * transformedNormal;\n\n#ifdef FLIP_SIDED\n\n  transformedNormal = -transformedNormal;\n\n#endif\n\n#ifdef USE_TANGENT\n\n  vec3 transformedTangent = (modelViewMatrix * vec4(objectTangent, 0.0)).xyz;\n\n#ifdef FLIP_SIDED\n\n  transformedTangent = -transformedTangent;\n\n#endif\n\n#endif\n#ifndef FLAT_SHADED\n  vNormal = normalize(transformedNormal);\n#ifdef USE_TANGENT\n  vTangent = normalize(transformedTangent);\n  vBitangent = normalize(cross(vNormal, vTangent) * tangent.w);\n#endif\n#endif\n\n#include <begin_vertex>\n#include <displacementmap_vertex>\n#include <morphtarget_vertex>\n#include <skinning_vertex>\n  // #include <project_vertex>\n  vec4 mvPosition = vec4(transformed, 1.0);\n\n#ifdef USE_INSTANCING\n\n  mvPosition = instanceMatrix * matSR * mvPosition;\n\n#endif\n\n  mvPosition = modelViewMatrix * mvPosition;\n\n  gl_Position = projectionMatrix * mvPosition;\n#include <clipping_planes_vertex>\n#include <logdepthbuf_vertex>\n  vViewPosition = -mvPosition.xyz;\n\n#include <worldpos_vertex>\n\n#include <shadowmap_vertex>\n \n\n#include <fog_vertex>\n\n}",n.exports});;
Cube("datav:/com/@datav-city-pro-v2/datav-engine-3d-icon/2.1.4/material",[],function(e,t,s,a,i,n){function r(e,t){for(var a=0;a<t.length;a++){var i=t[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return e.exports=function(t){var e,a,i;function n(e){var a=this;if(!(this instanceof n))throw new TypeError("Cannot call a class as a function");this._material=new t.MeshStandardMaterial({metalness:1,roughness:1,transparent:!0,normalScale:new t.Vector2(2,2)}),this._material.defines.ICON3D=!0,this._material.defines.highlightCount=1,this._radY={value:0},this._scale={value:new t.Vector3(1,1,1)},this._pickedInstanceId={value:-1,type:"int"},this._activeColor={value:new t.Vector3(e[0],e[1],e[2])},this._highlightInstanceIds={value:[-1],type:"int"},this._material.customOnBeforeCompile=function(e){var t=e.uniforms;e.vertexShader=s("datav:/com/@datav-city-pro-v2/datav-engine-3d-icon/2.1.4/shader/physical.vert.glsl"),e.fragmentShader=s("datav:/com/@datav-city-pro-v2/datav-engine-3d-icon/2.1.4/shader/physical.frag.glsl"),t.radY=a._radY,t.scale=a._scale,t.pickedInstanceId=a._pickedInstanceId,t.activeColor=a._activeColor,t.highlightInstanceIds=a._highlightInstanceIds},this._material.onBeforeCompile=function(e){a._material.customOnBeforeCompile(e)}}return e=n,(a=[{key:"scale",get:function(){return this._scale.value}},{key:"radY",get:function(){return this._radY.value},set:function(e){this._radY.value=e}},{key:"pickedInstanceId",set:function(e){this._pickedInstanceId.value=e}},{key:"activeColor",set:function(e){this._activeColor.value=new t.Vector3(e[0],e[1],e[2])}},{key:"depthWrite",set:function(e){this._material&&(this._material.depthWrite=e)}},{key:"depthTest",set:function(e){this._material&&(this._material.depthTest=e)}},{key:"map",set:function(e){this._material&&(this._material.map=e,this.needsUpdate=!0)}},{key:"roughnessMap",set:function(e){this._material&&(this._material.roughnessMap=e,this.needsUpdate=!0)}},{key:"metalnessMap",set:function(e){this._material&&(this._material.metalnessMap=e,this.needsUpdate=!0)}},{key:"normalMap",set:function(e){this._material&&(this._material.normalMap=e,this.needsUpdate=!0)}},{key:"roughness",set:function(e){this.material&&(this.material.roughness=e)}},{key:"metalness",set:function(e){this.material&&(this.material.metalness=e)}},{key:"color",get:function(){return this._material?this._material.color:null}},{key:"emissive",get:function(){return this._material?this._material.emissive:null}},{key:"emissiveMap",set:function(e){this._material&&(this._material.emissiveMap=e,this.needsUpdate=!0)}},{key:"material",get:function(){return this._material}},{key:"envMap",get:function(){return this._material?this._material.envMap:null},set:function(e){this._material&&(this._material.envMap=e,this.needsUpdate=!0)}},{key:"envMapIntensity",set:function(e){this._material&&(this._material.envMapIntensity=e)}},{key:"needsUpdate",set:function(e){this._material&&(this._material.needsUpdate=e)}},{key:"highlightCount",set:function(e){this._material&&(this._material.defines.highlightCount=e,this.needsUpdate=!0)}},{key:"highlightInstanceIds",set:function(e){this.highlightCount=e.length,this._highlightInstanceIds.value=e}},{key:"disposeEnvMap",value:function(){this._material&&this._material.envMap&&(this._material.envMap.dispose(),this._material.envMap=null,this.needsUpdate=!0)}},{key:"dispose",value:function(){this._material&&(this._material.dispose(),this._material=null)}}])&&r(e.prototype,a),i&&r(e,i),Object.defineProperty(e,"prototype",{writable:!1}),n},e.exports});;
Cube("datav:/com/@datav-city-pro-v2/datav-engine-3d-icon/2.1.4/icon3d",[],function(t,e,p,i,a,r){function n(t){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function v(t){return function(t){if(Array.isArray(t))return o(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||s(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function M(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var i=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=i){var a,r,n=[],s=!0,o=!1;try{for(i=i.call(t);!(s=(a=i.next()).done)&&(n.push(a.value),!e||n.length!==e);s=!0);}catch(t){o=!0,r=t}finally{try{s||null==i.return||i.return()}finally{if(o)throw r}}return n}}(t,e)||s(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function s(t,e){if(t){if("string"==typeof t)return o(t,e);var i=Object.prototype.toString.call(t).slice(8,-1);return"Map"===(i="Object"===i&&t.constructor?t.constructor.name:i)||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?o(t,e):void 0}}function o(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,a=new Array(e);i<e;i++)a[i]=t[i];return a}function b(t,e){for(var i=0;i<e.length;i++){var a=e[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}function I(){return(I="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,i){var a=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=x(t)););return t}(t,e);if(a)return a=Object.getOwnPropertyDescriptor(a,e),a.get?a.get.call(arguments.length<3?t:i):a.value}).apply(this,arguments)}function k(t,e){return(k=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function w(i){var a=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(t){return!1}}();return function(){var t,e=x(i),e=(t=a?(t=x(this).constructor,Reflect.construct(e,arguments,t)):e.apply(this,arguments),this);if(t&&("object"===n(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}}function x(t){return(x=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}return t.exports=function(t){function l(t,e){e=new Int32Array(e).fill(0),t.setAttribute("pick",new g.BufferAttribute(e,1))}var g=t.THREE,h=t.Utils,i=t.VG,e=i.Layer,a=t.FormatTransformer,m=t.coordHelper,u=p("datav:/com/@datav-city-pro-v2/datav-engine-3d-icon/2.1.4/material")(g,h.Chroma),r=new g.TextureLoader,d=(r.setCrossOrigin("anonymous"),new g.Matrix4),f=new g.Vector3,y=new g.Matrix4,c=[.5*Math.PI,7*Math.PI/6,11*Math.PI/6],t=o;if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&k(t,e);var n,s=w(o);function o(t){var e;if(this instanceof o)return(e=s.call(this)).classNameAlias="Icon3dLayer",e.layerName=e.classNameAlias,e.renderQueue=i.Geometry,e.needsAutoUpdate=!0,e.options=h.mergeOptions({isSceneGroup:!1,sceneId:["scene1"]},t||{}),e.needsWait=!0,e.formatTransformer=new a,e.enableInteractive=t.options.interactive.enableInteractive,e.init(),e.latestSpeed=e.options.options.animate.speed,e.highlightIdxes=[],e;throw new TypeError("Cannot call a class as a function")}return t=o,(e=[{key:"allowPicking",get:function(){return this.enableInteractive}},{key:"init",value:function(){this.lastTime,this._envMapIntensity=1,this._envMapIntensityFactor=this.options.options.graph.envMapIntensityFactor,this.geometries=new Map,this.geometries.set("geometryTypeA",(t=.5,e=1,r=Math.cos(c[0]),o=Math.sin(c[0]),s=[r*t,o*t],i=[.5*r+.5,.5*o+.5],n=[(r=Math.cos(c[1]))*t,(o=Math.sin(c[1]))*t],a=[.5*r+.5,.5*o+.5],t=[(r=Math.cos(c[2]))*t,(o=Math.sin(c[2]))*t],r=[.5*r+.5,.5*o+.5],o=[0,1,2,3,4,5,7,9,8,7,8,6,10,11,13,10,13,12,14,16,17,14,17,15],n=[s[0],s[1],e*=.5,n[0],n[1],e,t[0],t[1],e,s[0],s[1],-e,t[0],t[1],-e,n[0],n[1],-e,s[0],s[1],e,s[0],s[1],-e,n[0],n[1],e,n[0],n[1],-e,n[0],n[1],e,n[0],n[1],-e,t[0],t[1],e,t[0],t[1],-e,s[0],s[1],e,s[0],s[1],-e,t[0],t[1],e,t[0],t[1],-e],s=[i[0],i[1],a[0],a[1],r[0],r[1],i[0],i[1],a[0],a[1],r[0],r[1],1,1,0,1,1,0,0,0,0,1,0,0,1,1,1,0,0,1,1,1,0,0,1,0],(t=new g.BufferGeometry).setAttribute||(t.setAttribute=t.addAttribute),t.setIndex(new g.BufferAttribute(new Uint16Array(o),1)),t.setAttribute("position",new g.BufferAttribute(new Float32Array(n),3)),t.setAttribute("uv",new g.BufferAttribute(new Float32Array(s),2)),l(t,o.length),t.addGroup(0,6,0),t.addGroup(6,18,1),t.computeVertexNormals(),t.computeBoundingSphere(),t.computeBoundingBox(),t)),this.geometries.set("geometryTypeB",(a=i=e=1,e=new g.BoxBufferGeometry(e,i,a),i=e.groups[0].count+e.groups[1].count+e.groups[2].count+e.groups[3].count,a=e.groups[4].start,r=e.groups[4].count+e.groups[5].count,n=e.attributes.uv.count,l(e,n),e.clearGroups(),e.addGroup(0,i,1),e.addGroup(a,r,0),e)),this.geometries.set("geometryTypeC",function(t,e){for(var i=new g.CylinderBufferGeometry(t,t,e,128,1),t=(i.rotateY(.5*Math.PI),i.rotateX(.5*Math.PI),i.groups[0].start),e=i.groups[0].count,a=i.groups[1].start,r=i.groups[1].count+i.groups[2].count,n=0;n<257;n++){var s=i.getAttribute("uv").getX(515+n),o=i.getAttribute("uv").getY(515+n);i.getAttribute("uv").setX(515+n,1-s),i.getAttribute("uv").setY(515+n,1-o)}var h=i.attributes.uv.count;return l(i,h),i.clearGroups(),i.addGroup(t,e,1),i.addGroup(a,r,0),i}(.5,1));var t,e,i,a,r,n,s=this.options.options.interactive.activeColor,o=h.Chroma(s).gl();this.material0=new u(o),this.material1=new u(o),this._fileCache=new Map,this.updateMaterial()}},{key:"speed",set:function(t){this.latestSpeed=t}},{key:"getSpeedInOption",value:function(){return this.options.options.animate.speed}},{key:"envMapIntensity",set:function(t){this._envMapIntensity=t,this.updateEnvMapIntensity()}},{key:"envMapIntensityFactor",set:function(t){this._envMapIntensityFactor=t,this.updateEnvMapIntensity()}},{key:"getEnvMapIntensityFactorInOption",value:function(){return this.options.options.graph.envMapIntensityFactor}},{key:"addTo",value:function(t){I(x(o.prototype),"addTo",this).call(this,t)}},{key:"show",value:function(){this.options.visible=!0,I(x(o.prototype),"show",this).call(this)}},{key:"hide",value:function(){this.options.visible=!1,I(x(o.prototype),"hide",this).call(this)}},{key:"fetchTexture",value:function(i){var t=this._fileCache.get(i);return t||(t=new Promise(function(t,e){r.load(i,t,null,e)}),this._fileCache.set(i,t)),t}},{key:"setData",value:function(t){var i=this,r=(this.disposeMesh(),1/0),n=1/0,s=1/0,o=-1/0,h=-1/0,l=-1/0,u=[],e=t;if(!Array.isArray(t)){if("FeatureCollection"!==t.type)return this.emit("rendered"),console.error("Icon3dLayer: invalid data format. ",t);e=this.formatTransformer.geojson2datav(t)}if(!e.length)return console.warn("Icon3dLayer: data length is 0. ",t),this.emit("rendered");this.mesh=new g.InstancedMesh(this.geometries.get(this.options.options.graph.geometry.geometryType).clone(),[this.material0.material,this.material1.material],e.length),(this.data=e).forEach(function(t){var e,i=t.lng,a=t.lat,t=t.altitude,t=void 0===t?0:t;i="string"==typeof i?parseFloat(i):i,a="string"==typeof a?parseFloat(a):a,t="string"==typeof t?parseFloat(t):t,"number"==typeof i&&"number"==typeof a&&"number"==typeof t&&(m.setFromValues(i,a,t),m.toXYZ(f),u.push([f.x,f.y,f.z]),i=(e=M(u[u.length-1],3))[0],a=e[1],t=e[2],r=Math.min(i,r),n=Math.min(a,n),s=Math.min(t,s),o=Math.max(i,o),h=Math.max(a,h),l=Math.max(t,l))});var a=.5*(r+o),c=.5*(n+h),p=.5*(s+l);this.center=[a,c,p],(this.projPositions=u).forEach(function(t,e){m.fromXYZ.apply(m,v(t));t=m.transfrom;t.elements[12]-=a,t.elements[13]-=c,t.elements[14]-=p,d.makeRotationY(Math.PI*Math.random()),t.multiply(d),i.mesh.setMatrixAt(e,t)}),this.mesh.position.set(a,c,p),this.add(this.mesh),this.needsWait&&(this.needsWait=!1),this.emit("rendered"),this.cusRaycast=this.cusRaycast.bind(this)}},{key:"dataErrorHandler",value:function(){this.needsWait&&(this.needsWait=!1),this.emit("rendered")}},{key:"cusRaycast",value:function(t){var e=[];if(!this.mesh)return e;var i=this.mesh.matrixWorld,a=this.mesh.count,r=new g.Matrix4,n=[],s=new g.Mesh;if(s.geometry=this.mesh.geometry,s.material=this.mesh.material,void 0!==s.material){for(var o=this.material0,h=o.radY,o=o.scale,l=Math.cos(h*Math.PI),h=Math.sin(h*Math.PI),o=o.clone().multiplyScalar(1.2),u=(new g.Matrix4).set(l*o.x,0,-h*o.x,0,0,o.y,0,0,h*o.z,0,l*o.z,0,0,0,0,1),c=0;c<a;c++){this.mesh.getMatrixAt(c,r);var p=r.clone();r.multiply(u),y.multiplyMatrices(i,r),s.matrixWorld=y,s.raycast(t,n);for(var m=0,d=n.length;m<d;m++){var f=n[m];f.instanceId=c,f.object=this.mesh,f._matrixWorld=y,f._localMatrixWithoutMatSR=p,f.userData=this.data[c],e.push(f)}n.length=0}return e}}},{key:"getPickCandidate",value:function(){return[this]}},{key:"active",value:function(t,e){t=t.instanceId;this.material0&&(this.material0.pickedInstanceId=t),this.material1&&(this.material1.pickedInstanceId=t)}},{key:"inactive",value:function(){this.material0&&(this.material0.pickedInstanceId=-1),this.material1&&(this.material1.pickedInstanceId=-1)}},{key:"highlight",value:function(){for(var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],e=this.highlightIdxes.length=0,i=this.data.length;e<i;e++){var a=this.data[e];t.includes(a.id)&&this.highlightIdxes.push(e)}var r=0<this.highlightIdxes.length;return r||(this.highlightIdxes=[-1]),this.material0&&(this.material0.highlightInstanceIds=this.highlightIdxes),this.material1&&(this.material1.highlightInstanceIds=this.highlightIdxes),r}},{key:"unhightlight",value:function(){this.material0&&(this.material0.highlightInstanceIds=[-1]),this.material1&&(this.material1.highlightInstanceIds=[-1]),this.highlightIdxes.length=0}},{key:"updateEnvMapIntensity",value:function(){this.material0&&this.material1&&(this.material0.envMapIntensity=this._envMapIntensityFactor*this._envMapIntensity,this.material1.envMapIntensity=this._envMapIntensityFactor*this._envMapIntensity)}},{key:"setEnvMap",value:function(t){this.material0&&this.material1&&(this.material0.envMap=t,this.material1.envMap=t)}},{key:"updateMaterial",value:function(t){var e,i,a,r=this;this.material0&&this.material1&&(i=(a=this.options.options).general,a=a.graph,e=i.depthWrite,i=i.depthTest,a=a.geometry,this.material0.depthWrite=e,this.material0.depthTest=i,"geometryTypeB"===a.geometryType?this.material0.scale.set(100*a.scaleX,100*a.scaleY,100*a.scaleZ):this.material0.scale.set(100*a.radius,100*a.radius,100*a.scaleZ),this.material1.scale.copy(this.material0.scale),e=t?t.options.graph:null,i=this.options.options.graph,this.material0.color.fromArray(h.Chroma(i.foreground.color).gl()),this.material1.color.fromArray(h.Chroma(i.background.color).gl()),this.material0.emissive.fromArray(h.Chroma(i.foreground.emissive).gl()),this.material1.emissive.fromArray(h.Chroma(i.background.emissive).gl()),a=this.options.options.interactive.activeColor,t=h.Chroma(a).gl(),this.material0.activeColor=t,this.material1.activeColor=t,this.material0.metalness=i.foreground.metalness,this.material0.roughness=i.foreground.roughness,this.material1.metalness=i.background.metalness,this.material1.roughness=i.background.roughness,e&&e.foreground.map===i.foreground.map||(i.foreground.map?this.fetchTexture(i.foreground.map).then(function(t){t.encoding=g.sRGBEncoding,t.anisotropy=16,r.material0.map=t}):this.material0.map=null),e&&e.foreground.emissiveMap===i.foreground.emissiveMap||(i.foreground.emissiveMap?this.fetchTexture(i.foreground.emissiveMap).then(function(t){t.encoding=g.sRGBEncoding,r.material0.emissiveMap=t}):this.material0.emissiveMap=null),e&&e.foreground.roughnessMap===i.foreground.roughnessMap||(i.foreground.roughnessMap?this.fetchTexture(i.foreground.roughnessMap).then(function(t){r.material0.roughnessMap=t}):this.material0.roughnessMap=null),e&&e.foreground.metalnessMap===i.foreground.metalnessMap||(i.foreground.metalnessMap?this.fetchTexture(i.foreground.metalnessMap).then(function(t){r.material0.metalnessMap=t}):this.material0.metalnessMap=null),e&&e.foreground.normalMap===i.foreground.normalMap||(i.foreground.normalMap?this.fetchTexture(i.foreground.normalMap).then(function(t){r.material0.normalMap=t}):this.material0.normalMap=null),e&&e.background.map===i.background.map||(i.background.map?this.fetchTexture(i.background.map).then(function(t){t.encoding=g.sRGBEncoding,t.anisotropy=16,r.material1.map=t}):this.material1.map=null),e&&e.background.emissiveMap===i.background.emissiveMap||(i.background.emissiveMap?this.fetchTexture(i.background.emissiveMap).then(function(t){t.encoding=g.sRGBEncoding,r.material1.emissiveMap=t}):this.material1.emissiveMap=null),e&&e.background.roughnessMap===i.background.roughnessMap||(i.background.roughnessMap?this.fetchTexture(i.background.roughnessMap).then(function(t){r.material1.roughnessMap=t}):this.material1.roughnessMap=null),e&&e.background.metalnessMap===i.background.metalnessMap||(i.background.metalnessMap?this.fetchTexture(i.background.metalnessMap).then(function(t){r.material1.metalnessMap=t}):this.material1.metalnessMap=null),e&&e.background.normalMap===i.background.normalMap||(i.background.normalMap?this.fetchTexture(i.background.normalMap).then(function(t){r.material1.normalMap=t}):this.material1.normalMap=null))}},{key:"updateOptions",value:function(t){var e=h.deepClone(this.options);this.options=h.mergeOptions(this.options,t||{}),this.updateMaterial(e),this.envMapIntensityFactor=this.options.options.graph.envMapIntensityFactor,this.options.options.graph.geometry.geometryType!==e.options.graph.geometry.geometryType&&this.updateMesh(),h.easyDiff(e.sceneId.length,t.sceneId.length)&&h.deepDiff(e.sceneId,t.sceneId)||this.updateSceneId(),h.easyDiff(e.options.animate.speed,t.options.animate.speed)||(this.latestSpeed=t.options.animate.speed),this.enableInteractive=t.options.interactive.enableInteractive,this.enableInteractive||this.inactive()}},{key:"updateMesh",value:function(){if(this.mesh){for(var t=new g.InstancedMesh(this.geometries.get(this.options.options.graph.geometry.geometryType).clone(),[this.material0.material,this.material1.material],this.mesh.count),e=0;e<this.mesh.count;e++)this.mesh.getMatrixAt(e,d),t.setMatrixAt(e,d);t.position.copy(this.mesh.position),this.disposeMesh(),this.mesh=t,this.add(this.mesh)}}},{key:"autoUpdate",value:function(){this.animate()}},{key:"animate",value:function(){var t,e=this.latestSpeed;0!==e&&(t=performance.now(),this.lastTime||(this.lastTime=t),e=.1*e*(.001*(t-this.lastTime)),this.material0&&(this.material0.radY=(this.material0.radY+e)%2),this.material1&&(this.material1.radY=(this.material1.radY+e)%2),this.lastTime=t)}},{key:"disposeMesh",value:function(){this.mesh&&(this.remove(this.mesh),this.mesh.geometry.dispose(),this.mesh=null)}},{key:"disposeTextures",value:function(){this._fileCache.forEach(function(t){t.then(function(t){t.dispose(),t.image&&t.image.src&&(t.image.src="")})}),this._fileCache.clear()}},{key:"clear",value:function(){I(x(o.prototype),"clear",this).call(this),this.material0&&(this.material0.dispose(),this.material0=null),this.material1&&(this.material1.dispose(),this.material1=null),this.disposeTextures(),this.data&&(this.data.length=0)}},{key:"destroy",value:function(){this.clear(),I(x(o.prototype),"destroy",this).call(this)}}])&&b(t.prototype,e),n&&b(t,n),Object.defineProperty(t,"prototype",{writable:!1}),o},t.exports});;
Cube("datav:/com/@datav-city-pro-v2/datav-engine-3d-icon/2.1.4",["datav:/npm/eventemitter3/3.0.0"],function(e,t,r,n,i,o){function a(e){return(a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function c(t,e){var r,n=Object.keys(t);return Object.getOwnPropertySymbols&&(r=Object.getOwnPropertySymbols(t),e&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),n.push.apply(n,r)),n}function l(n){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?c(Object(i),!0).forEach(function(e){var t,r;t=n,r=i[e=e],e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(i)):c(Object(i)).forEach(function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(i,e))})}return n}function u(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function s(e,t){return(s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function y(r){var n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=f(r),t=(e=n?(e=f(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),this);if(e&&("object"===a(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");if(void 0!==t)return t;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}}function f(e){return(f=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var p=r("datav:/npm/eventemitter3/3.0.0"),h=r("datav:/com/@datav-city-pro-v2/datav-engine-3d-icon/2.1.4/icon3d"),r=function(){var e=i,t=p;if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&s(e,t);var r,n=y(i);function i(e,t){var r;if(this instanceof i)return(r=n.call(this)).options=t,r.comId="",r.type="Icon3d",r.isActived=!1,r;throw new TypeError("Cannot call a class as a function")}return e=i,(t=[{key:"addTo",value:function(e,t){this.cityproCore=e,this.comId=t,this.initLayer()}},{key:"setEnvMap",value:function(e){this.layer&&(this.layer.envMapIntensity=e.properties,this.layer.setEnvMap(e.value))}},{key:"initLayer",value:function(){var e=h(this.cityproCore);this.layer=new e(this.options),this.cityproCore.viewer.addLayer(this.comId,this.layer)}},{key:"setData",value:function(e){e&&this.layer&&this.layer.setData(e)}},{key:"errorRender",value:function(){console.log("三维图标组件数据错误"),this.layer&&this.layer.dataErrorHandler()}},{key:"enableInteractive",get:function(){return!!this.layer&&this.layer.enableInteractive}},{key:"active",value:function(e,t){var r={clickPosition:{x:e.offsetX,y:e.offsetY},data:l({},t.userData)};return 0===e.button&&(this.layer.active(t,e),this.emit("leftClick",r),this.isActived=!0),this.isActived}},{key:"inactive",value:function(){this.isActived&&this.layer&&this.layer.inactive&&this.layer.inactive(),this.isActived=!1}},{key:"highlight",value:function(){var e=(0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}).ids;this.layer.highlight(e)}},{key:"unhighlight",value:function(){this.layer.unhightlight()}},{key:"animate",value:function(){this.layer&&this.layer.animate()}},{key:"show",value:function(){this.layer&&this.layer.show()}},{key:"hide",value:function(){this.layer&&this.layer.hide()}},{key:"updateEnvMapIntensityFactor",value:function(e){this.layer&&(this.layer.envMapIntensityFactor=e)}},{key:"envMapIntensityFactorInOption",value:function(){return this.layer.getEnvMapIntensityFactorInOption()}},{key:"updateSpeed",value:function(e){this.layer&&(this.layer.speed=e)}},{key:"speedInOption",value:function(){return this.layer.getSpeedInOption()}},{key:"updateOptions",value:function(e){this.layer&&this.layer.updateOptions(e)}},{key:"remove",value:function(){this.clear(),console.log("remove is duplicate, please use clear instead.")}},{key:"clear",value:function(){this.layer&&this.layer.clear&&this.layer.clear()}},{key:"destroy",value:function(){this.layer&&this.layer.destroy&&this.layer.destroy()}}])&&u(e.prototype,t),r&&u(e,r),Object.defineProperty(e,"prototype",{writable:!1}),i}();return e.exports=r,e.exports});