// env=undefined => env=publish 
Cube("datav:/com/pie-percent/1.2.13",["datav:/npm/bcore/0.0.18/event","datav:/npm/jquery/2.1.4","datav:/npm/lodash/4.6.1","datav:/npm/d3/3.5.12","datav:/npm/chroma-js/1.2.1"],function(a,b,c){var d=c("datav:/npm/bcore/0.0.18/event"),e=c("datav:/npm/jquery/2.1.4"),f=c("datav:/npm/lodash/4.6.1"),g=c("datav:/npm/d3/3.5.12"),h=c("datav:/npm/chroma-js/1.2.1");return a.exports=d.extend(function(a,b){this.config={theme:{bg:["#000","#f9f9f9"],font:["#eee","#252525"],colors:["#444547","#A0AAB3"]},chart:{_innerRadius:0.6,_outerRadius:0.8,color:"#234591"},arc:{startColor:"#00ffcc",endColor:"#2b80cf",animationTime:2000},percent:{sizePercent:0.7,numberFontSize:30,percentFontSize:20,decimal:0,textStyle:{fontFamily:"Microsoft Yahei",color:"#FFF",fontWeight:"normal"}}},this.container=e(a),this.d3container=g.select(a),this.apis=null,this._data=0,this.chart=null,this.init(b),this.dataChanged=!1,this.cfgChanged=!1},{initSvg:function(){var a=this.container;a.empty(),a.css("background","transparent"),this.svg=this.d3container.append("svg").attr("width",a.width()).attr("height",a.height()),this.g=this.svg.append("g").attr("transform","translate("+a.width()/2+","+a.height()/2+")")},initPercent:function(){var a=this.config,b=this.config.percent.textStyle,c=this.container,d=a.percent.percentMargin||0,f=a.percent.percentSymbol||"%",g="<div class=\"percent-box\"><div class=\"number\" style=\"display: inline-block;font-size:"+a.percent.numberFontSize+"px\">0</div><span class=\"percent\" style=\"font-size:"+a.percent.percentFontSize+"px;margin-left:"+d+"px\">"+f+"</span></div>",h=Math.round(2*Math.min(a.chart.innerRadius,a.chart.outerRadius)*a.percent.sizePercent);this.percentNode=e(g).css({position:"absolute",background:"transparent",width:h,height:h,"line-height":h+"px",top:"calc(50% - "+h/2+"px)",left:"calc(50% - "+h/2+"px)","font-family":"\""+b.fontFamily+"\"",color:b.color,"text-anchor":"middle","text-align":"center","font-weight":b.fontWeight}),c.append(this.percentNode)},init:function(a){var b=this.mergeConfig(a);this.initSvg(),this.initPercent(),this.pieRender(b)},setLoading:function(a){var b=this.config,c=this,d=2*(a*Math.PI);this.arc.data([{startAngle:d}]).interrupt().transition().duration(b.arc.animationTime).attrTween("d",function(h){this._current=this._current||{startAngle:0};var d=g.interpolate(this._current,h);this._current=h;var i=c.percentNode.find(".number")[0],j=g.interpolate(0,100*a);return function(a){return e(i).html(j(a).toFixed(f.isNumber(b.percent.decimal)?b.percent.decimal:0)),c.entry(d(a))}})},setEmpty:function(){this.setLoading(0)},pieRender:function(a){var b=a.chart.outerRadius,c=a.chart.innerRadius;this.g.selectAll("path").remove(),this.entry=g.svg.arc().innerRadius(c).outerRadius(b).endAngle(2*Math.PI),this.pie=g.svg.arc().innerRadius(c).outerRadius(b);var d=a.arc.startColor,e=a.arc.endColor,f=h.scale([d,e]).mode("lch").correctLightness(),i=g.range(360).map(function(a,b){return{startAngle:b*(Math.PI/180),endAngle:(b+1)*(Math.PI/180),fill:f(b/360)}});this.bgPie=this.g.selectAll(".bg-pie").append("g").data(i).enter().append("path").attr({class:"bg-pie",d:this.pie}).style({fill:function(a){return a.fill},stroke:function(a){return a.fill},"stroke-width":0.5});this.arc=this.g.selectAll(".arc").append("g").data([{startAngle:0}]).enter().append("path").attr({class:"arc",d:this.entry}).style({fill:a.chart.color,stroke:a.chart.color,"stroke-width":1})},render:function(a,b){var c=this.mergeConfig(b);a=this.data(a),this.cfgChanged?(this.svg.attr("width",c.width).attr("height",c.height),this.g.attr("transform","translate("+c.width/2+","+c.height/2+")"),this.pieRender(c),this.setLoading(a)):this.dataChanged&&this.setLoading(a)},updatePercent:function(a){if(a.decimal!==this.config.percent.decimal)return this.render(null,{percent:a});var b=this.mergeConfig({percent:a}),c=this.container,d=c.find(".percent-box"),e=d.find(".number"),f=d.find(".percent"),g=Math.round(2*Math.min(b.chart.innerRadius,b.chart.outerRadius)*b.percent.sizePercent);d.css({color:b.percent.textStyle.color,"font-family":"\""+b.percent.textStyle.fontFamily+"\"","font-weight":b.percent.textStyle.fontWeight,width:g,height:g,"line-height":g+"px",top:"calc(50% - "+g/2+"px)",left:"calc(50% - "+g/2+"px)"});var h=b.percent.percentMargin||0,i=b.percent.percentSymbol||"%";b.percent.percentPosition&&"front"===b.percent.percentPosition?(f.after(e),f.css({"margin-right":h,"font-size":b.percent.percentFontSize})):(e.after(f),f.css({"margin-left":h,"font-size":b.percent.percentFontSize})),f.html(i),e.css({"font-size":b.percent.numberFontSize})},resize:function(a,b){this.mergeConfig({width:a,height:b}),this.render()},data:function(a){this.dataChanged=!1;var b;return a&&a[0]?(this._data!==a[0].value&&(this.dataChanged=!0),b=Math.abs(a[0].value||0),b=1<b?1:b,this._data=b):b=this._data||0,b},mergeConfig:function(a){if(!a)return this.config;var b=this.config;b.width=b.width||this.container.width(),b.height=b.height||this.container.height();var c=f.cloneDeep(a),d=f.defaultsDeep(a||{},b);return f.isEqual(b,d)?this.cfgChanged=!1:(this.config=d,this._calculatePieConfig(),this.cfgChanged=!0),this.config},_calculatePieConfig:function(a,b){a||(a=this.container.width()),b||(b=this.container.height());var c=Math.min(a,b)/2,d=this.config;this.config.width=a,this.config.height=b,this.config.chart.radius=c,this.config.chart.innerRadius=Math.round(c*this.config.chart._innerRadius),this.config.chart.outerRadius=Math.round(c*this.config.chart._outerRadius)},destroy:function(){this.chart=null,this.container&&this.container.empty(),this._data=null}}),a.exports});