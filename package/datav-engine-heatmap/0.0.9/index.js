// env=undefined => env=publish 
Cube("datav:/com/datav-engine-heatmap/0.0.9/shader/heatmap.frag.glsl",[],function(a){return a.exports="#ifdef GL_ES\n  precision highp float;\n#define GLSLIFY 1\n#endif\n\nvarying vec2 v_uv;\nvarying float v_width_seg;\nvarying float v_height_seg;\nvarying float v_grid_width;\nuniform sampler2D u_texture;\n#include <logdepthbuf_pars_fragment>\n\nvoid main() {\n  #include <logdepthbuf_fragment>\n  float opacity = 1.;\n\n  if(mod(v_uv.x, 1. / v_width_seg) < v_grid_width * 2. || mod(v_uv.y, 1. / v_height_seg) < v_grid_width * 2.) {\n    discard;\n  } else {\n    // opacity = smoothstep(0., v_grid_width * 4., mod(v_uv.x, 0.01) + mod(v_uv.y, 0.01));\n  }\n\n  vec4 color = texture2D(u_texture, v_uv);\n  color.a *= opacity;\n  gl_FragColor = color;\n  #include <premultiplied_alpha_fragment>\n}",a.exports});;
Cube("datav:/com/datav-engine-heatmap/0.0.9/shader/heatmap.vert.glsl",[],function(a){return a.exports="\n#ifdef GL_ES\n  precision highp float;\n#define GLSLIFY 1\n#endif\n\nvarying vec2 v_uv;\nvarying float v_width_seg;\nvarying float v_height_seg;\nvarying float v_grid_width;\n\nuniform float u_scale;\nuniform float u_width_seg;\nuniform float u_height_seg;\nuniform float u_grid_width;\nuniform vec3 u_source_color;\nuniform vec3 u_target_color;\nuniform sampler2D u_texture;\n#include <logdepthbuf_pars_vertex>\n\nfloat getIndex(float a, float b, float x){\n  if(a == b) return 0.0;\n  return (x - a) / (b - a);\n}\n\nfloat getZ(vec4 color){\n  float r_delta = getIndex(u_source_color.r, u_target_color.r, color.r);\n  float g_delta = getIndex(u_source_color.g, u_target_color.g, color.g);\n  float b_delta = getIndex(u_source_color.b, u_target_color.b, color.b);\n\n  return ((r_delta + g_delta + b_delta) / 3.0) * u_scale;\n}\n\nfloat decodeRGBA2Float( vec4 color ) {\n  return dot( color, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0));\n}\n\nvoid main() {\n  v_uv = uv;\n  v_width_seg = u_width_seg;\n  v_height_seg = u_height_seg;\n  v_grid_width = u_grid_width;\n  vec4 color = texture2D(u_texture, uv);\n  float z = position.z + getZ(color);\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(position.xy, z, 1.0);\n  #include <logdepthbuf_vertex>\n}",a.exports});;
Cube("datav:/com/datav-engine-heatmap/0.0.9/layer.js",["datav:/npm/eventemitter3/3.0.0"],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"===typeof b||"function"===typeof b)?b:a}function f(a,b){if("function"!==typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=c("datav:/npm/eventemitter3/3.0.0"),i=function(a){function b(){d(this,b);var a=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return a.preSceneName="main",a.usingSceneName="main",a}return f(b,a),g(b,[{key:"addTo",value:function(a){return a?void(this.viewer=a,this.Utils=a.Utils,this.controller=a.controller,this.scene=this.getAssignedScene(),this.viewer.on("projChanged",this.updatePostions.bind(this))):console.log("Layer needs viewer layer")}},{key:"getProjPos",value:function(a,b,c){return this.viewer&&this.viewer.Projection([a,b,c])}},{key:"updatePostions",value:function(){}},{key:"getAssignedScene",value:function(){var a=this.options;return a.isSceneGroup&&a.sceneName?a.sceneName?this.controller.getScene(a.sceneName)?this.controller.getScene(a.sceneName):this.controller.createScene(a.sceneName):void 0:this.controller.getScene("main")}},{key:"toggleScene",value:function(a,b,c){var d=this;this.controller.switchScene(a,b,c).then(function(){d.preSceneName=b,d.usingSceneName=c})}},{key:"show",value:function(){throw new Error("method: show must be overwritten")}},{key:"hide",value:function(){throw new Error("method: hide must be overwritten")}},{key:"updateOptions",value:function(){}}]),b}(h);return a.exports=i,a.exports});;
Cube("datav:/com/datav-engine-heatmap/0.0.9",["datav:/npm/simpleheat/0.4.0"],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"===typeof b||"function"===typeof b)?b:a}function f(a,b){if("function"!==typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=function a(b,c,d){null===b&&(b=Function.prototype);var e=Object.getOwnPropertyDescriptor(b,c);if(void 0===e){var f=Object.getPrototypeOf(b);return null===f?void 0:a(f,c,d)}if("value"in e)return e.value;var g=e.get;return void 0===g?void 0:g.call(d)},i=null,j=null,k=c("datav:/com/datav-engine-heatmap/0.0.9/layer.js"),l=c("datav:/npm/simpleheat/0.4.0"),m=function(a){function b(a,c){d(this,b);var f=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return f.options=Object.assign({visible:!0,width:145,height:75,widthSeg:100,heightSeg:100,gridWidth:1e-3,minOpacity:0.6,maxZoom:18,zScale:1,radius:5,blur:15,max:1,offsetX:0,offsetY:0,offsetZ:0,rotationX:0,rotationY:0,rotationZ:0},c||{}),f}return f(b,a),g(b,[{key:"addTo",value:function(a){h(b.prototype.__proto__||Object.getPrototypeOf(b.prototype),"addTo",this).call(this,a),i=a.three,j=a.Utils,this.init()}},{key:"init",value:function(){var a=this.options,b=this.options.width,c=this.options.height,d=this.canvas=document.createElement("canvas");d.width=b,d.height=c,this.heatmap=new l(d),this.updateHeatmapOptions();var e=this.texture=new i.Texture(d);e.anisotropy=this.viewer.renderer.getMaxAnisotropy();var f=this.material=this.initMaterial(),g=this.geometry=new i.PlaneBufferGeometry(1,1,100,100),h=this.mesh=new i.Mesh(g,f);h.renderOrder=500,this.setRotation(),this.setScale(),this.updatePostions(),this.scene.add(h)}},{key:"initMaterial",value:function(){var a=this.options,b=a.gradient,d=j.Chroma(b["0.0"]).gl(),e=j.Chroma(b["1.0"]).gl();return new i.ShaderMaterial({uniforms:{u_scale:{value:a.zScale},u_texture:{value:this.texture},u_width_seg:{value:a.widthSeg},u_height_seg:{value:a.heightSeg},u_grid_width:{value:a.gridWidth},u_source_color:{value:new i.Vector3(d[0],d[1],d[2])},u_target_color:{value:new i.Vector3(e[0],e[1],e[2])}},vertexShader:c("datav:/com/datav-engine-heatmap/0.0.9/shader/heatmap.vert.glsl"),fragmentShader:c("datav:/com/datav-engine-heatmap/0.0.9/shader/heatmap.frag.glsl"),side:i.DoubleSide,blending:i.NormalBlending,depthTest:!0,depthWrite:!0,transparent:!0,polygonOffset:!0,polygonOffsetUnits:1,polygonOffsetFactor:0.75})}},{key:"setData",value:function(a){if(!a||!Array.isArray(a))return console.log("heatmap layer no data");if(!a.length){this.heatmap&&this.heatmap.clear();var b=this.canvas.width,c=this.canvas.height;this.canvas.getContext("2d").clearRect(0,0,b,c),this.texture.needsUpdate=!0}else this.ds=a,this.render();this.checkVisible()}},{key:"checkVisible",value:function(){var a=this.options;a.visible?this.show():this.hide()}},{key:"show",value:function(){this.options.visible=!0,this.mesh&&(this.mesh.visible=!0)}},{key:"hide",value:function(){this.options.visible=!1,this.mesh&&(this.mesh.visible=!1)}},{key:"render",value:function(){this.heatmap.resize();var a=this.options,b=a.width,c=a.height,d=a.gradient,e=j.Chroma(d["0.0"]).gl(),f=j.Chroma(d["1.0"]).gl(),g=this.ds.map(function(a){return[a.x*b,a.y*c,void 0===a.value?1:a.value]});this.heatmap.data(g).draw(a.minOpacity),this.material.uniforms.u_texture.value=this.texture,this.material.uniforms.u_scale.value=a.zScale,this.material.uniforms.u_width_seg.value=a.widthSeg,this.material.uniforms.u_height_seg.value=a.heightSeg,this.material.uniforms.u_grid_width.value=a.gridWidth,this.material.uniforms.u_source_color.value=new i.Vector3(e[0],e[1],e[2]),this.material.uniforms.u_target_color.value=new i.Vector3(f[0],f[1],f[2]),this.material.needsUpdate=!0,this.texture.needsUpdate=!0}},{key:"setScale",value:function(){var a=this.options;this.mesh&&this.mesh.scale.set(0.01*a.width,0.01*a.height,1)}},{key:"setRotation",value:function(){var a=this.options,b=a.rotationX,c=a.rotationY,d=a.rotationZ;this.mesh&&this.mesh.rotation.set(b*Math.PI,c*Math.PI,d*Math.PI)}},{key:"updatePostions",value:function(){var a=this.options,b=this.getProjPos(a.offsetX,a.offsetY,a.offsetZ);this.mesh.position.set(b[0],b[1],b[2])}},{key:"redraw",value:function(){this.updateCanvas(),this.updateHeatmapOptions(),this.render(),this.setRotation(),this.setScale(),this.updatePostions()}},{key:"updateCanvas",value:function(){var a=this.options;this.canvas.width=a.width,this.canvas.height=a.height}},{key:"updateHeatmapOptions",value:function(){var a=this.options;this.heatmap.radius(a.radius,a.blur),a.gradient&&this.heatmap.gradient(a.gradient),a.max&&this.heatmap.max(a.max)}},{key:"updateOptions",value:function(a){var b=j.deepClone(this.options);this.options=j.mergeOptions(this.options,a||{}),this.redraw(),this.checkVisible(),j.easyDiff(b.sceneName,a.sceneName)||(this.scene=this.getAssignedScene(),this.toggleScene(this.mesh,this.usingSceneName,a.sceneName))}},{key:"remove",value:function(){this.mesh&&(this.scene.remove(this.mesh),this.mesh.dispose&&this.mesh.dispose(),this.mesh.geometry.dispose&&this.mesh.geometry.dispose(),this.mesh.material.dispose&&this.mesh.material.dispose()),this.mesh=null,this.heatmap.clear(),this.heatmap=null,this.canvas=null}}]),b}(k);return a.exports=m,a.exports});