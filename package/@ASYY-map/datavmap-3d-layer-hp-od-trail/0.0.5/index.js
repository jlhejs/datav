// env=undefined => env=publish 
Cube("datav:/com/datavmap-3d-layer-hp-od-trail/0.0.5/tubeFrag.js",[],function(a){return a.exports="\n#ifdef GL_ES\n  precision highp float;\n#endif\n\nuniform float uTimeCounter;\nuniform float uTrailLength;\nuniform vec3 uColor;\nvarying vec2 vUv;\n\nfloat calculateTimeContrlOpacity(float timeCounter, vec2 vUv) {\n  float uvGap = uTrailLength;\n  float uvTail = timeCounter - uvGap;\n\n  if((vUv.x < timeCounter) && (vUv.x > uvTail)) {\n    float opacity = (1.0 - (timeCounter - vUv.x) / uvGap);\n    opacity *= opacity;\n    opacity /= 1.3;\n\n    return opacity;\n  } else {\n    return 0.0;\n  }\n}\n\nvoid main() {\n  float currentOpacity = calculateTimeContrlOpacity(uTimeCounter, vUv);\n  // vec3 color = vec3(0.9, 0.3, 0.1);\n  // gl_FragColor = vec4(color, 1.0);\n  gl_FragColor = vec4(uColor, currentOpacity);\n}\n",a.exports});;
Cube("datav:/com/datavmap-3d-layer-hp-od-trail/0.0.5/tubeVertStill.js",[],function(a){return a.exports="\nvarying vec2 vUv;\n\nvoid main() {\n  vUv = uv;\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}\n",a.exports});;
Cube("datav:/com/datavmap-3d-layer-hp-od-trail/0.0.5/tubeFragStill.js",[],function(a){return a.exports="\n#ifdef GL_ES\n  precision highp float;\n#endif\n\nuniform float uTimeCounter;\nuniform float uTrailLength;\nuniform vec3 uColor;\nvarying vec2 vUv;\n\nfloat calculateTimeContrlOpacity(float timeCounter, vec2 vUv) {\n  float uvGap = uTrailLength;\n  float uvTail = timeCounter - uvGap;\n\n  if((vUv.x < timeCounter) && (vUv.x > uvTail)) {\n    float opacity = (1.0 - (timeCounter - vUv.x) / uvGap);\n    opacity *= opacity;\n    opacity /= 1.3;\n\n    return opacity;\n  } else {\n    return 0.0;\n  }\n}\n\nvoid main() {\n  float currentOpacity = calculateTimeContrlOpacity(uTimeCounter, vUv);\n  vec3 color = vec3(0.9, 0.3, 0.1);\n  gl_FragColor = vec4(color, 1.0);\n  // gl_FragColor = vec4(uColor, currentOpacity);\n}\n",a.exports});;
Cube("datav:/com/datavmap-3d-layer-hp-od-trail/0.0.5/tubeVert.js",[],function(a){return a.exports="\nvarying vec2 vUv;\n\nvoid main() {\n  vUv = uv;\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}\n",a.exports});;
Cube("datav:/com/datavmap-3d-layer-hp-od-trail/0.0.5/HpOdTrailLayer.js",["datav:/npm/eventemitter3/2.0.3","datav:/npm/safely-merge/1.0.1","datav:/npm/chroma-js/1.3.4"],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"===typeof b||"function"===typeof b)?b:a}function f(a,b){if("function"!==typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=c("datav:/npm/eventemitter3/2.0.3"),j=c("datav:/npm/safely-merge/1.0.1"),i=c("datav:/npm/chroma-js/1.3.4"),k=c("datav:/com/datavmap-3d-layer-hp-od-trail/0.0.5/tubeVert.js"),l=c("datav:/com/datavmap-3d-layer-hp-od-trail/0.0.5/tubeFrag.js"),m=c("datav:/com/datavmap-3d-layer-hp-od-trail/0.0.5/tubeVertStill.js"),n=c("datav:/com/datavmap-3d-layer-hp-od-trail/0.0.5/tubeFragStill.js");return a.exports=function(a){var b=a.datavgl,c=b.THREE,m=a.glLayer||a,n=b.DataVModelTools.point2buffer,o=a.worldsize,p={};return function(a){function b(a){d(this,b);var c=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return a=j(p,a),c.options=j(c.options,a),c.animate=c.animate.bind(c),c.init(),c}return f(b,a),g(b,[{key:"init",value:function(){this.meshGroup=new c.Group,m.on("runAnimation",this.animate)}},{key:"pixelsPerMeter",value:function(a){return 512/(6378137*(2*Math.PI)*Math.abs(Math.cos(a*(Math.PI/180))))}},{key:"setData",value:function(a){if(a&&a.length){this.disposeMesh(),this.meshGroup=new c.Group,this.latBench=a[0].from.lat;var b=this.preProcessData(a),d=n(b,{worldsize:o});this.positionData=d.positions,this.hostBuffer={},this.hostBuffer.positionArray=[],this.hostBuffer.normalArray=[],this.hostBuffer.uvArray=[],this.hostBuffer.indexArray=[],this.geometryList=[];for(var e=0;e<this.positionData.length;e+=6){var f=new c.Vector3(this.positionData[e+0],this.positionData[e+1],this.positionData[e+2]),g=new c.Vector3(this.positionData[e+3],this.positionData[e+4],this.positionData[e+5]),h=this.calculateRaiboVertex(f,g),i=this.createRainbowGeometry(h,this.latBench);this.geometryList.push(i),this.mergeGeometryBuffer(this.hostBuffer,i)}this.trailMerged=this.createBufferMesh(this.hostBuffer,this.latBench),this.meshGroup.add(this.trailMerged),this.trailStillMerged=this.createStillBufferMesh(this.hostBuffer,this.latBench),this.meshGroup.add(this.trailStillMerged),this.meshGroup.visible=this.options.visibility,m.offsetNode.add(this.meshGroup),m.emit("init-offset")}}},{key:"preProcessData",value:function(a){var b=[];return a.forEach(function(a){b.push(a.from),b.push(a.to)}),b}},{key:"calculateRaiboVertex",value:function(a,b){var d=this.options.trailRainbowHeight/5,e=[],f=new c.Vector3(0,0,0),g=f.addVectors(a,b).divideScalar(2),h=new c.Vector3(0,0,0),i=h.subVectors(a,b).length()/4*d,j=new c.Vector3(g.x,g.y,i);return e.push(a,j,b),e}},{key:"createRainbowGeometry",value:function(a,b){var d=new c.CatmullRomCurve3(a),e=this.pixelsPerMeter(b),f={path:d,tubularSegments:20*a.length,radius:this.options.trailRadius*this.options.trailRadiusMultiply*e,radiusSegments:16,closed:!1},g=new c.TubeBufferGeometry(f.path,f.tubularSegments,f.radius,f.radiusSegments,f.closed);return g.needsOffset=!0,g}},{key:"createStillBufferMesh",value:function(a,b){var d=this.pixelsPerMeter(b),e=new c.BufferGeometry;e.setIndex(new c.BufferAttribute(new Uint32Array(a.indexArray),1)),e.addAttribute("position",new c.BufferAttribute(new Float32Array(a.positionArray),3)),e.addAttribute("normal",new c.BufferAttribute(new Float32Array(a.normalArray),3)),e.addAttribute("uv",new c.BufferAttribute(new Float32Array(a.uvArray),2)),e.needsOffset=!0;var f=i(this.options.trailStillColor).gl(),g=new c.MeshBasicMaterial({color:new c.Color(f[0],f[1],f[2]),side:c.DoubleSide,blending:c.AdditiveBlending,depthTest:!0,depthWrite:!1,transparent:!0,opacity:this.options.trailStillOpacity});g.needsUpdate=!0;var h=new c.Mesh(e,g);return h.scale.setZ(1/d),h.frustumCulled=!1,h}},{key:"createBufferMesh",value:function(a,b){var d=this.pixelsPerMeter(b),e=new c.BufferGeometry;e.setIndex(new c.BufferAttribute(new Uint32Array(a.indexArray),1)),e.addAttribute("position",new c.BufferAttribute(new Float32Array(a.positionArray),3)),e.addAttribute("normal",new c.BufferAttribute(new Float32Array(a.normalArray),3)),e.addAttribute("uv",new c.BufferAttribute(new Float32Array(a.uvArray),2)),e.computeBoundingBox(),e.computeVertexNormals(),e.needsOffset=!0;var f=i(this.options.trailColor).gl(),g=new c.ShaderMaterial({uniforms:{uColor:{value:new c.Vector3(f[0],f[1],f[2])},uTrailLength:{value:this.options.trailLength},uTimeCounter:{value:0}},vertexShader:k,fragmentShader:l,side:c.DoubleSide,depthTest:!0,depthWrite:!1,transparent:!0});g.needsUpdate=!0;var h=new c.Mesh(e,g);return h.scale.setZ(1/d),h.frustumCulled=!1,h}},{key:"mergeGeometryBuffer",value:function(a,b){var c=a.positionArray.length/3,d=Array.from(b.attributes.position.array),e=Array.from(b.attributes.normal.array),f=Array.from(b.attributes.uv.array),g=Array.from(b.index.array);[].push.apply(a.positionArray,d),[].push.apply(a.normalArray,e),[].push.apply(a.uvArray,f);var h=this.offsetIndex(c,g);[].push.apply(a.indexArray,h)}},{key:"offsetIndex",value:function(a,b){var c=b.map(function(b){return b+a});return c}},{key:"destoryTrail",value:function(a){this.meshGroup.remove(a),a&&a.geometry.dispose(),a&&a.material.dispose(),a=null}},{key:"animate",value:function(){var a=this;this.meshGroup.children.forEach(function(b){b.material.uniforms&&(b.material.uniforms.uTimeCounter.value+=a.options.trailSpeed,1<b.material.uniforms.uTimeCounter.value&&(b.material.uniforms.uTimeCounter.value=0))})}},{key:"disposeMesh",value:function(){m.disposeNode(this.meshGroup),m.offsetNode.remove(this.meshGroup),this.meshGroup=null,this.geometryList&&(this.geometryList.forEach(function(a){a.dispose(),a=null}),this.geometryList=[]),this.hostBuffer&&(this.hostBuffer={},this.hostBuffer.positionArray=[],this.hostBuffer.normalArray=[],this.hostBuffer.uvArray=[],this.hostBuffer.indexArray=[])}},{key:"updateOptions",value:function(a){this.options=j(this.options,a),this.disposeMesh(),this.meshGroup=new c.Group;for(var b=0;b<this.positionData.length;b+=6){var d=new c.Vector3(this.positionData[b+0],this.positionData[b+1],this.positionData[b+2]),e=new c.Vector3(this.positionData[b+3],this.positionData[b+4],this.positionData[b+5]),f=this.calculateRaiboVertex(d,e),g=this.createRainbowGeometry(f,this.latBench);this.geometryList.push(g),this.mergeGeometryBuffer(this.hostBuffer,g)}this.trailMerged=this.createBufferMesh(this.hostBuffer,this.latBench),this.meshGroup.add(this.trailMerged),this.trailStillMerged=this.createStillBufferMesh(this.hostBuffer,this.latBench),this.meshGroup.add(this.trailStillMerged),this.meshGroup.visible=this.options.visibility,m.offsetNode.add(this.meshGroup),m.emit("init-offset")}},{key:"show",value:function(){this.options.visibility=!0,this.meshGroup&&(this.meshGroup.visible=!0)}},{key:"hide",value:function(){this.options.visibility=!1,this.meshGroup&&(this.meshGroup.visible=!1)}},{key:"remove",value:function(){m.off("runAnimation",this.animate),this.disposeMesh(),this.hostBuffer&&(this.hostBuffer={})}}]),b}(h)},a.exports});;
Cube("datav:/com/datavmap-3d-layer-hp-od-trail/0.0.5",["datav:/npm/eventemitter3/2.0.3","datav:/npm/safely-merge/1.0.1"],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"===typeof b||"function"===typeof b)?b:a}function f(a,b){if("function"!==typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=c("datav:/npm/eventemitter3/2.0.3"),i=c("datav:/npm/safely-merge/1.0.1"),j=c("datav:/com/datavmap-3d-layer-hp-od-trail/0.0.5/HpOdTrailLayer.js"),k={},l=function(a){function b(a,c){d(this,b);var f=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return f.container="string"===typeof a?document.querySelector(a):a,f.apis=c.apis,f.map=null,f._data=null,f.config=c,f}return f(b,a),g(b,[{key:"initLayer",value:function(){var a=this.getOptions(),b=j(this.map);this.layer=new b(a),this.render(this.data)}},{key:"init",value:function(){var a=this;this.resetID&&clearTimeout(this.resetID),this.resetID=setTimeout(function(){a.map.glLayer.loaded?(a.resetID&&clearTimeout(a.resetID),a.initLayer()):a.init()},100)}},{key:"addTo",value:function(a){var b=this;this.map=a,this.init(),this.endID=setTimeout(function(){b.resetID&&clearTimeout(b.resetID)},300000)}},{key:"getOptions",value:function(){return this.config=i(k,this.config),this.config}},{key:"show",value:function(){this.config.visibility=!0,this.layer&&this.layer.show&&this.layer.show()}},{key:"hide",value:function(){this.config.visibility=!1,this.layer&&this.layer.hide&&this.layer.hide()}},{key:"remove",value:function(){this.endID&&clearTimeout(this.endID),this.resetID&&clearTimeout(this.resetID),this.layer&&this.layer.remove&&this.layer.remove(),this.layer=null,this._data=null,this.data=null}},{key:"render",value:function(a){this.data=a,this.layer&&this.layer.setData(a)}},{key:"updateOptions",value:function(a){this.config=i(this.config,a),a=this.getOptions(),this.layer&&this.layer.updateOptions(a)}}]),b}(h);return a.exports=l,a.exports});