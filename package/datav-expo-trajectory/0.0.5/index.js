// env=undefined => env=publish 
Cube("datav:/com/datav-expo-trajectory/0.0.5/trajectory",["datav:/npm/chroma-js/1.3.4","datav:/npm/eventemitter3/3.0.0","datav:/npm/safely-merge/1.0.1"],function(a,b,c){let e=null;const d=c("datav:/npm/chroma-js/1.3.4"),f=c("datav:/npm/eventemitter3/3.0.0"),g=c("datav:/npm/safely-merge/1.0.1"),h={visibility:!0,lineColor:"RGBA(64, 243, 234, 1.00)",radius:0.4,closed:!1,radiusSegments:256,tubularSegments:300,getX:function(a){return+a.x},getY:function(a){return+a.y},getZ:function(a){return+a.z||0},getPosition:function(a){return a.position}};return a.exports=class extends f{constructor(a){super(),this.options=g(h,a||{}),this.speedArray=[]}addTo(a){e=a.three,this.scene=a.scene}render(a){return a?void(this.ds=a,this.initTrajLine()):console.log("please check trajline data")}initTrajLine(){let a=this.options,b=this.ds,c=[];b.forEach((b)=>{let d=a.getPosition(b),f=a.getX(d),g=a.getY(d),h=a.getZ(d);c.push(new e.Vector3(f,g,h))}),this.calSpeedProportion(c);let d=new e.CatmullRomCurve3(c),f=this.geometry=new e.TubeBufferGeometry(d,a.tubularSegments,a.radius,a.radiusSegments,a.closed),g=this.material=this.getMaterial(),h=this.mesh=new e.Mesh(f,g);h.frustumCulled=!1,h.renderOrder=1e3,h.visible=a.visibility,this.scene.add(h)}calSpeedProportion(a){let b=0,c=[];for(let d=0;d<a.length-1;d++){let e=a[d],f=a[d+1],g=e.distanceTo(f);b+=g,c.push(g)}if(b)for(let a=0;a<c.length;a++){let d=c[a],e=d/b;this.speedArray.push(e)}}getMaterial(){let a=this.options,b=d(a.lineColor).gl();return new e.ShaderMaterial({uniforms:{uColor:{value:new e.Vector3(b[0],b[1],b[2])},uTimeCounter:{value:0}},vertexShader:`
      varying vec2 vUv;
      
      void main() {
        vUv = uv;
        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
      }
      `,fragmentShader:`
      #ifdef GL_ES
        precision highp float;
      #endif
      
      varying vec2 vUv;
      uniform vec3 uColor;
      uniform float uTimeCounter;
      
      float calculateTimeControlOpacity(float timeCounter, vec2 vUv){
        if(vUv.x > timeCounter) {
          return 0.0;
        } else {
          return 1.0;
        }
      }
      
      void main() {
        float currentOpacity = calculateTimeControlOpacity(uTimeCounter, vUv);
        gl_FragColor = vec4(uColor, currentOpacity);
      }
      `,vertexColors:e.VertexColors,blending:e.NormalBlending,side:e.DoubleSide,depthTest:!1,depthWrite:!1,transparent:!0})}animation(){let a=this.options;1>=this.material.uniforms.uTimeCounter.value&&(this.material.uniforms.uTimeCounter.value+=a.speed)}hide(){this.material&&(this.material.uniforms.uTimeCounter.value=0)}updateSpeed(a,b){return a>this.speedArray.length-1?void(this.options.speed=0):void(this.options.speed=this.speedArray[a]/b)}updateOptions(a){this.options=g(this.options,a||{}),this.update()}update(){if(this.material){let a=this.options,b=d(a.lineColor).gl();this.material.uniforms.uColor.value=new e.Vector3(b[0],b[1],b[2]),this.material.needsUpdate=!0,this.mesh.visible=a.visibility}}remove(){this.scene.remove(this.mesh),this.mesh&&this.mesh.dispose&&this.mesh.dispose(),this.geometry&&this.geometry.dispose&&this.geometry.dispose(),this.material&&this.material.dispose&&this.material.dispose(),this.mesh=null,this.geometry=null,this.material=null}},a.exports});;
Cube("datav:/com/datav-expo-trajectory/0.0.5/marker",["datav:/npm/eventemitter3/3.0.0","datav:/npm/safely-merge/1.0.1"],function(a,b,c){let d=null;const e=c("datav:/npm/eventemitter3/3.0.0"),f=c("datav:/npm/safely-merge/1.0.1"),g={maxOpacity:1,fadeOutTime:60,sizeScale:10,spriteColor:16777215,title:"\u51FA\u73B0\u65F6\u95F4",titleSize:80,margin:20,aspectRatio:2,markerWidth:1e3,markerHeight:500,textColor:"#FF0000",fontFamily:"DIN Alternate Bold",fontSize:100,borderWidth:15,borderColor:"RGBA(64, 243, 234, 1.00)",getPicUrl:function(a){return a.url||a.picUrl||""},getInfo:function(a){if(!a.time)return"";let b=a.time;return b.split(" ")[1]}};return a.exports=class extends e{constructor(a){super(),this.options=f(g,a||{}),this.isFade=!1,this.fadeIndex=0}addTo(a){d=a.three,this.scene=a.scene}render(a){return a?void(this.ds=a,this.init()):console.log("please check marker data")}init(){this.removeSprite();let a=this.options,b=a.sizeScale,c=a.markerWidth,e=a.markerHeight,f=this.canvas=document.createElement("canvas");f.width=c,f.height=e,this.ctx=f.getContext("2d");let g=this.texture=new d.Texture(f);this.drawTexture();let h=new d.SpriteMaterial({map:g,color:a.spriteColor,opacity:0,alphaTest:0.5,depthTest:!1,depthWrite:!1}),i=this.sprite=new d.Sprite(h);i.scale.set(b*c/e,b,b),this.scene.add(i)}drawTexture(){let a=this;this.clear(),this.drawText();let b=this.options,c=b.aspectRatio||2,e=b.markerWidth/c,f=b.markerHeight,g=b.markerWidth-e,h=b.markerHeight,i=b.getPicUrl(this.ds),j=this.imageCanvas=document.createElement("canvas");j.width=e,j.height=f;let k=this.imageCtx=j.getContext("2d"),l=new d.ImageLoader().setCrossOrigin("*");l.load(i,function(c){let d=e/2,i=f/2,l=e/2;k.save(),k.arc(d,i,l,0,2*Math.PI),k.clip(),k.drawImage(c,0,0,e,f),k.restore(),k.beginPath(),k.arc(d,i,l-b.borderWidth/2-1,0,2*Math.PI),k.lineWidth=b.borderWidth,k.strokeStyle=b.borderColor,k.stroke(),a.ctx.drawImage(j,0,0,e,f,0,0,e,f),a.ctx.drawImage(a.textCanvas,0,0,g,h,e,0,g,h),a.texture.image=a.canvas,a.texture.needsUpdate=!0})}drawText(){this.clearText();let a=this.options,b=a.margin,c=a.fontSize,d=a.titleSize,e=a.markerHeight,f=a.markerWidth,g=a.aspectRatio||2,h=f-f/g,i=0,j=a.getInfo(this.ds),k=this.textCanvas=document.createElement("canvas");k.width=h,k.height=e;let l=this.textCtx=k.getContext("2d");l.font=`bold ${d}px ${a.fontFamily}`,l.fillStyle=a.textColor,l.textAlign="center",l.fillText(a.title,h/2,i+d),l.font=`bold ${c}px ${a.fontFamily}`,l.fillStyle=a.textColor,l.textAlign="center",l.fillText(j,h/2,i+d+b+c)}fadeOut(){if(this.sprite){let a=this.sprite,b=this.options;this.fadeIndex++;let c=this.fadeIndex/b.fadeOutTime*b.maxOpacity;a.material.opacity=c,this.fadeIndex===b.fadeOutTime&&(a.material.opacity=b.maxOpacity,this.isFade=!1,this.fadeIndex=0)}}setSpritePosition(a,b,c){this.sprite&&this.sprite.position.set(a,b,c)}clearOnlineCanvas(){this.ctx&&this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}clearImage(){this.imageCtx&&this.imageCtx.clearRect(0,0,this.imageCanvas.width,this.imageCanvas.height)}clearText(){this.textCtx&&this.textCtx.clearRect(0,0,this.textCanvas.width,this.textCanvas.height)}clear(){this.clearText(),this.clearImage(),this.clearOnlineCanvas()}removeSprite(){this.clear(),this.canvas=null,this.scene.remove(this.sprite),this.sprite&&this.sprite.material&&this.sprite.material.dispose&&this.sprite.material.dispose(),this.sprite&&this.sprite.dispose&&this.sprite.dispose(),this.sprite=null}restore(){let a=this.sprite;a&&(a.material.opacity=0,a.position.set(0,0,0))}updateTexture(){this.clear();let a=this.options,b=a.sizeScale,c=a.markerWidth,d=a.markerHeight;this.canvas.width=c,this.canvas.height=d,this.sprite.scale.set(b*c/d,b,b),this.drawTexture()}updateOptions(a){this.options=f(this.options,a||{}),this.updateTexture()}remove(){this.clear(),this.scene.remove(this.sprite),this.sprite&&this.sprite.material&&this.sprite.material.dispose&&this.sprite.material.dispose(),this.sprite&&this.sprite.dispose&&this.sprite.dispose(),this.sprite=null,this.ctx=null,this.textCtx=null,this.imageCtx=null,this.canvas=null,this.textCanvas=null,this.imageCanvas=null,this.ds=null}},a.exports});;
Cube("datav:/com/datav-expo-trajectory/0.0.5/traj-markers",["datav:/npm/eventemitter3/3.0.0","datav:/npm/safely-merge/1.0.1"],function(a,b,c){const e=c("datav:/com/datav-expo-trajectory/0.0.5/marker"),d=c("datav:/com/datav-expo-trajectory/0.0.5/trajectory"),f=c("datav:/npm/eventemitter3/3.0.0"),g=c("datav:/npm/safely-merge/1.0.1"),h={pauseTime:500,interval:100,offsetX:3,offsetY:3,offsetZ:0,repeat:!0,markers:{fadeOutTime:60,sizeScale:10,spriteColor:16777215,title:"\u51FA\u73B0\u65F6\u95F4",titleSize:70,markerWidth:1e3,markerHeight:500,aspectRatio:2,fontFamily:"DIN Alternate Bold",textColor:"#FF0000",fontSize:100,borderWidth:15,borderColor:"RGBA(64, 243, 234, 1.00)",maxOpacity:1},trajLines:{radius:0.4,lineColor:"RGBA(64, 243, 234, 1.00)"},getTime:function(a){return a.time},getX:function(a){return+a.position.x},getY:function(a){return+a.position.y},getZ:function(a){return+a.position.z||0}};return a.exports=class extends f{constructor(a){super(),this.options=g(h,a||{}),this.ds=[],this.markersArray=[],this.currentMarker=null,this.dataIndex=0,this.loopIndex=~~(100*Math.random()),this.timeoutId=null,this.status="working"}addTo(a){this.map=a}initMarkers(){let a=this.ds,b=this.options,c=this.markersArray,f=this.getMarkerOptions();for(let b=0;b<a.length;b++){let g=a[b],d=new e(f);d.addTo(this.map),d.render(g),c.push(d)}}initTrajLine(){let a=this.getTrajLineOptions();1<this.ds.length&&(this.trajLine=new d(a),this.trajLine.addTo(this.map),this.trajLine.render(this.ds))}render(a){this.remove(),this.ds=a||this.ds,this.dataLength=this.ds.length,this.dataSort(),this.initMarkers(),this.initTrajLine(),this.loop()}dataSort(){let a=this.ds,b=this.options,c=b.getX,e=b.getY,f=b.getZ,d=b.getTime,g=b.offsetX,h=b.offsetY,k=b.offsetZ;a.sort(function(c,a){return d(c)>d(a)?1:d(c)<d(a)?-1:0});for(let b,d=0;d<a.length;d++){b=a[d];for(let i,l=0;l<d;l++)i=a[l],c(b)===c(i)&&e(b)===e(i)&&f(b)===f(i)&&(b.position.x+=g,b.position.y+=h,b.position.z+=k)}}loop(){let a=this.options,b=a.markers.sizeScale;if(this.loopIndex%=a.interval,0===this.loopIndex&&"working"===this.status)if(this.dataIndex<this.dataLength){let c=this.ds[this.dataIndex];this.currentMarker=this.markersArray[this.dataIndex],this.currentMarker.setSpritePosition(a.getX(c)+0.5*b,a.getY(c)+0.25*b,a.getZ(c)),this.currentMarker.isFade=!0,this.currentMarker.fadeOut(),this.updateTrajLineSpeed(this.dataIndex,a.interval),this.dataIndex++}else this._clearTimeout(),this.status="finished",this.timeoutId=setTimeout(()=>a.repeat?(this.status="working",void this.repeat()):void this.remove(),a.pauseTime);this.trajLine&&this.trajLine.animation(),this.currentMarker&&this.currentMarker.isFade&&this.currentMarker.fadeOut(),this.loopIndex++,this.loopId=window.requestAnimationFrame(this.loop.bind(this))}_clearTimeout(){this.timeoutId&&clearTimeout(this.timeoutId),this.timeoutId=null}updateTrajLineSpeed(a,b){this.trajLine&&this.trajLine.updateSpeed(a,b)}getTrajLineOptions(){return this.options.trajLines}getMarkerOptions(){return this.options.markers}updateOptions(a){this.options=g(this.options,a||{}),this.updateAllMarkers(),this.updateAllTrajLines()}updateAllTrajLines(){let a=this.getTrajLineOptions();this.trajLine&&this.trajLine.updateOptions(a)}updateAllMarkers(){let a=this.getMarkerOptions(),b=this.markersArray;b.forEach(function(b){b.updateOptions(a)})}removeAllMarkers(){let a=this.markersArray;a.forEach(function(a){a.remove()}),a=[]}removeTrajLine(){this.trajLine&&this.trajLine.remove()}repeat(){this.loopIndex=0,this.dataIndex=0,this.currentMarker=null;let a=this.markersArray;a.forEach(function(a){a.restore()}),this.trajLine&&this.trajLine.hide()}remove(){this.loopId&&window.cancelAnimationFrame(this.loopId),this.removeAllMarkers(),this.removeTrajLine(),this._clearTimeout(),this.timeoutId=null,this.ds=[],this.markersArray=[],this.currentMarker=null,this.loopIndex=0,this.dataIndex=0}},a.exports});;
Cube("datav:/com/datav-expo-trajectory/0.0.5",["datav:/npm/eventemitter3/3.0.0","datav:/npm/safely-merge/1.0.1"],function(a,b,c){let e=0;const d=c("datav:/npm/eventemitter3/3.0.0"),f=c("datav:/com/datav-expo-trajectory/0.0.5/traj-markers"),g=c("datav:/npm/safely-merge/1.0.1"),h={pauseTime:500,interval:240,repeat:!0,offsetX:3,offsetY:3,offsetZ:0,markers:{fadeOutTime:60,sizeScale:10,spriteColor:16777215,title:"\u51FA\u73B0\u65F6\u95F4",titleSize:70,markerSize:500,aspectRatio:2,markerWidth:1e3,markerHeight:500,fontFamily:"DIN Alternate Bold",textColor:"RGBA(64, 243, 234, 1.00)",fontSize:100,borderWidth:15,borderColor:"RGBA(64, 243, 234, 1.00)",maxOpacity:1},trajLines:{radius:0.4,lineColor:"RGBA(64, 243, 234, 1.00)",lineVisibility:!0},getId:function(a){return a.id||e++}};return a.exports=class extends d{constructor(a,b){super(),this.options=g(h,b||{}),this.trajMarkersArray={},this.ds=[]}addTo(a){a||console.error("trajectory layer need map"),this.map=a}render(a){return a&&Array.isArray(a)?void(this.remove(),this.ds=a,this.initTrajMarkers()):console.log("please check trajmarker data")}initTrajMarkers(){let a=this.ds,b=this.getOptions();for(let c,d,e=0;e<a.length&&(c=a[e],Array.isArray(c)&&!(1>c.length));e++)if(d=this.options.getId(c),!this.trajMarkersArray[d]){let a=new f(b);a.addTo(this.map),a.render(c),this.trajMarkersArray[d]=a}}getOptions(){let a=this.options,b=a.markers,c=a.trajLines;return{pauseTime:a.pauseTime,interval:~~a.interval,repeat:a.repeat,offsetX:a.offsetX,offsetY:a.offsetY,offsetZ:a.offsetZ,markers:{fadeOutTime:~~b.fadeOutTime,title:b.title,sizeScale:b.sizeScale,spriteColor:16777215,titleSize:b.titleSize,aspectRatio:b.aspectRatio,markerWidth:b.markerSize*(b.aspectRatio||2),markerHeight:b.markerSize,fontFamily:b.fontFamily,textColor:b.textColor,fontSize:b.fontSize,margin:b.margin,borderWidth:b.borderWidth,borderColor:b.borderColor,maxOpacity:b.maxOpacity},trajLines:{radius:c.radius,lineColor:c.lineColor,visibility:c.lineVisibility}}}updateOptions(a){this.options=g(this.options,a||{}),this.update()}update(){let a=this.getOptions(),b=this.trajMarkersArray;for(let c in b)b[c].updateOptions(a)}removeFinishedTrajMarkers(){let a=this.trajMarkersArray;for(let b in a){let c=a[b];"finished"===c.status&&(console.log(`${b} is finished, and removed`),c.remove(),delete a[b])}}removeAllTrajMarkers(){let a=this.trajMarkersArray;for(let b in a){let c=a[b];c.remove(),delete a[b]}}remove(){this.removeAllTrajMarkers(),this.trajMarkersArray={},this.ds=[]}},a.exports});