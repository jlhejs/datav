// env=undefined => env=publish 
Cube("datav:/com/datav-solution-industry-model/0.0.4/src/utils/drawLabel",[],function(a){function b(a,b,c,d){a.beginPath(),a.moveTo(b[0],b[1]),a.lineTo(c[0],c[1]),a.lineTo(d[0],d[1]),a.stroke()}function c(a,c,d,e,f,g,h,i,j){let k=e+i.left+i.right,l=2*h.size+i.top+i.font+i.bottom,m=k+2*j.width,n=l+2*j.width;c.width=m,c.height=n,j.length=0.2*Math.min(m,n);let o=j.width;d.fillStyle=g.color,d.fillRect(o,o,k,l),d.strokeStyle=j.color,d.lineWidth=j.width;let p=0.5*j.width,q=[p+j.length,p],r=[p,p],s=[p,p+j.length];b(d,q,r,s),q=[m-p-j.length,p],r=[m-p,p],s=[m-p,p+j.length],b(d,q,r,s),q=[p+j.length,n-p],r=[p,n-p],s=[p,n-p-j.length],b(d,q,r,s),q=[m-p-j.length,n-p],r=[m-p,n-p],s=[m-p,n-p-j.length],b(d,q,r,s),d.font=f,d.textAlign="center",d.textBaseline="middle",d.fillStyle=h.color;let t=i.top+j.width+0.5*h.size,u=0.5*c.width;d.fillText(a.key,u,t),t+=h.size+i.font,d.fillText(a.value,u,t)}const d={font:{size:32,color:"#FFFFFF",weight:100},padding:{font:8,left:24,right:24,top:12,bottom:12},background:{color:"rgba(255, 255, 255, 0.2)"},outline:{width:4,color:"rgba(255, 255, 255, 0.8)"}};return a.exports=function(a,b){b=a(d,b);const e=b.padding,f=b.font,g=b.outline,h=b.background,i=document.createElement("canvas"),j=i.getContext("2d"),k=document.createElement("canvas"),l=k.getContext("2d");let m=`${f.weight} ${f.size}px MicrosoftYaHei,微软雅黑`;j.font=m;let n=g.width+e.top+f.size+e.font+f.size+e.bottom+g.width;return function(a){let b=document.createElement("canvas"),d=b.getContext("2d"),i=-Infinity;return Array.isArray(a)||(a=[a]),a.forEach((a)=>{let b=j.measureText(a.key).width,c=j.measureText(a.value).width;i=Math.max(i,b,c)}),b.width=g.width+e.left+i+e.right+g.width,b.height=n*a.length,a.forEach((a,b)=>{c(a,k,l,i,m,h,f,e,g),d.drawImage(k,0,0,k.width,k.height,0,n*b,k.width,k.height)}),[b,a.length]}},a.exports});;
Cube("datav:/com/datav-solution-industry-model/0.0.4/src/label",[],function(a,b,c){const d=c("datav:/com/datav-solution-industry-model/0.0.4/src/utils/drawLabel");return a.exports=function(a,b){const c={};return class{constructor(d,e){this.options=b.mergeOptions(c,e),this.text=d,this.size=new a.Vector2(1,1)}setText(a){this.text=a}initSprite(){if(!this.sprite){let b=new a.SpriteMaterial({depthTest:!1});this.sprite=new a.Sprite(b),this.sprite.visible=!1,this.sprite.renderOrder=1}}setColor(a,c,d){this.sprite&&(this.sprite.material.color.setRGB(a,c,d),this.sprite.material.needsUpdate=!0)}drawText(){this.sprite||this.initSprite();let[c,e]=d(b.mergeOptions,this.options)(this.text);if(this.sprite.material.map)this.sprite.material.map.image=c;else{let b=new a.CanvasTexture(c);b.anisotropy=16,this.sprite.material.map=b}this.sprite.visible=!0,this.sprite.material.map.needsUpdate=!0,this.size.set(this.options.size*c.width*e/c.height,this.options.size*e),this.sprite.material.needsUpdate=!0,this.sprite.scale.set(this.size.x,this.size.y,this.options.size,1)}setPosition(a,b,c){this.sprite&&this.sprite.position.set(a,b,c)}getSize(){return this.size}updateOptions(a){this.options=b.mergeOptions(this.options,a||{}),this.drawText()}remove(){this.sprite&&(this.sprite.material.dispose(),this.sprite.geometry.dispose(),this.sprite.material.map&&(this.sprite.material.map.dispose(),this.sprite.material.map.image=null),this.sprite=null)}}},a.exports});;
Cube("datav:/com/datav-solution-industry-model/0.0.4/src/shader/outline",[],function(a){const b=`
varying vec3 eyeNormal;
varying vec3 eyePos;

#include <logdepthbuf_pars_vertex>

void main() {
  vec4 pos = modelViewMatrix * vec4(position, 1.0);
  eyePos = pos.xyz / pos.w;
  eyeNormal = normalize( normalMatrix * normal );
  gl_Position = projectionMatrix * pos;

  #include <logdepthbuf_vertex>
}
`,c=`
uniform vec3 color;
uniform float opacity;
uniform float intensity;
varying vec3 eyeNormal;
varying vec3 eyePos;

#include <logdepthbuf_pars_fragment>

void main() {
    #include <logdepthbuf_fragment>

    vec3 N = normalize(eyeNormal);
    vec3 E = normalize(-eyePos);
    gl_FragColor = vec4(color, max(pow(1.0 - max(dot(E,N),0.0),intensity), opacity));
    #include <tonemapping_fragment>
    #include <premultiplied_alpha_fragment>
}
`;return a.exports={vertexShader:b,fragmentShader:c},a.exports});;
Cube("datav:/com/datav-solution-industry-model/0.0.4/src/utils/hdrCubeTextureLoader",[],function(a){return a.exports=function(a){function b(a,b){return[a+"px"+b,a+"nx"+b,a+"py"+b,a+"ny"+b,a+"pz"+b,a+"nz"+b]}const c=new a.HDRCubeTextureLoader;return function(d="",e="",f,g){let h=b(d,e);return new Promise((b,d)=>{c.load(a.UnsignedByteType,h,(c)=>{let d=c;if(g){let b=new a.PMREMGenerator(d);b.update(f);var e=new a.PMREMCubeUVPacker(b.cubeLods);e.update(f),d=e.CubeUVRenderTarget.texture}b(d)},void 0,d)})}},a.exports});;
Cube("datav:/com/datav-solution-industry-model/0.0.4/src/component",["datav:/npm/eventemitter3/3.0.0"],function(a,b,c){const d=c("datav:/npm/eventemitter3/3.0.0"),e=c("datav:/com/datav-solution-industry-model/0.0.4/src/shader/outline");return a.exports=function(a,b){const f=c("datav:/com/datav-solution-industry-model/0.0.4/src/label")(a,b),g=new a.Box3,h={status:{threshold:0.5,click:{color:5304572,opacity:0.2},alert:{color:16711680,opacity:0.2}}};return class extends d{constructor(a,c,d){super(),this.type="Component",this.options=b.mergeOptions(h,d),this.id=a,this.parent=c,this.init()}init(){this.center=new a.Vector3,this.size=new a.Vector3,this.sts="normal",this.initStsMaterial(),this.createAlertSprite()}initStsMaterial(){this.stsMaterial=new a.ShaderMaterial({uniforms:{color:{value:new a.Color(16777215)},opacity:{value:null},intensity:{value:5}},vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,transparent:!0})}createAlertSprite(){if(!this.alertSprite){let b=this.options.status.alert.icon;this.alertSprite=new a.Sprite(new a.SpriteMaterial({depthTest:!1,transparent:!0})),this.icon&&(this.alertSprite.material.map=this.icon),this.alertSprite.scale.set(b.size,b.size,1),this.alertSprite.visible=!1,this.alertSprite.renderOrder=1,this.parent.group.add(this.alertSprite),this.updateAlertSpritePosition()}}click(){this.model&&("alert"===this.sts?this.alertSprite&&(this.alertSprite.visible=!0):(this.sts="click",this.setStatus(this.options.status.click)))}setStatus(a){this.stsModel&&(this.stsModel.visible=!0);let c=b.Chroma(a.color).gl();this.stsMaterial.uniforms.color.value.setRGB(c[0],c[1],c[2]),this.stsMaterial.uniforms.opacity.value=a.opacity,this.label&&this.label.setColor(c[0],c[1],c[2])}alert(){if("alert"===this.sts&&this.model){let a=this.options.status;this.setStatus(a.alert)}}normal(){this.model&&("alert"!==this.sts&&(this.sts="normal",this.stsModel.visible=!1,this.label.setColor(1,1,1)),this.alertSprite&&(this.alertSprite.visible=!1))}updateStsModel(){this.model&&(this.stsModel=this.model.clone(),this.stsModel.traverse((a)=>{a.material&&(a.material=this.stsMaterial)}),this.stsModel.visible=!1,this.model.add(this.stsModel))}setModel(a){a&&(this.model=a,this.updateStsModel(),this.model.userData.__node__=this,this.model.userData.__normalStatus__=!0,this.updateLabel(),this.updateStatus(),this.updatePosition())}setValue(a){this.value=a,this.updateStatus()}setLabel(a){this.label?this.label.setText(a):this.label=new f(a,this.options.label),this.updateLabel(),this.updateStatus()}setAlertIcon(a){this.icon=a,this.alertSprite&&(this.alertSprite.material.map=a,this.alertSprite.material.needsUpdate=!0)}updatePosition(){this.updateBox(),this.updateLabelPosition(),this.updateAlertSpritePosition()}updateStatus(){let a=void 0===this.value||this.value<this.options.status.threshold;a?"alert"==this.sts&&(this.sts="normal",this.normal()):(this.sts="alert",this.createAlertSprite()),this.model&&(this.model.userData.__normalStatus__=a,this.alert())}removeLabel(){this.label&&(this.label.sprite&&this.parent.group.remove(this.label.sprite),this.label.remove())}removeStsModel(){this.stsModel&&(this.model&&this.model.remove(this.stsModel),this.stsMaterial.dispose(),this.initStsMaterial(),this.stsModel=null)}removeAlertSprit(){this.alertSprite&&(this.parent&&this.parent.group.remove(this.alertSprite),this.alertSprite=null)}remove(){this.sts="normal",this.model&&(delete this.model.userData.__node__,delete this.model.userData.__normalStatus__),this.removeLabel(),this.removeStsModel(),this.removeAlertSprit()}updateBox(){this.model&&(g.setFromObject(this.model),g.getCenter(this.center),g.getSize(this.size))}updateLabel(){this.model&&this.label&&(this.label.drawText(),this.label.sprite.parent!==this.parent.group&&this.parent.group.add(this.label.sprite))}updateLabelPosition(){if(this.label){let a=this.label.getSize(),b=this.center.x,c=this.center.y+0.5*this.size.y+a.y,d=this.center.z;this.label.setPosition(b,c,d)}}updateAlertSpritePosition(){this.alertSprite&&this.alertSprite.position.copy(this.center)}updateOptions(a){this.options=b.mergeOptions(this.options,a||{}),this.updateStatus();let c=this.sts;this.sts="normal",this.sts=c,"click"==this.sts?this.click():"alert"==this.sts&&this.alert();let d=this.options.status.alert.icon;this.alertSprite&&this.alertSprite.scale.set(d.size,d.size,1),this.label&&this.label.updateOptions(this.options.label)}}},a.exports});;
Cube("datav:/com/datav-solution-industry-model/0.0.4/src/industryModel",["datav:/npm/eventemitter3/3.0.0"],function(a,b,c){const d=c("datav:/npm/eventemitter3/3.0.0");return a.exports=function(a,b,e){function f(a,b){a.traverse((a)=>{a.material&&e.materialTraverse(a.material,(a,c)=>{let d=e.getCurrentMaterial(a,c);d&&b(d)})})}function g(a){for(let c in a.dispose(),a)if(a[c]instanceof b.Texture){a[c].dispose();let b=a[c].image;b instanceof HTMLImageElement?b.src="":a[c].image=null}}function h(a){i.setFromObject(a);let c=new b.Vector3,d=new b.Vector3;i.getCenter(c),i.getSize(d),a.updateMatrixWorld(!0,!0),a.traverse((a)=>{a.position.set(0,0,0),a.rotation.set(0,0,0,"XYZ"),a.scale.set(1,1,1),a.geometry&&(a.geometry=a.geometry.clone(),a.geometry.applyMatrix(a.matrixWorld),a.geometry.translate(-c.x,-c.y,-c.z),a.geometry.scale(1/d.x,1/d.y,1/d.z))}),a.updateMatrixWorld(!0,!0),a.userData.position=c,a.scale.copy(d)}const i=new b.Box3,j=c("datav:/com/datav-solution-industry-model/0.0.4/src/component")(b,e),k=c("datav:/com/datav-solution-industry-model/0.0.4/src/utils/hdrCubeTextureLoader")(b),l=new b.TextureLoader;l.setCrossOrigin("*");const m={component:{}};return class extends d{constructor(a){super(),this.options=e.mergeOptions(m,a),this.components=new Map,this.group=new b.Group,this.lastSeletedComponent,this.fetchAlertIcon(),this.fetchEnvHdrTexture(),this.fetchModel()}updateModelEnvMap(){let a=this.options.model.envMap.envMapIntensity;this.model&&f(this.model,(b)=>{b.envMap=this.hdrCubeTexture,b.envMapIntensity=a,b.needsUpdate=!0})}fetchEnvHdrTexture(){let b=this.options.model.envMap;this.removeHdrCubeTexture(),""==b.url.prefix&&""==b.url.postfix?this.updateModelEnvMap():k(b.url.prefix,b.url.postfix,a.renderer,!0).then((a)=>{this.hdrCubeTexture=a,this.updateModelEnvMap()}).catch((a)=>{console.log(a)})}fetchModel(){""==this.options.model.url||(this.removeModel(),e.fetchModel(this.options.model.url,(a)=>{this.model=a.scene,h(this.model),this.group.add(this.model),this.updatePosition(),this.updateModelEnvMap(),this.updateComponentsModel()}))}fetchAlertIcon(){let a=this.options.component.status.alert.icon.url;""==a||(this.removeIconTexture(),this.iconTexture=l.load(a),this.updateComponentsAlertIcon())}updatePosition(){if(this.model){let a=this.options.model.position;this.model.position.set(a.x,a.y,a.z)}this.model.updateMatrixWorld(!0,!0)}updateComponentsModel(){this.model&&this.components.forEach((a)=>{a.removeStsModel();let b=this.model.getObjectByName(a.id);b?a.setModel(b):a.remove()})}updateComponentsAlertIcon(){this.components.forEach((a)=>{a.setAlertIcon(this.iconTexture)})}setData(a){this.normalSeletedComponent(),this.removeComponents(),a.forEach((a)=>{let b=new j(a.id,this,this.options.component);b.setValue(a.value),b.setLabel(a.text),this.components.set(a.id,b)}),this.updateComponentsModel(),this.updateComponentsAlertIcon()}normalSeletedComponent(){this.lastSeletedComponent&&(this.lastSeletedComponent.normal(),this.lastSeletedComponent=null)}interactive(a){if(!this.model||0==this.components.length)return;let b=a.intersectObjects([this.model],!0);this.normalSeletedComponent();let c="";if(0<b.length){let a=b[0].object;for(;a.parent&&!a.userData.__node__&&a.parent!=this.group;)a=a.parent;a.userData.__node__&&(this.lastSeletedComponent=a.userData.__node__,this.lastSeletedComponent.click(),c=this.lastSeletedComponent.id)}this.emit("click",{id:c})}seletedComponent(a){this.normalSeletedComponent();let b=this.components.get(a);b&&(this.lastSeletedComponent=b,this.lastSeletedComponent.click())}updateOptions(a){let b=this.options.model.envMap.url,c=this.options.model.url,d=this.options.component.status.alert.icon.url;this.options=e.mergeOptions(this.options,a||{}),d!==this.options.component.status.alert.iconUrl&&this.fetchAlertIcon(),c===this.options.model.url?this.updatePosition():this.fetchModel();let f=this.options.model.envMap.url;b.prefix!==f.prefix||b.postfix!==f.postfix?this.fetchEnvHdrTexture():this.updateModelEnvMap(),this.components.forEach((a)=>{a.updatePosition(),a.updateOptions(this.options.component)})}removeIconTexture(){this.iconTexture&&(this.iconTexture.dispose(),this.iconTexture=null)}removeModel(){this.model&&(this.group.remove(this.model),this.model.traverse((a)=>{a.material&&f(a,(a)=>{g(a)}),a.geometry&&a.geometry.dispose()}),this.model=null)}clearComponents(){this.components.forEach((a)=>{a.remove()})}removeComponents(){this.clearComponents(),this.components=new Map}removeHdrCubeTexture(){this.hdrCubeTexture&&(this.hdrCubeTexture.dispose(),this.hdrCubeTexture=null),this.updateModelEnvMap()}remove(){this.normalSeletedComponent(),this.removeHdrCubeTexture(),this.removeModel(),this.removeComponents(),this.removeIconTexture()}}},a.exports});;
Cube("datav:/com/datav-solution-industry-model/0.0.4",["datav:/npm/eventemitter3/3.0.0"],function(a,b,c){const d=c("datav:/npm/eventemitter3/3.0.0");let e=null,f=null;return a.exports=class extends d{constructor(a,b){super(),this.options=Object.assign({},b||{})}addTo(a){e=a.three,f=a.Utils,this.engine=a.engine,this.init(),this.initInteractive()}init(){let a=c("datav:/com/datav-solution-industry-model/0.0.4/src/industryModel")(this.engine,e,f);this.layer=new a(this.options),this.layer.on("click",(a)=>{let b=this.options.callbackId,c=a[b];c&&this.emit("global_var",b,c)}),this.options.visible?this.show():this.hide(),this.engine.add(this.layer.group)}initInteractive(){this.mouse=new e.Vector2,this.raycaster=new e.Raycaster,this.engine.container.addEventListener("click",this.interactive.bind(this),!1)}interactive(a){let b=this.mouse,c=this.raycaster;b.x=2*(a.offsetX/this.engine.container.clientWidth)-1,b.y=2*-(a.offsetY/this.engine.container.clientHeight)+1,c.setFromCamera(b,this.engine.camera),this.layer&&this.layer.interactive(c)}setData(a){a&&Array.isArray(a)&&(!this.layer||this.layer.setData(a))}show(){this.layer&&(this.layer.group.visible=!0)}hide(){this.layer&&(this.layer.group.visible=!1)}selectedComponent(a){this.layer&&this.layer.selectedComponent(a)}updateOptions(a){this.options=f.mergeOptions(this.options,a||{}),this.options.visible?this.show():this.hide(),this.layer&&this.layer.updateOptions(this.options)}remove(){this.engine.container.removeEventListener("click",this.interactive),this.layer&&(this.layer.removeAllListeners("click"),this.engine.remove(this.layer.group),this.layer.remove(),this.layer=null)}},a.exports});