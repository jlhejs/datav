// env=undefined => env=publish 
Cube("datav:/com/datav-engine-terrain/0.0.20/src/shader/terrain.vert.glsl",[],function(a){return a.exports="#define GLSLIFY 1\nuniform sampler2D heightMap;\nuniform float magnitude;\nvarying float altitude;\n#ifdef USE_MAP\n\nvarying vec2 vUv;\n\n#endif\n\nconst float PI = 3.1415926;\n\n#include <logdepthbuf_pars_vertex>\n\nvoid main() {\n  #ifdef USE_MAP\n\n    vUv = uv;\n\n  #endif\n  vec3 color = texture2D(heightMap, uv).rgb;\n  altitude  = color.g * 255.0 * pow(2.0, 8.0) + color.b * 255.0;\n  if(color.r == 1.0) altitude = -altitude;\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(position.xy, altitude * 0.01 * magnitude, 1.0);\n\n  #include <logdepthbuf_vertex>\n}",a.exports});;
Cube("datav:/com/datav-engine-terrain/0.0.20/src/shader/terrain.frag.glsl",[],function(a){return a.exports="#define GLSLIFY 1\nuniform float maxAltitude;\nuniform sampler2D map;\nuniform vec3 color;\nuniform float opacity;\nvarying float altitude;\n#ifdef USE_MAP\n\nvarying vec2 vUv;\n\n#endif\n\n#include <logdepthbuf_pars_fragment>\n\nvoid main(){\n  #include <logdepthbuf_fragment>\n\n  float ratio = altitude / maxAltitude;\n\n  vec4 diffuseColor = vec4(color, opacity );\n\n  #ifdef USE_MAP\n\n    diffuseColor *= texture2D(map,vUv);\n\n  #else\n\n    diffuseColor.rgb *= ratio;\n\n  #endif\n\n  gl_FragColor = diffuseColor;\n\n  #include <premultiplied_alpha_fragment>\n}",a.exports});;
Cube("datav:/com/datav-engine-terrain/0.0.20/src/shader/contour.frag.glsl",[],function(a){return a.exports="#define GLSLIFY 1\nuniform float maxAltitude;\nuniform float lineWidth;\nuniform float interval;\nuniform vec3 color;\nuniform float opacity;\nvarying float altitude;\n\n#include <logdepthbuf_pars_fragment>\n\nvoid main(){\n\n  #include <logdepthbuf_fragment>\n  \n  float ratio = altitude / maxAltitude;\n  float n = float(int(maxAltitude / interval));\n  ratio = smoothstep(lineWidth, 0., abs(fract(ratio * n +.5)-.5) / fwidth(ratio * n) );\n  gl_FragColor = vec4(color, ratio * opacity);\n\n  #include <premultiplied_alpha_fragment>\n}          ",a.exports});;
Cube("datav:/com/datav-engine-terrain/0.0.20/src/shader/contour.vert.glsl",[],function(a){return a.exports="#define GLSLIFY 1\nuniform sampler2D heightMap;\nuniform float magnitude;\nvarying float altitude;\n\nconst float PI = 3.1415926;\n\n#include <logdepthbuf_pars_vertex>\n\nvoid main() {\n    vec3 color = texture2D(heightMap, uv).rgb;\n    altitude  = color.g * 255.0 * pow(2.0, 8.0) + color.b * 255.0;\n    if(color.r == 1.0) altitude = -altitude;\n    gl_Position = projectionMatrix * modelViewMatrix * vec4(position.xy, altitude * 0.01 * magnitude, 1.0);\n\n    #include <logdepthbuf_vertex>\n}",a.exports});;
Cube("datav:/com/datav-engine-terrain/0.0.20/src/terrain",["datav:/npm/eventemitter3/3.0.0"],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"===typeof b||"function"===typeof b)?b:a}function f(a,b){if("function"!==typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){var c=[],d=!0,e=!1,f=void 0;try{for(var g,h=a[Symbol.iterator]();!(d=(g=h.next()).done)&&(c.push(g.value),!(b&&c.length===b));d=!0);}catch(a){e=!0,f=a}finally{try{!d&&h["return"]&&h["return"]()}finally{if(e)throw f}}return c}return function(b,c){if(Array.isArray(b))return b;if(Symbol.iterator in Object(b))return a(b,c);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),h=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),i=c("datav:/npm/eventemitter3/3.0.0");return a.exports=function(a,b){var j={},k=new a.TextureLoader().setCrossOrigin("anonymous");return function(i){function l(a){d(this,l);var c=e(this,(l.__proto__||Object.getPrototypeOf(l)).call(this));return c.options=b.mergeOptions(j,a),c.init(),c}return f(l,i),h(l,[{key:"init",value:function(){this.group=new a.Group,this.group.rotation.x=0.5*-Math.PI,this.center=new a.Vector3,this.createGeometry(),this.createMaterial(),this.setData()}},{key:"createGeometry",value:function(){this.geometry&&this.geometry.dispose(),this.geometry=new a.PlaneBufferGeometry(1,1,64*this.options.terrain.density,64*this.options.terrain.density)}},{key:"createMaterial",value:function(){var b=this.options;this.contourMaterial=new a.ShaderMaterial({uniforms:{heightMap:{value:null},maxAltitude:{value:null},magnitude:{value:b.terrain.magnitude},lineWidth:{value:b.contour.width},interval:{value:b.contour.interval},color:{value:new a.Color(b.contour.color)},opacity:{value:b.contour.opacity}},vertexShader:c("datav:/com/datav-engine-terrain/0.0.20/src/shader/contour.vert.glsl"),fragmentShader:c("datav:/com/datav-engine-terrain/0.0.20/src/shader/contour.frag.glsl"),depthTest:!1,depthWrite:!1,transparent:!0,extensions:{derivatives:!0}}),this.terrainMaterial=new a.ShaderMaterial({uniforms:{heightMap:{value:null},maxAltitude:{value:null},magnitude:{value:b.terrain.magnitude},color:{value:new a.Color(b.terrain.color)},opacity:{value:b.terrain.opacity}},vertexShader:c("datav:/com/datav-engine-terrain/0.0.20/src/shader/terrain.vert.glsl"),fragmentShader:c("datav:/com/datav-engine-terrain/0.0.20/src/shader/terrain.frag.glsl"),transparent:!0}),""!==b.terrain.mapUrl&&(this.terrainMaterial.uniforms.map={value:k.load(b.terrain.mapUrl)},this.terrainMaterial.defines.USE_MAP=!0)}},{key:"setData",value:function(){var c=this;""!==this.options.tiffUrl&&fetch(this.options.tiffUrl).then(function(a){return a.arrayBuffer()}).then(function(d){GeoTIFF.fromArrayBuffer(d).then(function(d){d.getImage(0).then(function(d){var e=d.getHeight(),f=d.getWidth(),h=d.getBoundingBox();d.readRasters().then(function(d){for(var j=g(d,1),k=j[0],l=new Uint8Array(3*f*e),m="#000000",n=new a.Color,o=-Infinity,p=0;p<k.length;p++){var i=3*p,q=-32768==k[p]?0:k[p],r=0>q;q=Math.abs(q),o=Math.max(o,q);var s=q.toString(16);n.setStyle(m.substr(0,m.length-s.length)+s),l[i]=r?255:0,l[i+1]=parseInt(255*n.g),l[i+2]=parseInt(255*n.b)}var t=b.narrowedMercator([h[0],h[1]]),u=b.narrowedMercator([h[2],h[3]]);c.center.set(0.5*(t[0]+u[0]),0,0.5*(t[2]+u[2])),c.group.scale.x=Math.abs(u[0]-t[0]),c.group.scale.y=Math.abs(u[2]-t[2]),c.heightMap&&c.heightMap.dispose(),c.heightMap=new a.DataTexture(l,f,e,a.RGBFormat),c.heightMap.flipY=!0,c.heightMap.needsUpdate=!0,c.maxAltitude=o,c.updateMesh()})})}).catch(function(a){console.log(a)})})}},{key:"updateMesh",value:function(){this.terrain||(this.terrain=new a.Mesh(this.geometry,this.terrainMaterial),this.group.add(this.terrain)),this.contour||(this.contour=new a.Mesh(this.geometry,this.contourMaterial),this.group.add(this.contour)),this.terrainMaterial.uniforms.heightMap.value=this.heightMap,this.terrainMaterial.uniforms.maxAltitude.value=this.maxAltitude,this.contourMaterial.uniforms.heightMap.value=this.heightMap,this.contourMaterial.uniforms.maxAltitude.value=this.maxAltitude,this.group.position.copy(new a.Vector3().addVectors(this.center,this.options.offset))}},{key:"updateOptions",value:function(c){var d=this.options.tiffUrl,e=this.options.terrain.density,f=this.options.terrain.mapUrl;if(this.options=b.mergeOptions(this.options,c||{}),this.group.position.copy(new a.Vector3().addVectors(this.center,this.options.offset)),this.terrainMaterial){var g=this.terrainMaterial.uniforms;g.magnitude.value=this.options.terrain.magnitude,g.color.value.setStyle(this.options.terrain.color),g.opacity.value=this.options.terrain.opacity,f!==this.options.terrain.mapUrl&&(g.map&&g.map.value.dispose(),delete g.map,this.terrainMaterial.defines={},""!==c.terrain.mapUrl&&(g.map={value:k.load(this.options.terrain.mapUrl)},this.terrainMaterial.defines.USE_MAP=!0),this.terrainMaterial.needsUpdate=!0)}if(this.contourMaterial){var h=this.contourMaterial.uniforms;h.color.value.setStyle(this.options.contour.color),h.opacity.value=this.options.contour.opacity,h.lineWidth.value=this.options.contour.width,h.magnitude.value=this.options.terrain.magnitude,h.interval.value=this.options.contour.interval}e!==this.options.terrain.density&&(this.createGeometry(),this.terrain&&(this.terrain.geometry=this.geometry),this.contour&&(this.contour.geometry=this.geometry)),d!==this.options.tiffUrl&&this.setData()}},{key:"remove",value:function(){this.terrain&&(this.group.remove(this.terrain),this.terrainMaterial.uniforms.map&&this.terrainMaterial.uniforms.map.value.dispose(),this.terrainMaterial.dispose(),this.terrain=null,this.terrainMaterial=null),this.contour&&(this.group.remove(this.contour),this.contourMaterial.dispose(),this.contour=null,this.contourMaterial=null),this.geometry&&this.geometry.dispose(),this.heightMap&&(this.heightMap.dispose(),this.heightMap=null)}}]),l}(i)},a.exports});;
Cube("datav:/com/datav-engine-terrain/0.0.20/layer",["datav:/npm/eventemitter3/3.0.0"],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"===typeof b||"function"===typeof b)?b:a}function f(a,b){if("function"!==typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=c("datav:/npm/eventemitter3/3.0.0"),i=function(a){function b(){d(this,b);var a=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return a.preSceneName="main",a.usingSceneName="main",a}return f(b,a),g(b,[{key:"addTo",value:function(a){return a?void(this.viewer=a,this.Utils=a.Utils,this.controller=a.controller,this.scene=this.getAssignedScene(),this.viewer.on("projChanged",this.updatePostions.bind(this))):console.log("Layer needs viewer layer")}},{key:"getProjPos",value:function(a,b,c){return this.viewer&&this.viewer.Projection([a,b,c])}},{key:"updatePostions",value:function(){}},{key:"getAssignedScene",value:function(){var a=this.options;return a.isSceneGroup&&a.sceneName?a.sceneName?this.controller.getScene(a.sceneName)?this.controller.getScene(a.sceneName):this.controller.createScene(a.sceneName):void 0:this.controller.getScene("main")}},{key:"toggleScene",value:function(a,b,c){var d=this;this.controller.switchScene(a,b,c).then(function(){d.preSceneName=b,d.usingSceneName=c})}},{key:"show",value:function(){}},{key:"hide",value:function(){}},{key:"updateOptions",value:function(){}}]),b}(h);return a.exports=i,a.exports});;
Cube("datav:/com/datav-engine-terrain/0.0.20",[],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"===typeof b||"function"===typeof b)?b:a}function f(a,b){if("function"!==typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=function a(b,c,d){null===b&&(b=Function.prototype);var e=Object.getOwnPropertyDescriptor(b,c);if(void 0===e){var f=Object.getPrototypeOf(b);return null===f?void 0:a(f,c,d)}if("value"in e)return e.value;var g=e.get;return void 0===g?void 0:g.call(d)},i=c("datav:/com/datav-engine-terrain/0.0.20/layer"),j=null,k=function(a){function b(a,c){d(this,b);var f=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return f.options=Object.assign({isSceneGroup:!1,sceneName:"",visible:!0},c||{}),f}return f(b,a),g(b,[{key:"addTo",value:function(a){var c=this;h(b.prototype.__proto__||Object.getPrototypeOf(b.prototype),"addTo",this).call(this,a),j=a.three;var d=document.getElementsByName("datav-engine-terrain-geotifflib");0<d.length?this.init():this.loadScriptByUrl(this.options.scriptUrl).then(function(){c.init()})}},{key:"init",value:function(){var a=c("datav:/com/datav-engine-terrain/0.0.20/src/terrain")(j,this.Utils);this.layer=new a(this.options),this.options.visible?this.show():this.hide(),this.scene.add(this.layer.group)}},{key:"loadScriptByUrl",value:function(a){return new Promise(function(b){var c=document.createElement("script");c.setAttribute("name","datav-engine-terrain-geotifflib"),c.type="text/javascript",c.async=!1,c.src=a,document.body.appendChild(c),c.onload=function(){b("success load")},c.onerror=function(){b("load "+a+" error!")}})}},{key:"show",value:function(){this.options.visible=!0,this.layer&&(this.layer.group.visible=!0)}},{key:"hide",value:function(){this.options.visible=!1,this.layer&&(this.layer.group.visible=!1)}},{key:"updateOptions",value:function(a){var b=this.Utils.deepClone(this.options);this.options=this.Utils.mergeOptions(this.options,a||{}),this.options.visible?this.show():this.hide(),this.layer&&(this.layer.updateOptions(this.options),!this.Utils.easyDiff(b.sceneName,a.sceneName)&&(this.scene=this.getAssignedScene(),this.toggleScene(this.layer.group,this.usingSceneName,a.sceneName)))}},{key:"remove",value:function(){this.layer&&(this.scene.remove(this.layer.group),this.layer.remove(),this.layer=null)}}]),b}(i);return a.exports=k,a.exports});