// env=undefined => env=publish 
Cube("datav:/com/datavmap-3d-layer-basemap/0.0.27/tileData.js",[],function(a){return a.exports={NormalAMap:{type:"raster",tiles:["//webrd02.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}","//webrd03.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}"],maxzoom:16,tileSize:256},SatelliteAMap:{type:"raster",tiles:["//webst02.is.autonavi.com/appmaptile?style=6&x={x}&y={y}&z={z}","//webst03.is.autonavi.com/appmaptile?style=6&x={x}&y={y}&z={z}"],maxzoom:16,tileSize:256},GeoQBlue:{type:"raster",tiles:["//service.datav.aliyun.com/transparentProxy/proxy?url=http://map.geoq.cn/ArcGIS/rest/services/ChinaOnlineStreetPurplishBlue/MapServer/tile/{z}/{y}/{x}"],maxzoom:16,tileSize:256},TDMapLabel:{type:"raster",tiles:["//t0.tianditu.com/DataServer?T=cva_w&x={x}&y={y}&l={z}","//t1.tianditu.com/DataServer?T=cva_w&x={x}&y={y}&l={z}","//t2.tianditu.com/DataServer?T=cva_w&x={x}&y={y}&l={z}","//t3.tianditu.com/DataServer?T=cva_w&x={x}&y={y}&l={z}","//t4.tianditu.com/DataServer?T=cva_w&x={x}&y={y}&l={z}","//t5.tianditu.com/DataServer?T=cva_w&x={x}&y={y}&l={z}","//t6.tianditu.com/DataServer?T=cva_w&x={x}&y={y}&l={z}"],maxzoom:16,tileSize:256},TDMap:{type:"raster",tiles:["//t0.tianditu.com/DataServer?T=vec_w&x={x}&y={y}&l={z}","//t1.tianditu.com/DataServer?T=vec_w&x={x}&y={y}&l={z}","//t2.tianditu.com/DataServer?T=vec_w&x={x}&y={y}&l={z}","//t3.tianditu.com/DataServer?T=vec_w&x={x}&y={y}&l={z}","//t4.tianditu.com/DataServer?T=vec_w&x={x}&y={y}&l={z}","//t5.tianditu.com/DataServer?T=vec_w&x={x}&y={y}&l={z}","//t6.tianditu.com/DataServer?T=vec_w&x={x}&y={y}&l={z}"],maxzoom:16,tileSize:256}},a.exports});;
Cube("datav:/com/datavmap-3d-layer-basemap/0.0.27/tileLayer.js",["datav:/npm/eventemitter3/2.0.3","datav:/npm/safely-merge/1.0.1"],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"===typeof b||"function"===typeof b)?b:a}function f(a,b){if("function"!==typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=c("datav:/npm/eventemitter3/2.0.3"),i=c("datav:/npm/safely-merge/1.0.1"),j=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/,k="See https://www.mapbox.com/api-documentation/#access-tokens",l=c("datav:/com/datavmap-3d-layer-basemap/0.0.27/tileData.js");return a.exports=function(a){var b=a.datavgl,c=b.THREE,m=a.glLayer||a,n=a.style.imageManager?"imageManager":"spriteAtlas",o={};return function(c){function h(a){d(this,h);var b=e(this,(h.__proto__||Object.getPrototypeOf(h)).call(this));return a=i(o,a),b.options=i(b.options,a),b.init(),b}return f(h,c),g(h,[{key:"init",value:function(){this.setBasemap(this.options)}},{key:"updateBasemap",value:function(){var a=this;this.checkmapStatus(),this.endID=setTimeout(function(){a.resetID&&clearTimeout(a.resetID)},100000)}},{key:"checkmapStatus",value:function(){var b=this;a.loaded()&&a.isStyleLoaded()?(this.resetID&&clearTimeout(this.resetID),this.setBasemap(this.options)):(this.resetID&&clearTimeout(this.resetID),this.resetID=setTimeout(function(){b.checkmapStatus()},200))}},{key:"findCorrectInsertIndex",value:function(){var b=a.submtags,c=void 0;return 1<b.basemap.length&&(c=this.findInsertIndexByLayerTag(b.basemap),-1!==c)?c:b.fill.length&&(c=this.findBeforeIndexByLayerTag(b.line[0]),-1!==c)?c:b.line.length&&(c=this.findBeforeIndexByLayerTag(b.line[0]),-1!==c)?c:b.circle.length&&(c=this.findBeforeIndexByLayerTag(b.circle[0]),-1!==c)?c:a.getStyle().layers.length}},{key:"findInsertIndexByLayerTag",value:function(a){var b=this,c=a.findIndex(function(a){return-1!==a.indexOf(b.options.id)});return c===a.length-1?this.findAfterIndexByLayerTag(a[c-1]):this.findBeforeIndexByLayerTag(a[c+1])}},{key:"findAfterIndexByLayerTag",value:function(b){var c=a.getStyle(),e=-1;return c.layers.forEach(function(a,c){-1!==a.id.indexOf(b)&&(e=c+1)}),e}},{key:"findBeforeIndexByLayerTag",value:function(b){var c=a.getStyle();return c.layers.findIndex(function(a){return-1!==a.id.indexOf(b)})}},{key:"setBasemap",value:function(c){var d=this;if("raster"===c.tileType){var e=c.rasterOptions;if(a.getLayer(c.id+"_mask")){if(a.setPaintProperty(c.id,"raster-opacity",+e["raster-opacity"]),e.filter?(a.setPaintProperty(c.id,"raster-saturation",+e["raster-saturation"]),a.setPaintProperty(c.id,"raster-hue-rotate",+e["raster-hue-rotate"]),a.setPaintProperty(c.id,"raster-brightness-min",+e["raster-brightness-min"]),a.setPaintProperty(c.id,"raster-brightness-max",+e["raster-brightness-max"]),a.setPaintProperty(c.id,"raster-contrast",+e["raster-contrast"])):(a.setPaintProperty(c.id,"raster-saturation",0),a.setPaintProperty(c.id,"raster-hue-rotate",0),a.setPaintProperty(c.id,"raster-brightness-min",0),a.setPaintProperty(c.id,"raster-brightness-max",1),a.setPaintProperty(c.id,"raster-contrast",0)),a.getSource(c.id)){var f=a.getSource(c.id);if("raster"===f.type){var g=JSON.stringify(f.tiles)==(l[e.url]?JSON.stringify(l[e.url].tiles):JSON.stringify([e.url])),h=f.maxzoom==e.maxzoom;g&&h||(a.getSource(c.id)&&a.removeSource(c.id),a.addSource(c.id,l[e.url]||{type:"raster",tiles:[e.url],maxzoom:e.maxzoom,tileSize:256}))}else a.getSource(c.id)&&a.removeSource(c.id),a.addSource(c.id,l[e.url]||{type:"raster",tiles:[e.url],maxzoom:e.maxzoom,tileSize:256})}return void(a.getLayer(c.id+"_mask")&&a.setPaintProperty(c.id+"_mask","background-color",e["mask-color"]))}a.getLayer(c.id)&&a.removeLayer(c.id);var j=a.getStyle(),k={};Object.keys(j.sources).forEach(function(a){-1!==a.indexOf("_datav")&&-1===a.indexOf(d.options.id+"_user_vector")&&(k[a]=j.sources[a])}),k[c.id]=l[e.url]||{type:"raster",tiles:[e.url],maxzoom:e.maxzoom,tileSize:256};var m=j.layers.filter(function(a){return-1!==a.id.indexOf("_datav")&&-1===a.id.indexOf(d.options.id+"_user_vector")}),o=this.findCorrectInsertIndex(m);[].splice.apply(m,[o,0].concat([{id:c.id,type:"raster",source:c.id,paint:{"raster-opacity":+e["raster-opacity"],"raster-saturation":e.filter?+e["raster-saturation"]:0,"raster-hue-rotate":e.filter?+e["raster-hue-rotate"]:0,"raster-brightness-min":e.filter?+e["raster-brightness-min"]:0,"raster-brightness-max":e.filter?+e["raster-brightness-max"]:1,"raster-contrast":e.filter?+e["raster-contrast"]:0}},{id:c.id+"_mask",type:"background",paint:{"background-color":e["mask-color"]}}])),m=m.filter(function(a){return"background_datav"!==a.id}),m.unshift({id:"background_datav",type:"background",paint:{"background-color":"rgba(0,0,0,0)"}}),j.sources=JSON.parse(JSON.stringify(k)),j.layers=m,a.setStyle(j)}else if("vector"===c.tileType){a.getSource(c.id)&&a.removeSource(c.id),a.getLayer(c.id)&&a.removeLayer(c.id),a.getLayer(c.id+"_mask")&&a.removeLayer(c.id+"_mask");var p=c.vectorOptions;b.accessToken=p.mapbox_accesstoken;var q=this.normalizeStyleURL(p.style_url);fetch(q).then(function(a){return a.json()}).then(function(b){if(b.version){var c=a.getStyle(),e=i(a.style[n].images,{}),f=c.layers.filter(function(a){return-1!==a.id.indexOf("_datav")&&-1===a.id.indexOf(d.options.id+"_user_vector")}),g=b.layers;Object.keys(b.sources).forEach(function(a){var c=b.sources[a];b.sources[a+"_"+d.options.id+"_user_vector"]=c,delete b.sources[a]}),b.layers.forEach(function(a){a.id=a.id+"_"+d.options.id+"_user_vector",a.source&&(a.source=a.source+"_"+d.options.id+"_user_vector"),a.ref&&(a.ref=a.ref+"_"+d.options.id+"_user_vector")});var h=d.findCorrectInsertIndex(f);[].splice.apply(f,[h,0].concat(g));var j=i(c.sources,b.sources);c.sprite=b.sprite,c.sources=JSON.parse(JSON.stringify(j)),c.layers=f,a.setStyle(c,{localIdeographFontFamily:a.localIdeographFontFamily}),Object.keys(e).forEach(function(b){var c=b.split("_url_=")[1];!a.style[n].images[b]&&c&&a.loadImage(c,function(c,d){c&&(console.log(c),d=new Image,d.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII="),a.style[n].images[b]||a.addImage(b,d)})})}else console.log("\u9519\u8BEF\u7684access_token\u6216style_url")})}else{var r=c.imageOptions;if(a.getLayer(c.id)&&!a.getLayer(c.id+"_mask")){if(a.setPaintProperty(c.id,"raster-opacity",+r["raster-opacity"]),r.filter?(a.setPaintProperty(c.id,"raster-saturation",+r["raster-saturation"]),a.setPaintProperty(c.id,"raster-hue-rotate",+r["raster-hue-rotate"]),a.setPaintProperty(c.id,"raster-brightness-min",+r["raster-brightness-min"]),a.setPaintProperty(c.id,"raster-brightness-max",+r["raster-brightness-max"]),a.setPaintProperty(c.id,"raster-contrast",+r["raster-contrast"])):(a.setPaintProperty(c.id,"raster-saturation",0),a.setPaintProperty(c.id,"raster-hue-rotate",0),a.setPaintProperty(c.id,"raster-brightness-min",0),a.setPaintProperty(c.id,"raster-brightness-max",1),a.setPaintProperty(c.id,"raster-contrast",0)),a.getSource(c.id)){var s=a.getSource(c.id);if("image"===s.type&&JSON.stringify(s.coordinates===JSON.stringify([[r.minLng,r.maxLat],[r.maxLng,r.maxLat],[r.maxLng,r.minLat],[r.minLng,r.minLat]]))&&s.url===r.url)return;a.getSource(c.id)&&a.removeSource(c.id),a.addSource(c.id,{type:"image",url:r.url,coordinates:[[r.minLng,r.maxLat],[r.maxLng,r.maxLat],[r.maxLng,r.minLat],[r.minLng,r.minLat]]})}return}var t=a.getStyle();a.getLayer(c.id)&&a.removeLayer(c.id);var u={};Object.keys(t.sources).forEach(function(a){-1!==a.indexOf("_datav")&&-1===a.indexOf(c.id+"_user_vector")&&(u[a]=t.sources[a])}),u[c.id]={type:"image",url:r.url,coordinates:[[r.minLng,r.maxLat],[r.maxLng,r.maxLat],[r.maxLng,r.minLat],[r.minLng,r.minLat]]};var v=t.layers.filter(function(a){return-1!==a.id.indexOf("_datav")&&-1===a.id.indexOf(c.id)&&-1===a.id.indexOf(d.options.id+"_user_vector")}),w=this.findCorrectInsertIndex(v);[].splice.apply(v,[w,0].concat([{id:c.id,type:"raster",source:this.options.id,paint:{"raster-opacity":+r["raster-opacity"],"raster-saturation":r.filter?+r["raster-saturation"]:0,"raster-hue-rotate":r.filter?+r["raster-hue-rotate"]:0,"raster-brightness-min":r.filter?+r["raster-brightness-min"]:0,"raster-brightness-max":r.filter?+r["raster-brightness-max"]:1,"raster-contrast":r.filter?+r["raster-contrast"]:0}}])),v=v.filter(function(a){return"background_datav"!==a.id}),v.unshift({id:"background_datav",type:"background",paint:{"background-color":"rgba(0,0,0,0)"}}),t.sources=JSON.parse(JSON.stringify(u)),t.layers=v,a.setStyle(t)}}},{key:"isMapboxURL",value:function(a){return 0===a.indexOf("mapbox:")}},{key:"parseUrl",value:function(a){var b=a.match(j);return b||console.log("Unable to parse URL object"),{protocol:b[1],authority:b[2],path:b[3]||"/",params:b[4]?b[4].split("&"):[]}}},{key:"formatUrl",value:function(a){var b=a.params.length?"?"+a.params.join("&"):"";return a.protocol+"://"+a.authority+a.path+b}},{key:"normalizeStyleURL",value:function(a,b){if(!this.isMapboxURL(a))return a;var c=this.parseUrl(a);return c.path="/styles/v1"+c.path,this.makeAPIURL(c,b)}},{key:"normalizeSpriteURL",value:function(a,b){var c=this.parseUrl(a);return this.isMapboxURL(a)?(c.path="/styles/v1"+c.path+"/sprite",this.makeAPIURL(c,b)):a}},{key:"makeAPIURL",value:function(a,c){var d=this.parseUrl(b.config.API_URL);return(a.protocol=d.protocol,a.authority=d.authority,"/"!==d.path&&(a.path=""+d.path+a.path),!b.config.REQUIRE_ACCESS_TOKEN)?this.formatUrl(a):(c=c||b.config.ACCESS_TOKEN,c||console.log("An API access token is required to use Mapbox GL. "+k),"s"===c[0]&&console.log("Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). "+k),a.params.push("access_token="+c),this.formatUrl(a))}},{key:"updateOptions",value:function(a){this.options=i(this.options,a),this.data&&this.data.length&&(this.options.rasterOptions.url=this.data[0].url),this.setBasemap(this.options)}},{key:"setData",value:function(a){this.data=a,a.length&&a[0]&&a[0].url&&this.updateOptions({rasterOptions:{url:a[0].url}})}},{key:"remove",value:function(){var b=this;this.endID&&clearTimeout(this.endID),this.resetID&&clearTimeout(this.resetID);var c=a.getStyle(),d={};Object.keys(c.sources).forEach(function(a){-1!==a.indexOf("_datav")&&-1===a.indexOf(b.options.id)&&(d[a]=c.sources[a])});var e=c.layers.filter(function(a){return-1!==a.id.indexOf("_datav")&&-1===a.id.indexOf(b.options.id)});c.sources=d,c.layers=e,a.setStyle(c)}}]),h}(h)},a.exports});;
Cube("datav:/com/datavmap-3d-layer-basemap/0.0.27",["datav:/npm/eventemitter3/2.0.3","datav:/npm/safely-merge/1.0.1"],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"===typeof b||"function"===typeof b)?b:a}function f(a,b){if("function"!==typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=c("datav:/npm/eventemitter3/2.0.3"),i=c("datav:/npm/safely-merge/1.0.1"),j=c("datav:/com/datavmap-3d-layer-basemap/0.0.27/tileLayer.js"),k={},l=function(a){function b(a,c){d(this,b);var f=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return f.container="string"===typeof a?document.querySelector(a):a,f.apis=c.apis,f.map=null,f._data=null,f.config=c,f}return f(b,a),g(b,[{key:"initLayer",value:function(){var a=this.getOptions(),b=j(this.map);this.layer=new b(a)}},{key:"addTo",value:function(a){var b=this;this.map=a,this.mtag=this.id+"_datav_basemap",this.init(),this.endID=setTimeout(function(){b.resetID&&clearTimeout(b.resetID)},100000)}},{key:"init",value:function(){var a=this;this.map.loaded()&&this.map.isStyleLoaded()?(this.resetID&&clearTimeout(this.resetID),this.initLayer(),this.data&&this.data.length&&this.render(this.data)):(this.resetID&&clearTimeout(this.resetID),this.resetID=setTimeout(function(){a.init()},100))}},{key:"getOptions",value:function(){return this.config=i(k,this.config),i(this.config,{id:this.mtag,rasterOptions:{url:this.config.rasterOptions.url?this.config.rasterOptions.url:"GeoQBlue"}})}},{key:"data",value:function(a){return a&&(this._data=a),this._data}},{key:"remove",value:function(){this.endID&&clearTimeout(this.endID),this.resetID&&clearTimeout(this.resetID),this.layer&&this.layer.remove&&this.layer.remove(),this.layer=null,this._data=null}},{key:"render",value:function(a){a&&(this.data=a,this.layer&&this.layer.setData(a))}},{key:"updateOptions",value:function(a){this.config=i(this.config,a),a=this.getOptions(),this.layer&&this.layer.updateOptions(a)}}]),b}(h);return a.exports=l,a.exports});