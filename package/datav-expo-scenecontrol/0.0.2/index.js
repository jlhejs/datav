// env=undefined => env=publish 
Cube("datav:/com/datav-expo-scenecontrol/0.0.2",["datav:/npm/lodash/4.17.4","datav:/npm/async/2.5.0","datav:/npm/tween.js/16.6.0","datav:/npm/chroma-js/1.3.4","datav:/npm/eventemitter3/2.0.3","datav:/npm/safely-merge/1.0.1"],function(a,b,c){let d=null;const e=c("datav:/npm/lodash/4.17.4"),f=c("datav:/npm/async/2.5.0"),g=c("datav:/npm/tween.js/16.6.0"),h=c("datav:/npm/chroma-js/1.3.4"),i=c("datav:/npm/eventemitter3/2.0.3"),j=c("datav:/npm/safely-merge/1.0.1"),k={delay:3e3,duration:3e3,isWork:!1};return a.exports=class extends i{constructor(a,b){super(),this.options=j(k,b||{}),this.isStop=!1,this.repeating=!1,this.prePos=null,this.currentPos=null,this.currentTween=null,this.preStatus=[]}addTo(a){return a?void(d=a.three,this.map=a,this.scene=a.scene,this.orbitControls=a.controls,this.camera=this.orbitControls.object,this.init()):console.log("scenecontrol layer needs map layer")}setData(a){this.stop(),this.cameraPos=a,this.checkIsWork()}checkIsWork(){this.options.isWork?this.repeat():this.stop()}init(){this.initEvents()}initEvents(){this.map.on("animationFrame",this.animation.bind(this))}repeat(){if(this.cameraPos){this.repeating=!0,this.prePos||(this.prePos=this.cameraPos[0]),this.currentPos||(this.currentPos=e.cloneDeep(this.prePos)),this.isStop=!1;let a=this.cameraPos[0].delay;this.cameraPos[0].delay=0,this.doSceneSwitch(),this.cameraPos[0].delay=a}}stop(){this.repeating=!1,this.prePos=e.cloneDeep(this.currentPos),this.currentTween&&this.currentTween.stop(),this.currentTween&&g.remove(this.currentTween),this.currentTween=null,this.isStop=!0}doSceneSwitch(){let a=this;f.eachSeries(this.cameraPos,this.doTween.bind(this),function(){a.isStop||a.doSceneSwitch()})}doTween(a,b){let c=this.genTween(a,b);this.isStop?b("stop"):(this.currentTween=c,c.start())}getCameraPosByName(a){let b=e.findIndex(this.cameraPos,function(b){return b.name==a});return-1===b?this.cameraPos[0]:this.cameraPos[b]}genTween(a,b){let c=this,d=this.options,f=this.orbitControls,h=void 0===a.delay?d.delay:a.delay,i=void 0===a.duration?d.duration:a.duration,j=new g.Tween({fov:c.prePos.position.fov,px:c.prePos.position.px,py:c.prePos.position.py,pz:c.prePos.position.pz,tx:c.prePos.position.tx,tx:c.prePos.position.tx,tx:c.prePos.position.tx}).to(a.position,i).delay(h).onStart(function(){c.restoreKeyFrame()}).easing(a.easing||g.Easing.Linear.None).onUpdate(function(){c.currentPos&&(c.currentPos.position={fov:this.fov,px:this.px,py:this.py,pz:this.pz,tx:this.tx,ty:this.ty,tz:this.tz}),c.updateCameraPos(c.currentPos.position)}).onComplete(function(){c.prePos=e.cloneDeep(a),c.currentPos=e.cloneDeep(a),c.updateKeyFrame(a),g.remove(),b&&b()});return j}updateCameraPos(a){let b=new d.Vector3(a.tx,a.ty,a.tz);this.camera.fov=a.fov,this.orbitControls.target.copy(b),this.camera.position.set(a.px,a.py,a.pz),this.camera.lookAt(b),this.camera.updateProjectionMatrix()}restoreKeyFrame(){this.preStatus.length&&this.preStatus.forEach((a)=>{let b=a.mesh,d=a.preMesh;b.visible=d.visible,b.material.opacity=d.material.opacity;let e=d.material.color;b.material.color.setRGB(e.r,e.g,e.b),d&&d.dispose&&d.dispose(),d=null}),this.preStatus=[]}updateKeyFrame(a){let b=a.keyframe;b&&Array.isArray(b)&&b.length&&b.forEach((a)=>{let b=a.id,c=this.scene.getObjectByName(b);c&&c.traverse((b)=>{if("Mesh"===b.type){let d=b.clone();b.material=b.material.clone(),b.material.transparent=!0,b.visible=a.visible,b.material.opacity=a.opacity;let e=h(a.color).gl();b.material.color.setRGB(e[0],e[1],e[2]),this.preStatus.push({preMesh:d,mesh:b})}})})}removeLivingTween(){this.currentPos=null,this.currentTween&&this.currentTween.stop(),this.currentTween&&g.remove(this.currentTween),this.currentTween=null}switchCameraPositionByName(a){if("stop"===a)return this.stop();if("repeat"===a)return this.repeating?void 0:this.repeat();this.stop();let b=this.getCameraPosByName(a);if(b){this.currentPos||(this.currentPos=e.cloneDeep(b)),this.prePos||(this.prePos=e.cloneDeep(this.cameraPos[0]||this.currentPos));let a=b.delay;b.delay=0;let c=this.genTween(b);c.start(),this.currentTween=c,b.delay=a}}updateOptions(a){let b=this.options.isWork;this.options=j(this.options,a||{}),b!==a.isWork&&this.checkIsWork()}animation(){g.update()}remove(){this.map.off("animationFrame",this.animation),this.stop(),this.isStop=!1,this.repeating=!1,this.prePos=null,this.currentPos=null,this.currentTween=null,this.cameraPos=null,this.preStatus=[]}},a.exports});