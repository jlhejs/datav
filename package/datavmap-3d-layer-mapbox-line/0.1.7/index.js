// env=undefined => env=publish 
Cube("datav:/com/datavmap-3d-layer-mapbox-line/0.1.7/mlineLayer.js",["datav:/npm/eventemitter3/2.0.3","datav:/npm/safely-merge/1.0.1","datav:/npm/geojson-bbox/0.0.0"],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"===typeof b||"function"===typeof b)?b:a}function f(a,b){if("function"!==typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=c("datav:/npm/eventemitter3/2.0.3"),i=c("datav:/npm/safely-merge/1.0.1"),j=c("datav:/npm/geojson-bbox/0.0.0");return a.exports=function(a){var b=a.datavgl,c={};return function(h){function k(b){d(this,k);var f=e(this,(k.__proto__||Object.getPrototypeOf(k)).call(this));return b=i(c,b),f.options=i(f.options,b),f.onclick=f.onclick.bind(f),f.onmousemove=f.onmousemove.bind(f),f.tagIndex=a.submtags.line.length-1,f.init(),f}return f(k,h),g(k,[{key:"init",value:function(){this.data=[],this.interactiveLayers=[],this.geojson={type:"FeatureCollection",features:[]},this.new_geojson={type:"FeatureCollection",features:[]},a.getSource(this.options.id)||a.addSource(this.options.id,{type:"geojson",data:{type:"FeatureCollection",features:[]}}),this.updateLayers(),a.on("mousemove",this.onmousemove),a.on("mouseup",this.onclick)}},{key:"onmousemove",value:function(b){var c=this;if(this.options.interactive.interactive){var d=a.tolerance||1,e=[[b.point.x-d/2,b.point.y-d/2],[b.point.x+d/2,b.point.y+d/2]],f=this.interactiveLayers.filter(function(b){return a.getLayer(b)}),g=a.queryRenderedFeatures(e,{layers:f});return g.length?void(a.lineHover=!0,setTimeout(function(){return a.circleHover||!a.lineHover?(a.getLayer(c.options.id+"_layer_hover")&&a.setFilter(c.options.id+"_layer_hover",["==","datavid",""]),void(a.lineHover=!1)):void(a.lineHover=!1,a.getCanvas().style.cursor=c.options.interactive.clickPopup?"pointer":"",a.getLayer(c.options.id+"_layer_hover")&&a.setFilter(c.options.id+"_layer_hover",["==","datavid",g.length?void 0==g[0].properties.datavid?"":g[0].properties.datavid:""]))},6-0.1*this.tagIndex)):(a.getLayer(this.options.id+"_layer_hover")&&a.setFilter(this.options.id+"_layer_hover",["==","datavid",""]),void(a.getCanvas().style.cursor=""))}}},{key:"onclick",value:function(c){var d=this;if(this.options.interactive.interactive){var e=this.interactiveLayers.filter(function(b){return a.getLayer(b)}),f=a.tolerance||1,g=[[c.point.x-f/2,c.point.y-f/2],[c.point.x+f/2,c.point.y+f/2]],h=a.queryRenderedFeatures(g,{layers:e});h.length&&(a.lineClick=!0,setTimeout(function(){if(a.circleClick||!a.lineClick)return void(a.lineClick=!1);if(a.lineClick=!1,d.options.interactive.clickZoom){var e=j(h[0]),f=Math.abs(e[1]-e[3])*(d.options.interactive.zoomPad-1),g=Math.abs(e[0]-e[2])*(d.options.interactive.zoomPad-1);a.fitBounds([[e[0]-g,e[1]-f],[e[2]+g,e[3]+f]])}d.emit("click",h[0].properties),d.options.interactive.clickPopup&&h[0].properties.info&&new b.Popup().setLngLat(c.lngLat).setHTML(h[0].properties.info).addTo(a)},6-0.1*this.tagIndex))}}},{key:"setGeojson",value:function(a){this.geojson=a,this.genGeojson()}},{key:"setData",value:function(a){this.data=a,this.genGeojson()}},{key:"genGeojson",value:function(){var b=this;if(this.data.length){var c="";this.new_geojson.features=this.geojson.features.map(function(a){c=c||a.properties.link_id&&"link_id",c=c||a.properties.linkid&&"linkid",c=c||a.properties.id&&"id",c=c||a.properties.name&&"name";var d=b.data.find(function(b){return b.link_id==a.properties[c]});return d&&(d.link_id=""+d.link_id),Object.assign(a.properties,d),a})}else this.new_geojson=this.geojson;this.minValue=Math.min.apply([],this.new_geojson.features.map(function(a){return+a.properties.value})),this.maxValue=Math.max.apply([],this.new_geojson.features.map(function(a){return+a.properties.value})),isFinite(this.minValue)&&isFinite(this.maxValue)||(this.minValue=0,this.maxValue=0),this.new_geojson.features.forEach(function(a,b){a.properties.datavid=b+1}),a.getSource(this.options.id)&&a.getSource(this.options.id).setData(this.new_geojson),this.updateData()}},{key:"removeLayers",value:function(){var b=this;Object.keys(a.style._layers).forEach(function(c){-1!==c.indexOf(b.options.id)&&a.getLayer(c)&&a.removeLayer(c)})}},{key:"findCorrectInsertIndex",value:function(){var b=a.submtags,c=void 0;return 1<b.line.length&&(c=this.findInsertIndexByLayerTag(b.line),-1!==c)?c:b.circle.length&&(c=this.findBeforeIndexByLayerTag(b.circle[0]),-1!==c)?c:b.fill.length&&(c=this.findAfterIndexByLayerTag(b.fill[b.fill.length-1]),-1!==c)?c:b.basemap.length&&(c=this.findAfterIndexByLayerTag(b.basemap[b.basemap.length-1]),-1!==c)?c:a.getStyle().layers.length}},{key:"findInsertIndexByLayerTag",value:function(a){var b=this,c=a.findIndex(function(a){return-1!==a.indexOf(b.options.id)});return c===a.length-1?this.findAfterIndexByLayerTag(a[c-1]):this.findBeforeIndexByLayerTag(a[c+1])}},{key:"findAfterIndexByLayerTag",value:function(b){var c=a.getStyle(),e=-1;return c.layers.forEach(function(a,c){-1!==a.id.indexOf(b)&&(e=c+1)}),e}},{key:"findBeforeIndexByLayerTag",value:function(b){var c=a.getStyle();return c.layers.findIndex(function(a){return-1!==a.id.indexOf(b)})}},{key:"findInsertIndex",value:function(){var b=a.getStyle(),c=-1,e=-1,f=-1,g=-1;if(b.layers.forEach(function(a,b){-1!==a.id.indexOf("datav_fill")&&(c=b+1),-1!==a.id.indexOf("datav_line")&&(f=b+1),-1!==a.id.indexOf("datav_circle")&&(g=b+1),-1!==a.id.indexOf("datav_basemap")&&(e=b+1)}),-1!==f)return f;if(-1!==c)return c;if(-1!==e)return e;if(-1!==g)for(var d=0;d<b.layers.length;d++)if(-1!==b.layers[d].id.indexOf("datav_circle"))return d;return b.layers.length}},{key:"updateLayers",value:function(){var a=this;this.removeLayers(),this.interactiveLayers=[];var b=[],c=this.layers=[],d=this.options.underlinestroke,e=this.options.stroke,f=this.options.interactive,g=this.options.label;d.show&&c.push({id:this.options.id+"_layer_underline",type:"line",source:this.options.id,layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":d["line-color"],"line-width":d["line-width"],"line-blur":d["line-blur"]}}),c.push(JSON.parse(JSON.stringify({id:this.options.id+"_layer_line",type:"line",source:this.options.id,layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":{default:e["line-color"].color,property:"value",type:"exponential",stops:[[this.minValue||0,e["line-color"].minColor],[this.maxValue||0,e["line-color"].maxColor]]},"line-width":{default:e["line-width"].width,property:"value",type:"exponential",stops:[[this.minValue||0,e["line-width"].minWidth],[this.maxValue||0,e["line-width"].maxWidth]]},"line-blur":e["line-blur"],"line-dasharray":e["line-dasharray"]?e["line-dasharray"].split(",").map(function(a){return+a||0}):void 0}}))),b.push(this.options.id+"_layer_line"),f.isHover.show&&c.push({id:this.options.id+"_layer_hover",type:"line",source:this.options.id,layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":f.isHover["hover-color"],"line-width":f.isHover["hover-width"],"line-blur":2},filter:["==","datavid",""]}),g.show&&g["text-field"]&&c.push({id:this.options.id+"_layer_symbol_label",type:"symbol","symbol-placement":"line",source:this.options.id,layout:{"text-max-angle":45,"text-pitch-alignment":"viewport","symbol-placement":"line","symbol-avoid-edges":!0,"symbol-spacing":200,"text-rotation-alignment":"map","text-field":g["text-field"],"text-size":g["text-size"]},paint:{"text-color":g["text-color"],"text-halo-blur":g["text-halo-blur"],"text-halo-color":g["text-halo-color"],"text-halo-width":g["text-halo-width"],"text-translate":g["text-translate"]?g["text-translate"].split(",").map(function(a){return+a||0}):[0,0]}}),this.updateStyle(),this.interactiveLayers=b,this.endID=setTimeout(function(){a.resetID&&clearTimeout(a.resetID)},100000)}},{key:"updateStyle",value:function(){var b=this;if(a.loaded()&&a.isStyleLoaded()){this.resetID&&clearTimeout(this.resetID);var c=this.findCorrectInsertIndex(),d=a.getStyle(),e=this.layers;e.forEach(function(a){a.layout&&(a.layout.visibility=b.options.visible?"visible":"none"),a.layout||(a.layout={visibility:b.options.visible?"visible":"none"})}),[].splice.apply(d.layers,[c,0].concat(e)),a.setStyle(d),this.updateData()}else this.resetID&&clearTimeout(this.resetID),this.resetID=setTimeout(function(){b.updateStyle()},200)}},{key:"updateData",value:function(){var b=this.options.stroke;a.getLayer(this.options.id+"_layer_line")&&(a.setPaintProperty(this.options.id+"_layer_line","line-color",{default:b["line-color"].color,property:"value",type:"exponential",stops:[[this.minValue||0,b["line-color"].minColor],[this.maxValue||0,b["line-color"].maxColor]]}),a.setPaintProperty(this.options.id+"_layer_line","line-width",{default:b["line-width"].width,property:"value",type:"exponential",stops:[[this.minValue||0,b["line-width"].minWidth],[this.maxValue||0,b["line-width"].maxWidth]]}))}},{key:"updateOptions",value:function(a){this.options=i(this.options,a),this.updateLayers()}},{key:"show",value:function(){this.options.visible=!0,this.updateOptions(this.options)}},{key:"hide",value:function(){this.options.visible=!1,this.updateOptions(this.options)}},{key:"remove",value:function(){this.endID&&clearTimeout(this.endID),this.resetID&&clearTimeout(this.resetID),this.interactiveLayers=[],a.off("mousemove",this.onmousemove),a.off("mouseup",this.onclick),this.removeLayers(),a.getSource(this.options.id)&&a.removeSource(this.options.id)}}]),k}(h)},a.exports});;
Cube("datav:/com/datavmap-3d-layer-mapbox-line/0.1.7",["datav:/npm/eventemitter3/2.0.3","datav:/npm/safely-merge/1.0.1"],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"===typeof b||"function"===typeof b)?b:a}function f(a,b){if("function"!==typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=c("datav:/npm/eventemitter3/2.0.3"),i=c("datav:/npm/safely-merge/1.0.1"),j=c("datav:/com/datavmap-3d-layer-mapbox-line/0.1.7/mlineLayer.js"),k={},l=function(a){function b(a,c){d(this,b);var f=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return f.container="string"===typeof a?document.querySelector(a):a,f.apis=c.apis,f.map=null,f._data=null,f.config=c,f}return f(b,a),g(b,[{key:"initLayer",value:function(){var a=this,b=this.getOptions(),c=j(this.map);this.layer=new c(b),this.layer.on("click",function(b){var c=a.getOptions();a.emit("mapbox-line-map-click",b),""!==c.interactive["click-key"]&&a.emit("global_var",c.interactive["click-key"],b[c.interactive["click-key"]])})}},{key:"addTo",value:function(a){var b=this;this.map=a,this.config.id=this.mtag=this.id+"_datav_line",this.resetID&&clearTimeout(this.resetID),this.init(),this.endID=setTimeout(function(){b.resetID&&clearTimeout(b.resetID)},100000)}},{key:"init",value:function(){var a=this;this.map.loaded()&&this.map.isStyleLoaded()?(this.resetID&&clearTimeout(this.resetID),this.initLayer(),this.geojson&&this.setGeojson(this.geojson),this.data&&this.setData(this.data)):(this.resetID&&clearTimeout(this.resetID),this.resetID=setTimeout(function(){a.init()},100))}},{key:"getOptions",value:function(){return this.config=i(k,this.config),this.config}},{key:"setGeojson",value:function(a){this.geojson=a,!a||"FeatureCollection"!==a.type||this.layer&&this.layer.setGeojson(a)}},{key:"setData",value:function(a){a&&(this.data=a,this.layer&&this.layer.setData(a))}},{key:"show",value:function(){this.config.visible=!0,this.layer&&this.layer.show&&this.layer.show()}},{key:"hide",value:function(){this.config.visible=!1,this.layer&&this.layer.hide&&this.layer.hide()}},{key:"remove",value:function(){this.endID&&clearTimeout(this.endID),this.resetID&&clearTimeout(this.resetID),this.layer&&this.layer.remove&&this.layer.remove(),this.layer=null,this._data=null}},{key:"updateOptions",value:function(a){this.config=i(this.config,a),a=this.getOptions(),this.layer&&this.layer.updateOptions(a)}}]),b}(h);return a.exports=l,a.exports});