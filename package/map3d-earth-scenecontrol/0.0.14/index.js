// env=undefined => env=publish 
Cube("datav:/com/map3d-earth-scenecontrol/0.0.14",["datav:/npm/async/2.5.0","datav:/npm/eventemitter3/2.0.3"],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"===typeof b||"function"===typeof b)?b:a}function f(a,b){if("function"!==typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=null,i=null,j=c("datav:/npm/async/2.5.0"),k=c("datav:/npm/eventemitter3/2.0.3"),l=function(a){function b(a,c){d(this,b);var f=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return f.options=Object.assign({delay:3e3,duration:3e3,isWork:!1,tweenMode:"once"},c||{}),f.isStop=!1,f.repeating=!1,f.posIndex=0,f.isFirstCircle=!0,f.prePos=null,f.currentPos=null,f.currentTween=null,f}return f(b,a),g(b,[{key:"addTo",value:function(a){return a?void(h=a.THREE,i=a.Utils,this.map=a,this.scene=a.scene,this.orbitControls=a.orbitControls):console.log("scenecontrol layer needs map layer")}},{key:"setData",value:function(a){this.stop(),this.posIndex=0,this.isFirstCircle=!0,this.cameraPos=a,this.checkIsWork()}},{key:"checkIsWork",value:function(){this.stop(),this.options.isWork&&this.repeat()}},{key:"repeat",value:function(){if(this.cameraPos){this.repeating=!0,this.prePos||(this.prePos=this.getCameraPosByOrbitControl()),this.currentPos||(this.currentPos=i.deepClone(this.prePos)),this.isStop=!1;var a=this.cameraPos[0].delay;this.cameraPos[0].delay=0,this.doSceneSwitch(),this.cameraPos[0].delay=a}}},{key:"stop",value:function(){this.repeating=!1,this.prePos=i.deepClone(this.currentPos),this.currentTween&&this.currentTween.stop(),this.currentTween&&i.TWEEN.remove(this.currentTween),this.currentTween=null,this.isStop=!0}},{key:"doSceneSwitch",value:function(){var a=this;j.eachSeries(this.cameraPos,this.doTween.bind(this),function(){a.isStop||"repeat"!==a.options.tweenMode||(a.isFirstCircle=!1,a.doSceneSwitch())})}},{key:"doTween",value:function(a,b){var c=this.genTween(a,b);this.isStop?b("stop"):(this.currentTween=c,c.start())}},{key:"getCameraPosByName",value:function(a){if(!Array.isArray(this.cameraPos))return null;var b=this.cameraPos.findIndex(function(b){return b.name===a});return-1===b?this.cameraPos[0]:this.cameraPos[b]}},{key:"genTween",value:function(a,b){var c=!1,d=this,e=this.options,f=void 0===a.delay?e.delay:a.delay,g=void 0===a.duration?e.duration:a.duration;if(Array.isArray(this.cameraPos)&&2<=this.cameraPos.length&&0===this.posIndex&&!this.isFirstCircle){var h=this.cameraPos[0].position.lng,j=this.cameraPos[this.cameraPos.length-1].position.lng;180<Math.abs(h-j)&&!(0<h&&0>j)&&(a=i.deepClone(a),a.position.lng+=360,c=!0)}var k=new i.TWEEN.Tween({fov:d.prePos.position.fov,lat:d.prePos.position.lat,lng:d.prePos.position.lng,distance:d.prePos.position.distance}).to(a.position,g).delay(f).onStart(function(){}).easing(a.easing||i.TWEEN.Easing.Linear.None).onUpdate(function(){d.currentPos&&(d.currentPos.position={fov:this.fov,lat:this.lat,lng:this.lng,distance:this.distance}),d.updateCameraPos(this.fov,this.lat,this.lng,this.distance)}).onComplete(function(){c&&(a.position.lng-=360),d.prePos=i.deepClone(a),d.currentPos=i.deepClone(a),d.posIndex++,d.posIndex%=d.cameraPos.length,i.TWEEN.remove(),d.emitCallBackId(a),b&&b()});return k}},{key:"emitCallBackId",value:function(a){var b=this.options,c=b.callbackId,d=a[c];this.emit("map3d-earth-scene-loop-completed",a),c&&this.emit("global_var",c,d)}},{key:"getCameraPosByOrbitControl",value:function(){var a=this.orbitControls.object.position,b=a.distanceTo(new h.Vector3(0,0,0)),c=a.clone().multiplyScalar(200/b),d=this.map.unProjection(c.x,c.y,c.z),e={fov:this.orbitControls.object.fov,lat:d.lat,lng:d.lng,distance:b};return{position:e}}},{key:"updateCameraPos",value:function(a,b,c,d){if(0===this.map.projType){var e=this.map.Projection(c,b),f=new h.Vector3(0,0,0),g=new h.Vector3(e.x,e.y,e.z),i=g.distanceTo(f),j=g.clone().multiplyScalar(d/i);this.orbitControls.object.position.set(j.x,j.y,j.z),this.orbitControls.target.copy(f)}else if(1===this.map.projType){var k=this.map.Projection(c,b,200),l=new h.Vector3(k.x,k.y,k.z),m=new h.Vector3(k.x,k.y,k.z+d-200);this.orbitControls.object.position.set(m.x,m.y,m.z),this.orbitControls.target.copy(l)}this.orbitControls.object.fov=a,this.orbitControls.object.updateProjectionMatrix()}},{key:"removeLivingTween",value:function(){this.currentPos=null,this.currentTween&&this.currentTween.stop(),this.currentTween&&i.TWEEN.remove(this.currentTween),this.currentTween=null}},{key:"switchCameraPositionByName",value:function(a){if("stop"===a)return this.stop();if("repeat"===a)return this.repeating?void 0:this.repeat();this.stop();var b=this.getCameraPosByName(a);if(b){this.currentPos||(this.currentPos=i.deepClone(b)),this.prePos||(this.prePos=i.deepClone(this.cameraPos[0]||this.currentPos));var c=b.delay;b.delay=0,this.posIndex=0,this.isFirstCircle=!0;var d=this.genTween(b);d.start(),this.currentTween=d,b.delay=c}}},{key:"updateOptions",value:function(a){var b=this.options.isWork,c=this.options.tweenMode;this.options=i.mergeOptions(this.options,a||{}),(b!==a.isWork||c!==a.tweenMode)&&this.checkIsWork()}},{key:"remove",value:function(){this.stop(),this.isStop=!1,this.repeating=!1,this.posIndex=0,this.prePos=null,this.currentPos=null,this.currentTween=null,this.cameraPos=null}}]),b}(k);return a.exports=l,a.exports});