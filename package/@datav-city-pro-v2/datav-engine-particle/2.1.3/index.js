// env=undefined => env=publish 
Cube("datav:/com/@datav-city-pro-v2/datav-engine-particle/2.1.3/shader/point.frag.glsl",[],function(n,e,t,o,i,l){return n.exports="#define GLSLIFY 1\nuniform vec3 diffuse;\nuniform float opacity;\nuniform float pickedId;\nuniform vec3 pickedColor;\nuniform float pickedOpacity;\nuniform float highColorPattern;\n// uniform sampler2D uTexture;\n\n#include <common>\n#include <color_pars_fragment>\n#include <map_particle_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\nflat in float vId;\nflat in vec4 vColor;\n\nvoid main() {\n\t#include <clipping_planes_fragment>\n\n\tbool isPicked = pickedId > vId - 0.5 && pickedId < vId + 0.5;\n\t \n\t// 后期渲染模块会统一做gamma校正，\n    // 为了图元渲染颜色和配置项设置颜色保持一致，需要做以下处理以抵消\n\tvec4 vColor2 = vec4(pow(vColor.r, 2.2), pow(vColor.g, 2.2),pow(vColor.b, 2.2), vColor.a);\n\tvec3 pickedColor2 = vec3(pow(pickedColor.r, 2.2), pow(pickedColor.g, 2.2),pow(pickedColor.b, 2.2));\n\n\tvec4 diffuseColor = vColor2;\n\n\t#include <logdepthbuf_fragment>\n\t\n\t// #include <map_particle_fragment>\n\t#if defined( USE_MAP ) || defined( USE_ALPHAMAP )\n\t\tvec2 uv = ( uvTransform * vec3( gl_PointCoord.x, 1.0 - gl_PointCoord.y, 1 ) ).xy;\n    #endif\n\n    #ifdef USE_MAP\n\t\tvec4 mapTexel = texture2D( map, uv );\n\n\t\tif(isPicked){\n\t\t\tif(abs(highColorPattern-0.0) < EPSILON){\n\t\t\t\t// 正常高亮，不遮挡图案\n\t\t\t\tdiffuseColor = vec4( pickedColor2, pickedOpacity);\n            \tfloat channelAvenue = (mapTexel.r + mapTexel.g + mapTexel.b) / 3.0;\n\t\t\t\tdiffuseColor *= vec4(channelAvenue, channelAvenue, channelAvenue, mapTexel.a);\n\t\t\t}else if(abs(highColorPattern-1.0) < EPSILON){\n\t\t\t\t// 遮挡图案高亮\n\t\t\t\tdiffuseColor = vec4( pickedColor2, pickedOpacity * mapTexel.a);\n\t\t\t}else{\n\t\t\t\t// 视觉上无高亮变化\n\t\t\t\tdiffuseColor *= mapTexel;\n\t\t\t}\n\t\t\t\n\t\t}else{\n\t\t\tdiffuseColor *= mapTexel;\n\n\t\t}\n\n    #endif\n\n    #ifdef USE_ALPHAMAP\n\t\tdiffuseColor.a *= texture2D( alphaMap, uv ).g;\n    #endif\n\n\t#include <color_fragment>\n\t#include <alphatest_fragment>\n\t\n\tgl_FragColor = diffuseColor;\n\n\t#include <premultiplied_alpha_fragment>\n\t\n\t// 后期统一处理，这里无需\n\t// #include <tonemapping_fragment>\n\t// #include <encodings_fragment>\n\n\t#include <fog_fragment>\n}",n.exports});;
Cube("datav:/com/@datav-city-pro-v2/datav-engine-particle/2.1.3/shader/point.vert.glsl",[],function(e,t,n,i,o,r){return e.exports="#define GLSLIFY 1\nattribute float id;\nattribute float aSize;\nattribute vec4 aColor;\n\nuniform float uSizeFactor;\n\n// uniform float size;\n// uniform float scale;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nflat out float vId;\nflat out vec4 vColor;\n\nvoid main() {\n\t#include <color_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\t// gl_PointSize = size;\n\tgl_PointSize = aSize * uSizeFactor;\n\n\tvId = id;\n\tvColor = aColor;\n\n\t#ifdef USE_SIZEATTENUATION\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\t\tif ( isPerspective ) gl_PointSize = 1000.0 * ( aSize * uSizeFactor / - mvPosition.z );\n\t#endif\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <fog_vertex>\n}",e.exports});;
Cube("datav:/com/@datav-city-pro-v2/datav-engine-particle/2.1.3/shader/pick.frag.glsl",[],function(n,e,t,a,i,c){return n.exports="#define GLSLIFY 1\nuniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <color_pars_fragment>\n#include <map_particle_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\nflat in vec3 vEncodedId;\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_particle_fragment>\n\t#include <color_fragment>\n\t#include <alphatest_fragment>\n\tgl_FragColor = vec4(vEncodedId, 1.0);\n}",n.exports});;
Cube("datav:/com/@datav-city-pro-v2/datav-engine-particle/2.1.3/shader/pick.vert.glsl",[],function(e,n,t,i,r,o){return e.exports="#define GLSLIFY 1\nattribute vec3 encodedId;\nattribute float aSize;\n\n// uniform float size;\n// uniform float scale;\nuniform float uSizeFactor;\n\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nflat out vec3 vEncodedId;\n\nvoid main() {\n\t#include <color_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\n\t// gl_PointSize = size;\n\tgl_PointSize = aSize * uSizeFactor;\n\n\tvEncodedId = encodedId;\n\t#ifdef USE_SIZEATTENUATION\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\t\t// if ( isPerspective ) gl_PointSize *= ( scale / - mvPosition.z );\n\t\tif ( isPerspective ) gl_PointSize = 1000.0 * ( aSize * uSizeFactor / - mvPosition.z );\n\n\t#endif\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <fog_vertex>\n}",e.exports});;
Cube("datav:/com/@datav-city-pro-v2/datav-engine-particle/2.1.3/pickmaterial",[],function(t,e,n,a,i,r){function s(t,e){for(var a=0;a<e.length;a++){var i=e[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return t.exports=function(t){var e,a,i;function r(){var e=this;if(!(this instanceof r))throw new TypeError("Cannot call a class as a function");this._sizeFactor={value:1},this._material=new t.PointsMaterial,this._material.onBeforeCompile=function(t){t.uniforms.uSizeFactor=e._sizeFactor,t.vertexShader=n("datav:/com/@datav-city-pro-v2/datav-engine-particle/2.1.3/shader/pick.vert.glsl"),t.fragmentShader=n("datav:/com/@datav-city-pro-v2/datav-engine-particle/2.1.3/shader/pick.frag.glsl")}}return e=r,(a=[{key:"userData",get:function(){if(this._material)return this._material.userData}},{key:"sizeFactor",get:function(){return this._sizeFactor.value},set:function(t){this._sizeFactor.value=t}},{key:"size",get:function(){if(this._material)return this._material.size},set:function(t){this._material&&(this._material.size=t)}},{key:"map",set:function(t){this._material&&(this._material.map=t)}},{key:"material",get:function(){return this._material}},{key:"sizeAttenuation",set:function(t){this._material&&(this._material.sizeAttenuation=t,this._material.needsUpdate=!0)}},{key:"needsUpdate",set:function(t){this._material&&(this._material.needsUpdate=t)}},{key:"dispose",value:function(){this._material&&(this._material.dispose(),this._material=null)}}])&&s(e.prototype,a),i&&s(e,i),Object.defineProperty(e,"prototype",{writable:!1}),r},t.exports});;
Cube("datav:/com/@datav-city-pro-v2/datav-engine-particle/2.1.3/material",[],function(t,e,s,i,a,r){function o(t,e){for(var i=0;i<e.length;i++){var a=e[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return t.exports=function(e,i){var t,a,r;function n(){var i=this;if(!(this instanceof n))throw new TypeError("Cannot call a class as a function");this._pickedColor={value:new e.Color},this._pickedId={value:0},this._pickedOpacity={value:0},this._sizeScale={value:1},this._highColorPattern={value:0},this._texture={value:null},this._sizeFactor={value:1};var t=(new e.TextureLoader).setCrossOrigin("anonymous");this._material=new e.PointsMaterial({depthWrite:!1,transparent:!0,map:t.load("//img.alicdn.com/tfs/TB1SXF_SpT7gK0jSZFpXXaTkpXa-300-300.png")}),this._material.onBeforeCompile=function(t){var e=t.uniforms;t.vertexShader=s("datav:/com/@datav-city-pro-v2/datav-engine-particle/2.1.3/shader/point.vert.glsl"),t.fragmentShader=s("datav:/com/@datav-city-pro-v2/datav-engine-particle/2.1.3/shader/point.frag.glsl"),e.pickedId=i._pickedId,e.pickedColor=i._pickedColor,e.pickedOpacity=i._pickedOpacity,e.highColorPattern=i._highColorPattern,e.uSizeFactor=i._sizeFactor,e.uTexture=i._texture,i._uniforms=e}}return t=n,(a=[{key:"sizeFactor",get:function(){return this._sizeFactor.value},set:function(t){this._sizeFactor.value=t}},{key:"uTexture",get:function(){return this._texture.value},set:function(t){this._texture.value=t}},{key:"userData",get:function(){return this._material?this._material.userData:null}},{key:"size",get:function(){return this._material?this._material.size:0},set:function(t){this._material&&(this._material.size=t)}},{key:"color",set:function(t){t=i(t).gl(),this._material&&this._material.color.fromArray(t)}},{key:"opacity",set:function(t){this._material&&(this._material.opacity=t)}},{key:"pickedId",set:function(t){this._pickedId.value=t}},{key:"pickedColor",set:function(t){t=i(t).gl(),this._pickedColor.value.fromArray(t)}},{key:"pickedOpacity",set:function(t){this._pickedOpacity.value=t}},{key:"highColorPattern",set:function(t){this._highColorPattern.value=t}},{key:"map",get:function(){return this._material?this._material.map:null},set:function(t){this._material&&(this._material.map=t)}},{key:"blending",set:function(t){this._material&&(this._material.blending=t)}},{key:"depthWrite",set:function(t){this._material&&(this._material.depthWrite=t)}},{key:"depthTest",set:function(t){this._material&&(this._material.depthTest=t)}},{key:"sizeAttenuation",set:function(t){this._material&&(this._material.sizeAttenuation=t,this._material.needsUpdate=!0)}},{key:"material",get:function(){return this._material}},{key:"needsUpdate",set:function(t){this._material&&(this._material.needsUpdate=t)}},{key:"dispose",value:function(){this._material&&(this._material.dispose(),this._material=null)}}])&&o(t.prototype,a),r&&o(t,r),Object.defineProperty(t,"prototype",{writable:!1}),n},t.exports});;
Cube("datav:/com/@datav-city-pro-v2/datav-engine-particle/2.1.3/particle",["datav:/npm/alibabacloud-datav-tool-gui-utils/1.0.2"],function(t,e,b,i,r,a){function o(t){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function P(t){return function(t){if(Array.isArray(t))return n(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||function(t,e){var i;if(t)return"string"==typeof t?n(t,e):"Map"===(i="Object"===(i=Object.prototype.toString.call(t).slice(8,-1))&&t.constructor?t.constructor.name:i)||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?n(t,e):void 0}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function n(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,r=new Array(e);i<e;i++)r[i]=t[i];return r}function s(e,t){var i,r=Object.keys(e);return Object.getOwnPropertySymbols&&(i=Object.getOwnPropertySymbols(e),t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,i)),r}function w(r){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?s(Object(a),!0).forEach(function(t){var e,i;e=r,i=a[t=t],t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(a)):s(Object(a)).forEach(function(t){Object.defineProperty(r,t,Object.getOwnPropertyDescriptor(a,t))})}return r}function M(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function O(){return(O="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(t,e,i){var r=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=j(t)););return t}(t,e);if(r)return(r=Object.getOwnPropertyDescriptor(r,e)).get?r.get.call(arguments.length<3?t:i):r.value}).apply(this,arguments)}function S(t,e){return(S=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t})(t,e)}function T(i){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(t){return!1}}();return function(){var t,e=j(i),e=(t=r?(t=j(this).constructor,Reflect.construct(e,arguments,t)):e.apply(this,arguments),this);if(t&&("object"===o(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}}function j(t){return(j=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}return t.exports=function(t){var m=t.THREE,g=t.Utils,e=t.FormatTransformer,i=t.VG,r=t.viewer,a=t.container,v=t.coordHelper,o=t.engine,t=i.Layer,n=b("datav:/npm/alibabacloud-datav-tool-gui-utils/1.0.2").scale,s=n.color,c=n.size,l=n.marker,p=b("datav:/com/@datav-city-pro-v2/datav-engine-particle/2.1.3/material")(m,g.Chroma),u=b("datav:/com/@datav-city-pro-v2/datav-engine-particle/2.1.3/pickmaterial")(m),h=new m.TextureLoader,k=(h.setCrossOrigin("anonymous"),new m.Box3),n=y;if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");n.prototype=Object.create(t&&t.prototype,{constructor:{value:n,writable:!0,configurable:!0}}),Object.defineProperty(n,"prototype",{writable:!1}),t&&S(n,t);var f,d=T(y);function y(t){var e;if(this instanceof y)return(e=d.call(this)).classNameAlias="ParticleLayer",e.layerName=e.classNameAlias,e.renderQueue=i.Transparent,e.needsAutoUpdate=!0,e.options=g.mergeOptions({isSceneGroup:!1,sceneId:["scene1"],visible:!0,options:{general:{blendingType:"NormalBlending",fixedSize:!1,depthTest:!1,depthWrite:!1},graph:{color:{mapping:!1,fixed:"#6a6a6a",scale:{type:"ordinal",scheme:"cat-2",custom:!0,range:["#6ADDC3","#4DCD4E","#D9BA46"],domain:[],excepted:"#ffff00",abnormal:"#ff0000"}},marker:{mapping:!1,fixed:"//datav.oss-cn-hangzhou.aliyuncs.com/uploads/images/adadd5b5b5336716fdd06ac0b834511b.png",scale:{type:"ordinal",scheme:"basicIcon",custom:!0,range:["//img.alicdn.com/tfs/TB1SXF_SpT7gK0jSZFpXXaTkpXa-300-300.png","//img.alicdn.com/tfs/TB1kS9petTfau8jSZFwXXX1mVXa-300-300.png","//img.alicdn.com/tfs/TB1ulhZgzMZ7e4jSZFOXXX7epXa-300-300.png","//img.alicdn.com/tfs/TB1MFF_SpT7gK0jSZFpXXaTkpXa-300-300.png","//img.alicdn.com/tfs/TB1OCd2SuL2gK0jSZPhXXahvXXa-300-300.png"],excepted:"//img.alicdn.com/tfs/TB1SXF_SpT7gK0jSZFpXXaTkpXa-300-300.png",abnormal:"//img.alicdn.com/tfs/TB1SXF_SpT7gK0jSZFpXXaTkpXa-300-300.png",domain:[]}},size:{mapping:!1,fixed:24,scale:{custom:!0,type:"threshold",range:[50,500],excepted:100,abnormal:100}}},animate:{speed:0},interaction:{enableInteractive:!0,highColorPattern:0,color:"#ff5100",opacity:1}}},t||{}),e.enableInteractive=e.options.options.interaction.enableInteractive,e.latestSpeed=e.options.options.animate.speed,e.defaultValue=10,e.defalutAltitude=0,e.markerDictionary={},e.urlMaterialMap=new Map,e.urlPickMaterialMap=new Map,e;throw new TypeError("Cannot call a class as a function")}return n=y,(t=[{key:"addTo",value:function(t){O(j(y.prototype),"addTo",this).call(this,t),this.init()}},{key:"init",value:function(){this.group.ignoreWaterReflection=!0,this._ratio=0,this._propertiesData=[],this._textureCache=new Map,this._center=new m.Vector3,this.initPick(),this.formatTransformer=new e}},{key:"speed",set:function(t){this.latestSpeed=t}},{key:"getSpeedInOption",value:function(){return this.options.options.animate.speed}},{key:"initPick",value:function(){this.gpuPicker=r.picker.gpupicker,this.pickScene=new m.Scene,this.pick=this.pick.bind(this),a.addEventListener("click",this.pick,!1)}},{key:"show",value:function(){this.options.visible=!0,O(j(y.prototype),"show",this).call(this)}},{key:"hide",value:function(){this.options.visible=!1,O(j(y.prototype),"hide",this).call(this)}},{key:"fetchTexture",value:function(i){var t=this._textureCache.get(i);return t||(t=new Promise(function(t,e){h.load(i,t,null,e)}),this._textureCache.set(i,t)),t}},{key:"pick",value:function(t){var e,i;this.options.options.interaction.enableInteractive&&this.options.visible&&(e=this.gpuPicker.pick(this.pickScene,t,{highPerformance:!1,needsDepthRender:!0}).pickedId,this.urlMaterialMap.forEach(function(t){t.pickedId=e}),0<e&&(i=this._propertiesData[e-1],this.emit("pick",{data:i,clickPosition:{x:t.offsetX,y:t.offsetY}})))}},{key:"checkData",value:function(t){if(!t)return console.error("No data for particle.");var e=t;if(!Array.isArray(t)){if("FeatureCollection"!==t.type)return console.error("particle: invalid data format. ",t);e=this.formatTransformer.geojson2datav(t)}if(!e.length)return console.error("particle: the length of data is 0.",e);for(var i,r,a,o,n,s=[],c=0,l=e.length;c<l;c++)i=e[c],r=parseFloat(i.lng),a=parseFloat(i.lat),o=parseFloat(i.altitude||this.defalutAltitude),n=parseFloat(i.value),isNaN(r)||isNaN(a)||(n=isNaN(n)?this.defaultValue:n,s.push(w(w({},i),{},{lng:r,lat:a,altitude:o,value:n,vismapProperties:{}})));return s}},{key:"setMarker",value:function(t){var i,r=this;this.data2draw&&(this.markerDictionary={},i=l({config:t,data:this.data2draw,field:"markerField"}),this.data2draw.forEach(function(t){var e=i(t);t.vismapProperties.marker=e,r.markerDictionary[e]||(r.markerDictionary[e]=[]),r.markerDictionary[e].push(t)}))}},{key:"updateMarker",value:function(t){this.setData(null,!0,t)}},{key:"updateColor",value:function(t){var o=this;if(this.data2draw){this.colorConfig=t;var i=s({config:t,data:this.data2draw,field:"colorField"}),n=(this.data2draw.forEach(function(t){var e=i(t);t.vismapProperties.color=e}),[]);if(this.geometry){Object.keys(this.markerDictionary).forEach(function(t){for(var e=o.markerDictionary[t],i=0,r=e.length;i<r;i++){var a=e[i].vismapProperties.color;n.push.apply(n,P(g.Chroma(a).gl()))}});for(var t=this.geometry.getAttribute("aColor"),e=t.array,r=0,a=n.length;r<a;r++)e[r]=n[r];t.needsUpdate=!0}}}},{key:"updateSize",value:function(t){var o=this;if(this.data2draw){this.sizeConfig=t;var i=c({config:t,data:this.data2draw,field:"sizeField"}),n=(this.data2draw.forEach(function(t){var e=i(t);t.vismapProperties.size=e}),[]);if(this.geometry){Object.keys(this.markerDictionary).forEach(function(t){for(var e=o.markerDictionary[t],i=0,r=e.length;i<r;i++){var a=e[i].vismapProperties.size;n.push(a)}});for(var t=this.geometry.getAttribute("aSize"),e=t.array,r=0,a=n.length;r<a;r++)e[r]=n[r];t.needsUpdate=!0}}}},{key:"setData",value:function(t){var l=this,e=1<arguments.length&&void 0!==arguments[1]&&arguments[1],i=2<arguments.length?arguments[2]:void 0;if(this.clear(),e||(this.data2draw=this.checkData(t)),!this.data2draw)return this.emit("rendered");var e=this.options.options.graph,i=i||e.marker,p=(this.colorConfig||(this.colorConfig=e.color),this.sizeConfig||(this.sizeConfig=e.size),this.setMarker(i),this.updateSize(this.sizeConfig),this.updateColor(this.colorConfig),[]),u=[],h=0,f=[],d=[],y=[];this._propertiesData.length=0,Object.keys(this.markerDictionary).forEach(function(t){for(var e=l.markerDictionary[t],i=0,r=e.length;i<r;i++){var a=e[i],o=(l._propertiesData.push(a),a.lng),n=a.lat,s=a.altitude,a=a.vismapProperties,c=a.color,a=a.size,o=(v.setFromValues(o,n,s),f.push.apply(f,P(v.toArray())),++h);p.push(o),u.push.apply(u,P(l.gpuPicker.encode(o))),d.push.apply(d,P(g.Chroma(c).gl())),y.push(a)}}),k.setFromArray(f),k.getCenter(this._center);for(var r=2,a=f.length;r<a;r+=3)f[r-2]-=this._center.x,f[r-1]-=this._center.y,f[r]-=this._center.z;e=new m.BufferGeometry;e.setAttribute("id",new m.BufferAttribute(new Float32Array(p),1)),e.setAttribute("encodedId",new m.BufferAttribute(new Float32Array(u),3)),e.setAttribute("position",new m.BufferAttribute(new Float32Array(f),3)),e.setAttribute("aColor",new m.BufferAttribute(new Float32Array(d),4)),e.setAttribute("aSize",new m.BufferAttribute(new Float32Array(y),1)),this.geometry=e,this.updateParticle(),this.emit("rendered")}},{key:"dataErrorHandler",value:function(){this.emit("rendered")}},{key:"getMaterialByMarkerUrl",value:function(t){var e,i,r,a;return this.urlMaterialMap.has(t)?this.urlMaterialMap.get(t):(e=new p,i=(a=this.options.options.interaction).highColorPattern,r=a.color,a=a.opacity,e.pickedColor=r,e.pickedOpacity=a,e.highColorPattern=i,this.fetchTexture(t).then(function(t){t&&(t.encoding=m.sRGBEncoding,e.map=t,e.needsUpdate=!0)}),this.urlMaterialMap.set(t,e),e)}},{key:"getPickMaterialByMarkerUrl",value:function(t){var e;return this.urlPickMaterialMap.has(t)?this.urlPickMaterialMap.get(t):(e=new u,this.urlPickMaterialMap.set(t,e),e)}},{key:"autoUpdate",value:function(){this.animate()}},{key:"animate",value:function(){var e=this,i=this.latestSpeed,t=performance.now(),r=(this.lastTime||(this.lastTime=performance.now()),.001*(t-this.lastTime));this._ratio+=i*r*.1,this._ratio%=1,this.urlMaterialMap&&this.urlMaterialMap.forEach(function(t){t.sizeFactor=0<i?e._ratio:1}),this.urlPickMaterialMap&&this.urlPickMaterialMap.forEach(function(t){t.sizeFactor=0<i?e._ratio:1}),this.lastTime=t}},{key:"updateParticle",value:function(){var r,a,o,n=this;this.geometry&&(r=0,a=[],o=[],this.geometry.clearGroups(),Object.keys(this.markerDictionary).forEach(function(t,e){var i=n.markerDictionary[t],e=(n.geometry.addGroup(r,i.length,e),r+=i.length,n.getMaterialByMarkerUrl(t)),i=(a.push(e.material),n.getPickMaterialByMarkerUrl(t));o.push(i.material)}),this.particle?(this.particle.geometry=this.geometry,this.particle.material=a,this.pickParticle.geometry=this.geometry,this.pickParticle.material=o):(this.particle=new m.Points(this.geometry,a),this.particle.frustumCulled=!1,this.particle.matrixAutoUpdate=!1,this.add(this.particle),this.pickParticle=new m.Points(this.geometry,o),this.pickParticle.frustumCulled=!1,this.pickParticle.matrixAutoUpdate=!1,this.pickScene.add(this.pickParticle),this.updateSceneId4pick(this.pickParticle)),this.particle.position.copy(this._center),this.particle.matrix.setPosition(this.particle.position),this.pickParticle.position.copy(this._center),this.pickParticle.matrix.setPosition(this.particle.position),this.updateMaterial())}},{key:"updateMaterial",value:function(){var t=this.options.options,e=t.general,t=t.interaction,i=e.depthWrite,r=e.depthTest,a=e.blendingType,o=e.fixedSize,n=t.highColorPattern,s=t.color,c=t.opacity;this.urlMaterialMap.forEach(function(t){t.blending=m[a],t.depthWrite=i,t.depthTest=r,t.sizeAttenuation=!o,t.pickedColor=s,t.pickedOpacity=c,t.highColorPattern=n}),this.urlPickMaterialMap.forEach(function(t){t.sizeAttenuation=!o})}},{key:"updateOptions",value:function(t){var e=g.deepClone(this.options);this.options=g.mergeOptions(this.options,t||{}),this.updateMaterial(),this.latestSpeed=t.options.animate.speed,g.easyDiff(e.sceneId.length,t.sceneId.length)&&g.deepDiff(e.sceneId,t.sceneId)||(this.updateSceneId(),this.updateSceneId4pick(this.pickParticle))}},{key:"updateSceneId4pick",value:function(e){var t=this.options.sceneId;t&&e&&(e.layers.disableAll(),t.forEach(function(t){t=o.layerMask.createLayer(t);"number"==typeof t&&e.layers.enable(t)}))}},{key:"disposeTextures",value:function(){this._textureCache.forEach(function(t){t.then(function(t){t.dispose(),t.image&&t.image.src&&(t.image.src="")})}),this._textureCache.clear()}},{key:"disposeMaterial",value:function(){this._defaultPickMaterial.dispose(),this._defaultMaterial.dispose(),this._materials.forEach(function(t){t.dispose()}),this._pickMaterials.forEach(function(t){t.dispose()}),this._materials.clear(),this._pickMaterials.clear()}},{key:"clear",value:function(){(this.geometry||this.particle)&&O(j(y.prototype),"clear",this).call(this),this.pickScene&&this.pickParticle&&(this.pickScene.remove(this.pickParticle),this.pickParticle=null),this.geometry=null,this.particle=null,this.urlMaterialMap.forEach(function(t){return t.dispose()}),this.urlPickMaterialMap.forEach(function(t){return t.dispose()}),this.urlMaterialMap.clear(),this.urlPickMaterialMap.clear()}},{key:"remove",value:function(){this.clear(),a.removeEventListener("click",this.pick),this.disposeTextures()}}])&&M(n.prototype,t),f&&M(n,f),Object.defineProperty(n,"prototype",{writable:!1}),y},t.exports});;
Cube("datav:/com/@datav-city-pro-v2/datav-engine-particle/2.1.3",["datav:/npm/eventemitter3/3.0.0"],function(t,e,r,n,o,i){function a(t){return(a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function c(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function u(t,e){return(u=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t})(t,e)}function l(r){var n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(t){return!1}}();return function(){var t,e=s(r),e=(t=n?(t=s(this).constructor,Reflect.construct(e,arguments,t)):e.apply(this,arguments),this);if(t&&("object"===a(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return y(e)}}function y(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function s(t){return(s=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}var p=r("datav:/npm/eventemitter3/3.0.0"),f=r("datav:/com/@datav-city-pro-v2/datav-engine-particle/2.1.3/particle"),r=function(){var t=o,e=p;if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&u(t,e);var r,n=l(o);function o(t,e){var r;if(this instanceof o)return(r=n.call(this)).options=e,r.comId="",r.type="Particle",r.pick=r.pick.bind(y(r)),r;throw new TypeError("Cannot call a class as a function")}return t=o,(e=[{key:"addTo",value:function(t,e){this.cityproCore=t,this.comId=e,this.initLayer()}},{key:"initLayer",value:function(){var t=f(this.cityproCore);this.layer=new t(this.options),this.layer.on("pick",this.pick),this.cityproCore.viewer.addLayer(this.comId,this.layer)}},{key:"pick",value:function(t){this.emit("interactive",{data:t.data,clickPosition:t.clickPosition})}},{key:"setData",value:function(t){t&&this.layer&&this.layer.setData(t)}},{key:"errorRender",value:function(){console.log("二维图标组件数据错误"),this.layer&&this.layer.dataErrorHandler()}},{key:"show",value:function(){this.layer&&this.layer.show()}},{key:"hide",value:function(){this.layer&&this.layer.hide()}},{key:"updateSpeed",value:function(t){this.layer&&(this.layer.speed=t)}},{key:"speedInOption",value:function(){return this.layer.getSpeedInOption()}},{key:"updateColor",value:function(t){this.layer.updateColor(t)}},{key:"updateSize",value:function(t){this.layer.updateSize(t)}},{key:"updateMarker",value:function(t){this.layer.updateMarker(t)}},{key:"updateOptions",value:function(t){this.layer&&this.layer.updateOptions(t)}},{key:"clear",value:function(){this.layer&&this.layer.clear&&this.layer.clear()}},{key:"destroy",value:function(){this.layer&&(this.layer.off("pick",this.pick),this.layer.destroy(),this.layer=null)}}])&&c(t.prototype,e),r&&c(t,r),Object.defineProperty(t,"prototype",{writable:!1}),o}();return t.exports=r,t.exports});