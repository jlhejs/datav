// env=undefined => env=publish 
Cube("datav:/com/map3d-earth-area/0.1.5/extruder.js",["datav:/npm/earcut/2.1.2","datav:/npm/geojson-bbox/0.0.0"],function(e,r,s,n,p,a){var f=s("datav:/npm/earcut/2.1.2"),j=s("datav:/npm/geojson-bbox/0.0.0");return e.exports=function(e,p){p=Object.assign({rMax:205,rMin:201,project:null,closed:!0},p);var a=f.flatten(e),o=a.vertices,s=o.length/2,t=[],l=[],n=[],c=[],i=f(a.vertices,a.holes,a.dimensions);if(p.rMax===p.rMin){var u=j({type:"Polygon",coordinates:e}),h=u[2]-u[0],x=u[3]-u[1];o.forEach(function(e,r){var s;r%a.dimensions==0&&(s=p.project.ll2sphere(o[r],o[r+1],p.rMax),t.push(s.x,s.y,s.z),s=p.project.ll2plane(o[r],o[r+1],p.rMax),l.push(s.x,s.y,s.z),n.push((o[r]-u[0])/h,(o[r+1]-u[1])/x))}),c=i}else{var v=[],d=[];o.forEach(function(e,r){var s,n;r%a.dimensions==0&&(s=p.project.ll2sphere(o[r],o[r+1],p.rMin),n=p.project.ll2sphere(o[r],o[r+1],p.rMax),t.push(s.x,s.y,s.z),v.push(n.x,n.y,n.z),s=p.project.ll2plane(o[r],o[r+1],p.rMin),n=p.project.ll2plane(o[r],o[r+1],p.rMax),l.push(s.x,s.y,s.z),d.push(n.x,n.y,n.z))}),[].push.apply(t,v),[].push.apply(l,d);for(var r=0;r<s;r++)r===s-1?c.push(r+s,s,r,0,r,s):c.push(r+s,r+s+1,r,r+1,r,r+s+1);p.closed&&([].push.apply(c,i),i.forEach(function(e,r){r%3==0&&c.push(i[r+0]+s,i[r+2]+s,i[r+1]+s)}))}return{planePositions:l,spherePositions:t,uvs:n,cells:c,cellsLen:c.length,positionsLen:l.length}},e.exports});;
Cube("datav:/com/map3d-earth-area/0.1.5/extrude-line",["datav:/npm/gl-vec2/1.0.0/distance","datav:/npm/gl-vec2/1.0.0/copy","datav:/npm/gl-vec2/1.0.0/scaleAndAdd","datav:/npm/gl-vec2/1.0.0/dot","datav:/npm/as-number/1.0.0","datav:/npm/polyline-miter-util/1.0.1"],function(e,t,s,n,a,i){function r(e,t){for(var s=0;s<t.length;s++){var n=t[s];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var l,p,m={create:function(){return[0,0]},distance:s("datav:/npm/gl-vec2/1.0.0/distance"),clone:function(e){return[e[0],e[1]]},copy:s("datav:/npm/gl-vec2/1.0.0/copy"),scaleAndAdd:s("datav:/npm/gl-vec2/1.0.0/scaleAndAdd"),dot:s("datav:/npm/gl-vec2/1.0.0/dot")},o=s("datav:/npm/as-number/1.0.0"),v=m.create(),_=m.create(),y=m.create(),j=m.create(),P=m.create(),f=m.create(),s=s("datav:/npm/polyline-miter-util/1.0.1"),A=(_sphereProject=null,_planeProject=null,_R=null,s.computeMiter),g=s.normal,b=s.direction,c=(s=h,(l=[{key:"mapThickness",value:function(e,t,s){return this.thickness}},{key:"sphereProject",value:function(e){e=_sphereProject(e[0],e[1],_R);return[e.x,e.y,e.z]}},{key:"planeProject",value:function(e){e=_planeProject(e[0],e[1],_R);return[e.x,e.y,e.z]}},{key:"build",value:function(e){var t={spherePositions:[],planePositions:[],cells:[],uvs:[]};if(e.length<=1)return t;for(var s=e.length,n=(this._lastFlip=-1,this._started=!1,this._normal=null,0),a=0;a<s-1;a++)n+=m.distance(e[a],e[a+1]);for(var i=0,r=1,l=0;r<s;r++){var p=e[r-1],o=e[r],c=r<e.length-1?e[r+1]:null,h=this.mapThickness(o,r,e);i+=m.distance(p,o)/n,l+=this._seg(t,l,p,o,c,h/2,i)}return t}},{key:"_seg",value:function(e,t,s,n,a,i,r){var l,p=0,o=e.cells,c=e.planePositions,h=e.spherePositions,e=e.uvs,u="square"===this.cap,d="bevel"===this.join;return b(y,n,s),this._normal||(this._normal=m.create(),g(this._normal,y)),this._started||(this._started=!0,u&&(m.scaleAndAdd(_,s,y,-i),s=_),this.extrusions(c,e,s,this._normal,i,0,this.planeProject),this.extrusions(h,e,s,this._normal,i,0,this.sphereProject)),o.push(t+0,t+1,t+2),a?(b(j,a,n),a=A(P,f,y,j,i),l=m.dot(P,this._normal)<0?-1:1,(d=d)||"miter"!==this.join||a/i>this.miterLimit&&(d=!0),d?(m.scaleAndAdd(v,n,this._normal,-i*l),[].push.apply(h,this.sphereProject(m.clone(v))),[].push.apply(c,this.planeProject(m.clone(v))),e.push(r,1),m.scaleAndAdd(v,n,f,a*l),[].push.apply(h,this.sphereProject(m.clone(v))),[].push.apply(c,this.planeProject(m.clone(v))),e.push(r,0),[].push.apply(o,this._lastFlip!==-l?[t,t+2,t+3]:[t+2,t+1,t+3]),o.push(t+2,t+3,t+4),g(v,j),m.copy(this._normal,v),m.scaleAndAdd(v,n,v,-i*l),[].push.apply(h,this.sphereProject(m.clone(v))),[].push.apply(c,this.planeProject(m.clone(v))),e.push(r,0),p+=3):(this.extrusions(c,e,n,f,a,r,this.planeProject),this.extrusions(h,e,n,f,a,r,this.sphereProject),[].push.apply(o,1===this._lastFlip?[t,t+2,t+3]:[t+2,t+1,t+3]),l=-1,m.copy(this._normal,f),p+=2),this._lastFlip=l):(g(this._normal,y),u&&(m.scaleAndAdd(_,n,y,i),n=_),this.extrusions(c,e,s,this._normal,i,1,this.planeProject),this.extrusions(h,e,s,this._normal,i,1,this.sphereProject),[].push.apply(o,1===this._lastFlip?[t,t+2,t+3]:[t+2,t+1,t+3]),p+=2),p}},{key:"extrusions",value:function(e,t,s,n,a,i,r){m.scaleAndAdd(v,s,n,-a),[].push.apply(e,r(m.clone(v))),t.push(i,1),m.scaleAndAdd(v,s,n,a),[].push.apply(e,r(m.clone(v))),t.push(i,0)}}])&&r(s.prototype,l),p&&r(s,p),Object.defineProperty(s,"prototype",{writable:!1}),h);function h(e){if(!(this instanceof h))throw new TypeError("Cannot call a class as a function");this.miterLimit=o((e=e||{}).miterLimit,10),this.thickness=o(e.thickness,1),this.join=e.join||"miter",this.cap=e.cap||"butt",this._normal=null,this._lastFlip=-1,this._started=!1,_R=e.R,_sphereProject=e.project.ll2sphere,_planeProject=e.project.ll2plane}return e.exports=function(e,t){return new c(t).build(e)},e.exports});;
Cube("datav:/com/map3d-earth-area/0.1.5/shader/frag.pick.glsl",[],function(n,e,o,d,r,a){return n.exports="#define GLSLIFY 1\n// varying vec3 vColor;\nvarying vec3 vEncodedId;\n\n// flat in vec3 vEncodedId;\n// uniform vec3 u_encoded_id;\n\nvoid main() {\n  // gl_FragColor = vColor;\n\n\tgl_FragColor = vec4(vEncodedId, 1.0);\n}",n.exports});;
Cube("datav:/com/map3d-earth-area/0.1.5/shader/vert.pick.glsl",[],function(e,n,o,i,t,r){return e.exports="#define GLSLIFY 1\nattribute vec3 plane_position;\nattribute vec3 sphere_position;\nattribute vec3 encodedId;\n\n// attribute vec3 aColor;\n// varying vec3 vColor;\n\nuniform float u_proj_type;\nuniform float u_ease_index;\n\nvarying vec3 vEncodedId;\n// flat out vec3 vEncodedId;\n\nvec3 real_position() {\n  if(u_proj_type == 0.){\n    return mix(plane_position, sphere_position, u_ease_index);\n  } else if(u_proj_type == 1.){\n     return mix(sphere_position, plane_position, u_ease_index);\n  } else {\n    return vec3(0);\n  }\n  \n}\n\nvoid main() {\n  // vColor = aColor;\n  gl_Position = projectionMatrix * modelViewMatrix * vec4( real_position(), 1.0 );\n\n  vEncodedId = encodedId;\n}",e.exports});;
Cube("datav:/com/map3d-earth-area/0.1.5/shader/frag.glsl",[],function(r,a,n,o,e,l){return r.exports="#define GLSLIFY 1\n varying vec4 vColor;\n\nvoid main() {\n  gl_FragColor = vColor;\n}",r.exports});;
Cube("datav:/com/map3d-earth-area/0.1.5/shader/vert.glsl",[],function(e,n,o,i,t,r){return e.exports="#define GLSLIFY 1\nattribute vec4 aColor;\nattribute vec3 plane_position;\nattribute vec3 sphere_position;\n\nvarying vec4 vColor;\n\nuniform float u_proj_type;\nuniform float u_ease_index;\n\nvec3 real_position() {\n  if(u_proj_type == 0.){\n    return mix(plane_position, sphere_position, u_ease_index);\n  } else if(u_proj_type == 1.){\n     return mix(sphere_position, plane_position, u_ease_index);\n  } else {\n    return vec3(0);\n  }\n  \n}\n\nvoid main() {\n  vColor = aColor;\n  gl_Position = projectionMatrix * modelViewMatrix * vec4( real_position(), 1.0 );\n}",e.exports});;
Cube("datav:/com/map3d-earth-area/0.1.5/geojson2extrudeline",[],function(e,t,n,r,i,o){var c=n("datav:/com/map3d-earth-area/0.1.5/extrude-line");return e.exports=function(e,t){function n(r){var i=p[r],o=[];if(!i.geometry)return"continue";switch(i.geometry.type){case"MultiLineString":[].push.apply(o,i.geometry.coordinates);break;case"LineString":o.push(i.geometry.coordinates);break;case"Polygon":[].push.apply(o,i.geometry.coordinates);break;case"MultiPolygon":i.geometry.coordinates.forEach(function(e){[].push.apply(o,e)})}for(var e=u.spherePositions.length/3,t=0;t<o.length;t++)!function(e){var e=o[e],t=u.spherePositions.length/3,n={project:a.project,R:a.getR(i,r),thickness:a.getThickness(i,r),cap:a.getCap(i,r),join:a.getJoin(i,r),miterLimit:a.getMiterLimit(i,r)},e=c(e,n);e.spherePositions.map(function(e){return u.spherePositions.push(e)}),e.planePositions.map(function(e){return u.planePositions.push(e)}),e.uvs.map(function(e){return u.uv.push(e)}),e.cells.map(function(e){return e+t}).map(function(e){return u.index.push(e)})}(t);var n=u.spherePositions.length/3,s=a.getKey(i,r);u.key_index[s]={range:[e,n],userData:i.properties}}for(var a={getR:function(e,t){return 200.01},getThickness:function(e,t){return.05},getCap:function(e,t){return"square"},getJoin:function(e,t){return"bevel"},getMiterLimit:function(e,t){return.2},getKey:function(e,t){return e.properties.id||e.properties.adcode}},u=(Object.assign(a,t),{spherePositions:[],planePositions:[],uv:[],index:[],key_index:{}}),p=e.features,r=0;r<p.length;r++)n(r);return u},e.exports});;
Cube("datav:/com/map3d-earth-area/0.1.5/geojson2extrude",["datav:/npm/earcut/2.1.2"],function(e,t,r,n,o,a){function d(e){return function(e){if(Array.isArray(e))return i(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return i(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Map"===(r="Object"===r&&e.constructor?e.constructor.name:r)||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?i(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function i(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}r("datav:/npm/earcut/2.1.2");var m=r("datav:/com/map3d-earth-area/0.1.5/extruder.js");return e.exports=function(e,t){for(var p={getRMax:function(e,t){return e.properties.floor||e.properties.height||0},getRMin:function(e,t){return 200},getKey:function(e,t){return e.properties.id||e.properties.adcode||e.properties.ad_code||e.properties.name},getVertexColor:function(e,t){return[0,0,0,1]}},u=(Object.assign(p,t),[]),l=[],c=[],y=[],f={},h=[],g=e.features,r=0,n=g.length;r<n;r++)!function(e){var n,t=g[e],r=p.getKey(t,e)||e+1,o=[],a=p.getRMax(t,e),i=p.getRMin(t,e),s={planePositions:[],spherePositions:[],indexes:[],key:r};h.push(s),t.geometry&&("MultiPolygon"===t.geometry.type?[].push.apply(o,t.geometry.coordinates):"Polygon"===t.geometry.type&&o.push(t.geometry.coordinates),e=u.length/3,n=0,o.forEach(function(e){var t,r=u.length/3;e[0]&&(e=m(e,{rMax:a,rMin:i,project:p.project}),(t=s.planePositions).push.apply(t,d(e.planePositions)),(t=s.spherePositions).push.apply(t,d(e.spherePositions)),(t=s.indexes).push.apply(t,d(e.cells.map(function(e){return e+n}))),n+=e.planePositions.length/3,[].push.apply(l,e.planePositions),[].push.apply(u,e.spherePositions),[].push.apply(c,e.uvs),t=e.cells.map(function(e){return e+r}),[].push.apply(y,t))}),r&&(f[r]=[e,u.length/3]))}(r);return{attributes:{planePositions:l,spherePositions:u,uvs:c,indices_array:y,key_index:f},singleFeatGeoAttrsArr:h}},e.exports});;
Cube("datav:/com/map3d-earth-area/0.1.5",["datav:/npm/chroma-js/1.3.4","datav:/npm/eventemitter3/2.0.3","datav:/npm/safely-merge/1.0.1"],function(e,t,o,r,i,a){function s(e){return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function d(e){return function(e){if(Array.isArray(e))return n(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return n(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Map"===(r="Object"===r&&e.constructor?e.constructor.name:r)||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?n(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function n(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=new Array(t);r<t;r++)i[r]=e[r];return i}function l(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function h(e,t){return(h=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function u(r){var i=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=c(r),t=(e=i?(e=c(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),this);if(e&&("object"===s(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");if(void 0!==t)return t;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}}function c(e){return(c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var p=null,f=null,y=o("datav:/npm/chroma-js/1.3.4"),v=o("datav:/npm/eventemitter3/2.0.3"),m=o("datav:/npm/safely-merge/1.0.1"),g=o("datav:/com/map3d-earth-area/0.1.5/geojson2extrude"),k=o("datav:/com/map3d-earth-area/0.1.5/geojson2extrudeline"),A=function(){var e=a,t=v;if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&h(e,t);var r,i=u(a);function a(e,t){var r;if(this instanceof a)return(r=i.call(this)).options=m({visible:!0,height:2,isStokeOnly:!0,strokeWidth:.05,strokeColor:"#E7EE98",strokeOpacity:1,minFillColor:"#33C9FB",maxFillColor:"#1F68A7",defaultFillColor:"#676767",fillOpacity:1,chinaGeoJsonApi:"//geo.datav.aliyun.com/areas_v3/bound/330000_full.json",getId:function(e){return e.id||e.adcode||e.ad_code||e.name},getValue:function(e){return void 0===e.value?0:e.value}},t||{}),r.areaData=null,r.geoJsonData=null,r.code2value=null,r.colorScale=null,r.singleFeatGeoAttrsArr=[],r.areaDataMocked=!1,r.renderOrderIndex=10+Math.round(90*Math.random()),r.actived=!1,r.carouselEnabled=!0,r.inCarousel=!1,r.adcodes4carousel=[],r;throw new TypeError("Cannot call a class as a function")}return e=a,(t=[{key:"addTo",value:function(e){if(!e)return console.log("areas layer needs map layer");p=e.THREE,this.map=e,f=e.Utils,this.scene=e.scene,this.map.on("projChanged",this.updatePostions.bind(this)),this.initMaterial(),this.initInteract()}},{key:"initMaterial",value:function(){var e=this.options,t=e.strokeColor,e=e.defaultFillColor;this.areaMaterial=this.getMaterial(),this.strokeMaterial=this.getMaterial(),this.fillColor=y(e).gl(),this.strokeColor=y(t).gl()}},{key:"initInteract",value:function(){this.gpuPicker=this.map.interactiveGPU,this.pickScene=new p.Scene,this.pickedData=[],this.pick=this.pick.bind(this),this.gpuPicker.on("interactived",this.pick)}},{key:"pick",value:function(){var e;this.options.enableInteractive&&(this.gpuPicker.render(this.pickScene,!0),0<(e=this.gpuPicker.pickedId)?(this.inactive(),this.carouselEnabled=!1,this.inCarousel=!1,this.active(e-1,!0),this.actived=!0):(this.inCarousel||this.inactive(),this.carouselEnabled=!0,this.actived&&this.emit("inactive"),this.actived=!1))}},{key:"active",value:function(e){var t=!(1<arguments.length&&void 0!==arguments[1])||arguments[1];if(this.geometryArea&&this.colorScale&&this.code2value&&this.singleFeatGeoAttrsArr.length){var r=this.geometryArea.attributes.aColor.array,i=this.singleFeatGeoAttrsArr[e].key,a=this.areaKeyIndex[i],o=null,o=this.areaDataMocked||void 0===this.code2value[i]?this.fillColor:this.colorScale(this.code2value[i]).gl(),s=this.options.activeColor,s=y(s).gl();if(a)for(var n=a[0];n<a[1];n++)r[4*n+0]=s[0],r[4*n+1]=s[1],r[4*n+2]=s[2],r[4*n+3]=s[3];this.geometryArea.attributes.aColor.needsUpdate=!0,this.lastActiveFeatKey=i,this.color2recover=o,t&&this.emit("active",{clickPosition:{x:this.gpuPicker.mouse.x,y:this.gpuPicker.mouse.y},data:{adcode:i,value:this.code2value[i]}})}}},{key:"inactive",value:function(){if(this.lastActiveFeatKey&&this.color2recover){var e=this.areaKeyIndex[this.lastActiveFeatKey];if(e)for(var t=this.geometryArea.attributes.aColor.array,r=e[0];r<e[1];r++)t[4*r+0]=this.color2recover[0],t[4*r+1]=this.color2recover[1],t[4*r+2]=this.color2recover[2],t[4*r+3]=this.options.fillOpacity;this.geometryArea.attributes.aColor.needsUpdate=!0}}},{key:"activeByAdcode",value:function(e){if(this.carouselEnabled&&this.singleFeatGeoAttrsArr){this.inCarousel=!0;for(var t=0,r=this.singleFeatGeoAttrsArr.length;t<r;t++)if(this.singleFeatGeoAttrsArr[t].key===e)return this.inactive(),this.active(t,!1),!0;console.log("Invalid adcode in map3d-earth-area:",e)}return!1}},{key:"configCarousel",value:function(e,t,r){this.inCarousel=!0,this.carouselInterval=t;for(var i=this.adcodes4carousel.length=0;i<r;i++)for(var a=0,o=e.length;a<o;a++)this.adcodes4carousel.push(e[a])}},{key:"startCarousel",value:function(){var t=this;this.inCarousel&&this.adcodes4carousel.length?setTimeout(function(){var e=t.adcodes4carousel.shift();t.activeByAdcode(e),t.startCarousel()},this.carouselInterval):this.inactive()}},{key:"getMaterial",value:function(){return new p.ShaderMaterial({uniforms:{u_ease_index:{value:1},u_proj_type:{value:this.map.projType}},vertexShader:o("datav:/com/map3d-earth-area/0.1.5/shader/vert.glsl"),fragmentShader:o("datav:/com/map3d-earth-area/0.1.5/shader/frag.glsl"),side:p.DoubleSide,blending:p.NormalBlending,depthTest:!0,depthWrite:!0,transparent:!0})}},{key:"getPickingMaterial",value:function(){return this.pickMaterial||(this.pickMaterial=new p.ShaderMaterial({uniforms:{u_ease_index:{value:1},u_proj_type:{value:this.map.projType}},vertexShader:o("datav:/com/map3d-earth-area/0.1.5/shader/vert.pick.glsl"),fragmentShader:o("datav:/com/map3d-earth-area/0.1.5/shader/frag.pick.glsl"),side:p.FrontSide,blending:p.NormalBlending,depthTest:!0,depthWrite:!0})),this.pickMaterial}},{key:"setData",value:function(e){if(!e||!Array.isArray(e))return console.log("area layer no area data");this.areaData=e,this.areaDataMocked=!1,this.options.isStokeOnly||this.colorify()}},{key:"setGeojson",value:function(e){var t=this;e&&e.features&&Array.isArray(e.features)&&0<e.features.length?(this.geoJsonData=e,this.render()):fetch(this.options.chinaGeoJsonApi).then(function(e){return e.json()}).then(function(e){t.geoJsonData=e,console.log("使用默认的geojson"),t.render()}).catch(function(e){return console.log("fetch error",e)})}},{key:"render",value:function(){this.clean(),this.initMaterial(),this.renderStroke(),this.options.isStokeOnly||(this.renderArea(),this.colorify()),this.checkVisible()}},{key:"mockAreaData",value:function(){if(this.areaKeyIndex){var e,t=[];for(e in this.areaKeyIndex)t.push({adcode:e,value:0});this.areaData=t}this.areaDataMocked=!0}},{key:"colorify",value:function(){this.areaData||this.mockAreaData(),this.getValueRange(this.areaData);var e=this.options.defaultFillColor;if(this.fillColor=y(e).gl(),this.areaKeyIndex&&this.geometryArea&&this.colorScale&&this.code2value){var t,r=this.geometryArea.attributes.aColor.array;for(t in this.areaKeyIndex){var i=this.areaKeyIndex[t],a=null,a=this.areaDataMocked||void 0===this.code2value[t]?this.fillColor:this.colorScale(this.code2value[t]).gl();if(i)for(var o=i[0];o<i[1];o++)r[4*o+0]=a[0],r[4*o+1]=a[1],r[4*o+2]=a[2],r[4*o+3]=this.options.fillOpacity}this.geometryArea.attributes.aColor.needsUpdate=!0}}},{key:"getValueRange",value:function(e){for(var t=null,r=null,i=(this.code2value={},this.options),a=0;a<e.length;a++){var o=e[a],s=i.getId(o),o=i.getValue(o);this.code2value[s]||(this.code2value[s]=o),o<(r=null==r?o:r)&&(r=o),(t=null==t?o:t)<o&&(t=o)}null!==r&&null!==t&&(this.colorScale=y.scale([i.minFillColor,i.maxFillColor]).domain([r,t]))}},{key:"renderArea",value:function(){if(this.geoJsonData){for(var r=this.options,e=this.geoJsonData,e=g(e,{project:f,getRMax:function(e,t){return 200+r.height},getRMin:function(e,t){return 200+r.height},getKey:function(e,t){return e.properties.id||e.properties.adcode||e.properties.ad_code||e.properties.name}}),t=e.attributes,e=e.singleFeatGeoAttrsArr,i=(this.singleFeatGeoAttrsArr=e,[]),a=0;a<t.spherePositions.length/3;a++)i[4*a+0]=this.fillColor[0],i[4*a+1]=this.fillColor[1],i[4*a+2]=this.fillColor[2],i[4*a+3]=r.fillOpacity;var o=this.geometryArea=new p.BufferGeometry;o.setIndex(new p.BufferAttribute(new Uint32Array(t.indices_array),1)),o.addAttribute("sphere_position",new p.BufferAttribute(new Float32Array(t.spherePositions),3).setDynamic(!0)),o.addAttribute("plane_position",new p.BufferAttribute(new Float32Array(t.planePositions),3).setDynamic(!0)),o.addAttribute("aColor",new p.BufferAttribute(new Float32Array(i),4).setDynamic(!0)),o.setDrawRange(0,t.spherePositions.length),o.computeBoundingSphere(),o.computeBoundingBox(),this.areaKeyIndex=t.key_index,this.meshArea=new p.Mesh(o,this.areaMaterial),this.meshArea.renderOrder=this.renderOrderIndex,this.scene.add(this.meshArea),this.renderPickingArea(e)}}},{key:"renderPickingArea",value:function(e){for(var t=this.getPickingMaterial(),r=0,i=e.length;r<i;r++){for(var a=e[r],o=a.planePositions,s=a.spherePositions,a=a.indexes,n=new p.BufferGeometry,l=(n.setIndex(new p.BufferAttribute(new Uint32Array(a),1)),n.addAttribute("sphere_position",new p.BufferAttribute(new Float32Array(s),3)),n.addAttribute("plane_position",new p.BufferAttribute(new Float32Array(o),3)),s.length/3),h=[],u=this.gpuPicker.encode(r+1),c=0;c<l;c++)h.push.apply(h,d(u));n.addAttribute("encodedId",new p.BufferAttribute(new Float32Array(h),3)),n.setDrawRange(0,s.length);a=new p.Mesh(n,t);a.frustumCulled=!1,a.matrixAutoUpdate=!1,this.pickScene.add(a)}}},{key:"renderStroke",value:function(){if(this.geoJsonData){for(var r=this.options,e=this.geoJsonData,t=k(e,{project:f,getR:function(){return 200+r.height},getThickness:function(e,t){return r.strokeWidth},getKey:function(e,t){return e.properties.id||e.properties.adcode||e.properties.ad_code||e.properties.name}}),i=[],a=0;a<t.spherePositions.length/3;a++)i[4*a+0]=this.strokeColor[0],i[4*a+1]=this.strokeColor[1],i[4*a+2]=this.strokeColor[2],i[4*a+3]=r.strokeOpacity;e=this.geometryStroke=new p.BufferGeometry;e.setIndex(new p.BufferAttribute(new Uint32Array(t.index),1)),e.addAttribute("sphere_position",new p.BufferAttribute(new Float32Array(t.spherePositions),3).setDynamic(!0)),e.addAttribute("plane_position",new p.BufferAttribute(new Float32Array(t.planePositions),3).setDynamic(!0)),e.addAttribute("uv",new p.BufferAttribute(new Float32Array(t.uv),2)),e.addAttribute("aColor",new p.BufferAttribute(new Float32Array(i),4)),e.setDrawRange(0,t.spherePositions.length),e.computeBoundingSphere(),e.computeBoundingBox(),this.strokeKeyIndex=t.key_index,this.meshStroke=new p.Mesh(e,this.strokeMaterial),this.meshStroke.renderOrder=this.renderOrderIndex+1,this.scene.add(this.meshStroke)}}},{key:"updateOptions",value:function(e){var t=this.options.height,r=this.options.strokeWidth,i=this.options.isStokeOnly,a=this.options.fillOpacity;this.options=m(this.options,e||{}),t!==e.height||r!==e.strokeWidth||i!==e.isStokeOnly||a!==e.fillOpacity?this.render():e.isStokeOnly||this.colorify(),this.updateStroke(),this.checkVisible()}},{key:"updatePostions",value:function(e){var t=e.projType,e=e.index;this.areaMaterial.uniforms.u_ease_index.value=e,this.areaMaterial.uniforms.u_proj_type.value=t,this.strokeMaterial.uniforms.u_ease_index.value=e,this.strokeMaterial.uniforms.u_proj_type.value=t,this.pickMaterial&&(this.pickMaterial.uniforms.u_ease_index.value=e,this.pickMaterial.uniforms.u_proj_type.value=t)}},{key:"updateStroke",value:function(){for(var e=this.options,t=e.strokeOpacity,r=y(e.strokeColor).gl(),i=this.geometryStroke.attributes.aColor.array,a=0;a<i.length/4;a++)i[4*a+0]=r[0],i[4*a+1]=r[1],i[4*a+2]=r[2],i[4*a+3]=t;this.geometryStroke.attributes.aColor.needsUpdate=!0}},{key:"checkVisible",value:function(){this.options.visible?this.show():this.hide()}},{key:"hide",value:function(){this.options.visible=!1,this.meshArea&&(this.meshArea.visible=!1),this.meshStroke&&(this.meshStroke.visible=!1)}},{key:"show",value:function(){this.options.visible=!0,this.meshArea&&(this.meshArea.visible=!0),this.meshStroke&&(this.meshStroke.visible=!0)}},{key:"clean",value:function(){this.meshArea&&this.scene.remove(this.meshArea),this.meshArea&&this.meshArea.dispose&&this.meshArea.dispose(),this.geometryArea&&this.geometryArea.dispose&&this.geometryArea.dispose(),this.areaMaterial&&this.areaMaterial.dispose&&this.areaMaterial.dispose(),this.meshStroke&&this.scene.remove(this.meshStroke),this.meshStroke&&this.meshStroke.dispose&&this.meshStroke.dispose(),this.geometryStroke&&this.geometryStroke.dispose&&this.geometryStroke.dispose(),this.strokeMaterial&&this.strokeMaterial.dispose&&this.strokeMaterial.dispose()}},{key:"remove",value:function(){this.map.off("projChanged",this.updatePostions),this.meshArea&&this.scene.remove(this.meshArea),this.meshArea&&this.meshArea.dispose&&this.meshArea.dispose(),this.geometryArea&&this.geometryArea.dispose&&this.geometryArea.dispose(),this.areaMaterial&&this.areaMaterial.dispose&&this.areaMaterial.dispose(),this.meshStroke&&this.scene.remove(this.meshStroke),this.meshStroke&&this.meshStroke.dispose&&this.meshStroke.dispose(),this.geometryStroke&&this.geometryStroke.dispose&&this.geometryStroke.dispose(),this.strokeMaterial&&this.strokeMaterial.dispose&&this.strokeMaterial.dispose(),this.areaData=null,this.geoJsonData=null,this.code2value=null,this.colorScale=null,this.meshArea=null,this.geometryArea=null,this.areaMaterial=null,this.meshStroke=null,this.geometryStroke=null,this.strokeMaterial=null}}])&&l(e.prototype,t),r&&l(e,r),Object.defineProperty(e,"prototype",{writable:!1}),a}();return e.exports=A,e.exports});