// env=undefined => env=publish 
Cube("datav:/com/datavmap-3d-layer-mapbox-scatter/0.1.9/mscatterLayer.js",["datav:/npm/eventemitter3/2.0.3","datav:/npm/safely-merge/1.0.1"],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"===typeof b||"function"===typeof b)?b:a}function f(a,b){if("function"!==typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=c("datav:/npm/eventemitter3/2.0.3"),i=c("datav:/npm/safely-merge/1.0.1");return a.exports=function(a){var b=a.datavgl,c={},j=a.style.imageManager?"imageManager":"spriteAtlas";return function(h){function k(b){d(this,k);var f=e(this,(k.__proto__||Object.getPrototypeOf(k)).call(this));return b=i(c,b),f.options=i(f.options,b),f.group={},f.onclick=f.onclick.bind(f),f.onmousemove=f.onmousemove.bind(f),f.tagIndex=a.submtags.circle.length-1,f.init(),f}return f(k,h),g(k,[{key:"init",value:function(){a.getSource(this.options.id)||a.addSource(this.options.id,{type:"geojson",data:this.json2url({type:"FeatureCollection",features:[]})}),this.popup=new b.Popup({closeButton:!1,closeOnClick:!0}),this.updateLayers(),a.on("mousemove",this.onmousemove),a.on("mouseup",this.onclick)}},{key:"onmousemove",value:function(b){var c=this;if(this.options.defaultOptions.interactive){var d=this.interactiveLayers.filter(function(b){return a.getLayer(b)}),e=a.tolerance||1,f=[[b.point.x-e/2,b.point.y-e/2],[b.point.x+e/2,b.point.y+e/2]],g=a.queryRenderedFeatures(f,{layers:d});return g.length?void(a.circleHover=!0,setTimeout(function(){if(!a.circleHover)return void(a.circleHover=!1);if(a.circleHover=!1,a.getCanvas().style.cursor="pointer","hover"===c.options.defaultOptions.infobox){var b=c.options.defaultOptions.popup;g.length&&g[0].properties.info&&c.popup.setLngLat(g[0].geometry.coordinates).setHTML("<div style='font-size:"+b["font-size"]+"px;padding:5px;color:"+b["font-color"]+";font-family:"+b["font-family"]+";font-weight:"+(b["font-weight"]?"bold":"initial")+"'>"+g[0].properties.info+"</div>").addTo(a)}},9-0.1*this.tagIndex)):(a.getCanvas().style.cursor="",void("hover"!==this.options.defaultOptions.infobox||g.length||this.popup.remove()))}}},{key:"onclick",value:function(b){var c=this;if(this.options.defaultOptions.interactive){var d=a.tolerance||1,e=this.interactiveLayers.filter(function(b){return a.getLayer(b)}),f=[[b.point.x-d/2,b.point.y-d/2],[b.point.x+d/2,b.point.y+d/2]],g=a.queryRenderedFeatures(f,{layers:e});return g.length?void(a.circleClick=!0,setTimeout(function(){if(!a.circleClick)return void(a.circleClick=!1);if(a.circleClick=!1,c.emit("click",g[0].properties),a.getLayer(c.options.id+"_layer_interactive_style")&&a.setFilter(c.options.id+"_layer_interactive_style",["==","datavid",g.length?void 0==g[0].properties.datavid?"":g[0].properties.datavid:""]),c.options.defaultOptions["interactive-animation"].ismove&&a.flyTo({center:g[0].geometry.coordinates,zoom:c.options.defaultOptions["interactive-animation"].zoom,pitch:c.options.defaultOptions["interactive-animation"].pitch}),"click"===c.options.defaultOptions.infobox&&g[0].properties.info){var b=c.options.defaultOptions.popup;c.popup.setLngLat(g[0].geometry.coordinates).setHTML("<div style='font-size:"+b["font-size"]+"px;padding:5px;color:"+b["font-color"]+";font-family:"+b["font-family"]+";font-weight:"+(b["font-weight"]?"bold":"initial")+"'>"+g[0].properties.info+"</div>").addTo(a)}},9-0.1*this.tagIndex)):void(a.getLayer(this.options.id+"_layer_interactive_style")&&a.setFilter(this.options.id+"_layer_interactive_style",["==","datavid",""]))}}},{key:"json2url",value:function(a){var b=JSON.stringify(a),c=new Blob([b],{type:"application/json"}),d=URL.createObjectURL(c);return d}},{key:"flyTo",value:function(b,c){var d=a.querySourceFeatures(this.options.id,{filter:["==",b,c]});d.length&&a.flyTo({center:d[0].geometry.coordinates,zoom:this.options.defaultOptions["interactive-style"].animateOptions.zoom,pitch:this.options.defaultOptions["interactive-style"].animateOptions.pitch})}},{key:"arr2geojson",value:function(a){var b=this,c={},d=a.map(function(a,e){return c[a.type]||(c[void 0==a.type?b.options.id:a.type]=[]),isNaN(+a.value)||c[void 0==a.type?b.options.id:a.type].push(+a.value),a.value=+a.value,a.datavid=e+1,a.type&&(a.type=""+a.type),{type:"Feature",geometry:{type:"Point",coordinates:[+a.lng,+a.lat]},properties:a}});return Object.keys(c).forEach(function(a){var d=Math.min.apply([],c[a]),e=Math.max.apply([],c[a]);isFinite(d)&&isFinite(e)||(d=0,e=0),b.group[a]={min:d,max:e}}),{type:"FeatureCollection",features:d}}},{key:"setData",value:function(b){this.geojson=this.arr2geojson(b),a.getSource(this.options.id)&&a.getSource(this.options.id).setData(this.json2url(this.geojson)),this.updateData()}},{key:"removeLayers",value:function(){var b=this;Object.keys(a.style._layers).forEach(function(c){-1!==c.indexOf(b.options.id)&&a.getLayer(c)&&a.removeLayer(c)})}},{key:"removeImages",value:function(){var b=this;Object.keys(a.style[j].images).forEach(function(c){-1!==c.indexOf(b.options.id)&&a.style[j]._getImage(c)&&a.removeImage(c)})}},{key:"findCorrectInsertIndex",value:function(){var b=a.submtags,c=void 0;return 1<b.circle.length&&(c=this.findInsertIndexByLayerTag(b.circle),-1!==c)?c:b.line.length&&(c=this.findAfterIndexByLayerTag(b.line[b.line.length-1]),-1!==c)?c:b.fill.length&&(c=this.findAfterIndexByLayerTag(b.fill[b.fill.length-1]),-1!==c)?c:b.basemap.length&&(c=this.findAfterIndexByLayerTag(b.basemap[b.basemap.length-1]),-1!==c)?c:a.getStyle().layers.length}},{key:"findInsertIndexByLayerTag",value:function(a){var b=this,c=a.findIndex(function(a){return-1!==a.indexOf(b.options.id)});return c===a.length-1?this.findAfterIndexByLayerTag(a[c-1]):this.findBeforeIndexByLayerTag(a[c+1])}},{key:"findAfterIndexByLayerTag",value:function(b){var c=a.getStyle(),e=-1;return c.layers.forEach(function(a,c){-1!==a.id.indexOf(b)&&(e=c+1)}),e}},{key:"findBeforeIndexByLayerTag",value:function(b){var c=a.getStyle();return c.layers.findIndex(function(a){return-1!==a.id.indexOf(b)})}},{key:"findInsertIndex",value:function(){var b=a.getStyle(),c=-1,e=-1,f=-1,g=-1;return b.layers.forEach(function(a,b){-1!==a.id.indexOf("datav_fill")&&(c=b+1),-1!==a.id.indexOf("datav_line")&&(f=b+1),-1!==a.id.indexOf("datav_basemap")&&(e=b+1),-1!==a.id.indexOf("datav_circle")&&(g=b+1)}),-1===g?-1===f?-1===c?-1===e?b.layers.length:e:c:f:g}},{key:"updateLayers",value:function(){var a=this;this.removeLayers(),this.removeImages(),this.interactiveLayers=[];var b=[],c=[this.options.id],d=this.layers=[],e=this.options.defaultOptions["interactive-style"],f=this.images=[];if(this.options.defaultOptions.interactive&&d.push({id:this.options.id+"_layer_interactive_style",type:"circle",source:this.options.id,layout:{},paint:{"circle-color":e["circle-color"],"circle-radius":e["circle-radius"],"circle-blur":e["circle-blur"],"circle-stroke-width":e["circle-stroke-width"],"circle-stroke-color":e["circle-stroke-color"]},filter:["==","datavid",""]}),this.options.series.forEach(function(b,e){if(b.type)if(c.push(b.type),b.isIcon){var f=b.icon;d.push({id:a.options.id+"_layer_symbol_"+e,type:"symbol",source:a.options.id,layout:{"icon-image":a.options.id+"_image_"+e+"_url_="+f["icon-image"]+"?"+a.options.id,"icon-optional":!1,"icon-allow-overlap":!0,"icon-rotation-alignment":"viewport","icon-pitch-alignment":"viewport","icon-size":a.options.defaultOptions.icon["icon-driven"]?{type:"exponential",base:2,stops:[[a.options.defaultOptions.icon["zoom-stop1"],a.options.defaultOptions.icon["zoom-stop-size1"]],[a.options.defaultOptions.icon["zoom-stop2"],a.options.defaultOptions.icon["zoom-stop-size2"]]]}:f["icon-size"]},paint:{"icon-translate":f["icon-offset"]?f["icon-offset"].split(",").map(function(a){return+a||0}):[0,0]},filter:["==","type",b.type]}),a.images.push(a.options.id+"_image_"+e+"_url_="+f["icon-image"]+"?"+a.options.id)}else{var g=b.scatter;g.isDataBind?d.push({id:a.options.id+"_layer_"+e,type:"circle",source:a.options.id,layout:{},paint:{"circle-color":{default:g["circle-color-data-driven"].fillColor,property:"value",type:"exponential",stops:[[a.group[b.type]&&a.group[b.type].min||0,g["circle-color-data-driven"].minFillColor],[a.group[b.type]&&a.group[b.type].max||0,g["circle-color-data-driven"].maxFillColor]]},"circle-radius":{default:g["circle-radius-data-driven"].defaultSize,property:"value",type:"exponential",stops:[[a.group[b.type]&&a.group[b.type].min||0,g["circle-radius-data-driven"].minSize],[a.group[b.type]&&a.group[b.type].max||0,g["circle-radius-data-driven"].maxSize]]},"circle-blur":g["circle-other"]["circle-blur"],"circle-stroke-width":g["circle-other"]["circle-stroke-width"],"circle-stroke-color":g["circle-other"]["circle-stroke-color"]},filter:["==","type",b.type]}):d.push({id:a.options.id+"_layer_"+e,type:"circle",source:a.options.id,layout:{},paint:{"circle-color":g["circle-color"],"circle-radius":g["circle-radius"],"circle-blur":g["circle-other"]["circle-blur"],"circle-stroke-width":g["circle-other"]["circle-stroke-width"],"circle-stroke-color":g["circle-other"]["circle-stroke-color"]},filter:["==","type",b.type]})}}),this.options.defaultOptions.isIcon){var g=this.options.defaultOptions.icon;d.push({id:this.options.id+"_layer_symbol_default",type:"symbol",source:this.options.id,layout:{"icon-image":this.options.id+"_image_default_url_="+g["icon-image"]+"?"+this.options.id,"icon-size":this.options.defaultOptions.icon["icon-driven"]?{type:"exponential",base:2,stops:[[this.options.defaultOptions.icon["zoom-stop1"],this.options.defaultOptions.icon["zoom-stop-size1"]],[this.options.defaultOptions.icon["zoom-stop2"],this.options.defaultOptions.icon["zoom-stop-size2"]]]}:g["icon-size"],"icon-allow-overlap":!0,"icon-rotation-alignment":"viewport","icon-pitch-alignment":"viewport"},paint:{"icon-translate":g["icon-translate"]?g["icon-translate"].split(",").map(function(a){return+a||0}):[0,0]},filter:["!in","type"].concat(c)}),this.images.push(this.options.id+"_image_default_url_="+g["icon-image"]+"?"+this.options.id)}else{var h=this.options.defaultOptions.scatter;h.isDataBind?d.push({id:this.options.id+"_layer_default",type:"circle",source:this.options.id,layout:{},paint:{"circle-color":{default:h["circle-color-data-driven"].fillColor,property:"value",type:"exponential",stops:[[this.group[this.options.id]&&this.group[this.options.id].min||0,h["circle-color-data-driven"].minFillColor],[this.group[this.options.id]&&this.group[this.options.id].max||0,h["circle-color-data-driven"].maxFillColor]]},"circle-radius":{default:h["circle-radius-data-driven"].defaultSize,property:"value",type:"exponential",stops:[[this.group[this.options.id]&&this.group[this.options.id].min||0,h["circle-radius-data-driven"].minSize],[this.group[this.options.id]&&this.group[this.options.id].max||0,h["circle-radius-data-driven"].maxSize]]},"circle-blur":h["circle-other"]["circle-blur"],"circle-stroke-width":h["circle-other"]["circle-stroke-width"],"circle-stroke-color":h["circle-other"]["circle-stroke-color"]},filter:["!in","type"].concat(c)}):d.push({id:this.options.id+"_layer_default",type:"circle",source:this.options.id,layout:{},paint:{"circle-color":h["circle-color"],"circle-radius":h["circle-radius"],"circle-blur":h["circle-other"]["circle-blur"],"circle-stroke-width":h["circle-other"]["circle-stroke-width"],"circle-stroke-color":h["circle-other"]["circle-stroke-color"]},filter:["!in","type"].concat(c)})}var i=this.options.defaultOptions.label;i.show&&i["text-field"]&&d.push({id:this.options.id+"_layer_symbol_label",type:"symbol",source:this.options.id,layout:{"text-optional":!0,"text-ignore-placement":!1,"text-allow-overlap":!1,"text-anchor":i["text-anchor"],"text-field":i["text-field"],"text-justify":i["text-justify"],"text-rotate":i["text-rotate"],"text-size":i["text-size"]},paint:{"text-color":i["text-color"],"text-halo-blur":i["text-halo-blur"],"text-halo-color":i["text-halo-color"],"text-halo-width":i["text-halo-width"],"text-translate":i["text-translate"].split(",").map(function(a){return+a||0})}}),d.push({id:this.options.id+"_layer_interactive",type:"circle",source:this.options.id,layout:{},paint:{"circle-color":"rgba(0, 0, 0, 0)","circle-radius":15}}),b.push(this.options.id+"_layer_interactive"),this.updateStyle(),this.interactiveLayers=b,this.endID=setTimeout(function(){a.resetID&&clearTimeout(a.resetID)},100000)}},{key:"updateStyle",value:function(){var b=this,c=!0,d=this.layers;this.images.forEach(function(b){var c=b.split("_url_=")[1];a.style[j].images[b]||a.loadImage(c,function(c,d){c&&(console.log(c),d=new Image,d.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII="),a.style[j].images[b]||a.addImage(b,d)})});for(var e,f=0;f<d.length;f++)if(e=d[f],e.layout["icon-image"])if(!a.style[j].images[e.layout["icon-image"]]){c=!1;break}else c=!0;if(c&&a.loaded()&&a.isStyleLoaded()){this.resetID&&clearTimeout(this.resetID);var g=this.findCorrectInsertIndex();-1===g&&(g=1);var h=a.getStyle();d.forEach(function(a){a.layout&&(a.layout.visibility=b.options.visible?"visible":"none"),a.layout||(a.layout={visibility:b.options.visible?"visible":"none"})}),[].splice.apply(h.layers,[g,0].concat(d)),a.setStyle(h),this.updateData()}else this.resetID&&clearTimeout(this.resetID),this.resetID=setTimeout(function(){b.updateStyle()},200)}},{key:"updateData",value:function(){var b=this;this.options.series.forEach(function(c,d){if(c.type&&!c.isIcon){var e=c.scatter;e.isDataBind&&a.getLayer(b.options.id+"_layer_"+d)&&(a.setPaintProperty(b.options.id+"_layer_"+d,"circle-color",{default:e["circle-color-data-driven"].fillColor,property:"value",type:"exponential",stops:[[b.group[c.type]&&b.group[c.type].min||0,e["circle-color-data-driven"].minFillColor],[b.group[c.type]&&b.group[c.type].max||0,e["circle-color-data-driven"].maxFillColor]]}),a.setPaintProperty(b.options.id+"_layer_"+d,"circle-radius",{default:e["circle-radius-data-driven"].defaultSize,property:"value",type:"exponential",stops:[[b.group[c.type]&&b.group[c.type].min||0,e["circle-radius-data-driven"].minSize],[b.group[c.type]&&b.group[c.type].max||0,e["circle-radius-data-driven"].maxSize]]}))}});var c=this.options.defaultOptions.scatter;c.isDataBind&&a.getLayer(this.options.id+"_layer_default")&&(a.setPaintProperty(this.options.id+"_layer_default","circle-color",{default:c["circle-color-data-driven"].fillColor,property:"value",type:"exponential",stops:[[this.group[this.options.id]&&this.group[this.options.id].min||0,c["circle-color-data-driven"].minFillColor],[this.group[this.options.id]&&this.group[this.options.id].max||0,c["circle-color-data-driven"].maxFillColor]]}),a.setPaintProperty(this.options.id+"_layer_default","circle-radius",{default:c["circle-radius-data-driven"].defaultSize,property:"value",type:"exponential",stops:[[this.group[this.options.id]&&this.group[this.options.id].min||0,c["circle-radius-data-driven"].minSize],[this.group[this.options.id]&&this.group[this.options.id].max||0,c["circle-radius-data-driven"].maxSize]]}))}},{key:"updateOptions",value:function(a){this.options=i(this.options,a),this.updateLayers()}},{key:"show",value:function(){this.options.visible=!0,this.updateLayout(!0)}},{key:"hide",value:function(){this.options.visible=!1,this.updateLayout(!1)}},{key:"updateLayout",value:function(b){this.layers&&this.layers.forEach(function(c){a.setLayoutProperty(c.id,"visibility",b?"visible":"none")})}},{key:"remove",value:function(){this.interactiveLayers=[],this.endID&&clearTimeout(this.endID),this.resetID&&clearTimeout(this.resetID),a.off("mousemove",this.onmousemove),a.off("mouseup",this.onclick),this.removeLayers(),this.removeImages(),a.getSource(this.options.id)&&a.removeSource(this.options.id)}}]),k}(h)},a.exports});;
Cube("datav:/com/datavmap-3d-layer-mapbox-scatter/0.1.9",["datav:/npm/eventemitter3/2.0.3","datav:/npm/safely-merge/1.0.1"],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"===typeof b||"function"===typeof b)?b:a}function f(a,b){if("function"!==typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=c("datav:/npm/eventemitter3/2.0.3"),i=c("datav:/npm/safely-merge/1.0.1"),j=c("datav:/com/datavmap-3d-layer-mapbox-scatter/0.1.9/mscatterLayer.js"),k={},l=function(a){function b(a,c){d(this,b);var f=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return f.container="string"===typeof a?document.querySelector(a):a,f.apis=c.apis,f.map=null,f._data=null,f.config=c,f}return f(b,a),g(b,[{key:"initLayer",value:function(){var a=this,b=this.getOptions(),c=j(this.map);this.layer=new c(b),this.layer.on("click",function(b){var c=a.getOptions();a.emit("mapbox-scatter-map-click",b),""!==c.defaultOptions["click-key"]&&a.emit("global_var",c.defaultOptions["click-key"],b[c.defaultOptions["click-key"]])})}},{key:"addTo",value:function(a){var b=this;this.map=a,this.config.id=this.mtag=this.id+"_datav_circle",this.resetID&&clearTimeout(this.resetID),this.init(),this.endID=setTimeout(function(){b.resetID&&clearTimeout(b.resetID)},100000)}},{key:"init",value:function(){var a=this;this.map.loaded()&&this.map.isStyleLoaded()?(this.resetID&&clearTimeout(this.resetID),this.initLayer(),this.data&&this.render(this.data)):(this.resetID&&clearTimeout(this.resetID),this.resetID=setTimeout(function(){a.init()},100))}},{key:"getOptions",value:function(){return this.config=i(k,this.config),this.config}},{key:"show",value:function(){this.config.visible=!0,this.layer&&this.layer.show&&this.layer.show()}},{key:"hide",value:function(){this.config.visible=!1,this.layer&&this.layer.hide&&this.layer.hide()}},{key:"remove",value:function(){this.endID&&clearTimeout(this.endID),this.resetID&&clearTimeout(this.resetID),this.layer&&this.layer.remove&&this.layer.remove(),this.layer=null,this._data=null}},{key:"render",value:function(a){a&&(this.data=a,this.layer&&this.layer.setData(a))}},{key:"updateOptions",value:function(a){this.config=i(this.config,a),a=this.getOptions(),this.layer&&this.layer.updateOptions(a)}}]),b}(h);return a.exports=l,a.exports});