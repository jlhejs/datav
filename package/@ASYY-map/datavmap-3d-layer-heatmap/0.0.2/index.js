// env=undefined => env=publish 
Cube("datav:/com/datavmap-3d-layer-heatmap/0.0.2/shader/heatmap.frag.glsl",[],function(a){return a.exports="#ifdef GL_ES\n  precision highp float;\n#define GLSLIFY 1\n#endif\n\nvarying vec2 v_uv;\nvarying float v_width_seg;\nvarying float v_height_seg;\nvarying float v_grid_width;\nuniform float u_opacity;\nuniform sampler2D u_texture;\n\n#include <common>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n\nvoid main() {\n  #include <logdepthbuf_fragment>\n  float opacity = 1.;\n\n  if(mod(v_uv.x, 1. / v_width_seg) < v_grid_width * 2. || mod(v_uv.y, 1. / v_height_seg) < v_grid_width * 2.) {\n    discard;\n  } else {\n    // opacity = smoothstep(0., v_grid_width * 4., mod(v_uv.x, 0.01) + mod(v_uv.y, 0.01));\n  }\n\n  vec4 color = texture2D(u_texture, v_uv);\n  color.a *= u_opacity;\n  gl_FragColor = color;\n  // gl_FragColor = vec4(1.0, .0, .0, 1.);\n\n  #include <fog_fragment>\n  #include <premultiplied_alpha_fragment>\n}",a.exports});;
Cube("datav:/com/datavmap-3d-layer-heatmap/0.0.2/shader/heatmap.vert.glsl",[],function(a){return a.exports="\n#ifdef GL_ES\n  precision highp float;\n#define GLSLIFY 1\n#endif\n\nvarying vec2 v_uv;\nvarying float v_width_seg;\nvarying float v_height_seg;\nvarying float v_grid_width;\n\nuniform float u_scale;\nuniform float u_width_seg;\nuniform float u_height_seg;\nuniform float u_grid_width;\nuniform vec3 u_source_color;\nuniform vec3 u_target_color;\nuniform sampler2D u_texture;\n\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n\nfloat getIndex(float a, float b, float x){\n  if(a == b) return 0.0;\n  return (x - a) / (b - a);\n}\n\nfloat getZ(vec4 color){\n  float r_delta = getIndex(u_source_color.r, u_target_color.r, color.r);\n  float g_delta = getIndex(u_source_color.g, u_target_color.g, color.g);\n  float b_delta = getIndex(u_source_color.b, u_target_color.b, color.b);\n\n  return ((r_delta + g_delta + b_delta) / 3.0) * u_scale;\n}\n\nfloat decodeRGBA2Float( vec4 color ) {\n  return dot( color, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0));\n}\n\nvoid main() {\n  v_uv = uv;\n  v_width_seg = u_width_seg;\n  v_height_seg = u_height_seg;\n  v_grid_width = u_grid_width;\n  vec4 color = texture2D(u_texture, uv);\n  float z = position.z + getZ(color);\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(position.xy, z, 1.0);\n\n  vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n  #include <fog_vertex>\n  #include <logdepthbuf_vertex>\n}",a.exports});;
Cube("datav:/com/datavmap-3d-layer-heatmap/0.0.2/coord",[],function(a){var b=3.141592653589793;return a.exports={project:function(a,c){var d={worldsize:256/b};Object.assign(d,c);var e=d.worldsize||6378137,f=e*b,g=b/180,h=[e*a[0]*g,e*Math.log(Math.tan(b/4+0.5*a[1]*g))];return h[0]>f&&(h[0]=f),h[0]<-f&&(h[0]=-f),h[1]>f&&(h[1]=f),h[1]<-f&&(h[1]=-f),[h[0]||0,h[1]||0,a[2]||0]}},a.exports});;
Cube("datav:/com/datavmap-3d-layer-heatmap/0.0.2/heatmap",["datav:/npm/chroma-js/1.3.4","datav:/npm/eventemitter3/3.0.0","datav:/npm/safely-merge/1.0.1","datav:/npm/simpleheat/0.4.0"],function(a,b,c){function d(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)}function e(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function f(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"===typeof b||"function"===typeof b)?b:a}function g(a,b){if("function"!==typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var h=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),i=c("datav:/npm/chroma-js/1.3.4"),j=c("datav:/npm/eventemitter3/3.0.0"),k=c("datav:/npm/safely-merge/1.0.1"),l=4095,m=function(a){var b=[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY];return b=a.reduce(function(a,b){return[Math.min(b[0],a[0]),Math.min(b[1],a[1]),Math.max(b[0],a[2]),Math.max(b[1],a[3])]},b),b},n=function(c,a){return c===a};return a.exports=function(a){var b=a.datavgl,o=b.THREE,p=a.glLayer||a,q=c("datav:/npm/simpleheat/0.4.0"),r=c("datav:/com/datavmap-3d-layer-heatmap/0.0.2/coord").project;return function(a){function b(a){e(this,b);var c=f(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return c.options=k({visible:!0,widthSeg:100,heightSeg:100,gridWidth:0,minOpacity:0.6,maxZoom:18,zScale:1,radius:5,blur:15,max:1,opacity:1,depthWrite:!0,offset:50,sceneNames:[{sceneName:"main"}]},a||{}),c.init(),c}return g(b,a),h(b,[{key:"init",value:function(){this.canvas=document.createElement("canvas"),this.canvas.width=10,this.canvas.height=10,this.heatmap=new q(this.canvas),this.updateHeatmapOptions(),this.texture=new o.Texture(this.canvas),this.texture.anisotropy=32,this.texture.magFilter=o.LinearMipmapLinearFilter,this.texture.minFilter=o.LinearMipmapLinearFilter,this.material=this.initMaterial(),this.geometry=new o.PlaneBufferGeometry(1,1,100,100),this.mesh=new o.Mesh(this.geometry,this.material),this.mesh.renderOrder=500+Math.floor(10*Math.random()),p.offsetNode.add(this.mesh),p.emit("init-offset")}},{key:"initMaterial",value:function(){var a=this.options,b=a.zScale,d=a.widthSeg,e=a.heightSeg,f=a.gridWidth,g=a.gradient,h=a.opacity,j=a.depthWrite,k=i(g["0.0"]).gl(),l=i(g["1.0"]).gl();return new o.ShaderMaterial({uniforms:o.UniformsUtils.merge([o.UniformsLib.fog,{u_scale:{value:b},u_texture:{value:this.texture},u_width_seg:{value:d},u_height_seg:{value:e},u_grid_width:{value:f},u_opacity:{value:h},u_source_color:{value:new o.Vector3(k[0],k[1],k[2])},u_target_color:{value:new o.Vector3(l[0],l[1],l[2])}}]),vertexShader:c("datav:/com/datavmap-3d-layer-heatmap/0.0.2/shader/heatmap.vert.glsl"),fragmentShader:c("datav:/com/datavmap-3d-layer-heatmap/0.0.2/shader/heatmap.frag.glsl"),side:o.DoubleSide,blending:o.NormalBlending,depthTest:!0,depthWrite:j,transparent:!0,fog:!0})}},{key:"setData",value:function(a){if(!a||!Array.isArray(a))return console.log("heatmap layer no data");if(!a.length){this.heatmap&&this.heatmap.clear();var b=this.canvas,c=b.width,d=b.height;this.canvas.getContext("2d").clearRect(0,0,c,d),this.texture.needsUpdate=!0}else this.ds=a,this.render();this.checkVisible()}},{key:"checkVisible",value:function(){this.options.visible?this.show():this.hide()}},{key:"show",value:function(){this.options.visible=!0,this.mesh.visible=!0}},{key:"hide",value:function(){this.options.visible=!1,this.mesh.visible=!1}},{key:"render",value:function(){var a=this,b=this.options,c=b.blur,e=b.radius,f=b.offset,g=b.minOpacity;this.meshWidth=0,this.meshHeight=0,this.canvasWidth=0,this.canvasHeight=0;var h=e+c,i=this.ds.map(function(a){return[a.x,a.y]}),j=m(i),k=[j[0],j[1],f],n=[j[0],j[3],f],o=[j[2],j[3],f];this.centerCoords=[(j[0]+j[2])/2,(j[1]+j[3])/2,f];var p=r(k),q=r(n),s=r(o),t=r(k,{worldsize:6378137}),u=r(n,{worldsize:6378137}),v=r(o,{worldsize:6378137}),w=j[2]-j[0],z=j[3]-j[1];this._width=Math.abs(u[0]-v[0]),this._heigth=Math.abs(u[1]-t[1]),this.meshWidth=Math.abs(q[0]-s[0]),this.meshHeight=Math.abs(q[1]-p[1]),this.canvasWidth=~~(this._width+2*h),this.canvasHeight=~~(this._heigth+2*h),this.meshWidth*=this.canvasWidth/this._width,this.meshHeight*=this.canvasHeight/this._heigth,(this._width+2*h>l||this._heigth+2*h>l)&&(this._width>this._heigth?(this.canvasHeight=this._heigth/this._width*l,this.canvasWidth=l):(this.canvasWidth=this._width/this._heigth*l,this.canvasHeight=l));var A=Math.max.apply(Math,d(this.ds.map(function(a){return a.value}))),x=this.ds.map(function(b){var c=(a.canvasWidth-2*h)*((b.x-j[0])/w)+h,d=(a.canvasHeight-2*h)*(1-(b.y-j[1])/z)+h;return[c,d,(void 0===b.value?1:b.value)/A]});this.updateCanvas(),this.updateHeatmapOptions(),this.setScale(),this.updatePostions(),this.heatmap.data(x).draw(g),this.updateMaterial()}},{key:"setScale",value:function(){this.mesh.scale.set(this.meshWidth,this.meshHeight,1)}},{key:"updatePostions",value:function(){var a=r(this.centerCoords);this.mesh.position.set(a[0],a[1],a[2])}},{key:"updateCanvas",value:function(){this.canvas.width=this.canvasWidth,this.canvas.height=this.canvasHeight,this.heatmap.resize()}},{key:"updateHeatmapOptions",value:function(){var a=this.options,b=a.max,c=a.blur,d=a.radius,e=a.gradient;this.heatmap.radius(d,c),this.heatmap.gradient(e),this.heatmap.max(b)}},{key:"updateMaterial",value:function(){var a=this.options,b=a.zScale,c=a.widthSeg,d=a.gradient,e=a.heightSeg,f=a.gridWidth,g=a.opacity,h=a.depthWrite,j=i(d["0.0"]).gl(),k=i(d["1.0"]).gl();this.material.uniforms.u_texture.value=this.texture,this.material.uniforms.u_scale.value=b,this.material.uniforms.u_opacity.value=g,this.material.uniforms.u_width_seg.value=c,this.material.uniforms.u_height_seg.value=e,this.material.uniforms.u_grid_width.value=f,this.material.uniforms.u_source_color.value=new o.Vector3(j[0],j[1],j[2]),this.material.uniforms.u_target_color.value=new o.Vector3(k[0],k[1],k[2]),this.material.depthWrite=h,this.material.needsUpdate=!0,this.texture.needsUpdate=!0}},{key:"updateOpaticy",value:function(){var a=this.options.opacity;this.material.uniforms.u_opacity.value=a}},{key:"updateOptions",value:function(a){var b=Object.assign({},this.options);this.options=k(this.options,a||{}),n(b.blur,a.blur)&&n(b.radius,a.radius)&&n(b.offset,a.offset)&&n(b.zScale,a.zScale)&&n(b.minOpacity,a.minOpacity)||this.render(),n(b.zScale,a.zScale)&&n(b.widthSeg,a.widthSeg)&&n(b.heightSeg,a.heightSeg)&&n(b.gridWidth,a.gridWidth)&&n(b.depthWrite,a.depthWrite)||this.updateMaterial(),n(b.opacity,a.opacity)||this.updateOpaticy(),n(b.offset,a.offset)||(this.centerCoords&&(this.centerCoords[2]=a.offset),this.updatePostions()),n(b.visible,a.visible)||this.checkVisible()}},{key:"remove",value:function(){p.offsetNode.remove(this.mesh),this.geometry.dispose(),this.material.dispose(),this.mesh=null,this.heatmap.clear(),this.heatmap=null,this.canvas=null}}]),b}(j)},a.exports});;
Cube("datav:/com/datavmap-3d-layer-heatmap/0.0.2",["datav:/npm/eventemitter3/3.0.0","datav:/npm/safely-merge/1.0.1"],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"===typeof b||"function"===typeof b)?b:a}function f(a,b){if("function"!==typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=c("datav:/npm/eventemitter3/3.0.0"),i=c("datav:/npm/safely-merge/1.0.1"),j=c("datav:/com/datavmap-3d-layer-heatmap/0.0.2/heatmap"),k={},l=function(a){function b(a,c){d(this,b);var f=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return f.container="string"===typeof a?document.querySelector(a):a,f.apis=c.apis,f.map=null,f._data=null,f.config=c,f}return f(b,a),g(b,[{key:"initLayer",value:function(){var a=this.getOptions(),b=j(this.map);this.layer=new b(a),this.setData(this.data)}},{key:"init",value:function(){var a=this;this.resetID&&clearTimeout(this.resetID),this.resetID=setTimeout(function(){a.map.glLayer.loaded?(a.resetID&&clearTimeout(a.resetID),a.initLayer()):a.init()},100)}},{key:"addTo",value:function(a){var b=this;this.map=a,this.init(),this.endID=setTimeout(function(){b.resetID&&clearTimeout(b.resetID)},300000)}},{key:"getOptions",value:function(){return this.config=i(k,this.config),this.config}},{key:"show",value:function(){this.layer&&this.layer.show&&this.layer.show()}},{key:"hide",value:function(){this.layer&&this.layer.hide&&this.layer.hide()}},{key:"remove",value:function(){this.endID&&clearTimeout(this.endID),this.resetID&&clearTimeout(this.resetID),this.layer&&this.layer.remove&&this.layer.remove(),this.layer=null,this._data=null,this.data=null}},{key:"setData",value:function(a){this.data=a,this.layer&&this.layer.setData(a)}},{key:"updateOptions",value:function(a){this.config=i(this.config,a),a=this.getOptions(),this.layer&&this.layer.updateOptions(a)}}]),b}(h);return a.exports=l,a.exports});