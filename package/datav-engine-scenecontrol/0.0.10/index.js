// env=undefined => env=publish 
Cube("datav:/com/datav-engine-scenecontrol/0.0.10",["datav:/npm/async/2.5.0","datav:/npm/eventemitter3/3.0.0"],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"===typeof b||"function"===typeof b)?b:a}function f(a,b){if("function"!==typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=null,i=null,j=null,k=c("datav:/npm/async/2.5.0"),l=c("datav:/npm/eventemitter3/3.0.0"),m=function(a){function b(a,c){d(this,b);var f=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return f.options=Object.assign({delay:3e3,duration:3e3,isWork:!1,distance:30},c||{}),f.isStop=!1,f.repeating=!1,f.currentTween=null,f.firstRun=!0,f}return f(b,a),g(b,[{key:"addTo",value:function(a){return a?void(h=a.three,j=a.Utils,i=j.TWEEN,this.viewer=a,this.scene=a.scene,this.camera=this.viewer.camera,this.orbitControls=a.controls):console.log("scenecontrol layer needs viewer layer")}},{key:"setData",value:function(a){this.stop(),this.cameraPos=[],Array.isArray(a)&&a.length&&(this.cameraPos=a.filter(function(a){return 1<a.path.length}),this.createInterPath(),this.checkIsWork())}},{key:"checkIsWork",value:function(){this.options.isWork?this.repeat():this.stop()}},{key:"repeat",value:function(){if(this.cameraPos){this.repeating=!0,this.isStop=!1;var a=this.cameraPos[0].delay;this.cameraPos[0].delay=0,this.doSceneSwitch(),this.cameraPos[0].delay=a}}},{key:"stop",value:function(){this.repeating=!1,this.currentTween&&this.currentTween.stop(),this.currentTween&&i.remove(this.currentTween),this.currentTween=null,this.isStop=!0,this.firstRun=!0}},{key:"doSceneSwitch",value:function(){var a=this;this.firstRun||this.reSortCameraPos(),k.eachSeries(this.cameraPos,this.doTween.bind(this),function(){a.firstRun=!1,a.isStop||a.doSceneSwitch()})}},{key:"doSceneGroupSwitch",value:function(a){var b=this;k.eachSeries(a,this.doTween.bind(this),function(){b.stop()})}},{key:"reSortCameraPos",value:function(){var a=this.cameraPos.length;this.cameraPos[0]={delay:1e3,duration:3e3,__type:"inserted",forceTarget:this.cameraPos[1].forceTarget,__preCameraPos:this.cameraPos[a-1].__lastCameraPos,__preCameraLookAtPos:this.cameraPos[a-1].__lastCameraLookAtPos,__lastCameraPos:this.cameraPos[1].__preCameraPos,__lastCameraLookAtPos:this.cameraPos[1].__preCameraLookAtPos}}},{key:"doTween",value:function(a,b){var c=this.genTween(a,b);this.isStop?b("stop"):(this.currentTween=c,c.start())}},{key:"getCameraPosIndexByName",value:function(a){var b=this.cameraPos.findIndex(function(b){return b.name===a});return-1===b?1:b}},{key:"createInterPath",value:function(){var a=this,b=this.options,c=b.duration;this.cameraPos=this.cameraPos.map(function(b){var c=void 0===b.distance?0:b.distance,d=a.createTubeIndicator(b.path),e="back"===b.direction?1:0;return b.indicator=d,b.__type="source",b.__preCameraPos=a.getCameraHoldPos(e,c,d),b.__preCameraLookAtPos=a.getCameraLookAtPos(e,d),b.__lastCameraPos=a.getCameraHoldPos(1-e,c,d),b.__lastCameraLookAtPos=a.getCameraLookAtPos(1-e,d),b});for(var d=this.cameraPos.length,e=[],f=0;f<d;f++){var g=this.cameraPos[f].forceTarget,h=void 0===this.cameraPos[f].delay?b.delay:this.cameraPos[f].delay;if(0===f)e.push({delay:h,__type:"inserted",forceTarget:g,__preCameraPos:this.camera.position.clone(),__preCameraLookAtPos:this.orbitControls.target.clone(),__lastCameraPos:this.cameraPos[0].__preCameraPos,__lastCameraLookAtPos:this.cameraPos[0].__preCameraLookAtPos});else{var i=this.getForceTarget(this.cameraPos[f-1].forceTarget),j=this.getForceTarget(this.cameraPos[f].forceTarget);e.push({delay:h,__type:"inserted",__preCameraPos:this.cameraPos[f-1].__lastCameraPos,__preCameraLookAtPos:i||this.cameraPos[f-1].__lastCameraLookAtPos,__lastCameraPos:this.cameraPos[f].__preCameraPos,__lastCameraLookAtPos:j||this.cameraPos[f].__preCameraLookAtPos})}}for(var k=[],l=0;l<d;l++)k.push(e[l]),k.push(this.cameraPos[l]);this.cameraPos=k}},{key:"getProjPos",value:function(a,b,c){return this.viewer&&this.viewer.Projection([a,b,c])}},{key:"createTubeIndicator",value:function(a){var b=this,c=[];a.forEach(function(a){var d=b.getProjPos(a[0],a[1],a[2]);c.push(new h.Vector3(d[0],d[1],d[2]))});var d=new h.CatmullRomCurve3(c),e=new h.TubeBufferGeometry(d,5*d.points.length,0.2,6,!1);return e}},{key:"getForceTarget",value:function(a){if(null===a||void 0===a||!a.length)return null;var b=this.getProjPos(a[0],a[1],a[2]);return new h.Vector3(b[0],b[1],b[2])}},{key:"disposeIndicator",value:function(a){a&&a.dispose&&a.dispose()}},{key:"getCameraLookAtPos",value:function(a,b){return b.parameters.path.getPointAt(a)}},{key:"getCameraHoldPos",value:function(a,b,c){var d=c.parameters.path.getTangentAt(a),e=this.getCameraLookAtPos(a,c),f=new h.Vector3(0,1,0),g=d.clone().multiplyScalar(-1).normalize().add(f).normalize(),i=e.clone().add(g.multiplyScalar(b));return i}},{key:"genTween",value:function(a,b){var c=a.__type;switch(c){case"source":return this.createSourceTween(a,b);break;case"inserted":return this.createInsertedTween(a,b);}}},{key:"createSourceTween",value:function(a,b){var c=this,d=this.options,e=void 0===a.duration?d.duration:a.duration,f=void 0===a.distance?d.distance:a.distance,g=a.direction,h=this.getForceTarget(a.forceTarget);return new i.Tween({value:0}).to({value:1},e).delay(0).interpolation(i.Interpolation.Bezier).onStart(function(){("outer"===a.emit||"all"===a.emit)&&c.emit("scene-control-start",{type:"start",info:a.info}),("inner"===a.emit||"all"===a.emit)&&c.viewer.emit("viewer-scene-control-start",{type:"start",info:a.info})}).easing(i.Easing[a.easing]||i.Easing.Linear.None).onUpdate(function(){var b="back"===g?1-this.value:this.value;if(h)c.orbitControls.target.copy(h),c.camera.lookAt(h);else{var d=c.getCameraLookAtPos(b,a.indicator);c.orbitControls.target.copy(d),c.camera.lookAt(d)}var e=c.getCameraHoldPos(b,f,a.indicator);c.camera.position.copy(e),("outer"===a.emit||"all"===a.emit)&&c.emit("scene-control-moving",{type:"moving",info:a.info}),("inner"===a.emit||"all"===a.emit)&&c.viewer.emit("viewer-scene-control-moving",{type:"moving",info:a.info})}).onComplete(function(){c.prePos=j.deepClone(a),c.currentPos=j.deepClone(a),("outer"===a.emit||"all"===a.emit)&&c.emit("scene-control-end",{type:"end",info:a.info}),("inner"===a.emit||"all"===a.emit)&&c.viewer.emit("viewer-scene-control-end",{type:"end",info:a.info}),c.emitCallBackId(a),i.remove(),b&&b()})}},{key:"createInsertedTween",value:function(a,b){var c=this,d=a.__preCameraPos,e=a.__preCameraLookAtPos,f=a.__lastCameraPos,g=a.__lastCameraLookAtPos,j=this.getForceTarget(a.forceTarget);return new i.Tween({px:d.x,py:d.y,pz:d.z,tx:e.x,ty:e.y,tz:e.z}).to({px:f.x,py:f.y,pz:f.z,tx:g.x,ty:g.y,tz:g.z},800).delay(a.delay||0).interpolation(i.Interpolation.Bezier).onStart(function(){}).easing(i.Easing.Linear.None).onUpdate(function(){var a=new h.Vector3(this.px,this.py,this.pz);if(j)c.orbitControls.target.copy(j),c.camera.lookAt(j);else{var b=new h.Vector3(this.tx,this.ty,this.tz);c.orbitControls.target.copy(b),c.camera.lookAt(b)}c.camera.position.copy(a)}).onComplete(function(){i.remove(),b&&b()})}},{key:"emitCallBackId",value:function(a){var b=this.options,c=b.endCallbackId,d=a[c];c&&this.emit("global_var",c,d)}},{key:"removeLivingTween",value:function(){this.currentTween&&this.currentTween.stop(),this.currentTween&&i.remove(this.currentTween),this.currentTween=null}},{key:"switchCameraPositionByName",value:function(a){if("stop"===a)return this.stop();if("repeat"===a)return this.repeating?void 0:this.repeat();this.stop();var b=this.getCameraPosIndexByName(a),c=[];c.push({delay:0,__type:"inserted",forceTarget:this.cameraPos[b].forceTarget,__preCameraPos:this.camera.position.clone(),__preCameraLookAtPos:this.orbitControls.target.clone(),__lastCameraPos:this.cameraPos[b].__preCameraPos,__lastCameraLookAtPos:this.cameraPos[b].__preCameraLookAtPos}),c.push(this.cameraPos[b]),this.isStop=!1,this.doSceneGroupSwitch(c)}},{key:"updateOptions",value:function(a){var b=this.options.isWork;this.options=j.mergeOptions(this.options,a||{}),b!==a.isWork&&this.checkIsWork()}},{key:"remove",value:function(){this.stop(),this.isStop=!1,this.repeating=!1,this.currentTween=null,this.cameraPos=null}}]),b}(l);return a.exports=m,a.exports});