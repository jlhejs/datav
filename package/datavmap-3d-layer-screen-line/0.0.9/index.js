// env=undefined => env=publish 
Cube("datav:/com/datavmap-3d-layer-screen-line/0.0.9/meshline-geometry.js",["datav:/npm/safely-merge/1.0.1"],function(a,b,c){var d=c("datav:/npm/safely-merge/1.0.1"),e=function(a,b,c){return b<c?a<b?b:a>c?c:a:a<c?c:a>b?b:a},f={project:function(a){return[a[0]||0,a[1]||0,a[2]||0]}};return a.exports=function(a,b){b=d(f,b);for(var c=[],g=[],h=[],j=[],k=[],l=[],m=a.length,o=b.project,p=0;p<m;p++){var i=e(p-1,0,m-1),q=e(p+1,0,m-1),r=o(a[i]),s=o(a[q]),t=o(a[p]);if(h.push(t[0],t[1],t[2],t[0],t[1],t[2]),g.push(r[0],r[1],r[2],r[0],r[1],r[2]),j.push(s[0],s[1],s[2],s[0],s[1],s[2]),c.push(1,-1),l.push(p/m,p/m),p<m-1){var u=2*p;k.push(u,u+1,u+2),k.push(u+1,u+3,u+2)}}return{side:c,prev:g,curr:h,next:j,indices:k,v:l}},a.exports});;
Cube("datav:/com/datavmap-3d-layer-screen-line/0.0.9/meshline.vert.glsl",[],function(a){return a.exports="#define GLSLIFY 1\nattribute vec3 prevPosition;\nattribute vec3 nextPosition;\nattribute float aSide;\nattribute float aV;\nuniform float uLineWidth; //\u7EBF\u5BBD\nuniform float uNear;\nuniform vec2 uResolution;\nuniform float uIsPixelWidth; //\u662F\u5426\u4F7F\u7528\u5C4F\u5E55\u50CF\u7D20\u5355\u4F4D\nvarying vec2 vUv;\n//\u6295\u5F71\u540E\u5904\u7406\nvec2 fix(vec4 i, float aspect) {\n  vec2 res = i.xy / i.w;\n  res.x *= aspect;\n  return res;\n}\n\nvec2 unfix(vec2 i, float aspect) {\n  i.x /= aspect;\n  return i;\n}\n\nvec4 clipNear(vec4 p1, vec4 p2) {\n  float n = (p1.w - uNear) / (p1.w - p2.w);\n  return vec4(mix(p1.xy, p2.xy, n), -uNear, uNear);\n}\n\nvoid main() {\n  vUv = vec2(sign(aSide) / 2.0 + 0.5, aV);\n  float aspect = uResolution.x / uResolution.y;\n  float pixelWidthRatio = 1. / (uResolution.x * projectionMatrix[0][0]);\n  mat4 mvp = projectionMatrix * modelViewMatrix;\n  //\u6C42\u51FA\u5404\u4E2A\u70B9\u7684\u6295\u5F71\u5750\u6807\n  vec4 prevProj = mvp * vec4(prevPosition, 1.0);\n  vec4 currProj = mvp * vec4(position, 1.0);\n  vec4 nextProj = mvp * vec4(nextPosition, 1.0);\n\n  if (currProj.w < 0.0) {\n    if (nextProj.w > 0.0) {\n      currProj = clipNear(currProj, nextProj);\n    } else if (prevProj.w > 0.0) {\n      currProj = clipNear(currProj, prevProj);\n    }\n  }\n\n  //\u6C42\u51FA\u5404\u4E2A\u70B9\u7684\u5C4F\u5E55\u5750\u6807\n  vec2 prevScreen = fix(prevProj, aspect);\n  vec2 currScreen = fix(currProj, aspect);\n  vec2 nextScreen = fix(nextProj, aspect);\n\n  vec2 dir;\n  float pixelWidth = currProj.w * pixelWidthRatio;\n  //\u5411\u6269\u5C55\u65B9\u5411\u6269\u5C55\u4E00\u534A\n  float width = uLineWidth * aSide * 0.5;\n  //\u9ED8\u8BA4\u5C4F\u5E55\u50CF\u7D20\u5355\u4F4D\n  if (uIsPixelWidth == 1.0) {\n    width = width * pixelWidth * 3.0;\n  }\n  //\u8D77\u70B9\n  if (currProj == prevProj) {\n    dir = normalize(nextScreen - currScreen);\n  } else if (currProj == nextProj) { //\u7EC8\u70B9\n    dir = normalize(currScreen - prevScreen);\n  } else { //\u7ED3\u5C3E\u70B9\n    vec2 dirA = normalize(currScreen - prevScreen);\n    vec2 dirB = normalize(nextScreen - currScreen);\n    vec2 tanget = normalize(dirA + dirB);\n    float miter = 1.0 / max(dot(tanget, dirA), 0.5);\n    width *= miter;\n    dir = tanget;\n  }\n  vec2 offset = vec2(-dir.y, dir.x) * width;\n  offset.x /= aspect;\n  currProj.xy += offset;\n  gl_Position = currProj;\n}",a.exports});;
Cube("datav:/com/datavmap-3d-layer-screen-line/0.0.9/meshline.frag.glsl",[],function(a){return a.exports="#define GLSLIFY 1\nuniform sampler2D texture;\nvarying vec2 vUv;\nuniform vec4 uColor;\nuniform float uBrightness;\nconst vec3 _024 = vec3(0.0, 2.0, 4.0);\nconst vec3 zero = vec3(0.0);\nconst float PI = 3.14159265359;\nconst vec3 one = vec3(1.0);\nvec3 hue(float H) {\n  H *= 6.0;\n  return clamp(vec3(abs(H - 3.) - 1.0, 2. - abs(H - 2.), 2. - abs(H - 4.)),\n               zero, one);\n}\n\nvec3 hsb2rgb(vec3 hsb) {\n  vec3 rgb = vec3(mix(vec3(1.0), hue(hsb.r), hsb.g));\n  rgb = vec3(mix(vec3(0.0), rgb, hsb.b));\n  return clamp(rgb, vec3(0.0), vec3(1.0));\n}\n\nvec3 rgb2hsb(vec3 c) {\n  float low = min(min(c.r, c.g), c.b);\n  float high = max(max(c.r, c.g), c.b);\n  vec3 foo = ((c - c.gbr) / (high - low) + _024) *\n             vec3(c.b == high, c.r == high, c.g == high);\n  return clamp(\n      vec3(mod(4.0 + dot(foo, one), 6.0) / 6.0, (high - low) / high, high),\n      zero, one);\n}\n\nvoid main() {\n  vec3 hsbColor = rgb2hsb(uColor.rgb);\n  hsbColor.b *= uBrightness;\n  gl_FragColor = vec4(hsb2rgb(hsbColor), uColor.w);\n}",a.exports});;
Cube("datav:/com/datavmap-3d-layer-screen-line/0.0.9/geojson-meshline-geometry.js",[],function(a,b,c){var d=c("datav:/com/datavmap-3d-layer-screen-line/0.0.9/meshline-geometry.js");return a.exports=function(a,b){var c=[],e=[],f=[],g=[],h=[],i=[];return a.features&&a.features.length&&a.features.forEach(function(a){var j=[];"MultiPolygon"===a.geometry.type?a.geometry.coordinates.forEach(function(a){[].push.apply(j,a)}):"Polygon"===a.geometry.type?[].push.apply(j,a.geometry.coordinates):"MultiLineString"===a.geometry.type?[].push.apply(j,a.geometry.coordinates):"LineString"===a.geometry.type&&j.push(a.geometry.coordinates),j.forEach(function(a){var j=d(a,b);[].push.apply(h,j.indices.map(function(a){return a+c.length})),[].push.apply(c,j.side),[].push.apply(e,j.prev),[].push.apply(f,j.curr),[].push.apply(g,j.next),[].push.apply(i,j.v)})}),{side:c,prev:e,curr:f,next:g,indices:h,v:i}},a.exports});;
Cube("datav:/com/datavmap-3d-layer-screen-line/0.0.9/meshline-layer.js",["datav:/npm/eventemitter3/2.0.3","datav:/npm/safely-merge/1.0.1","datav:/npm/chroma-js/1.3.4"],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"===typeof b||"function"===typeof b)?b:a}function f(a,b){if("function"!==typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=c("datav:/npm/eventemitter3/2.0.3"),i=c("datav:/npm/safely-merge/1.0.1"),j=c("datav:/npm/chroma-js/1.3.4"),k=c("datav:/com/datavmap-3d-layer-screen-line/0.0.9/geojson-meshline-geometry.js");return a.exports=function(a){var b=a.datavgl,l=b.THREE,m=a.glLayer||a,n=a.worldsize,o={};return function(a){function b(a){d(this,b);var c=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return a=i(o,a),c.options=i(c.options,a),c.init(),c}return f(b,a),g(b,[{key:"init",value:function(){this.initMaterial()}},{key:"initMaterial",value:function(){this.material=new l.ShaderMaterial({uniforms:{uResolution:{value:[m.renderer.getSize().width,m.renderer.getSize().height]},uColor:{value:j(this.options.color).gl()},uBrightness:{value:this.options.brightness},uIsPixelWidth:{value:1},uLineWidth:{value:this.options.lineWidth},uNear:{value:m.camera.near}},side:l.DoubleSide,transparent:!0,blending:l.AdditiveBlending,fragmentShader:c("datav:/com/datavmap-3d-layer-screen-line/0.0.9/meshline.frag.glsl"),vertexShader:c("datav:/com/datavmap-3d-layer-screen-line/0.0.9/meshline.vert.glsl")}),this.material.needsUpdate=!0}},{key:"setData",value:function(a){var b=this;if(this.line&&m.offsetNode.remove(this.line),this.geometry&&this.geometry.dispose(),a&&a.features){var c=k(a,{project:function(a,c){var d=Math.PI||3.141592653589793,e={worldsize:n,offset:[0,0]};Object.assign(e,c);var f=d/180,g=(a[0]||a[x])-e.offset[0],h=(a[1]||a[y])-e.offset[1],i=[n*g*f,n*Math.log(Math.tan(d/4+0.5*h*f)),(a[2]||0)+b.options.verticlePosition];return i}}),d=this.geometry=new l.BufferGeometry;d.setIndex(new l.BufferAttribute(new Uint32Array(c.indices),1)),d.addAttribute("position",new l.BufferAttribute(new Float32Array(c.curr),3)),d.addAttribute("prevPosition",new l.BufferAttribute(new Float32Array(c.prev),3)),d.addAttribute("nextPosition",new l.BufferAttribute(new Float32Array(c.next),3)),d.addAttribute("aSide",new l.BufferAttribute(new Float32Array(c.side),1)),d.addAttribute("aV",new l.BufferAttribute(new Float32Array(c.v),1)),d.needsOffset=!0,d.needsOffsetFields=["prevPosition","nextPosition"],d.computeBoundingSphere(),d.computeBoundingBox();var e=this.line=new l.Mesh(d,this.material);e.visible=this.options.visibility,e.frustumCulled=!1,m.offsetNode.add(e)}m.emit("init-offset")}},{key:"updateOptions",value:function(a){a.verticlePosition!==this.options.verticlePosition&&(this.options=i(this.options,a),this.updateVerticlePosition()),this.options=i(this.options,a),this.material.uniforms.uLineWidth.value=this.options.lineWidth,this.material.uniforms.uColor.value=j(this.options.color).gl(),this.material.uniforms.uBrightness.value=this.options.brightness,this.line.visible=this.options.visibility}},{key:"updateVerticlePosition",value:function(){for(var a=this.options.verticlePosition,b=this.geometry.attributes.position,c=this.geometry.attributes.prevPosition,d=this.geometry.attributes.nextPosition,e=b.count,f=0;f<e;f++)b.setZ(f,a);for(var g=c.count,h=0;h<g;h++)c.setZ(h,a);for(var i=d.count,j=0;j<i;j++)d.setZ(j,a);b.needsUpdate=!0,c.needsUpdate=!0,d.needsUpdate=!0}},{key:"show",value:function(){this.options.visibility=!0,this.line&&(this.line.visible=!0)}},{key:"hide",value:function(){this.options.visibility=!1,this.line&&(this.line.visible=!1)}},{key:"remove",value:function(){this.line&&m.offsetNode.remove(this.line),this.geometry&&this.geometry.dispose(),this.material.dispose()}}]),b}(h)},a.exports});;
Cube("datav:/com/datavmap-3d-layer-screen-line/0.0.9",["datav:/npm/eventemitter3/2.0.3","datav:/npm/safely-merge/1.0.1"],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"===typeof b||"function"===typeof b)?b:a}function f(a,b){if("function"!==typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=c("datav:/npm/eventemitter3/2.0.3"),i=c("datav:/npm/safely-merge/1.0.1"),j=c("datav:/com/datavmap-3d-layer-screen-line/0.0.9/meshline-layer.js"),k={};return a.exports=function(a){function b(a,c){d(this,b);var f=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return f.container="string"===typeof a?document.querySelector(a):a,f.apis=c.apis,f.map=null,f._data=null,f.config=c,f}return f(b,a),g(b,[{key:"initLayer",value:function(){var a=this.getOptions(),b=j(this.map);this.layer=new b(a),this.updateData(this.data)}},{key:"init",value:function(){var a=this;this.resetID&&clearTimeout(this.resetID),this.resetID=setTimeout(function(){a.map.glLayer.loaded?(a.resetID&&clearTimeout(a.resetID),a.initLayer()):a.init()},100)}},{key:"addTo",value:function(a){var b=this;this.map=a,this.init(),this.endID=setTimeout(function(){b.resetID&&clearTimeout(b.resetID)},300000)}},{key:"getOptions",value:function(){return this.config=i(k,this.config),this.config}},{key:"show",value:function(){this.config.visibility=!0,this.layer&&this.layer.show&&this.layer.show()}},{key:"hide",value:function(){this.config.visibility=!1,this.layer&&this.layer.hide&&this.layer.hide()}},{key:"remove",value:function(){this.endID&&clearTimeout(this.endID),this.resetID&&clearTimeout(this.resetID),this.layer&&this.layer.remove&&this.layer.remove(),this.layer=null,this._data=null,this.data=null}},{key:"updateData",value:function(a){this.data=a,this.layer&&this.layer.setData(a)}},{key:"updateOptions",value:function(a){this.config=i(this.config,a),a=this.getOptions(),this.layer&&this.layer.updateOptions(a)}}]),b}(h),a.exports});