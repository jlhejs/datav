// env=undefined => env=publish 
Cube("datav:/com/@datav-city-pro-v2/datav-engine-breathbubble/2.1.3/shaders/breathbubble.frag.glsl",[],function(e,n,r,t,a,o){return e.exports="#ifdef GL_ES\n  precision highp float;\n#define GLSLIFY 1\n#endif\n\n#include <logdepthbuf_pars_fragment>\n\nuniform sampler2D uTexture;\nuniform float uBright;\nuniform float uOpacity;\nuniform vec2 uTextureSegments; //horizontal and verticle segments of a texture, as frames of animation graph\nuniform vec2 uFrameCoord; // the 2D coord of current small fig in the big png pic.\nuniform vec3 uColor;\nvarying vec2 vUv;\n\nvec2 scaleUv(vec2 uv, vec2 transformStep, vec2 uTextureSegments) {\n  float uSegmentUnit = 1.0 / uTextureSegments.x;\n  float vSegmentUnit = 1.0 / uTextureSegments.y;\n \n  return vec2(uv.x / uTextureSegments.x + uSegmentUnit * transformStep.x, \n  1.0 - uv.y / uTextureSegments.y - vSegmentUnit * transformStep.y);\n}\n\n \n\nvoid main() {\n  #include <logdepthbuf_fragment>\n\n  vec2 scaledUvs = scaleUv(vUv, uFrameCoord, uTextureSegments);\n  vec4 fragColor = texture2D(uTexture, scaledUvs);\n\n  // 由于配置项显示的颜色已经是经过gamma校正的，而后期渲染模块会统一做gamma校正，\n  // 为了图元渲染颜色和配置项设置颜色保持一致，需要做以下处理以抵消\n\tvec3 gammaBackColor = vec3(pow(uColor.r, 2.2), pow(uColor.g, 2.2),pow(uColor.b, 2.2));\n\n  fragColor *= vec4(gammaBackColor, uOpacity);\n\n  gl_FragColor = fragColor * uBright;\n\n  #include <premultiplied_alpha_fragment>\n}",e.exports});;
Cube("datav:/com/@datav-city-pro-v2/datav-engine-breathbubble/2.1.3/shaders/breathbubble.vert.glsl",[],function(n,i,e,o,t,v){return n.exports="#define GLSLIFY 1\n#include <common>\n#include <logdepthbuf_pars_vertex>\n\nvarying vec2 vUv;\n\nvoid main() {\n  vUv = uv;\n\n  vec4 mvPosition = vec4(position, 1.0); //transformed\n  #ifdef USE_INSTANCING\n\n    mvPosition = instanceMatrix * mvPosition;\n\n  #endif\n\n  mvPosition = modelViewMatrix * mvPosition;\n  gl_Position = projectionMatrix * mvPosition;\n\n  #include <logdepthbuf_vertex>\n}\n\n ",n.exports});;
Cube("datav:/com/@datav-city-pro-v2/datav-engine-breathbubble/2.1.3/breathbubble",[],function(e,t,d,r,a,o){function i(e){return(i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function y(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function v(){return(v="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var a=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=x(e)););return e}(e,t);if(a)return a=Object.getOwnPropertyDescriptor(a,t),a.get?a.get.call(arguments.length<3?e:r):a.value}).apply(this,arguments)}function b(e,t){return(b=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function g(r){var a=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=x(r),t=(e=a?(e=x(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),this);if(e&&("object"===i(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");if(void 0!==t)return t;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}}function x(e){return(x=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}return e.exports=function(e){var l=e.THREE,u=e.Utils,r=e.VG,t=e.FormatTransformer,s=e.coordHelper,e=r.Layer,n=(this.formatTransformer=new t,new l.Vector3),h=new l.Vector3,c=new l.Quaternion,f=new l.Vector3,p=new l.Matrix4,t=new l.Vector3(1,0,0),m=(new l.Quaternion).setFromAxisAngle(t,-.5*Math.PI),t=i;if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&b(t,e);var a,o=g(i);function i(e){var t;if(this instanceof i)return(t=o.call(this)).classNameAlias="BreathBubbleLayer",t.layerName=t.classNameAlias,t.renderQueue=r.Transparent,t.needsAutoUpdate=!0,t.options=Object.assign({visible:!0},e||{}),t.defaultValue=1,t.defaultAltitude=0,t.calFrameCoord(),t.frameCursor=0,t;throw new TypeError("Cannot call a class as a function")}return t=i,(e=[{key:"addTo",value:function(e){v(x(i.prototype),"addTo",this).call(this,e)}},{key:"calFrameCoord",value:function(){for(var e=this.options.options.graph,t=e.textureSegmentsX,r=[],a=e.textureSegmentsY-1;0<=a;a--)for(var o=0;o<t;o++)r.push([o,a]);this.frameCoords&&(this.frameCoords.length=0),this.frameCoords=r}},{key:"setData",value:function(e){if(!e)return console.error("no data for BreathBubbleLayer.");this.clear();var t,r,a,o,i=e,s=[];if(!Array.isArray(e)){if("FeatureCollection"!==e.type)return console.log("BreathBubbleLayer: invalid data format. ",e);i=this.formatTransformer.geojson2datav(e)}if(!i.length)return console.error("BreathBubbleLayer: the length of data is 0.",i);for(var n=0,l=i.length;n<l;n++)o=i[n],t=parseFloat(o.lng),r=parseFloat(o.lat),a=parseFloat(o.altitude),isNaN(t)||isNaN(r)||(o=parseFloat(o.value),a=isNaN(a)?this.defaultAltitude:a,o=isNaN(o)?this.defaultValue:o,s.push({lng:t,lat:r,altitude:a,value:o}));this.formattedData=s,this.render()}},{key:"render",value:function(){this.initMaterial();for(var e=this.options.options.general,t=e.verticalOffset,r=e.scaleFactor,e=new l.PlaneBufferGeometry(1e3,1e3),e=new l.InstancedMesh(e,this.material,this.formattedData.length),a=(this.add(e),this.mesh=e,0),o=this.formattedData.length;a<o;a++){var i=this.formattedData[a];s.setFromValues(i.lng,i.lat,i.altitude+t),s.toXYZ(n),s.transfrom.decompose(h,c,f),i=i.value*r,f.set(i,i,i),c.multiply(m),p.compose(h,c,f),this.mesh.setMatrixAt(a,p)}this.checkVisible(),this.emit("rendered")}},{key:"initMaterial",value:function(){this.material&&this.material.dispose&&this.material.dispose();var e=this.options.options,t=e.general,e=e.graph,r=t.blending,a=t.depthTest,t=t.depthWrite,o=e.sequenceFrameTexture,i=e.textureSegmentsX,s=e.textureSegmentsY,n=e.bright,e=e.color,o=(this.texture=(new l.TextureLoader).setCrossOrigin("*").load(o),this.textureSegmentsLimit=i*s,u.Chroma(e).gl());this.material=new l.ShaderMaterial({uniforms:{uTexture:{value:this.texture},uTextureSegments:{value:new l.Vector2(i,s)},uOpacity:{value:o[3]},uBright:{value:n},uFrameCoord:{value:new l.Vector2(0,0)},uColor:{value:new l.Vector3(o[0],o[1],o[2])}},vertexShader:d("datav:/com/@datav-city-pro-v2/datav-engine-breathbubble/2.1.3/shaders/breathbubble.vert.glsl"),fragmentShader:d("datav:/com/@datav-city-pro-v2/datav-engine-breathbubble/2.1.3/shaders/breathbubble.frag.glsl"),side:l.DoubleSide,blending:l[r],depthTest:a,depthWrite:t,transparent:!0})}},{key:"animate",value:function(){var e;this.material&&(e=this.options.options.animate.sequenceFrameSpeed,this.frameCursor>this.textureSegmentsLimit?this.frameCursor=0:this.frameCursor+=e,e=Math.floor(this.frameCursor)%this.textureSegmentsLimit,e=this.frameCoords[e],this.material.uniforms.uFrameCoord.value=new l.Vector2(e[0],e[1]))}},{key:"autoUpdate",value:function(){this.animate()}},{key:"updateVerticalOffset",value:function(e,t){for(var r=0,a=this.formattedData.length;r<a;r++){var o=this.formattedData[r],o=(s.setFromValues(o.lng,o.lat,o.altitude+e),s.toXYZ(n),p.copy(s.transform),p.decompose(h,c,f),h.copy(n),o.value*t);f.set(o,o,o),c.multiply(m),p.compose(h,c,f),this.mesh.setMatrixAt(r,p)}this.mesh.instanceMatrix.needsUpdate=!0}},{key:"updateScale",value:function(e){for(var t=0,r=this.formattedData.length;t<r;t++){var a=this.formattedData[t],a=(this.mesh.getMatrixAt(t,p),p.decompose(h,c,f),a.value*e);f.set(a,a,a),p.compose(h,c,f),this.mesh.setMatrixAt(t,p)}this.mesh.instanceMatrix.needsUpdate=!0}},{key:"checkVisible",value:function(){this.options.visible?this.show():this.hide()}},{key:"hide",value:function(){this.options.visible=!1,v(x(i.prototype),"hide",this).call(this)}},{key:"show",value:function(){this.options.visible=!0,v(x(i.prototype),"show",this).call(this)}},{key:"updateOptions",value:function(e){var t=u.deepClone(this.options),t=(this.options=u.mergeOptions(this.options,e||{}),t.options),r=t.general,t=t.graph,e=e.options,a=e.general,e=e.graph,r=(u.easyDiff(r.scaleFactor,a.scaleFactor)||this.updateScale(a.scaleFactor),u.easyDiff(r.verticalOffset,a.verticalOffset)||this.updateVerticalOffset(a.verticalOffset,a.scaleFactor),u.easyDiff(t.sequenceFrameTexture,e.sequenceFrameTexture)||(this.material.uniforms.uTexture.value=(new l.TextureLoader).setCrossOrigin("*").load(e.sequenceFrameTexture)),u.easyDiff(t.textureSegmentsX,e.textureSegmentsX)&&u.easyDiff(t.textureSegmentsY,e.textureSegmentsY)||(r=e.textureSegmentsX,t=e.textureSegmentsY,this.textureSegmentsLimit=r*t,this.material.uniforms.uTextureSegments.value=new l.Vector2(r,t),this.calFrameCoord()),e.color),t=e.bright,e=a.blending,o=a.depthWrite,a=a.depthTest,r=u.Chroma(r).gl();this.material.uniforms.uColor.value=new l.Vector3(r[0],r[1],r[2]),this.material.uniforms.uOpacity.value=r[3],this.material.uniforms.uBright.value=t,this.material.blending=l[e],this.material.depthTest=a,this.material.depthWrite=o,this.material.needsUpdate=!0}},{key:"clear",value:function(){v(x(i.prototype),"clear",this).call(this),this.mesh&&this.mesh.dispose(),this.formattedData&&(this.formattedData.length=0),this.texture&&this.texture.dispose()}},{key:"destroy",value:function(){this.clear(),this.frameCoords&&(this.frameCoords.length=0),v(x(i.prototype),"destroy",this).call(this)}}])&&y(t.prototype,e),a&&y(t,a),Object.defineProperty(t,"prototype",{writable:!1}),i},e.exports});;
Cube("datav:/com/@datav-city-pro-v2/datav-engine-breathbubble/2.1.3",["datav:/npm/eventemitter3/3.0.0"],function(t,e,r,o,n,i){function a(t){return(a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function c(t,e){for(var r=0;r<e.length;r++){var o=e[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function u(t,e){return(u=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function l(r){var o=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(t){return!1}}();return function(){var t,e=s(r),e=(t=o?(t=s(this).constructor,Reflect.construct(e,arguments,t)):e.apply(this,arguments),this);if(t&&("object"===a(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}}function s(t){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}var y=r("datav:/npm/eventemitter3/3.0.0"),f=r("datav:/com/@datav-city-pro-v2/datav-engine-breathbubble/2.1.3/breathbubble"),r=function(){var t=n,e=y;if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&u(t,e);var r,o=l(n);function n(t,e){var r;if(this instanceof n)return(r=o.call(this)).options=e,r.comId="",r;throw new TypeError("Cannot call a class as a function")}return t=n,(e=[{key:"addTo",value:function(t,e){this.cityproCore=t,this.comId=e,this.initLayer()}},{key:"initLayer",value:function(){var t=f(this.cityproCore);this.layer=new t(this.options),this.cityproCore.viewer.addLayer(this.comId,this.layer)}},{key:"setData",value:function(t){this.layer&&this.layer.setData(t)}},{key:"setOpacity",value:function(t){this.layer&&this.layer.setOpacity(t)}},{key:"updateOptions",value:function(t){this.layer&&this.layer.updateOptions&&this.layer.updateOptions(t)}},{key:"show",value:function(){this.layer&&this.layer.show&&this.layer.show()}},{key:"hide",value:function(){this.layer&&this.layer.hide&&this.layer.hide()}},{key:"remove",value:function(){console.log("remove is duplicate, please use clear instead.",this),this.clear()}},{key:"clear",value:function(){this.layer&&this.layer.clear&&this.layer.clear()}},{key:"destroy",value:function(){this.layer&&(this.layer.destroy&&this.layer.destroy(),this.layer=null)}}])&&c(t.prototype,e),r&&c(t,r),Object.defineProperty(t,"prototype",{writable:!1}),n}();return t.exports=r,t.exports});