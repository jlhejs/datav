// env=undefined => env=publish 
Cube("datav:/com/datavmap-2d-layer-flyingline/0.2.15/lib/BezierCurve.js",["datav:/npm/bcore/0.0.21/utils"],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var e=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),f=c("datav:/npm/bcore/0.0.21/utils"),g={outN:200},h=function(){function a(b){d(this,a),this.options=f.deepMerge(g,b)}return e(a,[{key:"data",value:function(a){if(!a||!Array.isArray(a)||2>a.length)return void console.log("\u6700\u5C11\u4E8C\u4E2A\u63A7\u5236\u70B9");this._data=a,this.ptsN=a.length;var b=this.path=[];return this.processing(),b}},{key:"processing",value:function(){for(var a,b=this.options,c=b.outN,d=this._data,e=this.path,f=0;f<c;f++)a=f/c,f===c-1&&(a=1),this.calculate(d,a)}},{key:"calculate",value:function(a,b){var c=this.path;if(2===a.length)c.push(this.percentCoords(a[0],a[1],b));else if(2<a.length){for(var e=[],f=[],d=0;d<a.length-1;d++)f=this.percentCoords(a[d],a[d+1],b),e.push(f);this.calculate(e,b)}else return}},{key:"ptsDistance",value:function(a,b){var c=Math.pow(a[0]-b[0],2),d=Math.pow(a[1]-b[1],2);return Math.pow(c+d,0.5)}},{key:"percentCoords",value:function(a,b,c){var d=a[0]+(b[0]-a[0])*c,e=a[1]+(b[1]-a[1])*c;return[d,e]}}]),a}();return a.exports=h,a.exports});;
Cube("datav:/com/datavmap-2d-layer-flyingline/0.2.15/FlyingLineCanvas.js",["datav:/npm/bcore/0.0.21/utils"],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var e=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),f=null;return a.exports=function(a){var b=c("datav:/npm/bcore/0.0.21/utils"),g=c("datav:/com/datavmap-2d-layer-flyingline/0.2.15/lib/BezierCurve.js"),h={getLat:function(a){return a.lat},getLng:function(a){return a.lng},ptsN:400,step:80,speed:1,height:2.5,style:{lineWidth:2,fillColor:"RGBA(0, 0, 0, 0.96)"}};return f||(f=function(){function c(a){d(this,c),this.options=b.deepMerge(h,a),this.init()}return e(c,[{key:"set",value:function(a,b,c){this.map=a,this.ctx=b,this.lineIndex=c}},{key:"init",value:function(){var a=this.options.ptsN=~~this.options.ptsN,b=this.beziercurve=new g({outN:a});this.reset()}},{key:"reset",value:function(){var a=this.options;this.step=~~a.step,this.ptsStart=0,this.pathLength=~~a.ptsN}},{key:"data",value:function(a){a&&this.processing(a)}},{key:"updateData",value:function(){var a=this._data,b=this.usingData=[];if(a){var c=this.options,d=~~c.step,e=~~c.speed;if(this.ptsStart<d)for(var f=0;f<this.ptsStart;f++)b.push(a[f]);else if(d<=this.ptsStart&&this.ptsStart<this.pathLength)for(var f=this.ptsStart-d;f<this.ptsStart;f++)b.push(a[f]);else if(this.ptsStart>=this.pathLength)for(var f=this.ptsStart-d;f<this.pathLength;f++)b.push(a[f]);this.ptsStart+=e}}},{key:"updatePath",value:function(){var a=this.usingData;2>a.length}},{key:"outData",value:function(){var a=this.usingData;return!a||2>a.length?[]:a}},{key:"processing",value:function(a){this._data=[];var b=this.beziercurve,c=this.latLngToContainerPoint(a),d=this.getControlPoint(c),e=[c[0],d,c[1]];b.options.outN=~~this.options.ptsN,this._data=b.data(e)}},{key:"getControlPoint",value:function(c){var d=this.options,e=d.height||1,f=c[0],g=c[1],h=f[0],i=g[0],j=f[1],k=g[1],l=Math.pow(Math.pow(h-i,2)+Math.pow(j-k,2),0.5);l/=e;var m=Math.pow((i-h)/(k-j),2),a=Math.pow((k-j)/(i-h),2),b=(h+i)/2+l/Math.pow(m+1,0.5),n=(j+k)/2-l/Math.pow(a+1,0.5);return[b,n]}},{key:"latLngToContainerPoint",value:function(b){if(b){var c=this.options,d=c.getLat,e=c.getLng,f=this.map,g=f.latLngToContainerPoint(new a.LatLng(d(b.from),e(b.from))),h=f.latLngToContainerPoint(new a.LatLng(d(b.to),e(b.to)));return[[g.x,g.y],[h.x,h.y]]}}},{key:"updateOptions",value:function(a){a&&(this.options=b.deepMerge(this.options,a))}},{key:"update",value:function(){this.updateData(),this.updatePath()}}]),c}())},a.exports});;
Cube("datav:/com/datavmap-2d-layer-flyingline/0.2.15/FlyingLinesCanvasLayer.js",["datav:/npm/chroma-js/1.3.3"],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"===typeof b||"function"===typeof b)?b:a}function f(a,b){if("function"!==typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=null;return a.exports=function(a){var j=c("datav:/npm/chroma-js/1.3.3"),b=a.datavUtils,i=a.BaseLayer,k=a.CanvasLayer,l=c("datav:/com/datavmap-2d-layer-flyingline/0.2.15/FlyingLineCanvas.js"),m={lineN:100,getLat:function(a){return a.lat},getLng:function(a){return a.lng},ptsN:400,step:80,speed:1,height:2.5,style:{strokeColor:function(b,c,d,e){var f=j(b).rgb(),g=parseInt(f[0]),h=parseInt(f[1]),i=parseInt(f[2]),k=j(c).rgb(),l=parseInt(k[0]),m=parseInt(k[1]),n=parseInt(k[2]),o=Math.pow(d,e);return"rgba("+~~((l-g)*d+g)+","+~~((m-h)*d+h)+","+~~((n-i)*d+i)+","+o+")"},fromColor:"rgba(255, 255, 255, 1.0)",toColor:"rgba(0, 0, 0, 1.0)",flareColor:"rgba(100, 227, 249, 1.0)",k:4,lineWidth:2,fillColor:"rgba(0, 0, 0, 0.96)",circleColor:"rgba(100, 227, 249, 1.0)",circleRadius:20,circleSpeed:0.5}};return h||(h=function(c){function h(a){d(this,h);var c=e(this,(h.__proto__||Object.getPrototypeOf(h)).call(this));return a=b.mergeOptions(m,a),c.options=b.mergeOptions(c.options,a),c.type="fill",c}return f(h,c),g(h,[{key:"addTo",value:function(a){a&&(this.map=a,a.on("move",this.move,this),this.initCanvas(),this.initLines(),this.loop(),this.circleList=[],this.drawCircleFlash())}},{key:"initCanvas",value:function(){var b=this.map,c=b.getSize(),d=this.canvasFlyingLine=a.DomUtil.create("canvas","leaflet-layer leaflet-zoom-hide");d.width=c.x,d.height=c.y,b.getPane("overlayPane").appendChild(d),this.ctx=d.getContext("2d");var e=this.canvasFlare=a.DomUtil.create("canvas","leaflet-layer leaflet-zoom-hide");e.width=c.x,e.height=c.y,b.getPane("overlayPane").appendChild(e),this.ctxFlare=e.getContext("2d");var f=this.canvasCircleFlash=a.DomUtil.create("canvas","leaflet-layer leaflet-zoom-hide");f.width=c.x,f.height=c.y,b.getPane("overlayPane").appendChild(f),this.ctxCircleFlash=f.getContext("2d"),this.resize()}},{key:"resize",value:function(){var b=this.map.getSize();this.canvasFlyingLine.width=b.x,this.canvasFlyingLine.height=b.y,this.canvasFlare.width=b.x,this.canvasFlare.height=b.y,this.canvasCircleFlash.width=b.x,this.canvasCircleFlash.height=b.y;var c=a.DomUtil.getPosition(this.map.getPanes().mapPane);c&&(a.DomUtil.setPosition(this.canvasFlyingLine,{x:-c.x,y:-c.y}),a.DomUtil.setPosition(this.canvasFlare,{x:-c.x,y:-c.y}),a.DomUtil.setPosition(this.canvasCircleFlash,{x:-c.x,y:-c.y}))}},{key:"move",value:function(){this.resize(),this.clean()}},{key:"clean",value:function(){var a,b,c=this.using,d=this.unusing;if(c){for(var e in c)a=c[e],b=a.lineIndex,a.reset(),d.push(a),delete c[b];this.circleList=[]}}},{key:"render",value:function(a){this.unusing.length&&a&&this.data(a)}},{key:"data",value:function(a){if(a)for(var b,c=this.using,d=this.unusing,e=0;e<a.length;e++)if(b=a[e],d.length&&b){var f=d.pop();f.data(b),f.od=b,this.initStartEvents(f),c[f.lineIndex]=f}}},{key:"initStartEvents",value:function(a){this.emit("start",{location:a.od.from,id:a.lineIndex})}},{key:"initEndEvents",value:function(a){this.emit("end",{location:a.od.to,id:a.lineIndex});var b={id:a.lineIndex,xy:a.usingData[a.usingData.length-1],r:5};this.circleList.push(b)}},{key:"drawCircleFlash",value:function(){if(this.circleList&&0<this.circleList.length){var a=this.ctxCircleFlash,b=a.canvas;a.clearRect(0,0,b.width,b.height);var e=this.options,f=e.style.circleRadius;if(0<f){var g=e.style.circleColor,h=e.style.circleSpeed;a.save();var k=a.globalCompositeOperation;a.globalCompositeOperation="destination-in",a.globalCompositeOperation=k;for(var l,d=0;d<this.circleList.length;d++)if(l=this.circleList[d],l.xy&&l.xy[0]&&l.xy[1]){var i=a.createRadialGradient(l.xy[0],l.xy[1],l.r/6,l.xy[0],l.xy[1],l.r),m=j(g).rgba(),c=m[3]||0.6;if(0.6>c||(l.r>f?c=0.1:l.r>f-1?c=0.2:l.r>f-2?c=0.3:l.r>f-3?c=0.4:l.r>f-4?c=0.5:l.r>f-5&&(c=0.6)),i.addColorStop(0,"rgba(0,0,0,0)"),i.addColorStop(1,this.prefixColor(g,c)),a.beginPath(),a.arc(l.xy[0],l.xy[1],l.r,0,2*Math.PI),a.closePath(),a.fillStyle=i,a.shadowOffsetX=0,a.shadowOffsetY=2,a.shadowBlur=5,a.shadowColor=this.prefixColor(g,0.5),a.fill(),l.r+=h||0.5,l.r>f){this.circleList.shift();continue}this.circleList[d]=l}}}this.drawCircleFlashId=window.requestAnimationFrame(this.drawCircleFlash.bind(this))}},{key:"initLines",value:function(){for(var a=this.options,b=a.lineN,c=this.map,d=this.ctx,e=this.using={},f=this.unusing=[],g=0;g<b;g++){var h=new l(this.map.L),i=new h({getLat:a.getLat,getLng:a.getLng,ptsN:a.ptsN,step:a.step,height:a.height,style:a.style});i.set(c,d,g),f.push(i)}}},{key:"cleanUsedPath",value:function(){var a,b,c=this.using,d=this.unusing;if(c)for(var e in c)a=c[e],b=a.lineIndex,a.ptsStart>=a.step+a.pathLength&&(a.reset(),this.initEndEvents(a),d.push(a),delete c[b])}},{key:"hide",value:function(){this.canvasFlyingLine&&this.canvasFlyingLine.style&&(this.canvasFlyingLine.style.opacity=0),this.canvasFlare&&this.canvasFlare.style&&(this.canvasFlare.style.opacity=0),this.canvasCircleFlash&&this.canvasCircleFlash.style&&(this.canvasCircleFlash.style.opacity=0)}},{key:"show",value:function(){this.canvasFlyingLine&&this.canvasFlyingLine.style&&(this.canvasFlyingLine.style.opacity=1),this.canvasFlare&&this.canvasFlare.style&&(this.canvasFlare.style.opacity=1),this.canvasCircleFlash&&this.canvasCircleFlash.style&&(this.canvasCircleFlash.style.opacity=1)}},{key:"loop",value:function(){this.cleanUsedPath(),this.update(),this.loopId=window.requestAnimationFrame(this.loop.bind(this))}},{key:"update",value:function(){var a=this.using;if(a){var b=this.ds=[];for(var c in a){var d=a[c];d.update(),b.push(d.outData())}this.draw(),this.drawFlare()}}},{key:"drawFlare",value:function(){var a=this.ds,b=this.ctxFlare,c=b.canvas,e=b.canvas.width,f=b.canvas.height,g=this.options,h=g.style.fillColor,i=g.style.flareWidth,k=g.style.flareColor,l=this.prefixColor(k,1),m=this.prefixColor(k,0.9),n=this.prefixColor(k,0.2),o=this.prefixColor(k,0.01);b.clearRect(0,0,c.width,c.height);for(var p=0;p<a.length;p++){var j=a[p],d=j.length,q=j[d-1];if(q){if(b.save(),b.translate(q[0],q[1]),2<=j.length){var r=j[d-2],s=Math.atan2(q[1]-r[1],q[0]-r[0]);b.rotate(s)}b.scale(3,1),b.beginPath(),b.arc(0,0,i,0,2*Math.PI),b.closePath();var t=b.createRadialGradient(0,0,0,0,0,i);t.addColorStop(0,l),t.addColorStop(0.5,m),t.addColorStop(0.8,n),t.addColorStop(1,o),b.fillStyle=t,b.fill(),b.restore()}}}},{key:"draw",value:function(){var a=this.ds,b=this.ctx,c=this.ctxFlare,e=b.canvas,f=b.canvas.width,g=b.canvas.height,h=this.options,l=h.style.fillColor,m=h.style.strokeColor,n=h.style.lineWidth,o=h.style.k,k=h.style.fromColor,q=h.style.toColor;b.clearRect(0,0,e.width,e.height);var r=b.globalCompositeOperation;b.globalCompositeOperation="destination-in",b.fillStyle=l,b.fillRect(0,0,f,g),b.globalCompositeOperation=r;for(var s,d=0;d<a.length;d++){s=a[d];for(var j=0;j<s.length-1;j++){var i=j/s.length,p=s[j],t=s[j+1];!p||!t||(b.beginPath(),b.lineWidth=n,b.strokeStyle=m(k,q,i,o),b.moveTo(p[0],p[1]),b.lineTo(t[0],t[1]),b.stroke())}}}},{key:"prefixColor",value:function(a,d){var e=j(a).rgb(),c=e[0]||255,f=e[1]||255,g=e[2]||255;return"rgba("+c+","+f+","+g+","+(d||1)+")"}},{key:"updateOptions",value:function(a){a&&(a=this.options=b.mergeOptions(this.options,a)),a=this.options;var c;this.circleList=[];var d=this.using;for(var e in d)c=d[e],c&&c.updateOptions&&c.updateOptions(a);var f=this.unusing;for(var g in f)c=f[g],c&&c.updateOptions&&c.updateOptions(a)}},{key:"remove",value:function(){window.cancelAnimationFrame(this.loopId),window.cancelAnimationFrame(this.drawCircleFlashId),this.map.getPanes().overlayPane.removeChild(this.canvasFlyingLine),this.map.getPanes().overlayPane.removeChild(this.canvasFlare),this.map.getPanes().overlayPane.removeChild(this.canvasCircleFlash),this.map.off("move",this.move,this),this.canvasFlyingLine=null,this.canvasFlare=null,this.canvasCircleFlash=null,this.using=null,this.unusing=null}}]),h}(k))},a.exports});;
Cube("datav:/com/datavmap-2d-layer-flyingline/0.2.15/data-pool",[],function(a){function b(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var c=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),d={maxN:10,outN:3},e=function(){function a(c){b(this,a),this.options=Object.assign(d,c||{}),this.data=[],this.dsIndex=0}return c(a,[{key:"addData",value:function(a){a&&[].push.apply(this.data,a)}},{key:"clean",value:function(){this.data=[],this.dsIndex=0,this.discardArray=[]}},{key:"getDataLength",value:function(){return this.data?this.data.length:0}},{key:"getAllData",value:function(){var a=this.data;return a?a:[]}},{key:"check",value:function(){var a=this.options,b=a.maxN,c=void 0;this.discardArray=[];var d=this.data;return d.length>b&&(c=d.length-b,this.discardArray=d.splice(0,c)),this.discardArray}},{key:"outDataClean",value:function(a){var b=this.data,c=a||this.options.outN;return b?b.splice(0,c):[]}},{key:"outData",value:function(a){var b=this.data,c=[],e=a||this.options.outN,f=b.length,g=this.dsIndex;if(b){if(f<=e)return c=b,c;if(g+e<=f){for(var h,d=g;d<e+g;d++)h=b[d],c.push(h);this.dsIndex+=e}else{for(var i,j=g+e-f,k=g;k<f;k++)i=b[k],c.push(i);for(var l,m=0;m<j;m++)l=b[m],c.push(l);this.dsIndex=j}return c}}}]),a}();return a.exports=e,a.exports});;
Cube("datav:/com/datavmap-2d-layer-flyingline/0.2.15",["datav:/npm/bcore/0.0.21/event"],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"===typeof b||"function"===typeof b)?b:a}function f(a,b){if("function"!==typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=c("datav:/npm/bcore/0.0.21/event"),i=c("datav:/com/datavmap-2d-layer-flyingline/0.2.15/FlyingLinesCanvasLayer.js"),j=c("datav:/com/datavmap-2d-layer-flyingline/0.2.15/data-pool"),k=void 0,l={},m=function(a){function b(a,c){d(this,b);var f=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return f.container="string"===typeof a?document.querySelector(a):a,f.apis=c.apis,f.map=null,f.config=c,f.config.visibility=!1,f.indexFlying=0,f.indexCount=0,f.dataPool=null,f}return f(b,a),g(b,[{key:"addTo",value:function(a){this._map=a,k=a.L.datavUtils,this.initCom(),this.loop()}},{key:"getOptions",value:function(){var a=this.config=k.mergeOptions(l,this.config),b={outSpeed:a.outSpeed,speed:a.speed,ptsN:a.ptsN,step:a.step,height:a.height,style:{fromColor:a.style.fromColor,toColor:a.style.toColor,flareColor:a.style.flareColor,lineWidth:a.style.lineWidth,flareWidth:a.style.flareWidth,k:a.style.k,circleColor:a.style.circleColor,circleRadius:a.style.circleRadius,circleSpeed:a.style.circleSpeed}};return b}},{key:"initCom",value:function(){this.options=this.getOptions();var a=new i(this._map.L);this.layer=new a(this.options),this.layer.addTo(this._map),this.layer.updateOptions(this.options),this.dataPool=new j({maxN:500,outN:3})}},{key:"updateOptions",value:function(a){this.config=k.mergeOptions(this.config,a),this.options=this.getOptions(),this.layer&&this.layer.updateOptions(this.options),this.config.visibility?this.show():this.hide()}},{key:"show",value:function(){this.config.visibility=!0,this.layer&&this.layer.show&&this.layer.show()}},{key:"hide",value:function(){this.config.visibility=!1,this.layer&&this.layer.hide&&this.layer.hide()}},{key:"remove",value:function(){this.layer.remove&&this.layer.remove(),window.cancelAnimationFrame(this.loopId),this.indexFlying=0,this.indexCount=0,this.dataPool.clean(),this.dataPool=null}},{key:"render",value:function(a){if(!a)return console.log("\u5730\u56FE\u7EC4\u4EF6Map2dCanvasFlyingLine\u672A\u6536\u5230\u6570\u636E...");var a=a.map(function(a){return{from:{lat:+a.from.lat||+a.from.split(",")[1],lng:+a.from.lng||+a.from.split(",")[0]},to:{lat:+a.to.lat||+a.to.split(",")[1],lng:+a.to.lng||+a.to.split(",")[0]}}});this.dataPool.clean(),this.dataPool.addData(a)}},{key:"loop",value:function(){if(this.dataPool&&this.dataPool.getDataLength()){var a=this.options,b=~~(0.95*a.ptsN/a.speed),c=this.dataPool.getDataLength(),d=b;if(d=5>c?b:20>c?6:3,this.indexFlying++,this.indexFlying%=d,0===this.indexFlying){var e=this.dataPool.outData(~~(0.5*a.outSpeed));this.layer&&this.layer.render(e)}}this.loopId=window.requestAnimationFrame(this.loop.bind(this))}}]),b}(h);return a.exports=m,a.exports});