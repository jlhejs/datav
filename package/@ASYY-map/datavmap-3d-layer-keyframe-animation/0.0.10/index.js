// env=undefined => env=publish 
Cube("datav:/com/datavmap-3d-layer-keyframe-animation/0.0.10/frag.js",[],function(a){return a.exports="\n#ifdef GL_ES\n  precision highp float;\n#endif\n\nuniform sampler2D uTexture;\nuniform float uOpacity;\nuniform vec2 uTextureSegments; //horizontal and verticle segments of a texture, as frames of animation graph\nuniform float uFrameCursor; //represent which is the current animation frame\nvarying float vStartFrame;\n\nvec2 scaleUv(vec2 pCoord, vec2 transformStep, vec2 uTextureSegments) {\n  float uSegmentUnit = 1.0 / uTextureSegments.x;\n  float vSegmentUnit = 1.0 / uTextureSegments.y;\n  return vec2(pCoord.x / uTextureSegments.x + uSegmentUnit * transformStep.x, pCoord.y / uTextureSegments.y + vSegmentUnit * transformStep.y);\n}\n\n//>>> calculate the current frame of the counter ------\nvec2 calculateCurrentFrame(float uFrameCursor) {\n  float uFrameCursorModed;\n  float segmentLimit = uTextureSegments.x * uTextureSegments.y;\n\n  if(uFrameCursor >= segmentLimit) {\n    uFrameCursorModed = mod(uFrameCursor, segmentLimit); \n  } else {\n    uFrameCursorModed = uFrameCursor;\n  }\n\n  float transformStepX = mod(uFrameCursorModed, uTextureSegments.x);\n  float transformStepY = floor(uFrameCursorModed / uTextureSegments.x);\n  //reverse texture again of Y axis, but not work yet\n  // float transformStepY = uTextureSegments.y - floor(uFrameCursorModed / uTextureSegments.x); \n\n  return vec2(transformStepX, transformStepY);\n}\n\nvoid main() {\n  float segmentLimit = uTextureSegments.x * uTextureSegments.y;\n  float frameOffset = floor(vStartFrame * segmentLimit); //make a int start frame offset\n\n  // vec2 currentFrame = calculateCurrentFrame(uFrameCursor + frameOffset);\n  float floorFrameCursor = floor(uFrameCursor); //adaptive speed\n  vec2 currentFrame = calculateCurrentFrame(floorFrameCursor + frameOffset);\n  // vec2 currentFrame = calculateCurrentFrame(floorFrameCursor);\n\n  vec2 scaledUvs = scaleUv(gl_PointCoord, currentFrame, uTextureSegments);\n\n  vec4 fragColor = texture2D(uTexture, scaledUvs);\n\n  // if (fragColor.w < 0.01) { //to enable depth test\n  //   discard;\n  // }\n\n  gl_FragColor = fragColor * uOpacity;\n}\n",a.exports});;
Cube("datav:/com/datavmap-3d-layer-keyframe-animation/0.0.10/vert.js",[],function(a){return a.exports="\n  uniform float uSize;\n\n  attribute float aStartFrame;\n  attribute float aOpacity;\n\n  // varying float vPointIndex;\n  varying float vStartFrame;\n\n  void main() {\n    vStartFrame = aStartFrame;\n\n    gl_PointSize = uSize;\n    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n  }\n",a.exports});;
Cube("datav:/com/datavmap-3d-layer-keyframe-animation/0.0.10/KeyframeAnimationLayer.js",["datav:/npm/eventemitter3/2.0.3","datav:/npm/safely-merge/1.0.1","datav:/npm/chroma-js/1.3.4"],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"===typeof b||"function"===typeof b)?b:a}function f(a,b){if("function"!==typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=c("datav:/npm/eventemitter3/2.0.3"),i=c("datav:/npm/safely-merge/1.0.1"),j=c("datav:/npm/chroma-js/1.3.4"),k=c("datav:/com/datavmap-3d-layer-keyframe-animation/0.0.10/vert.js"),l=c("datav:/com/datavmap-3d-layer-keyframe-animation/0.0.10/frag.js");return a.exports=function(a){var b=a.datavgl,c=b.THREE,j=a.glLayer||a,m=b.DataVModelTools.point2buffer,n=a.worldsize,o={};return function(a){function b(a){d(this,b);var c=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return a=i(o,a),c.options=i(c.options,a),c.animate=c.animate.bind(c),c.init(),c}return f(b,a),g(b,[{key:"init",value:function(){this.meshGroup=new c.Group,j.on("runAnimation",this.animate)}},{key:"setData",value:function(a){if(a&&0==a.length&&this.meshGroup&&this.disposeMesh(),a&&a.length){this.disposeMesh(),this.meshGroup=new c.Group;var b=m(a,{worldsize:n}),d=this.attributesDataWrapper(b);this.points=this.createPoints(d),this.meshGroup.add(this.points),this.meshGroup.visible=this.options.visibility,j.rootNode.add(this.meshGroup)}}},{key:"attributesDataWrapper",value:function(a){for(var b={positions:a.positions,pointsIndex:[],startFrame:[]},c=0;c<b.positions.length/3;c++)b.pointsIndex.push(c),b.startFrame.push(Math.random());return b}},{key:"createPoints",value:function(a){this.pointsGeometry=new c.BufferGeometry,this.pointsGeometry.addAttribute("position",new c.BufferAttribute(new Float32Array(a.positions),3)),this.pointsGeometry.addAttribute("aPointIndex",new c.BufferAttribute(new Float32Array(a.pointsIndex),1)),this.pointsGeometry.addAttribute("aStartFrame",new c.BufferAttribute(new Float32Array(a.startFrame),1)),this.pointsTexture=new c.TextureLoader().setCrossOrigin("*"),this.pointsTexture.flipY=!1,this.textureSegmentsX=this.options.textureSegmentsX,this.textureSegmentsY=this.options.textureSegmentsY,this.textureSegmentsLimit=this.textureSegmentsX*this.textureSegmentsY,this.pointsMaterial=new c.ShaderMaterial({uniforms:{uTexture:{value:this.pointsTexture.load(this.options.pointsTexture)},uTextureSegments:{value:new c.Vector2(this.textureSegmentsX,this.textureSegmentsY)},uSize:{value:this.options.size},uOpacity:{value:this.options.opacity},uFrameCursor:{value:-this.textureSegmentsLimit}},vertexShader:k,fragmentShader:l,side:c.DoubleSide,blending:c.AdditiveBlending,depthTest:!1,transparent:!0});var b=new c.Points(this.pointsGeometry,this.pointsMaterial);return b}},{key:"animate",value:function(){this.pointsMaterial&&(this.pointsMaterial.uniforms.uFrameCursor.value>=this.textureSegmentsLimit?this.pointsMaterial.uniforms.uFrameCursor.value=0:this.pointsMaterial.uniforms.uFrameCursor.value+=this.options.speed)}},{key:"disposeMesh",value:function(){this.meshGroup&&j.disposeNode(this.meshGroup),j.rootNode.remove(this.meshGroup),this.meshGroup=null}},{key:"updateOptions",value:function(a){this.options=i(this.options,a),this.pointsMaterial.uniforms.uTexture.value=this.pointsTexture.load(this.options.pointsTexture),this.textureSegmentsX=this.options.textureSegmentsX,this.textureSegmentsY=this.options.textureSegmentsY,this.textureSegmentsLimit=this.textureSegmentsX*this.textureSegmentsY,this.pointsMaterial.uniforms.uTextureSegments.value=new c.Vector2(this.textureSegmentsX,this.textureSegmentsY),this.pointsMaterial.uniforms.uSize.value=this.options.size,this.pointsMaterial.uniforms.uSize.value=this.options.size,this.pointsMaterial.uniforms.uOpacity.value=this.options.opacity,this.pointsMaterial.needsUpdate=!0,this.points.position.z=this.options.heightPosition,this.meshGroup.visible=this.options.visibility}},{key:"show",value:function(){this.options.visibility=!0,this.meshGroup&&(this.meshGroup.visible=!0)}},{key:"hide",value:function(){this.options.visibility=!1,this.meshGroup&&(this.meshGroup.visible=!1)}},{key:"remove",value:function(){j.off("runAnimation",this.animate),this.disposeMesh()}}]),b}(h)},a.exports});;
Cube("datav:/com/datavmap-3d-layer-keyframe-animation/0.0.10",["datav:/npm/eventemitter3/2.0.3","datav:/npm/safely-merge/1.0.1"],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"===typeof b||"function"===typeof b)?b:a}function f(a,b){if("function"!==typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=c("datav:/npm/eventemitter3/2.0.3"),i=c("datav:/npm/safely-merge/1.0.1"),j=c("datav:/com/datavmap-3d-layer-keyframe-animation/0.0.10/KeyframeAnimationLayer.js"),k={},l=function(a){function b(a,c){d(this,b);var f=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return f.container="string"===typeof a?document.querySelector(a):a,f.apis=c.apis,f.map=null,f._data=null,f.config=c,f}return f(b,a),g(b,[{key:"initLayer",value:function(){var a=this.getOptions(),b=j(this.map);this.layer=new b(a),this.render(this.data)}},{key:"init",value:function(){var a=this;this.resetID&&clearTimeout(this.resetID),this.resetID=setTimeout(function(){a.map.glLayer.loaded?(a.resetID&&clearTimeout(a.resetID),a.initLayer()):a.init()},100)}},{key:"addTo",value:function(a){var b=this;this.map=a,this.init(),this.endID=setTimeout(function(){b.resetID&&clearTimeout(b.resetID)},300000)}},{key:"getOptions",value:function(){return this.config=i(k,this.config),this.config}},{key:"show",value:function(){this.config.visibility=!0,this.layer&&this.layer.show&&this.layer.show()}},{key:"hide",value:function(){this.config.visibility=!1,this.layer&&this.layer.hide&&this.layer.hide()}},{key:"remove",value:function(){this.endID&&clearTimeout(this.endID),this.resetID&&clearTimeout(this.resetID),this.layer&&this.layer.remove&&this.layer.remove(),this.layer=null,this._data=null,this.data=null}},{key:"render",value:function(a){this.data=a,this.layer&&this.layer.setData(a)}},{key:"updateOptions",value:function(a){this.config=i(this.config,a),a=this.getOptions(),this.layer&&this.layer.updateOptions(a)}}]),b}(h);return a.exports=l,a.exports});