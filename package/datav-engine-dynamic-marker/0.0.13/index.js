// env=undefined => env=publish 
Cube("datav:/com/datav-engine-dynamic-marker/0.0.13/src/dynamicmarker",["datav:/npm/eventemitter3/3.0.0"],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"===typeof b||"function"===typeof b)?b:a}function f(a,b){if("function"!==typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=c("datav:/npm/eventemitter3/3.0.0");return a.exports=function(a,b){var c={},i=new a.TextureLoader;return i.setCrossOrigin("anonymous"),function(h){function j(a){d(this,j);var f=e(this,(j.__proto__||Object.getPrototypeOf(j)).call(this));return f.options=b.mergeOptions(c,a),f.init(),f.maps={},f}return f(j,h),g(j,[{key:"init",value:function(){var b=this.options.animate;this.totalAnimateTime=b.riseTime+b.waitTime+b.declineTime,this.markers=[],this.group=new a.Group,this.group.position.copy(this.options.offset)}},{key:"setData",value:function(c){var d=this,e=this.options,f=b.Chroma(e.style.color).gl();this.remove(),c.forEach(function(b){var c=b.projedPos,g=d.maps[b.imageUrl];g||(g=i.load(b.imageUrl),g.anisotropy=e.anisotropy,d.maps[b.imageUrl]=g);var h=new a.SpriteMaterial({map:g,transparent:!0,depthTest:!1,depthWrite:!0,opacity:e.style.opacity,color:new a.Color(f[0],f[1],f[2])}),j=new a.Sprite(h);j.userData.startTime=0.5*d.totalAnimateTime*Math.random(),j.position.set(c[0],c[1],c[2]),d.markers.push(j),d.group.add(j)})}},{key:"animate",value:function(a){var b=this,c=this.options,d=c.animate,e=d.riseTime,f=d.waitTime,g=d.declineTime,h=c.size,i=c.style.opacity;this.markers.forEach(function(c){var d=c.userData.startTime,j=Math.max(a-d,0)%b.totalAnimateTime,k=void 0;k=j<=e?j/e:j<=e+f?1:1-(j-e-f)/g,k*=k,c.material.opacity=i*k,c.scale.set(h.width*k,h.height*k,1)})}},{key:"updateOptions",value:function(c){var d=this;this.options=b.mergeOptions(this.options,c||{});var e=this.options.animate;this.group.position.copy(this.options.offset),this.totalAnimateTime=e.riseTime+e.waitTime+e.declineTime;var f=b.Chroma(this.options.style.color).gl();this.markers.forEach(function(b){b.material.color=new a.Color(f[0],f[1],f[2]),b.userData.startTime=0.5*d.totalAnimateTime*Math.random()})}},{key:"remove",value:function(){var a=this;this.markers.forEach(function(b){a.group.remove(b),b.material.dispose()}),Object.keys(this.maps).forEach(function(b){a.maps[b]&&a.maps[b].dispose()}),this.maps={},this.markers=[]}}]),j}(h)},a.exports});;
Cube("datav:/com/datav-engine-dynamic-marker/0.0.13/layer",["datav:/npm/eventemitter3/3.0.0"],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"===typeof b||"function"===typeof b)?b:a}function f(a,b){if("function"!==typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=c("datav:/npm/eventemitter3/3.0.0"),i=function(a){function b(){d(this,b);var a=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return a.preSceneName="main",a.usingSceneName="main",a}return f(b,a),g(b,[{key:"addTo",value:function(a){return a?void(this.viewer=a,this.Utils=a.Utils,this.controller=a.controller,this.scene=this.getAssignedScene(),this.viewer.on("projChanged",this.updatePostions.bind(this))):console.log("Layer needs viewer layer")}},{key:"getProjPos",value:function(a,b,c){return this.viewer&&this.viewer.Projection([a,b,c])}},{key:"updatePostions",value:function(){}},{key:"getAssignedScene",value:function(){var a=this.options;return a.isSceneGroup&&a.sceneName?a.sceneName?this.controller.getScene(a.sceneName)?this.controller.getScene(a.sceneName):this.controller.createScene(a.sceneName):void 0:this.controller.getScene("main")}},{key:"toggleScene",value:function(a,b,c){var d=this;this.controller.switchScene(a,b,c).then(function(){d.preSceneName=b,d.usingSceneName=c})}},{key:"updateOptions",value:function(){}}]),b}(h);return a.exports=i,a.exports});;
Cube("datav:/com/datav-engine-dynamic-marker/0.0.13",[],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"===typeof b||"function"===typeof b)?b:a}function f(a,b){if("function"!==typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=function a(b,c,d){null===b&&(b=Function.prototype);var e=Object.getOwnPropertyDescriptor(b,c);if(void 0===e){var f=Object.getPrototypeOf(b);return null===f?void 0:a(f,c,d)}if("value"in e)return e.value;var g=e.get;return void 0===g?void 0:g.call(d)},i=c("datav:/com/datav-engine-dynamic-marker/0.0.13/layer"),j=null,k=function(a){function b(a,c){d(this,b);var f=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return f.options=Object.assign({isSceneGroup:!1,sceneName:""},c||{}),f}return f(b,a),g(b,[{key:"addTo",value:function(a){h(b.prototype.__proto__||Object.getPrototypeOf(b.prototype),"addTo",this).call(this,a),j=a.three,this.animate=this.animate.bind(this),a.addListener("animationFrame",this.animate),this.init()}},{key:"init",value:function(){var a=c("datav:/com/datav-engine-dynamic-marker/0.0.13/src/dynamicmarker")(j,this.Utils);this.options.anisotropy=this.viewer.renderer.getMaxAnisotropy(),this.layer=new a(this.options),this.options.visible?this.show():this.hide(),this.scene.add(this.layer.group),this.clock=new j.Clock}},{key:"animate",value:function(){this.layer&&this.layer.animate(this.clock.getElapsedTime())}},{key:"show",value:function(){this.options.visible=!0,this.layer&&(this.layer.group.visible=!0)}},{key:"hide",value:function(){this.options.visible=!1,this.layer&&(this.layer.group.visible=!1)}},{key:"setData",value:function(a){a&&Array.isArray(a)&&this.layer&&(this.data=a,this.updatePostions())}},{key:"updatePostions",value:function(){var a=this;this.data&&(this.data.forEach(function(b){b.projedPos=a.getProjPos(b.pos.x,b.pos.y,b.pos.z)}),this.layer.setData(this.data))}},{key:"updateOptions",value:function(a){var b=this.Utils.deepClone(this.options);this.options=this.Utils.mergeOptions(this.options,a||{}),this.options.visible?this.show():this.hide(),this.layer&&(this.layer.updateOptions(this.options),!this.Utils.easyDiff(b.sceneName,a.sceneName)&&(this.scene=this.getAssignedScene(),this.toggleScene(this.layer.group,this.usingSceneName,a.sceneName)))}},{key:"remove",value:function(){this.viewer.removeListener(this.animate),this.layer&&(this.scene.remove(this.layer.group),this.layer.remove(),this.layer=null)}}]),b}(i);return a.exports=k,a.exports});