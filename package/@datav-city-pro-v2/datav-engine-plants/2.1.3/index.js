// env=undefined => env=publish 
Cube("datav:/com/@datav-city-pro-v2/datav-engine-plants/2.1.3/plant",[],function(t,e,i,o,n,a){function r(t){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function b(){return(b="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,i){var o=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=M(t)););return t}(t,e);if(o)return o=Object.getOwnPropertyDescriptor(o,e),o.get?o.get.call(arguments.length<3?t:i):o.value}).apply(this,arguments)}function w(t,e){return(w=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function B(i){var o=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(t){return!1}}();return function(){var t,e=M(i),e=(t=o?(t=M(this).constructor,Reflect.construct(e,arguments,t)):e.apply(this,arguments),this);if(t&&("object"===r(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}}function M(t){return(M=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function k(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function s(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function L(t,e,i){e&&s(t.prototype,e),i&&s(t,i),Object.defineProperty(t,"prototype",{writable:!1})}return t.exports=function(t){var h=t.VG,e=t.THREE,n=t.Utils,t=e.Vector3,o=e.Box3,i=e.Matrix4,u=e.Group,d=e.InstancedMesh,G=new t,_=new i,p=0,a={headers:{"accept-encoding":"deflate,gzip"}},s=(L(r,[{key:"createBatchedGroup",value:function(t){this.asset&&0<this.count&&(this.batchedData.length=16*this.count,this.batchedGroup=y(this.asset,new Float32Array(this.batchedData),this.fAttr0,this.count,t))}},{key:"reset",value:function(){this.batchedGroup&&(g(this.batchedGroup),this.batchedGroup=null),this.count=0}}]),r);function r(){k(this,r),this.asset=null,this.batchedGroup=null,this.batchedData=[],this.fAttr0=null,this.count=0}L(c,[{key:"group",get:function(){return this.dynamicBatchedGroup.batchedGroup},set:function(t){this.dynamicBatchedGroup.batchedGroup=t}},{key:"asset",get:function(){return this.dynamicBatchedGroup.asset},set:function(t){this.dynamicBatchedGroup.asset=t}},{key:"cullingResult",get:function(){return this._cullingResult},set:function(t){this._preCullingResult=this._cullingResult,this._cullingResult=t}},{key:"preCullingResult",get:function(){return this._preCullingResult}}]);var f=c;function c(t,e,i){k(this,c),this.code=t,this.state=0,this.url=e,this.modelUrl="",this.level=i,this.fAttr0=null,this.positions=null,this.count=0,this._cullingResult=0,this._preCullingResult=0,this.boundingVolume=new o,this.dynamicBatchedGroup=null,this.children=[]}function l(t,e){e&&e(t);var i=t.children;if(Array.isArray(i))for(var o=0,n=i.length;o<n;o++)l(i[o],e)}function y(t,e,i,o,n){if(!(o<=0)){for(var a=new u,r=(a.name=n,t.children.length),s=0;s<r;s++){var c=t.children[s],l=c.material,c=new d(c.geometry,l,o);!1===l.transparent&&(c.customGBufferMaterial=h.getGBufferMaterial(l)),c.instanceMatrix.array=e,c.name=n+"_"+s,a.add(c)}return a.position.fromArray(i),a.frustumCulled=!1,a}}function g(t){if(t){t.parent&&t.parent.remove(t);for(var e=t.children,i=e.length,o=0;o<i;o++){var n=e[o];n.customGBufferMaterial&&n.customGBufferMaterial.dispose()}}}e=h.CityBaseLayer,t=m;if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&w(t,e);var v=B(m);function m(t){var e;return k(this,m),(e=v.call(this,"PlantLayer")).options=Object.assign({isSceneGroup:!1,sceneId:["scene1"]},t||{}),e.needsAutoUpdate=!0,e}return L(m,[{key:"envMap",set:function(t){this._envMap=t,this.updateEnvMap()}},{key:"envMapIntensity",set:function(t){var e=this.options.options.general;this._envMapIntensity=t*e.light.envMapIntensityFactor,this.updateEnvMap()}},{key:"initialize",value:function(){this._stack=[],this._loadTiles=[],this._selectedTiles=[],this._root=new f("","",0),this._root.dynamicBatchedGroup=new s,this._modelMatrix=new i,this._fileCache=new Map,this._envMapIntensity=1,this._lodDistGap=this.options.options.model.lodDistGap,this.dynamicBatchedGroupL4=new s,this.dynamicBatchedGroupL5=new s,this.onViewVaried=this.onViewVaried.bind(this),this.clearNode.bind(this),this.viewChanged=!0,this.forceUpdate=!0}},{key:"addTo",value:function(t){b(M(m.prototype),"addTo",this).call(this,t);t=this.viewer.controls;t&&t.on("ViewVaried",this.onViewVaried)}},{key:"setData",value:function(t){var e=this,i=(this.clear(),this.viewer.surface),o=this._root.children,n=this._root.boundingVolume;o.length=0,n.makeEmpty(),i.ellipsoid.geodeticCoordToVector3(t.position,"degree",G),this._modelMatrix.setPosition(G),this._maxLevel=t.maxLevel,function t(e,i,o,n){if(i)for(var a=0,r=i.length;a<r;a++){var s,c=i[a],l=new f(c.code,c.url,c.level),c=(n&&n(l),c.geoBoundingBox),h=l.boundingVolume,u=l.children;6===c.length&&(s=[c[0],c[1],c[2]],o.geodeticCoordToVector3(s,"degree",G),h.expandByPoint(G),s[2]=c[5],o.geodeticCoordToVector3(s,"degree",G),h.expandByPoint(G),s=[c[3],c[1],c[2]],o.geodeticCoordToVector3(s,"degree",G),h.expandByPoint(G),s[2]=c[5],o.geodeticCoordToVector3(s,"degree",G),h.expandByPoint(G),s=[c[3],c[4],c[2]],o.geodeticCoordToVector3(s,"degree",G),h.expandByPoint(G),s[2]=c[5],o.geodeticCoordToVector3(s,"degree",G),h.expandByPoint(G),s=[c[0],c[4],c[2]],o.geodeticCoordToVector3(s,"degree",G),h.expandByPoint(G),s[2]=c[5],o.geodeticCoordToVector3(s,"degree",G),h.expandByPoint(G)),e.children.push(l),t(l,i[a].children,o,n);for(var d=0,p=u.length;d<p;d++)l.boundingVolume.union(u[d].boundingVolume)}}(this._root,t.nodes,i.ellipsoid,function(t){4===t.level?t.dynamicBatchedGroup=e.dynamicBatchedGroupL4:5===t.level?t.dynamicBatchedGroup=e.dynamicBatchedGroupL5:t.dynamicBatchedGroup=new s});for(var a=0,r=o.length;a<r;a++)n.union(o[a].boundingVolume);this.resolve(),this.emit("rendered")}},{key:"dataErrorHandler",value:function(){this.needsWait&&(this.needsWait=!1),this.emit("rendered")}},{key:"addToLoadList",value:function(t){this._loadTiles.push(t)}},{key:"addToSelectedList",value:function(t){this._selectedTiles.push(t)}},{key:"getModelInfo",value:function(t){var e,i;t&&(e=this.options.options.model.plant,i=Math.max(Math.min(parseInt(t.level-1,10),e.length-1),0),t.modelUrl=e[i].url,t.modelScale=e[i].scale)}},{key:"fetchData",value:function(m){var b=this;m.url&&fetch(m.url,a).then(function(t){return t.arrayBuffer()}).then(function(t){for(var t=b.getParsedData(t),e=t.fAttr0,t=t.positions,i=!(m.level<=3)&&m.dynamicBatchedGroup.fAttr0||e,i=(m.dynamicBatchedGroup.fAttr0=i,m.state=2,b.getModelInfo(m),m),o=e,n=t,a=m.modelScale,r=m.dynamicBatchedGroup.fAttr0,s=b.viewer.surface.ellipsoid,c=n.length/8,l=new Float32Array(16*c),h=_.elements,u=0;u<c;u++){var d=8*u,p=n[5+d]+o[0],f=n[6+d]+o[1],y=n[7+d]+o[2],g=n[1+d]*a.x,v=n[2+d]*a.x,d=n[3+d]*a.x;G.set(p,f,y),s.eastUpSouthToFixedFrame(G,_),h[0]*=g,h[4]*=v,h[8]*=d,h[12]-=r[0],h[1]*=g,h[5]*=v,h[9]*=d,h[13]-=r[1],h[2]*=g,h[6]*=v,h[10]*=d,h[14]-=r[2],h[3]*=g,h[7]*=v,h[11]*=d,h[15]=1,_.toArray(l,16*u)}i.count=c,i.fAttr0=o,i.positions=n,i.instanceMatrixData=l})}},{key:"fetchModelAsset",value:function(e){e.asset?e.state=3:this.fetchModel(e.modelUrl).then(function(t){e.asset=t,e.state=3})}},{key:"createStaticBatchedGroup",value:function(t){t.group||(t.group=y(t.asset,t.instanceMatrixData,t.fAttr0,t.count,t.code),t.dynamicBatchedGroup.count=t.count,this.setEnvMap(t.group),this.setShadowAndLight(t.group,t.level))}},{key:"createDynamicBatchedGroup",value:function(t){var e=t.fAttr0,i=t.positions,o=t.count,n=t.instanceMatrixData,a=this.viewer.surface.Culling.frustum,r=G,s=t.dynamicBatchedGroup,c=s.batchedData,l=s.count;if(2===t.cullingResult)for(var h=0;h<o;h++){var u=16*h,d=16*l;c[d]=n[u],c[1+d]=n[1+u],c[2+d]=n[2+u],c[3+d]=n[3+u],c[4+d]=n[4+u],c[5+d]=n[5+u],c[6+d]=n[6+u],c[7+d]=n[7+u],c[8+d]=n[8+u],c[9+d]=n[9+u],c[10+d]=n[10+u],c[11+d]=n[11+u],c[12+d]=n[12+u],c[13+d]=n[13+u],c[14+d]=n[14+u],c[15+d]=n[15+u],l++}else for(var p=0;p<o;p++){var f=8*p,y=i[5+f]+e[0],g=i[6+f]+e[1],f=i[7+f]+e[2];r.set(y,g,f),a.containsPoint(r)&&(c[y=16*l]=n[g=16*p],c[1+y]=n[1+g],c[2+y]=n[2+g],c[3+y]=n[3+g],c[4+y]=n[4+g],c[5+y]=n[5+g],c[6+y]=n[6+g],c[7+y]=n[7+g],c[8+y]=n[8+g],c[9+y]=n[9+g],c[10+y]=n[10+g],c[11+y]=n[11+g],c[12+y]=n[12+g],c[13+y]=n[13+g],c[14+y]=n[14+g],c[15+y]=n[15+g],l++)}s.count=l}},{key:"onViewVaried",value:function(){this.viewChanged=!0}},{key:"autoUpdate",value:function(){this.animate()}},{key:"animate",value:function(){if(this.emit("animate"),p++,p%=6,0<this._root.children.length&&0===p){var t,e=this.viewer.engine.camera,i=this.viewer.surface.Culling,o=!1;if(this.forceUpdate||this.viewChanged){for(l=this._selectedTiles.length,h=0;h<l;h++)(t=this._selectedTiles[h]).group&&t.group.parent&&t.group.parent.remove(t.group);if(this._stack.length=0,this._loadTiles.length=0,this._selectedTiles.length=0,this.dynamicBatchedGroupL4.reset(),this.dynamicBatchedGroupL5.reset(),i.computeVisibility(this._root.boundingVolume)){var n=[],a=0;for(l=this._root.children.length,h=0;h<l;h++)(t=this._root.children[h]).cullingResult=this.viewChanged?i.computeVisibility(t.boundingVolume):t.cullingResult,t.cullingResult&&(3===t.state?this._stack.push(t):this.addToLoadList(t));for(t=this._stack.pop();t;t=this._stack.pop()){var r=(this._maxLevel-t.level)*this._lodDistGap;if(0===t.children.length||t.boundingVolume.distanceToPoint(e.position)>=r)this.addToSelectedList(t);else{for(var s=t.children,c=!0,l=s.length,a=0,h=0;h<l;h++){var u=s[h];u.cullingResult=i.computeVisibility(u.boundingVolume),u.cullingResult&&(u.state<3?(c=!1,this.addToLoadList(u)):n[a++]=u)}if(c)for(h=0;h<a;h++)this._stack.push(n[h]);else this.addToSelectedList(t)}}}o=!0}for(this.forceUpdate=!1,this.viewChanged=!1,l=this._loadTiles.length,h=0;h<l;h++)0===(t=this._loadTiles[h]).state?(t.state=1,this.fetchData(t)):2===t.state?this.fetchModelAsset(t):3===t.state&&(this.forceUpdate=!0);if(o){for(l=this._selectedTiles.length,h=0;h<l;h++)(t=this._selectedTiles[h]).level<=3?(this.createStaticBatchedGroup(t),t.group&&this.add(t.group)):this.createDynamicBatchedGroup(t);this.dynamicBatchedGroupL4.createBatchedGroup("batchdGroupL4"),this.dynamicBatchedGroupL5.createBatchedGroup("batchdGroupL5"),this.dynamicBatchedGroupL4.batchedGroup&&(this.setEnvMap(this.dynamicBatchedGroupL4.batchedGroup),this.setShadowAndLight(this.dynamicBatchedGroupL4.batchedGroup,4),this.add(this.dynamicBatchedGroupL4.batchedGroup)),this.dynamicBatchedGroupL5.batchedGroup&&(this.setEnvMap(this.dynamicBatchedGroupL5.batchedGroup),this.setShadowAndLight(this.dynamicBatchedGroupL5.batchedGroup,5),this.add(this.dynamicBatchedGroupL5.batchedGroup))}}}},{key:"setEnvMap",value:function(t){if(t)for(var e=t.children.length,i=0;i<e;i++){var o=t.children[i];!0===o.material.transparent&&(o.material.envMap!==this._envMap&&(o.material.envMap=this._envMap,o.material.needsUpdate=!0),o.material.envMapIntensity=this._envMapIntensity)}}},{key:"setShadowAndLight",value:function(t,e){if(t)for(var i=this.options.options.general.shadow,e=e>=i.lodThreshold,o=e&&i.castShadow,n=e&&i.receiveShadow,a=t.children.length,r=0;r<a;r++){var s=t.children[r];s.castShadow=o,s.receiveShadow=n}}},{key:"updateEnvMap",value:function(){var e=this;l(this._root,function(t){return e.setEnvMap(t.group)})}},{key:"updateShadowAndLight",value:function(){var e=this;l(this._root,function(t){return e.setShadowAndLight(t.group,t.level)})}},{key:"updateOptions",value:function(t){var h=this,e=n.deepClone(this.options),i=JSON.stringify(e.options.model.plant),t=(this.options=n.mergeOptions(this.options,t||{}),this.options.options.model),o=JSON.stringify(t.plant);this._lodDistGap=t.lodDistGap,i!==o?(l(this._root,function(t){if(h.clearNode(t),2===t.state){var e=t.modelScale;if(h.getModelInfo(t),e.x!==t.modelScale.x||e.y!==t.modelScale.y||e.z!==t.modelScale.z)for(var i=t,t=t.modelScale,o=t.x/e.x,n=t.y/e.y,a=t.z/e.z,r=i.count,s=i.instanceMatrixData,c=0;c<r;c++){var l=16*c;s[l]*=o,s[4+l]*=n,s[8+l]*=a,s[1+l]*=o,s[5+l]*=n,s[9+l]*=a,s[2+l]*=o,s[6+l]*=n,s[10+l]*=a,s[3+l]*=o,s[7+l]*=n,s[11+l]*=a}}}),this.forceUpdate=!0):this.updateShadowAndLight(),n.easyDiff(e.sceneId.length,this.options.sceneId.length)&&n.deepDiff(e.sceneId,this.options.sceneId)||this.updateSceneId()}},{key:"clearNode",value:function(t){t&&(g(t.group),t.state=Math.min(t.state,2),t.modelUrl="",t.asset=null,t.group=null)}},{key:"clear",value:function(){l(this._root,this.clearNode),this.forceUpdate=!0}},{key:"destroy",value:function(){this.clear(),this.disposeFileCache(),this._root.children.length=0,this._root.boundingVolume.makeEmpty(),this.needsAutoUpdate=!1;var t=this.viewer.controls;t&&t.off("ViewVaried",this.onViewVaried)}}]),m},t.exports});;
Cube("datav:/com/@datav-city-pro-v2/datav-engine-plants/2.1.3",["datav:/npm/eventemitter3/3.0.0"],function(e,t,r,n,o,i){function a(e){return(a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function s(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function u(r){var n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=c(r),t=(e=n?(e=c(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),this);if(e&&("object"===a(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");if(void 0!==t)return t;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}}function c(e){return(c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var y=r("datav:/npm/eventemitter3/3.0.0"),f=r("datav:/com/@datav-city-pro-v2/datav-engine-plants/2.1.3/plant"),r=function(){var e=o,t=y;if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&l(e,t);var r,n=u(o);function o(e,t){var r;if(this instanceof o)return(r=n.call(this)).options=t,r.visible=!0,r.isBasicFeature=!0,r.comId="",r.type="Plant",r;throw new TypeError("Cannot call a class as a function")}return e=o,(t=[{key:"addTo",value:function(e,t){return this.cityproCore=e,this.comId=t,this.initLayer()}},{key:"setEnvMap",value:function(e){this.layer&&(this.layer.envMapIntensity=e.properties,this.layer.envMap=e.value)}},{key:"initLayer",value:function(){var e=this,t=f(this.cityproCore),t=(this.layer=new t(this.options),this.cityproCore.viewer),t=(this.visible?this.layer.show():this.layer.hide(),t.addLayer(this.comId,this.layer));return this.layer.on("rendered",function(){e.emit("rendered","植被渲染完成")}),t}},{key:"setData",value:function(e){var t=this;this.layer&&e&&(e.url?""!==e.url&&(this.layer.hide(),fetch(e.url).then(function(e){return e.json()}).then(function(e){t.layer&&(t.visible?t.layer.show():t.layer.hide(),t.layer.setData(e))}).catch(function(){t.errorRender()})):this.layer&&(this.visible?this.layer.show():this.layer.hide(),this.layer.setData(e)))}},{key:"errorRender",value:function(){console.log("植被点位L2组件数据出错"),this.layer&&this.layer.dataErrorHandler()}},{key:"updateOptions",value:function(e){this.layer&&this.layer.updateOptions(e)}},{key:"show",value:function(){this.visible=!0,this.layer&&this.layer.show()}},{key:"hide",value:function(){this.visible=!1,this.layer&&this.layer.hide()}},{key:"destroy",value:function(){this.layer&&(this.layer.destroy&&this.layer.destroy(),this.layer=null)}}])&&s(e.prototype,t),r&&s(e,r),Object.defineProperty(e,"prototype",{writable:!1}),o}();return e.exports=r,e.exports});