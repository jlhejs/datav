// env=undefined => env=publish 
Cube("datav:/com/datavmap-3d-layer-water/0.2.11/water-material.js",[],function(a){return a.exports=function(a){a.ShaderLib.water={uniforms:a.UniformsUtils.merge([a.UniformsLib.fog,{normalSampler:{type:"t",value:null},mirrorSampler:{type:"t",value:null},alpha:{type:"f",value:1},time:{type:"f",value:0},distortionScale:{type:"f",value:20},noiseScale:{type:"f",value:1},textureMatrix:{type:"m4",value:new a.Matrix4},sunColor:{type:"c",value:new a.Color(8355711)},sunDirection:{type:"v3",value:new a.Vector3(0.70707,0.70707,0)},eye:{type:"v3",value:new a.Vector3(0,0,0)},waterColor:{type:"c",value:new a.Color(5592405)},intensity:{value:1}}]),vertexShader:"uniform mat4 textureMatrix;\nuniform float time;\nvarying vec4 mirrorCoord;\nvarying vec3 worldPosition;\nvarying vec3 modelPosition;\nvarying vec3 surfaceX;\nvarying vec3 surfaceY;\nvarying vec3 surfaceZ;\nvoid main()\n{\n  mirrorCoord = modelMatrix * vec4(position, 1.0);\n  worldPosition = mirrorCoord.xyz;\n  modelPosition = position;\n  surfaceX = vec3( modelMatrix[0][0], modelMatrix[0][1], modelMatrix[0][2]);\n  surfaceY = vec3( modelMatrix[1][0], modelMatrix[1][1], modelMatrix[1][2]);\n  surfaceZ = vec3( modelMatrix[2][0], modelMatrix[2][1], modelMatrix[2][2]);\n  mirrorCoord = textureMatrix * mirrorCoord;\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}",fragmentShader:["uniform sampler2D mirrorSampler;","uniform float alpha;","uniform float time;","uniform float distortionScale;","uniform float noiseScale;","uniform sampler2D normalSampler;","uniform vec3 sunColor;","uniform vec3 sunDirection;","uniform vec3 eye;","uniform vec3 waterColor;","uniform float intensity;","varying vec4 mirrorCoord;","varying vec3 worldPosition;","varying vec3 modelPosition;","varying vec3 surfaceX;","varying vec3 surfaceY;","varying vec3 surfaceZ;","void sunLight(const vec3 surfaceNormal, const vec3 eyeDirection, in float shiny, in float spec, in float diffuse, inout vec3 diffuseColor, inout vec3 specularColor)","{","  vec3 reflection = normalize(reflect(-sunDirection, surfaceNormal));","  float direction = max(0.0, dot(eyeDirection, reflection));","  specularColor += pow(direction, shiny) * sunColor * spec;","  diffuseColor += max(dot(sunDirection, surfaceNormal), 0.0) * sunColor * diffuse;","}","vec3 getNoise(in vec2 uv)","{","  vec2 uv0 = uv / (103.0 * noiseScale) + vec2(time / 17.0, time / 29.0);","  vec2 uv1 = uv / (107.0 * noiseScale) - vec2(time / -19.0, time / 31.0);","  vec2 uv2 = uv / (vec2(8907.0, 9803.0) * noiseScale) + vec2(time / 101.0, time /   97.0);","  vec2 uv3 = uv / (vec2(1091.0, 1027.0) * noiseScale) - vec2(time / 109.0, time / -113.0);","  vec4 noise = texture2D(normalSampler, uv0) +","    texture2D(normalSampler, uv1) +","    texture2D(normalSampler, uv2) +","    texture2D(normalSampler, uv3);","  return noise.xyz * 0.5 - 1.0;","}",a.ShaderChunk.common,a.ShaderChunk.fog_pars_fragment,"void main()","{","  vec3 worldToEye = eye - worldPosition;","  vec3 eyeDirection = normalize(worldToEye);","  vec3 noise = getNoise(modelPosition.xy * 1.0);","  vec3 distordCoord = noise.x * surfaceX + noise.y * surfaceY;","  vec3 distordNormal = distordCoord + surfaceZ;","  if(dot(eyeDirection, surfaceZ) < 0.0)","    distordNormal = distordNormal * -1.0;","  vec3 diffuseLight = vec3(0.0);","  vec3 specularLight = vec3(0.0);","  sunLight(distordNormal, eyeDirection, 100.0, 2.0, 0.5, diffuseLight, specularLight);","  float distance = length(worldToEye);","  vec2 distortion = distordCoord.xy * distortionScale * sqrt(distance) * 0.07;","  vec3 mirrorDistord = mirrorCoord.xyz + vec3(distortion.x, distortion.y, 1.0);","  vec3 reflectionSample = texture2DProj(mirrorSampler, mirrorDistord).xyz;","  float theta = max(dot(eyeDirection, distordNormal), 0.0);","  float reflectance = 0.3 + (1.0 - 0.3) * pow((1.0 - theta), 3.0);","  vec3 scatter = max(0.0, dot(distordNormal, eyeDirection)) * waterColor;"," vec3 albedo = mix(sunColor * diffuseLight * 0.3 + scatter, (vec3(0.1) + reflectionSample * 0.9 + reflectionSample * specularLight), reflectance);"," vec3 outgoingLight = albedo;",a.ShaderChunk.fog_fragment," float value = max(0.05,outgoingLight.r * 0.299 + outgoingLight.g * 0.587 + outgoingLight.b * 0.114);"," value = mod(value,0.2);"," gl_FragColor = vec4(waterColor * value * intensity, alpha );","}"].join("\n")},a.Water=function(b,c,d,e){function f(a,b){return void 0===a?b:a}a.Object3D.call(this),this.name="water_"+this.id,e=e||{},this.matrixNeedsUpdate=!0;var g=f(e.textureWidth,512),h=f(e.textureHeight,512);this.clipBias=f(e.clipBias,-1e-4),this.alpha=f(e.alpha,1),this.time=f(e.time,0),this.normalSampler=f(e.waterNormals,null),this.sunDirection=f(e.sunDirection,new a.Vector3(0.70707,0.70707,0)),this.sunColor=new a.Color(f(e.sunColor,16777215)),this.waterColor=new a.Color(f(e.waterColor,8355711)),this.eye=f(e.eye,new a.Vector3(0,0,0)),this.distortionScale=f(e.distortionScale,20),this.noiseScale=f(e.noiseScale,1),this.side=f(e.side,a.FrontSide),this.fog=f(e.fog,!1),this.intensity=f(e.intensity,1),this.renderer=b,this.scene=d,this.mirrorPlane=new a.Plane,this.normal=new a.Vector3(0,0,1),this.cameraWorldPosition=new a.Vector3,this.rotationMatrix=new a.Matrix4,this.lookAtPosition=new a.Vector3(0,0,-1),this.clipPlane=new a.Vector4,c instanceof a.PerspectiveCamera?this.camera=c:(this.camera=new a.PerspectiveCamera,console.log(this.name+": camera is not a Perspective Camera!")),this.textureMatrix=new a.Matrix4,this.mirrorCamera=this.camera.clone(),this.texture=new a.WebGLRenderTarget(g,h),this.tempTexture=new a.WebGLRenderTarget(g,h);var i=a.ShaderLib.water,j=a.UniformsUtils.clone(i.uniforms);this.material=new a.ShaderMaterial({fragmentShader:i.fragmentShader,vertexShader:i.vertexShader,uniforms:j,transparent:!0,side:this.side,fog:this.fog}),this.mesh=new a.Object3D,this.material.uniforms.mirrorSampler.value=this.texture.texture,this.material.uniforms.textureMatrix.value=this.textureMatrix,this.material.uniforms.alpha.value=this.alpha,this.material.uniforms.time.value=this.time,this.material.uniforms.normalSampler.value=this.normalSampler,this.material.uniforms.sunColor.value=this.sunColor,this.material.uniforms.waterColor.value=this.waterColor,this.material.uniforms.sunDirection.value=this.sunDirection,this.material.uniforms.distortionScale.value=this.distortionScale,this.material.uniforms.noiseScale.value=this.noiseScale,this.material.uniforms.intensity.value=this.intensity,this.material.uniforms.eye.value=this.eye,a.Math.isPowerOfTwo(g)&&a.Math.isPowerOfTwo(h)||(this.texture.generateMipmaps=!1,this.tempTexture.generateMipmaps=!1)},a.Water.prototype=Object.create(a.Object3D.prototype),a.Water.prototype.renderWithMirror=function(a){this.updateTextureMatrix(),this.matrixNeedsUpdate=!1;var b=a.camera;a.camera=this.mirrorCamera,a.render(!0),this.render(),this.matrixNeedsUpdate=!0,a.camera=b,a.updateTextureMatrix()},a.Water.prototype.updateTextureMatrix=function(){function b(a){return a?0>a?-1:1:0}void 0!==this.parent&&(this.mesh=this.parent),this.updateMatrixWorld(),this.camera.updateMatrixWorld(),this.cameraWorldPosition.setFromMatrixPosition(this.camera.matrixWorld),this.rotationMatrix.extractRotation(this.matrixWorld),this.normal=new a.Vector3(0,0,1).applyEuler(this.mesh.rotation);var d=this.camera.position.clone().sub(this.mesh.position);if(0>this.normal.dot(d)){var e=new a.Vector3(0,0,1).applyEuler(this.mesh.rotation);this.normal.reflect(e)}var f=this.mesh.position.clone().sub(this.cameraWorldPosition);f.reflect(this.normal).negate(),f.add(this.mesh.position),this.rotationMatrix.extractRotation(this.camera.matrixWorld),this.lookAtPosition.set(0,0,-1),this.lookAtPosition.applyMatrix4(this.rotationMatrix),this.lookAtPosition.add(this.cameraWorldPosition);var g=this.mesh.position.clone().sub(this.lookAtPosition);g.reflect(this.normal).negate(),g.add(this.mesh.position),this.up.set(0,-1,0),this.up.applyMatrix4(this.rotationMatrix),this.up.reflect(this.normal).negate(),this.mirrorCamera.position.copy(f),this.mirrorCamera.up=this.up,this.mirrorCamera.lookAt(g),this.mirrorCamera.aspect=this.camera.aspect,this.mirrorCamera.updateProjectionMatrix(),this.mirrorCamera.updateMatrixWorld(),this.mirrorCamera.matrixWorldInverse.getInverse(this.mirrorCamera.matrixWorld),this.textureMatrix.set(0.5,0,0,0.5,0,0.5,0,0.5,0,0,0.5,0.5,0,0,0,1),this.textureMatrix.multiply(this.mirrorCamera.projectionMatrix),this.textureMatrix.multiply(this.mirrorCamera.matrixWorldInverse),this.mirrorPlane.setFromNormalAndCoplanarPoint(this.normal,this.mesh.position),this.mirrorPlane.applyMatrix4(this.mirrorCamera.matrixWorldInverse),this.clipPlane.set(this.mirrorPlane.normal.x,this.mirrorPlane.normal.y,this.mirrorPlane.normal.z,this.mirrorPlane.constant);var h=new a.Vector4,i=this.mirrorCamera.projectionMatrix;h.x=(b(this.clipPlane.x)+i.elements[8])/i.elements[0],h.y=(b(this.clipPlane.y)+i.elements[9])/i.elements[5],h.z=-1,h.w=(1+i.elements[10])/i.elements[14];var j=new a.Vector4;j=this.clipPlane.multiplyScalar(2/this.clipPlane.dot(h)),i.elements[2]=j.x,i.elements[6]=j.y,i.elements[10]=j.z+1-this.clipBias,i.elements[14]=j.w;var c=new a.Vector3;c.setFromMatrixPosition(this.camera.matrixWorld),this.eye=c,this.material.uniforms.eye.value=this.eye},a.Water.prototype.render=function(b){if(this.matrixNeedsUpdate&&this.updateTextureMatrix(),this.matrixNeedsUpdate=!0,void 0!==this.scene&&this.scene instanceof a.Scene){this.material.visible=!1;var c=void 0!==b&&b?this.tempTexture:this.texture;this.renderer.render(this.scene,this.mirrorCamera,c,!0),this.material.visible=!0,this.material.uniforms.mirrorSampler.value=c.texture}}},a.exports});;
Cube("datav:/com/datavmap-3d-layer-water/0.2.11/waterLayer.js",["datav:/npm/bcore/0.0.21/event","datav:/npm/safely-merge/1.0.0"],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"===typeof b||"function"===typeof b)?b:a}function f(a,b){if("function"!==typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=c("datav:/npm/bcore/0.0.21/event"),i=c("datav:/npm/safely-merge/1.0.0"),j=c("datav:/com/datavmap-3d-layer-water/0.2.11/water-material.js");return a.exports=function(a){var b=a.datavgl,c=b.THREE;j(c);var k=a.glLayer||a,l=a.worldsize,m=b.DataVModelTools.extrude2buffer,n=new c.TextureLoader,o=new c.Box3;n.setCrossOrigin("anonymous");var p={normalMapUrl:"https://img.alicdn.com/tfs/TB1OSvUczihSKJjy0FlXXadEXXa-1024-1024.jpg",textureWidth:1024,textureHeight:1024,alpha:1,speed:5,sunDirection:new c.Vector3(0.70707,0,0.70707).normalize(),sunColor:16777215,waterColor:16711680,noiseScale:1,distortionScale:1,intensity:3};return function(b){function h(a){d(this,h);var b=e(this,(h.__proto__||Object.getPrototypeOf(h)).call(this));return a=i(p,a),b.options=i(p,a),b.init(),b}return f(h,b),g(h,[{key:"init",value:function(){this.counter=1,this.onAnimation=this.onAnimation.bind(this),this.initWater()}},{key:"onAnimation",value:function(){var a=11-this.options.speed;this.water&&this.waterMesh.visible&&0==this.counter%a&&(1==this.counter,this.water.material.uniforms.time.value+=1/60,this.water.render()),++this.counter}},{key:"initWater",value:function(){var a=n.load(this.options.normalMapUrl);a.wrapS=a.wrapT=c.RepeatWrapping,this.options.waterNormals=a,this.options.side=c.DoubleSide,this.water=new c.Water(void 0,void 0,void 0,this.options),this.water.frustumCulled=!1,this.uniforms=this.water.material.uniforms,this.waveParams={distortionScale:1,noiseScale:1}}},{key:"addWaterMesh",value:function(b){var d=this.geometry=new c.BufferGeometry;d.colorsNeedUpdate=!0,d.elementsNeedUpdate=!0,d.verticesNeedUpdate=!0,d.dynamic=!0;for(var e=new Float32Array(b.positions.length),f=0,g=e.length;f<g;f+=3)e[f]=0,e[f+1]=0,e[f+2]=1;d.setIndex(new c.BufferAttribute(new Uint32Array(b.indices_array),1)),d.addAttribute("position",new c.BufferAttribute(new Float32Array(b.positions),3)),d.addAttribute("normal",new c.BufferAttribute(new Float32Array(e),3)),d.addAttribute("uv",new c.BufferAttribute(new Float32Array(b.uvs),2)),d.needsOffset=!0,this.waterMesh=new c.Mesh(d,this.water.material);b.offset;this.waterMesh.position.z=0.01,this.waterMesh.add(this.water),this.waterMesh.frustumCulled=!1,window.waterMesh=this.waterMesh,o.setFromObject(this.waterMesh);var h=o.getSize(),i=o.getCenter(),j=Math.min(h.x,h.y),l=j/10,m=j/100;if(this.waveParams.distortionScale=l,this.waveParams.noiseScale=m,this.uniforms.distortionScale.value=l,this.uniforms.noiseScale.value=m,this.uniforms.eye.value.copy(o.max),this.updateOptions({}),!k.offsetNode){var n=this;a.once("load",function(){k.offsetNode.add(n.waterMesh),k.emit("init-offset"),k.on("runAnimation",n.onAnimation)})}else k.offsetNode.add(this.waterMesh),k.emit("init-offset"),k.on("runAnimation",this.onAnimation)}},{key:"setData",value:function(a){a&&"FeatureCollection"===a.type&&(this.removeMesh(),this.disposeGeometry(),this.addWaterMesh(m(a,{worldsize:l})))}},{key:"disposeGeometry",value:function(){this.geometry&&(this.geometry.dispose(),this.geometry=null)}},{key:"disposeMaterial",value:function(){this.water&&(this.water.material.dispose(),this.water=null)}},{key:"updateOptions",value:function(a){if(this.waterMesh&&this.water){this.options=i(this.options,a),this.waterMesh.visible=this.options.visible,this.uniforms.alpha.value=this.options.alpha;var b=this.options.noiseScale,c=this.options.distortionScale;1e-6<=b&&(this.uniforms.noiseScale.value=this.waveParams.noiseScale/b),this.uniforms.waterColor.value.set(this.options.waterColor),this.uniforms.intensity.value=this.options.intensity}}},{key:"show",value:function(){this.options.visible=!0,this.waterMesh&&(this.waterMesh.visible=!0)}},{key:"hide",value:function(){this.options.visible=!1,this.waterMesh&&(this.waterMesh.visible=!1)}},{key:"removeMesh",value:function(){this.waterMesh&&(this.waterMesh.remove(this.water),k.offsetNode.remove(this.waterMesh),this.waterMesh=null)}},{key:"remove",value:function(){this.waterMesh&&(k.off("runAnimation",this.onAnimation),this.removeMesh(),this.disposeGeometry(),this.disposeMaterial())}}]),h}(h)},a.exports});;
Cube("datav:/com/datavmap-3d-layer-water/0.2.11",["datav:/npm/bcore/0.0.21/event","datav:/npm/safely-merge/1.0.0"],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"===typeof b||"function"===typeof b)?b:a}function f(a,b){if("function"!==typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=c("datav:/npm/bcore/0.0.21/event"),i=c("datav:/npm/safely-merge/1.0.0"),j=c("datav:/com/datavmap-3d-layer-water/0.2.11/waterLayer.js"),k={};return a.exports=function(a){function b(a,c){d(this,b);var f=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return f.container="string"===typeof a?document.querySelector(a):a,f.apis=c.apis,f.map=null,f.data=null,f.config=c,f}return f(b,a),g(b,[{key:"init",value:function(){var a=this.getOptions(),b=j(this.map);this.layer=new b(a)}},{key:"addTo",value:function(a){this.map=a,this.init()}},{key:"getOptions",value:function(){return this.config=i(k,this.config),this.config}},{key:"data",value:function(a){return a&&(this.data=a),this.data}},{key:"show",value:function(){this.config.visible=!0,this.layer&&this.layer.show&&this.layer.show()}},{key:"hide",value:function(){this.config.visible=!1,this.layer&&this.layer.hide&&this.layer.hide()}},{key:"remove",value:function(){this.layer&&(this.layer.remove(),this.layer=null,this.data=null)}},{key:"render",value:function(a){this.layer.setData(a)}},{key:"updateOptions",value:function(a){this.config=i(this.config,a),a=this.getOptions(),this.layer&&this.layer.updateOptions(a)}}]),b}(h),a.exports});