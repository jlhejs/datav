// env=undefined => env=publish 
Cube("datav:/com/@datav-city-pro-v2/datav-engine-model-instance/1.1.1/model",[],function(t,e,i,n,a,r){function s(t){return(s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function o(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function c(t,e){return(c=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function l(i){var n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(t){return!1}}();return function(){var t,e=h(i),e=(t=n?(t=h(this).constructor,Reflect.construct(e,arguments,t)):e.apply(this,arguments),this);if(t&&("object"===s(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");if(void 0!==e)return e;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}}function h(t){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}return t.exports=function(t){var S=t.THREE,s=t.Utils,e=t.VG,r=t.coordHelper,j=new S.Matrix4,R=new S.Color,t=e.ModelViewerLayer,e=a;if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&c(e,t);var i,n=l(a);function a(t){if(this instanceof a)return(t=n.call(this,t)).classNameAlias="InstancedModelLayer",t.modelUrl=t.options.url,t.offsetAlt=t.options.renderEffect.offsetAlt,t._datumMatrix=new S.Matrix4,t._datumInvertMatrix=new S.Matrix4,t._datumRelativeMatrices=[],t._rotationMatrix=new S.Matrix4,t._quaternion=new S.Quaternion,t._scale=new S.Vector3,t._position=new S.Vector3,t.instancedMaxCount=0,t.instancedMatrices=[],t.instancedInvertMatrices=[],t.instancedMeshes=[],t.animationNodeNames=[],t.rootBoneUUIDs=[],t.bones=[],t.gpuPickingMeshes=new S.Group,t.gpuPickingMeshes.matrixAutoUpdate=!1,t.gpuPickingMaterial=new S.MeshBasicMaterial({vertexColors:!0,reflectivity:0,refractionRatio:0,toneMapped:!1,fog:!1}),t._needsLoadModel=!0,t;throw new TypeError("Cannot call a class as a function")}return e=a,(t=[{key:"dataErrorHandler",value:function(){this.needsWait&&(this.needsWait=!1),this.emit("rendered")}},{key:"setData",value:function(t){if(!t||!Array.isArray(t))throw new Error("点位数据非数组, 格式错误");this._datumRelativeMatrices=[],this.recordPreviousInstanceMatrices(1),this.convertPointData2TransformMatrix(t),this.updateTransformMatrix(this.options.transform),this.gpuPickingMeshes.applyMatrix4(this._datumMatrix),this.gpuPickingMeshes.visible=!1,this._needsLoadModel?(0===t.length?this.emit("rendered"):this.loadModel(),this._needsLoadModel=!1,this.instancedMaxCount=t.length):t.length<=this.instancedMaxCount?this.updateInstanceTransformMatrix():(this.updateInstanceCount(),this.instancedMaxCount=t.length)}},{key:"convertPointData2TransformMatrix",value:function(t){if(0<t.length)for(var e=void 0!==t[0].altitude?t[0].altitude:0,i=(r.setFromValues(t[0].lng,t[0].lat,e+this.offsetAlt),this._datumMatrix.copy(r.transform),this._datumInvertMatrix.copy(r.transform).invert(),new S.Matrix4),n=0,a=t.length;n<a;++n)e=void 0!==t[n].altitude?t[n].altitude:0,r.setFromValues(t[n].lng,t[n].lat,e+this.offsetAlt),i.copy(r.transform),this._datumRelativeMatrices.push((new S.Matrix4).multiplyMatrices(this._datumInvertMatrix,i)),this.instancedMatrices.push(new S.Matrix4)}},{key:"updateTransformMatrix",value:function(t){var e=t.scale,t=t.rotation;this._scale.set(e.x,e.y,e.z),this._rotationMatrix.makeRotationFromEuler(new S.Euler(t.x*Math.PI,t.y*Math.PI,t.z*Math.PI,"XYZ"));for(var i=0,n=this.instancedMatrices.length;i<n;++i)this._quaternion.setFromRotationMatrix(j.copy(this._datumRelativeMatrices[i]).multiply(this._rotationMatrix)),this._position.set(this._datumRelativeMatrices[i].elements[12],this._datumRelativeMatrices[i].elements[13],this._datumRelativeMatrices[i].elements[14]),this.instancedMatrices[i].compose(this._position,this._quaternion,this._scale)}},{key:"recordPreviousInstanceMatrices",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0;this.instancedInvertMatrices=[];for(var e=0,i=this.instancedMatrices.length;e<i;++e)this.instancedInvertMatrices.push(this.instancedMatrices[e].invert());1===t&&(this.gpuPickingMeshes.matrix.premultiply(this._datumInvertMatrix),this.instancedMatrices=[])}},{key:"addToScene",value:function(t){var e=this.options,i=e.animation,e=e.renderEffect,n=(this.emit("rendered"),new S.Group);this.add(n),this.model={scene:n,animations:t.animations},this.materialsManager.bind(t),this.materialsManager.initMaterial();for(var a=0;a<t.animations.length;++a)for(var r=t.animations[a].tracks,s=0;s<r.length;++s)this.animationNodeNames.push(r[s].name.split(".")[0]);t.scene.updateMatrixWorld(),this.generateInstanceMeshes(t.scene,n,n),this.bones.forEach(function(t){var e;t.parent?((e=new S.Object3D).applyMatrix4(t.parent.matrixWorld),e.add(t),n.add(e)):n.add(t)}),this.add(this.gpuPickingMeshes),this.animationManager.bind(this.model),this.animationManager.autoPlay=i.autoPlay,this.animationManager.timeScale=i.timeScale,this.setRenderEffect(e),this.checkVisible(),this.emit("loaded")}},{key:"generateInstanceMeshes",value:function(t,e,i){var n,a=this,r=t.name||t.uuid,s=-1!==this.animationNodeNames.indexOf(r),o=this.instancedMatrices.length;if(t.isMesh){var c=[],l=new S.Matrix4;if(t instanceof S.InstancedMesh)for(var o=this.instancedMatrices.length*t.count,h=0,u=this.instancedMatrices.length;h<u;++h)for(var d=0,f=t.count;d<f;++d)l.copy(this.instancedMatrices[h]),l.multiply((new S.Matrix4).fromArray(t.instanceMatrix.array,16*d)),l.toArray(c,16*(h*f+d));else for(var m=0,p=this.instancedMatrices.length;m<p;++m)this.instancedMatrices[m].toArray(c,16*m);var M=t.geometry,y=t.material,v=t.customGBufferMaterial,M=M.clone();t instanceof S.SkinnedMesh||M.applyMatrix4(t.matrixWorld),(n=new S.InstancedMesh(M,y,o)).name=r;for(var g=0;g<o;++g)n.setMatrixAt(g,j.fromArray(c,16*g));n.customGBufferMaterial=v;var M=new Float32Array(4*o),M=(M.fill(-1),n.instanceColor=new S.InstancedBufferAttribute(M,4),n.geometry),x=M.morphAttributes,M=M.attributes,b=Object.keys(x);if(0<b.length){var I=x[b[0]];if(void 0!==I){n.morphTargetInfluences=[],n.morphTargetDictionary={};for(var k=0,w=I.length;k<w;k++){var _=I[k].name||String(k);n.morphTargetInfluences.push(0),n.morphTargetDictionary[_]=k}}y.morphTargets&&(y.vertexColors||void 0!==M.uv2)&&(y.morphTargets=!1,y.morphNormals=!1,v.morphTargets=!1,v.morphNormals=!1)}t.isSkinnedMesh&&(n.skeleton=t.skeleton,n.isSkinnedMesh=!0,n.bindMatrix=n.matrixWorld,n.bindMatrixInverse=(new S.Matrix4).copy(n.matrixWorld).invert(),n.bindMode=t.bindMode,x=t.skeleton.bones[0],-1===this.rootBoneUUIDs.indexOf(x.uuid)&&(this.bones.push(x),this.rootBoneUUIDs.push(x.uuid))),this.instancedMeshes.push(n),this.createGPUPickingMesh(n,R)}else!s||t.isBone||((n=new S.Object3D).name=r);n&&((t.parentNodeHasAnimation&&e?e:i).add(n),n.frustumCulled=!1,n.modelViewMatrix.multiplyMatrices=function(t,e){j.copy(a._datumMatrix),j.multiply(e),j.premultiply(t),n.modelViewMatrix.copy(j)});for(var A=0,P=t.children.length;A<P;++A){var O=t.children[A];(s||null!=e&&e.parentNodeHasAnimation)&&(O.parentNodeHasAnimation=!0),this.generateInstanceMeshes(O,n,i)}}},{key:"createGPUPickingMesh",value:function(t,e){var i,n=t.geometry.clone();if(t instanceof S.InstancedMesh){(i=new S.InstancedMesh(n,this.gpuPickingMaterial,t.count)).instanceMatrix.copy(t.instanceMatrix);for(var a=0;a<t.count;++a)e.setHex(16777215*Math.random()),c=e.getHex(),i.setColorAt(a,e),0===a?i.name=c.toString():i.name+="_".concat(c);for(var r=n.attributes.position,s=[],o=0;o<r.count;o++)s.push(1,1,1);n.setAttribute("color",new S.Float32BufferAttribute(s,3)),t.pickingId=i.name}else{i=new S.Mesh(n,this.gpuPickingMaterial),e.setHex(16777215*Math.random());for(var c=e.getHex(),l=n.attributes.position,h=[],u=0;u<l.count;u++)h.push(e.r,e.g,e.b);n.setAttribute("color",new S.Float32BufferAttribute(h,3)),i.name=c,t.pickingId=c}i.applyMatrix4(t.matrixWorld),this.gpuPickingMeshes.add(i)}},{key:"updateInstanceTransformMatrix",value:function(){for(var t=this.instancedMatrices.length,e=0,i=this.instancedMeshes.length;e<i;++e){var n=this.instancedMeshes[e],a=n.count/this.instancedInvertMatrices.length;if(1==a)for(var r=0;r<t;++r)n.setMatrixAt(r,this.instancedMatrices[r]);else{for(var s=[],o=0;o<a;++o)s.push(j.fromArray(n.instanceMatrix.array,16*o).multiply(this.instancedInvertMatrices[0]));for(var c=0;c<t;++c)for(var l=0;l<a;++l)j.copy(this.instancedMatrices[c]).multiply(s[l]),n.setMatrixAt(c*a+l,j)}n.count=t,n.instanceMatrix.needsUpdate=!0;var h=this.gpuPickingMeshes.children[e];h.count=t,h.instanceMatrix.copy(n.instanceMatrix),h.instanceMatrix.needsUpdate=!0}}},{key:"updateInstanceCount",value:function(){for(var t,e=this.instancedMatrices.length,i=0,n=this.instancedMeshes.length;i<n;++i){var a=this.instancedMeshes[i],r=a.count/this.instancedInvertMatrices.length,s=a.geometry,o=a.material,c=a.customGBufferMaterial,l=a.morphTargetInfluences,h=a.morphTargetDictionary,u=a.castShadow,d=new S.InstancedMesh(s,o,e*r);if(1==r)for(var f=0;f<e;++f)d.setMatrixAt(f,this.instancedMatrices[f]);else{for(var m=[],p=0;p<r;++p)m.push(j.fromArray(a.instanceMatrix.array,16*p).multiply(this.instancedInvertMatrices[0]));for(var M=0;M<e;++M)for(var y=0;y<r;++y)j.copy(this.instancedMatrices[M]).multiply(m[y]),d.setMatrixAt(M*r+y,j)}d.name=a.name,d.customGBufferMaterial=c;var s=new Float32Array(4*e),o=(s.fill(-1),d.instanceColor=new S.InstancedBufferAttribute(s,4),d.castShadow=u,d.morphTargetInfluences=l,d.morphTargetDictionary=h,a.isSkinnedMesh&&(d.skeleton=a.skeleton,d.isSkinnedMesh=!0,d.bindMatrix=d.matrixWorld,d.bindMatrixInverse=(new S.Matrix4).copy(d.matrixWorld).invert(),d.bindMode=a.bindMode),a.dispose(),a.copy(d),this.gpuPickingMeshes.children[i]),v=new S.InstancedMesh(o.geometry,this.gpuPickingMaterial,a.count);v.instanceMatrix.copy(a.instanceMatrix);for(var g=0;g<a.count;++g)R.setHex(16777215*Math.random()),t=R.getHex(),v.setColorAt(g,R),0===g?v.name=t.toString():v.name+="_".concat(t);o.dispose(),o.copy(v),a.pickingId=o.name}}},{key:"updateOptions",value:function(t){var e=s.deepClone(this.options);this.setRenderEffect(t.renderEffect),s.easyDiff(e.renderEffect.offsetAlt,t.renderEffect.offsetAlt)||(this.recordPreviousInstanceMatrices(),this.updateHeight(t.renderEffect.offsetAlt-this.offsetAlt),this.updateInstanceTransformMatrix(),this.offsetAlt=t.renderEffect.offsetAlt),s.easyObjDiff(e.transform.rotation,t.transform.rotation)&&s.easyObjDiff(e.transform.scale,t.transform.scale)||(this.recordPreviousInstanceMatrices(),this.updateTransformMatrix(t.transform),this.updateInstanceTransformMatrix()),s.easyDiff(e.url,t.url)||(this.dispose(),this.modelUrl=t.url,this.loadModel()),s.easyObjDiff(e.animation,t.animation)||this.updateAnimationOpts(t.animation),s.easyObjDiff(e.interactiveStyle,t.interactiveStyle)||this.updateInteraction(t.interactiveStyle),s.easyDiff(e.sceneId.length,t.sceneId.length)&&s.deepDiff(e.sceneId,t.sceneId)||(this.options.sceneId=t.sceneId,this.updateSceneId(t.sceneId)),this.options=s.mergeOptions(this.options,t||{})}},{key:"updateHeight",value:function(t){for(var e=0,i=this._datumRelativeMatrices.length;e<i;++e)j.copy(this._datumRelativeMatrices[e]),j.premultiply(this._datumMatrix),r.fromXYZ(j.elements[12],j.elements[13],j.elements[14]),r.setFromValues(r.longitude,r.latitude,r.altitude+t),this._datumRelativeMatrices[e].copy(r.transform).premultiply(this._datumInvertMatrix),this._position.set(this._datumRelativeMatrices[e].elements[12],this._datumRelativeMatrices[e].elements[13],this._datumRelativeMatrices[e].elements[14]),this.instancedMatrices[e].compose(this._position,this._quaternion,this._scale)}},{key:"updateInteraction",value:function(t){this.resetMaterial(),this.currentObj={},t.enable?(this.allowGPUPicking=!0,this.currentObj&&this.updateInteractiveStyle(t,this.currentObj)):this.allowGPUPicking=!1}},{key:"updateInteractiveStyle",value:function(t){var e,i,n,a=this,r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};this.options.interactiveStyle=s.mergeOptions(this.options.interactiveStyle,t||{}),0!==Object.keys(r).length&&(e=t.interactiveColor,i=t.interactiveExt,n=s.Chroma(e).gl(),"local"===i?(this.preIntersectObj&&this.preIntersectObj.mesh&&this.resetMaterial(),this.model&&this.model.scene&&this.model.scene.traverse(function(t){a.materialsManager&&a.materialsManager.updateInterativeStyle({mesh:t,id:r.id},n)})):this.model&&this.model.scene&&this.model.scene.traverse(function(t){a.materialsManager&&a.materialsManager.updateInterativeStyle({mesh:t,id:-2},n)})),this.preIntersectObj=r}},{key:"playAllAnimation",value:function(){var e=this;Object.keys(this.animationManager.actions).forEach(function(t){e.animationManager.actions[t].play(),e.animationManager.setActionWeight(e.animationManager.actions[t],1)})}},{key:"setAnimation",value:function(t,e){switch(e){case 1:this.animationManager.activateAllActions(),this.animationManager.activateActionByName(t);break;case 0:this.animationManager.deactivateActionByName(t)}}},{key:"stopAllAnimation",value:function(){this.animationManager.autoPlay=!1}}])&&o(e.prototype,t),i&&o(e,i),Object.defineProperty(e,"prototype",{writable:!1}),a},t.exports});;
Cube("datav:/com/@datav-city-pro-v2/datav-engine-model-instance/1.1.1",["datav:/npm/eventemitter3/3.0.0"],function(e,t,n,r,i,o){function a(e){return(a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function l(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function c(e,t){return(c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function s(n){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=u(n),t=(e=r?(e=u(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments),this);if(e&&("object"===a(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");if(void 0!==t)return t;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}}function u(e){return(u=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var y=n("datav:/npm/eventemitter3/3.0.0"),f=n("datav:/com/@datav-city-pro-v2/datav-engine-model-instance/1.1.1/model"),n=function(){var e=i,t=y;if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&c(e,t);var n,r=s(i);function i(e,t){var n;if(this instanceof i)return(n=r.call(this)).options=Object.assign({enableGBuffer:!0,url:""},t),n.comId="",n.type="MotionModel",n;throw new TypeError("Cannot call a class as a function")}return e=i,(t=[{key:"addTo",value:function(e,t){this.cityproCore=e,this.comId=t,this.initLayer()}},{key:"initLayer",value:function(){var e=new f(this.cityproCore),t=this.refractOptions(this.options);this.layer=new e(t),this.cityproCore.viewer.addLayer(this.comId,this.layer),this.initEvents()}},{key:"setData",value:function(e){this.layer&&this.layer.setData(e)}},{key:"errorRender",value:function(){console.log("实例化组件数据错误"),this.layer&&this.layer.dataErrorHandler()}},{key:"initEvents",value:function(){var n=this;this.layer.on("pick",function(e){var t={name:e.name,instanceId:e.instanceId,mesh:e.mesh};switch(e.button){case 0:n.emit("leftClick",t);break;case 1:n.emit("middleClick",t);break;case 2:n.emit("rightClick",t);break;default:n.emit("leftClick",t)}}),this.layer.on("rendered",function(){n.emit("rendered","实例化模型组加载完成")}),this.layer.on("loaded",function(){n.emit("loaded")})}},{key:"updateInteraction",value:function(e){this.layer&&this.layer.updateInteraction(e)}},{key:"setEnvMap",value:function(e){this.layer&&this.layer.setEnvMap(e)}},{key:"updateOptions",value:function(e){e=this.refractOptions(e);this.layer&&this.layer.updateOptions(e)}},{key:"refractOptions",value:function(e){var t,n,r,i,o=Object.assign({renderEffect:{shadow:!1,depthWrite:!0,wireframe:!1,opacity:1,offsetAlt:0},interactiveStyle:{enable:!1,clickType:"click",interactiveColor:"RGBA(79, 240, 252, 0.2)",interactiveExt:"local"},animation:{autoPlay:!1,showSkeleton:!1,defaultLoopMode:"LoopRepeat",timeScale:1},light:{envMapIntensityFactor:1,emissiveIntensity:0}},e);return o.options&&delete o.options,e.options&&(e=e.options,t=e.general,n=e.graphic,i=e.animate,e=e.interaction,o.url=n.url,Object.keys(o.renderEffect).forEach(function(e){return o.renderEffect[e]=t[e]}),Object.keys(o.light).forEach(function(e){return o.light[e]=t.light[e]}),r=i.modelAnimate,i=i.scanner,o.animation=r,o.scanner=i,o.interactiveStyle=e,o.transform={rotation:{x:n.rotation.x/180,y:n.rotation.y/180,z:n.rotation.z/180},scale:n.scale}),o}},{key:"updateScanner",value:function(e){this.layer&&this.layer.updateScannerOpts(e)}},{key:"playAllAnimation",value:function(){this.layer&&this.layer.playAllAnimation()}},{key:"playSpecifiedAnimation",value:function(e){this.layer&&this.layer.setAnimation(e,1)}},{key:"stopAllAnimation",value:function(){this.layer&&this.layer.stopAllAnimation()}},{key:"stopSpecifiedAnimation",value:function(e){this.layer&&this.layer.setAnimation(e,0)}},{key:"show",value:function(){this.layer&&this.layer.show&&this.layer.show()}},{key:"hide",value:function(){this.layer&&this.layer.hide&&this.layer.hide()}},{key:"clear",value:function(){this.layer&&this.layer.clear&&this.layer.clear()}},{key:"destroy",value:function(){this.layer&&this.layer.destroy&&this.layer.destroy()}}])&&l(e.prototype,t),n&&l(e,n),Object.defineProperty(e,"prototype",{writable:!1}),i}();return e.exports=n,e.exports});