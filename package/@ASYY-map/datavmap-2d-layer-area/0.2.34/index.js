// env=undefined => env=publish 
Cube("datav:/com/datavmap-2d-layer-area/0.2.34/areaLayer.js",["datav:/npm/polylabel/1.0.2","datav:/npm/chroma-js/1.3.3"],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"===typeof b||"function"===typeof b)?b:a}function f(a,b){if("function"!==typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();return a.exports=function(a){var b=a.datavUtils,h=a.BaseLayer,i=c("datav:/npm/polylabel/1.0.2"),j=c("datav:/npm/chroma-js/1.3.3"),k={pane:"fillPane",opacity:1,"click-key":"",isLabel:!1,label:{labelField:"name",labelFontSize:12,labelColor:"#fff",labelFontFamily:"",labelShadowColor:"#000"},style:{minFillColor:"rgba(5, 96, 125, 0.8)",maxFillColor:"rgba(0, 255, 240, 0.5)",fillColor:"rgba(77, 77, 77, 0.5)",color:"#fff",weight:1,dashArray:"1,0",fillOpacity:1},isHover:!0,hover:{fillColor:"#FEE619"},isOpenPopup:!0,clickZoom:!0,zoomPad:1.5};return function(c){function h(a){d(this,h);var c=e(this,(h.__proto__||Object.getPrototypeOf(h)).call(this));return a=b.mergeOptions(k,a),c.options.visibility=!0,c.options=b.mergeOptions(c.options,a),c.type="fill",c}return f(h,c),g(h,[{key:"init",value:function(){this.data=null,this.geojson=null,this.geojsonLayer=null,this.labelLayer=a.layerGroup(),this.labelLayer.addTo(this.map),this.pane.style.pointerEvents="none",this.renderer=a.canvas({padding:0.1,pane:this.options.pane,tolerance:0}),this.renderer.addTo(this.map)}},{key:"setData",value:function(a){this.data=a,this.range=this.getRange(),this.genGeojson()}},{key:"setGeojson",value:function(a){a.features.filter(function(a){return a.geometry}),this.geojson=a,this.genGeojson()}},{key:"genGeojson",value:function(){var a=this;if(this.geojson&&this.geojson.features&&this.geojson.features.length&&this.data&&this.data.length){var b=null,c=JSON.parse(JSON.stringify(this.geojson));this.new_geojson=c.features.map(function(c){b=b||c.properties.ad_code&&"ad_code",b=b||c.properties.adcode&&"adcode",b=b||c.properties.id&&"id",b=b||c.properties.name&&"name";var d=a.data.find(function(a){return a.area_id==c.properties[b]});return Object.assign(c.properties,d),c})}else this.new_geojson=this.geojson}},{key:"genLabel",value:function(b,c){if(c.properties[this.options.label.labelField]){var d=a.divIcon({iconSize:null,className:"",html:"<div style=\"pointer-events:none;color:"+this.options.label.labelColor+";width:50px;text-align:center;font-size:"+this.options.label.labelFontSize+"px;position: relative;transform: translate(-50%,-50%);font-family:"+this.options.label.labelFontFamily+";text-shadow: 0px 2px 1px "+this.options.label.labelShadowColor+";\">"+(c.properties[this.options.label.labelField]||"")+"</div>"}),e=a.marker([b[1],b[0]],{clickable:!1,keyboard:!1,interactive:!1,icon:d});this.labelLayer.addLayer(e)}}},{key:"getRange",value:function(){if(!this.data.length)return null;var a=this.data.filter(function(a){return void 0!=a.value&&!isNaN(+a.value)&&""!==a.value});if(2>a.length)return null;var b=a.reduce(function(c,a){return+c.value<=+a.value?c:a},{}),c=a.reduce(function(c,a){return+c.value>=+a.value?c:a},{});return[+b.value,+c.value]}},{key:"highlightFeature",value:function(a){var b=a.target.feature.properties;if((this.emit("mouseover",b),!(b.hasOwnProperty("isInteractive")&&!1===b.isInteractive))&&this.options.isHover){var c=a.target;c.setStyle({fillColor:this.options.hover.fillColor})}}},{key:"resetHighlight",value:function(a){this.emit("mouseout",a.target.feature.properties),this.geojsonLayer&&this.geojsonLayer.resetStyle(a.target)}},{key:"area",value:function(a){for(var b,c=0,d=0;d<a.length;d++){b=a[d];for(var e=0,f=b.length,g=f-1;e<f;g=e++)c+=(b[e][0]-b[g][0])*(b[e][1]+b[g][1])*(d?-1:1)}return Math.abs(c)/2}},{key:"calLabelPos",value:function(a,b){var c=this;if(a.geometry&&"Polygon"===a.geometry.type)return i(a.geometry.coordinates,b);if(a.geometry&&"MultiPolygon"===a.geometry.type){var d=a.geometry.coordinates.reduce(function(d,a){return c.area(d)>=c.area(a)?d:a},{});return i(d,b)}}},{key:"zoomToFeatureOrOpenPopup",value:function(a){this.map.isFly=this.options.clickZoom;var b=a.target.feature,c=b.properties;if(!(c.hasOwnProperty("isInteractive")&&!1===c.isInteractive)){if(this.options.clickZoom&&(c.bounds?this.map.fitBounds(c.bounds):this.map.fitBounds(a.target.getBounds().pad(this.options.zoomPad-1))),this.options.isOpenPopup){var d=void 0==c.info?void 0!=c.name&&void 0!=c.value?"\u540D\u79F0\uFF1A"+c.name+"<br/>\u6570\u503C\uFF1A"+c.value:void 0==c.name?"\u65E0\u4FE1\u606F":""+c.name:""+c.info,e=this.map.L.popup();if(e.setLatLng(a.latlng).setContent(d).openOn(this.map),!e._container)return;var f=e._container;if(!f)return;var g=f.querySelector(".leaflet-popup-content-wrapper");g.style.color="rgb(234, 226, 210)",g.style.backgroundColor="rgba(30, 30, 30, 1)",g.style.borderRadius="3px";var h=f.querySelector(".leaflet-popup-tip");h.style.backgroundColor="rgba(30, 30, 30, 1)"}this.emit("click",c)}}},{key:"onUpdateOptions",value:function(){this.render()}},{key:"render",value:function(){var c=this;this.options.visibility&&this.geojson&&(this.range&&(this.colorScale=j.scale([this.options.style.minFillColor,this.options.style.maxFillColor]).domain(this.range)),this.geojsonLayer&&this.geojsonLayer.clearLayers(),this.geojsonLayer&&this.geojsonLayer.remove(),this.labelLayer&&this.labelLayer.clearLayers(),this.geojsonLayer=a.geoJSON(this.new_geojson,{renderer:this.renderer,style:function(a){if(c.range){var d=void 0==a.properties.value?c.options.style.fillColor:c.colorScale(+a.properties.value).css();return b.mergeOptions(c.options.style,{fillColor:a.properties.fillColor||d,color:a.properties.color||c.options.style.color,weight:a.properties.weight||c.options.style.weight,dashArray:a.properties.dashArray||c.options.style.dashArray})}return b.mergeOptions(c.options.style,{fillColor:a.properties.fillColor||(void 0==a.properties.value?c.options.style.fillColor:c.options.style.maxFillColor),color:a.properties.color||c.options.style.color,weight:a.properties.weight||c.options.style.weight,dashArray:a.properties.dashArray||c.options.style.dashArray})},onEachFeature:function(a,b){if(b.on({mouseover:c.highlightFeature,mouseout:c.resetHighlight,click:c.zoomToFeatureOrOpenPopup},c),c.options.isLabel)try{var d;d=a.properties.customLabelPosition?a.properties.customLabelPosition:c.calLabelPos(a,1),c.genLabel(d,a)}catch(b){b&&console.log(a)}},filter:function(a){return a.geometry&&("Polygon"===a.geometry.type||"MultiPolygon"===a.geometry.type)}}),this.geojsonLayer.addTo(this.map))}},{key:"show",value:function(){this.options.visibility=!0,this.onUpdateOptions()}},{key:"hide",value:function(){this.options.visibility=!1,this.geojsonLayer&&this.geojsonLayer.clearLayers(),this.labelLayer&&this.labelLayer.clearLayers()}},{key:"getIndex",value:function(){var a=this.renderer._container&&this.renderer._container.style.zIndex;return a}},{key:"setZIndex",value:function(a){this.renderer._container&&(this.renderer._container.style.zIndex=a)}},{key:"onRemove",value:function(){this.geojsonLayer&&this.geojsonLayer.clearLayers(),this.geojsonLayer&&this.geojsonLayer.remove(),this.labelLayer&&this.labelLayer.clearLayers(),this.labelLayer&&this.labelLayer.remove(),this.renderer.remove(),this.geojsonLayer=null,this.labelLayer=null,this.geojson=null,this.new_geojson=null,this.data=null}}]),h}(h)},a.exports});;
Cube("datav:/com/datavmap-2d-layer-area/0.2.34",["datav:/npm/bcore/0.0.21/event"],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"===typeof b||"function"===typeof b)?b:a}function f(a,b){if("function"!==typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=c("datav:/npm/bcore/0.0.21/event"),i=c("datav:/com/datavmap-2d-layer-area/0.2.34/areaLayer.js"),j=void 0,k={},l=function(a){function b(a,c){d(this,b);var f=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return f.container="string"===typeof a?document.querySelector(a):a,f.apis=c.apis,f.map=null,f._data=null,f.config=c,f.config.mapData=c.mapData||"//sh-conf.oss-cn-shanghai.aliyuncs.com/datav-coms-data/china.json",f.config.visibility=!0,f}return f(b,a),g(b,[{key:"init",value:function(){var a=this,b=this.getOptions(),c=i(this.map.L);this.layer=new c(b),this.layer.addTo(this.map),this.layer.on("click",function(b){var c=a.getOptions(),d=b;b&&b.adcode&&!b.area_id&&(d.area_id=b.adcode),a.emit("area-map-click",d),""!==c["click-key"]&&a.emit("global_var",c["click-key"],b[c["click-key"]])}),this.layer.on("mouseover",function(b){var c=b;b&&b.adcode&&!b.area_id&&(c.area_id=b.adcode),a.emit("area-map-mouseover",c)}),this.layer.on("mouseout",function(b){var c=b;b&&b.adcode&&!b.area_id&&(c.area_id=b.adcode),a.emit("area-map-mouseout",c)})}},{key:"addTo",value:function(a){this.map=a,j=a.L.datavUtils,this.init()}},{key:"getOptions",value:function(){var a=this.config=j&&j.mergeOptions(k,this.config),b={"click-key":a.interactive["click-key"],isLabel:a.label.show,label:{labelField:a.label.labelField,labelFontSize:a.label.labelFontSize,labelColor:a.label.labelColor,labelFontFamily:a.label.labelFontFamily,labelShadowColor:a.label.labelShadowColor},style:{minFillColor:a.fill.minFillColor,maxFillColor:a.fill.maxFillColor,fillColor:a.fill.fillColor,color:a.stroke.color,weight:a.stroke.weight,dashArray:a.stroke.dashArray},isHover:a.interactive.isHover.show,hover:{fillColor:a.interactive.isHover.fillColor},isOpenPopup:a.interactive.isOpenPopup,clickZoom:a.interactive.clickZoom,zoomPad:a.interactive.zoomPad};return b}},{key:"setGeojson",value:function(a){var b=this,c=null;c=Array.isArray(a)&&a.length?a[0]:a,c&&c.type&&"featurecollection"===c.type.toLowerCase()&&c.features&&0<c.features.length?this.layer&&this.layer.setGeojson(c):this.defaultGeojson?(this.geojson=this.defaultGeojson,console.log("\u4F7F\u7528\u9ED8\u8BA4\u7684geojson"),this.layer&&this.layer.setGeojson(this.defaultGeojson)):fetch(this.config.mapData).then(function(a){return a.json()}).then(function(a){b.defaultGeojson=a,b.geojson=a,console.log("\u4F7F\u7528\u9ED8\u8BA4\u7684geojson"),b.layer&&b.layer.setGeojson(b.defaultGeojson),b.layer&&b.layer.render()}).catch(function(a){return console.log("fetch error",a)}),this.layer&&this.layer.render()}},{key:"show",value:function(){this.config.visibility=!0,this.layer&&this.layer.show&&this.layer.show()}},{key:"hide",value:function(){this.config.visibility=!1,this.layer&&this.layer.hide&&this.layer.hide()}},{key:"remove",value:function(){this.layer&&this.layer.remove&&this.layer.remove(),this.layer=null,this._data=null}},{key:"setData",value:function(a){this.layer&&this.layer.setData(a),this.layer&&this.layer.render()}},{key:"updateOptions",value:function(a){this.config=j.mergeOptions(this.config,a),a=this.getOptions(),this.layer&&this.layer.updateOptions(a)}}]),b}(h);return a.exports=l,a.exports});