// env=undefined => env=publish 
Cube("datav:/com/@datav-city-pro-v2/datav-engine-ground/2.1.1",["datav:/npm/eventemitter3/3.0.0"],function(r,n,o,e,t,i){function p(e){return(p="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}return function(e,t){"object"==(void 0===n?"undefined":p(n))&&"object"==(void 0===r?"undefined":p(r))?r.exports=t(o("datav:/npm/eventemitter3/3.0.0")):"function"==typeof define&&define.amd?define(["eventemitter3"],t):"object"==(void 0===n?"undefined":p(n))?n.Chart=t(o("datav:/npm/eventemitter3/3.0.0")):e.Chart=t(e.eventemitter3)}(window,function(r){return function(r){var n={};function o(e){if(n[e])return n[e].exports;var t=n[e]={i:e,l:!1,exports:{}};return r[e].call(t.exports,t,t.exports,o),t.l=!0,t.exports}return o.m=r,o.c=n,o.d=function(e,t,r){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==p(t)&&t&&t.__esModule)return t;var r=Object.create(null);if(o.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)o.d(r,n,function(e){return t[e]}.bind(null,n));return r},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=1)}([function(e,t){e.exports=function(e){var r=[[],[],[],[],[],[]],n=[[],[],[],[],[],[]],o=[];return[e.matS,e.matR].forEach(function(e){o.push(100*e.uvScale.x,100*e.uvScale.y),r[0].push(e.map),n[0].push(e.color),r[1].push(e.normalMap),n[1].push("rgb(255, 255, 255)"),r[2].push(e.emissiveMap),n[2].push(e.emissive);var t=parseInt(255*e.aoMapIntensity,10);r[3].push(e.aoMap),n[3].push("rgb(".concat(t,", ").concat(t,", ").concat(t,")")),r[4].push(e.roughnessMap),t=parseInt(255*e.roughness,10),n[4].push("rgb(".concat(t,", ").concat(t,", ").concat(t,")")),r[5].push(e.metalnessMap),t=parseInt(255*e.metalness,10),n[5].push("rgb(".concat(t,", ").concat(t,", ").concat(t,")"))}),{imageUrlArr:r,pbrMatCoeffArr:n,uvScaleData:o}}},function(e,t,r){function o(e){return(o="function"==typeof Symbol&&"symbol"==p(Symbol.iterator)?function(e){return p(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":p(e)})(e)}function i(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function u(e,t){return(u=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function c(r){var n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=a(r);return function(e,t){if(t&&("object"===o(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}(this,n?(e=a(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))}}function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var s=r(2),f=r(3),l=r(0),r=function(){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&u(e,t)}(a,s);var e,t,n=c(a);function a(e,t){var r;return function(e){if(!(e instanceof a))throw new TypeError("Cannot call a class as a function")}(this),(r=n.call(this)).options=t,r.visible=!0,r.comId="",r.type="Ground",r.isBasicFeature=!0,r}return t=[{key:"editBeforePublish",value:function(e,t,r){var o=e.componentData,i=r.UI,e=o.config.options.graphic,r=l(e),e=(r.vtbuffer=e.vtbuffer,a.pack(t,r));return e.then(function(e){if(e.isError||!e.data||!e.data.url)return Promise.reject(new Error(e.message));i.Notify.success("".concat(o.alias," 材质打包成功"));var t=JSON.parse(JSON.stringify(o.config)),r=t.sceneId,t=t.options,n=t.general,t=t.graphic.vtbuffer;return t.url=e.data.url,{config:{sceneId:r,options:{general:n,graphic:{vtbuffer:t}}}}})}},{key:"pack",value:function(e,t){return fetch(e.staticPackingEndpoint,{method:"POST",headers:{"content-type":"application/json","X-Auth-Token":"datav","xsrf-token":e.csrf,"from-app":e.fromApp},body:JSON.stringify({comConfig:t})}).then(function(e){return e.json()})}}],i((e=a).prototype,[{key:"addTo",value:function(e,t){return this.cityproCore=e,this.comId=t,this.initLayer()}},{key:"setEnvMap",value:function(e){this.layer&&(this.layer.envMapIntensity=e.properties,this.layer.envMap=e.value)}},{key:"initLayer",value:function(){var e=this,t=f(this.cityproCore),t=(this.layer=new t(this.options),this.cityproCore.viewer.addLayer(this.comId,this.layer));return this.visible?this.layer.show():this.layer.hide(),this.layer.on("rendered",function(){e.emit("rendered","地面L1渲染完成")}),t}},{key:"setData",value:function(e){var t=this;this.layer&&(e instanceof ArrayBuffer?this.layer.setData(e):e&&e.url&&""!==e.url&&(this.layer.hide(),fetch(e.url,{headers:{"accept-encoding":"deflate,gzip"}}).then(function(e){return e.arrayBuffer()}).then(function(e){t.layer&&(t.visible?t.layer.show():t.layer.hide(),t.layer.setData(e))})))}},{key:"errorRender",value:function(){console.log("地面L1组件数据错误"),this.layer&&this.layer.dataErrorHandler()}},{key:"updateOptions",value:function(e){this.layer&&this.layer.updateOptions(e)}},{key:"show",value:function(){this.visible=!0,this.layer&&this.layer.show()}},{key:"hide",value:function(){this.visible=!1,this.layer&&this.layer.hide()}},{key:"remove",value:function(){this.clear()}},{key:"clear",value:function(){this.layer&&this.layer.clear&&this.layer.clear()}},{key:"destroy",value:function(){this.layer&&(this.layer.destroy&&this.layer.destroy(),this.layer=null)}}]),i(e,t),Object.defineProperty(e,"prototype",{writable:!1}),a}();e.exports=r},function(e,t){e.exports=r},function(e,t,r){function o(e){return(o="function"==typeof Symbol&&"symbol"==p(Symbol.iterator)?function(e){return p(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":p(e)})(e)}function a(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function u(e,t){return(u=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function c(r){var n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=i(r);return function(e,t){if(t&&("object"===o(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return s(e)}(this,n?(e=i(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))}}function s(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function i(e){return(i=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}e.exports=function(e){var t=e.VG,o=e.Utils,i=r(0);return function(){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&u(e,t)}(n,t.CityBaseLayer);var e,r=c(n);function n(e){!function(e){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this),(t=r.call(this,"GroundLayer")).options=Object.assign({isSceneGroup:!1,sceneId:["scene1"]},e||{});var t,e=t.options.options.graphic.vtbuffer;return t.resolution.set(256*Math.pow(2,e.resExp),256*Math.pow(2,e.resExp),e.styleNum),t.emitWorldVaried=t.emitWorldVaried.bind(s(t)),t}return a((e=n).prototype,[{key:"setData",value:function(e){this.setMeshBuffer(e),this.emitWorldVaried(),this.resolve(),this.emit("rendered")}},{key:"dataErrorHandler",value:function(){this.needsWait&&(this.needsWait=!1),this.emit("rendered")}},{key:"emitWorldVaried",value:function(){this.viewer.onWorldVaried()}},{key:"updateMaterialRuntime",value:function(e){var t=this;fetch(e.vtbuffer.url,{headers:{"accept-encoding":"deflate,gzip"}}).then(function(e){return e.arrayBuffer()}).then(function(e){t.setVTBuffer(e),t.emitWorldVaried()})}},{key:"updateMaterialEditor",value:function(e){var e=i(e),t=e.uvScaleData,r=e.imageUrlArr,e=e.pbrMatCoeffArr;this.updateVT(t,r,e,this.emitWorldVaried)}},{key:"updateMaterial",value:function(){var e;this.updateLight(),this.material&&(""!==(e=this.options.options.graphic).vtbuffer.url?this.updateMaterialRuntime(e):this.updateMaterialEditor(e))}},{key:"updateShadow",value:function(){this.mesh&&(this.mesh.canCastShadow=!0,this.mesh.canReceiveShadow=!0);var e=this.options.options.general;this.castShadow=e.shadow.castShadow,this.receiveShadow=e.shadow.receiveShadow,this.emitWorldVaried()}},{key:"updateLight",value:function(){var e=this.options.options.general;this.envMapIntensityFactor=e.light.envMapIntensityFactor,this.emissiveIntensity=e.light.emissiveIntensity,this.emitWorldVaried()}},{key:"updateOptions",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=o.deepClone(this.options);this.options=o.mergeOptions(this.options,e||{}),this.options.options,this.updateMaterial(t.options),this.updateShadow(),o.easyDiff(t.sceneId.length,this.options.sceneId.length)&&o.deepDiff(t.sceneId,this.options.sceneId)||this.updateSceneId()}}]),Object.defineProperty(e,"prototype",{writable:!1}),n}()}}])}),r.exports});