// env=undefined => env=publish 
Cube("datav:/com/@double11-2017/double11-2017-table-bar/1.2.4",["datav:/npm/bcore/0.0.18/event","datav:/npm/jquery/2.1.4","datav:/npm/lodash/4.17.4","datav:/npm/chroma-js/1.3.4","datav:/npm/web-animations-js/2.3.2"],function(a,b,c){function d(a){var b=""+(a.light.show&&"<div class=\"content-light\" style=\"position: absolute;height: 100%;border-right:1px solid rgba(255, 255, 255, .24); width: 50%; background: linear-gradient(270deg, rgba(255, 255, 255, .13), rgba(255, 255, 255, 0)); transform: translate3d(-100%, 0, 0)\"></div>"||""),c=a.bar.show&&"<div class=\"content-bar\" style=\"position: absolute; height: 100%;overflow: hidden;\">"+b+"</div>"||"",d="<div class=\"table-line\" style=\"display: flex;\">\n  "+(a.index.show&&"<div class=\"table-index\" style=\"flex: none;text-align: center;display:flex;justify-content: center;align-items: center;\"></div>"||"")+"\n  <div class=\"table-content\" style=\"position: relative;white-space: nowrap;display: flex;align-items: center;\">\n    "+c+"\n    <div class=\"content-text-wrap\" style=\"margin: 0 1em;height: 100%;display: flex;align-items: center;overflow: hidden;width: 100%;position: relative;\">\n      <div class=\"content-text\" style=\"position: absolute; white-space:nowrap;display:flex;justify-content: center;\"></div>\n    </div>\n  </div>\n</div>";return d}var e=c("datav:/npm/bcore/0.0.18/event"),f=c("datav:/npm/jquery/2.1.4"),g=c("datav:/npm/lodash/4.17.4"),h=c("datav:/npm/chroma-js/1.3.4"),i=c("datav:/npm/web-animations-js/2.3.2"),j={1:"<%= i %>",2:"NO.<%= i %>",3:"(<%= i %>)"};return a.exports=e.extend(function(a,b){this.config={rotate:!0,global:{duration:2e3,padding:8,quantity:5,height:36,left:0,right:0},index:{show:!0,format:null,fontSize:16,fontWeight:"normal",color:"#fff",padding:10},content:{format:null,fontSize:16,fontWeight:"normal",color:"#fff",marquee:{show:!0,duration:8e3}},bar:{show:!0,color:"#1371FB"},light:{show:!0,color:"#28f8ff",width:70},background:{show:!0,color:"#1371fb"}},this.container=f(a).css({transform:"translate3d(0,0,0)"}),this.apis=b.apis,this._data=null,this.chart=null,this.isFirst=!0,this.flashAnimates=[],this.flashStopTimer=null,this.flipPageAnimates=[],this.flipPageStopTimer=null,this.animateFrameTimer=[],this.marqueeAnimates=[],this.page=0,this.init(b)},{init:function(a){var b=this.mergeConfig(a);this.container.css({marginTop:b.global.top,marginLeft:b.global.left})},render:function(a){this.rerender(a,this.config)},rerender:function(a,b){var c=this,e=this;if(this.clearAnimates(),a=this.data(a,!0),a&&a.length){for(var k=b,l="",m=d(k),n=0;n<k.global.quantity;n++)l+=m;this.container.empty(),this.container.append(l),this.container.css({marginTop:k.global.top,marginLeft:k.global.left}),this.lines=this.container.find(".table-line"),this.indexs=this.container.find(".table-index"),this.contents=this.container.find(".content-text"),this.backgrounds=this.container.find(".table-content"),this.bars=this.container.find(".content-bar"),this.lights=this.container.find(".content-light"),this.updateStyle(),this.backgrounds.css({width:e.container.width()-k.global.left-k.index.textarea.width-k.index.textarea.marginRight});var o=this.indexFormat=g.template(j[k.index.format]);this.indexs.text(function(b){return a&&a[b]&&""!==a[b].content?o&&o({i:b+1})||b+1:""}).css({background:function(b){return a&&a[b]&&k.index.background&&""!==a[b].content&&k.index.background||"transparent"}}),this.contents.each(function(b){var c=f(this);c.text(a&&a[b]&&a[b].content||""),a[b]&&""!==a[b].content&&c.width()+2*k.content.textarea.fontSize>c.parent().width()&&e.startMarquee(c,b)});var i=k.bar.colors;this.scales=g.map(i,function(a,b,c){return 0==b?null:h.scale([c[b-1].color,a.color]).mode("lch").domain([c[b-1].pos,a.pos])}),k.bar.show&&this.bars.css({width:function(b){return 0!==e.max&&a[b]?a[b].value/e.max*(e.container.width()-k.global.left-k.index.textarea.width-k.index.textarea.marginRight):"0"},background:function(b){return"all"===k.bar.colorMap?e.calBg(1,c.scales):e.calBg(0!==e.max&&a[b]?a[b].value/e.max:0,c.scales)}}),this.setNextData((this.page+1)%this.pageSum),this.startAnimate(),this.visibleEventAdd||document.addEventListener("visibilitychange",function(){var a=document.visibilityState;"visible"===a?c.startAnimate():"hidden"===a&&c.clearAnimates()}),this.visibleEventAdd=!0}},calBg:function(a,b){var c=this.config,d=this.data(),e=c.bar.colors,f="",g=0;if(b){for(;e[g]&&a>=e[g].pos;)f+=e[g].color+" "+100*(e[g].pos*a)+"%,",g++;return e[g]&&a<e[g].pos&&(f+=b[g]&&b[g](a)+" 100%,"),"linear-gradient(90deg, "+f.slice(0,-1)+")"}},startAnimate:function(){var a=this.config;this.startFlashAnimate(0),this.marqueeAnimates&&this.marqueeAnimates.forEach(function(b){return b.play()}),a.global.isFlip&&(this.flipPageStopTimer=setTimeout(this.startFlipPageAnimate.bind(this,0,(this.page+1)%this.pageSum),a.global.flipStopTime))},startFlipPageAnimate:function(b,c){function d(f){e.animateFrameTimer[b]&&cancelAnimationFrame(e.animateFrameTimer[b]),f.currentTime>=i.flipTime?(f.cancel(),o.width()+2*h.content.textarea.fontSize>o.parent().width()&&e.startMarquee(o,b),b+1>=g&&(e.startFlashAnimate(0),e.nextMax&&e.max!=e.nextMax&&(e.max=e.nextMax),e.setNextData((e.page+1)%e.pageSum),clearTimeout(e.flipPageStopTimer),e.flipPageStopTimer=setTimeout(e.startFlipPageAnimate.bind(e,0,(e.page+1)%e.pageSum),h.global.flipStopTime))):e.animateFrameTimer[b]=requestAnimationFrame(d.bind(e,f)),f.currentTime>=v&&j&&(j=!1,b+1<g&&e.startFlipPageAnimate(b+1,c)),f.currentTime>=w&&k&&(k=!1,l.text(m).css("background",n),o.text(p),q.css({width:r,background:s}),t.css({background:u}))}var e=this,g=this.flipPageAnimates.length,h=this.config,i=h.global,a=1e3/60/i.flipTime,j=!0,k=!0;c!=this.page&&(this.page=c),0===b&&this.clearAnimates();var l=f(e.indexs.get(b)),m=l.data("next"),n=l.data("next-bg"),o=f(e.contents.get(b)),p=o.data("next"),q=f(e.bars.get(b)),r=q.data("next-width"),s=q.data("next-bg"),t=f(e.backgrounds.get(b)),u=t.data("next-bar-bg"),v=((i.playBackNext||0.49999)-(b*i.playPad||0))*i.flipTime,w=(i.playBackNext||0.49999)*i.flipTime;this.flipPageAnimates[b].play(),d(this.flipPageAnimates[b])},startFlashAnimate:function(b){function c(i){d.flashFrameTimer&&cancelAnimationFrame(d.flashFrameTimer),i.currentTime>g.duration?i.cancel():d.flashFrameTimer=requestAnimationFrame(c.bind(d,i)),i.currentTime>=(g.playBackNext||0.5)*g.duration&&h&&(h=!1,b+1>=e?d.flashStopTimer=setTimeout(d.startFlashAnimate.bind(d,0),f.light.stopTime):d.startFlashAnimate(b+1))}var d=this,e=this.flashAnimates.length,f=this.config,g=f.light,a=1e3/60/g.duration,h=!0;0==b&&this.clearFlashAnimate(),this.flashAnimates[b]&&this.flashAnimates[b].play(),c(this.flashAnimates[b])},updateOptions:function(a){this.mergeConfig(a),this.render()},updateStyle:function(){var b=this.config,c=this;this.clearAnimates(),this.container.css({fontFamily:"\""+b.global.fontFamily+"\""}),this.lines.css({height:b.global.height+"px",marginBottom:b.global.padding+"px"}),this.indexs.css(b.index.textarea),this.contents.css(b.content.textarea),this.backgrounds.not(this.backgrounds.last()).css({background:b.background.color,borderRadius:b.background.borderRadius}),this.flipPageAnimates=[],this.lines.each(function(){var d=this.animate([{transform:"translate3d(0,0,0) rotateX(0deg)",easing:"ease"},{transform:"translate3d(0,0,0) rotateX(-90deg)",offset:0.499998},{transform:"translate3d(0,0,0) rotateX(-270deg)",offset:0.499999,easing:"ease"},{transform:"translate3d(0,0,0) rotateX(-360deg)"}],{duration:b.global.flipTime,fill:"backwards"});d.pause(),c.flipPageAnimates.push(d)}),this.bars.css({borderRadius:b.bar.borderRadius}),this.flashAnimates=[],b.light.show&&this.lights.each(function(){var d=this.animate([{transform:"translate3d(-100%, 0, 0)"},{transform:"translate3d(200%, 0, 0)"}],{duration:b.light.duration,fill:"backwards",easing:"ease-out"});d.pause(),c.flashAnimates.push(d)})},resize:function(){this.render()},clearFlashAnimate:function(){this.flashAnimates.length&&this.flashAnimates.forEach(function(b){return b.cancel&&b.cancel()}),this.flashFrameTimer&&cancelAnimationFrame(this.flashFrameTimer),this.flashStopTimer&&clearTimeout(this.flashStopTimer)},clearMarqueeAnimate:function(){this.marqueeAnimates.length&&this.marqueeAnimates.forEach(function(b){return b.cancel&&b.cancel()}),clearTimeout(this.marqueeAnimates)},clearFlipPageAnimate:function(){this.flipPageAnimates.length&&this.flipPageAnimates.forEach(function(b){return b.cancel&&b.cancel()}),this.animateFrameTimer.length&&this.animateFrameTimer.forEach(function(b){return b&&cancelAnimationFrame(b)}),this.flipPageStopTimer&&clearTimeout(this.flipPageStopTimer)},clearAnimates:function(){this.clearFlashAnimate(),this.clearFlipPageAnimate(),this.clearMarqueeAnimate()},setNextData:function(a){var b=this,c=this.config,d=this.data(),e=this;if(d&&d.length){var g=a*c.global.quantity;this.indexs.each(function(a,e){f(e).data("next",d[g+a]&&""!==d[g+a].content?b.indexFormat&&b.indexFormat({i:g+a+1})||g+a+1:"").data("next-bg",d[g+a]&&c.index.background&&""!==d[g+a].content?c.index.background:"transparent")}),this.contents.each(function(a,b){f(b).data("next",d[g+a]&&d[g+a].content||"")}),this.bars.each(function(a,h){var i=0!==b.max&&d[g+a]?d[g+a].value/b.max:0;f(h).data("next-width",i*(e.container.width()-c.global.left-c.index.textarea.width-c.index.textarea.marginRight)).data("next-bg",b.calBg("all"===c.bar.colorMap?1:i,e.scales))}),this.backgrounds.each(function(a,b){f(b).data("next-bar-bg",d[g+a]&&c.background.color&&""!==d[g+a].content?c.background.color:"transparent")})}},data:function(a,b){var c=this.config;if(a&&a.length){this._data=g.orderBy(a,function(a){return g.toNumber(a.value)},["desc"]);var d=this._data[0]&&this._data[0].value?g.toNumber(this._data[0].value):0;this.max?this.nextMax=d:this.max=d;var e=Math.ceil(this._data.length/c.global.quantity)||0;this.pageSum||(this.pageSum=e)}if(b){var f=this._data[0]&&this._data[0].value?g.toNumber(this._data[0].value):0;this.max=f;var h=Math.ceil(this._data.length/c.global.quantity)||0;this.pageSum=h}return this._data},mergeConfig:function(a){return a?(a.bar&&a.bar.colors&&(this.config.bar.colors=a.bar.colors),this.config=g.defaultsDeep(a||{},this.config),this.config.index.textarea.width="string"===typeof this.config.index.textarea.width?Number.parseFloat(this.config.index.textarea.width):this.config.index.textarea.width,this.config):this.config},updateLayout:function(){},startMarquee:function(a,b){var c=this.config,d=a.width();if(c.content.marquee.show){a.html(a.text()+"<i style=\"width:"+2*c.content.textarea.fontSize+"px\"></i>"+a.text())+"<i style=\"width:"+2*c.content.textarea.fontSize+"px\"></i>";this.marqueeAnimates[b]=a.get(0).animate([{transform:"translate3d(0, 0, 0)",easing:"linear"},{transform:"translate3d("+-(d+20)+"px, 0, 0)"}],{duration:c.content.marquee.duration,iterations:Infinity})}},destroy:function(){this.clearAnimates(),this.flashAnimates=null,this.flipPageAnimates=null,this.flashFrameTimer=null,this.flashStopTimer=null,this.flipPageStopTimer=null,this.indexs=null,this.marqueeAnimates=null,this.scales=null,this._data=null,this.contents=null,this.lights=null,this.lines=null,this.backgrounds=null,this.bars=null,this.container.empty()},clean:function(){this.rerender([{value:"0",content:""},{value:"0",content:""},{value:"0",content:""},{value:"0",content:""},{value:"0",content:""}]),this.startAnimate()}}),a.exports});