// env=undefined => env=publish 
Cube("datav:/com/datavmap-2d-layer-vectorfield/0.0.9/Particle",[],function(a){const b={maxParticleAge:90};return a.exports=class{constructor(a){this.options=Object.assign(b,a||{}),this.x=null,this.y=null,this.xt=null,this.yt=null,this.age=null,this.xLeft=null,this.xRight=null,this.yTop=null,this.yBottom=null}setPos(a,b){this.x=a,this.y=b}setAge(){let a=this.options,b=a.maxParticleAge;this.age=Math.floor(Math.random()*b)}setRange(a,b,c,d){this.xLeft=a,this.xRight=b,this.yTop=c,this.yBottom=d}},a.exports});;
Cube("datav:/com/datavmap-2d-layer-vectorfield/0.0.9/utils",[],function(a){const{cos:b,sin:c,PI:d,abs:e,asin:f,sqrt:g}=Math,i=(a)=>c(a/2)*c(a/2),j=(a)=>a*d/180;return a.exports={distributionFunc:function(a,b){return function(c){return Math.exp(-0.5*(c-a)*(c-a)/b)/(Math.sqrt(b)*Math.sqrt(2*Math.PI))}},computeDistance:function(a,c,d,e){a=j(a),d=j(d),c=j(c),e=j(e);const k=i(a-d)+b(a)*b(d)*i(c-e),h=2*6371.004*f(g(k));return h},computeCos:function(a,b){return(a.x*b.x+a.y*b.y)/(Math.sqrt(a.x*a.x+a.y*a.y)*Math.sqrt(b.x*b.x+b.y*b.y))},computeTimeInterval:function(a,b){const c=(a-b)/3600;return 0===c?1/60:c},fixNumber:(a)=>Math.round(1e5*a)/1e5,getCenter:(a,b,c,d,e)=>{let f=Math.floor((c.maxLat-a)/(c.maxLat-c.minLat)*e),g=Math.floor((b-c.minLng)/(c.maxLng-c.minLng)*d);return f=f===e?e-1:f,g=g===d?d-1:g,{x:g,y:f}}},a.exports});;
Cube("datav:/com/datavmap-2d-layer-vectorfield/0.0.9/Flow",["datav:/npm/chroma-js/1.3.3"],function(a,b,c){const d=c("datav:/com/datavmap-2d-layer-vectorfield/0.0.9/Particle"),e=c("datav:/npm/chroma-js/1.3.3"),f={velocityScale:5e-3*(Math.pow(window.devicePixelRatio,1/3)||1),maxParticleAge:90,lineWidth:1,nx:100,ny:100,slow:{velocity:5,color:"#B40023"},medium:{color:"#FCD97D"},fast:{velocity:50,color:"#2468B4"}};return a.exports=class{constructor(a){this.options=Object.assign(f,a),this.colorScale=this.getColorScale({slow:this.options.slow.color,medium:this.options.medium.color,fast:this.options.fast.color}),this.loopIndex=0,this.canvas=null,this.data=null,this.remove=this.remove.bind(this),this.stop=this.stop.bind(this)}addTo(a){return a?void(this.map=a):void error("needs a map")}setCanvas(a){a&&(this.canvas=a)}init(){this.bounds=this.getBounds(),this.mapBounds=this.getMapBounds();const a=this.mapBounds,b=(a.south-a.north)*(a.west-a.east);this.velocityScale=this.options.velocityScale*Math.pow(b,0.4)}getBounds(){let a=this.map.getSize(),b=a.x,c=a.y,d=[0,0],e=[b,c],f=Math.round(d[0]),g=Math.max(Math.floor(d[1],0),0),h=Math.min(Math.ceil(e[0],b),b-1),i=Math.min(Math.ceil(e[1],c),c-1);return{x:f,y:g,xMax:b,yMax:i,width:b,height:c}}getMapBounds(){let a=this.map.getSize(),b=a.x,c=a.y,d=this.map.getBounds(),e=d._southWest,f=d._northEast;return{south:this.deg2rad(e.lat),north:this.deg2rad(f.lat),east:this.deg2rad(f.lng),west:this.deg2rad(e.lng),width:b,height:c}}getColorScale(a){const b=e.scale([a.slow,a.medium,a.fast]).colors(15);return b.map((a)=>`rgb(${e(a).rgb().join()})`)}deg2rad(a){return a/180*Math.PI}rad2deg(a){return a/(Math.PI/180)}setData(a,b,c){a&&(this.gridData=a),b&&(this.options.nx=b),c&&(this.options.ny=c)}render(){this.stop(),this.init(),this.buildGrid(),this.interpolateField(),this.animate()}clearCtx(){if(this.ctx){const a=this.ctx.canvas.width,b=this.ctx.canvas.height;this.ctx.clearRect(0,0,a,b),this.ctx=null}}stop(){this.clearCtx(),this.columns=[],this.bounds=null,this.mapBounds=null,this.particles=[],this.buckets=[],this.colorStyles=null,this.bbx=null,this.originLat=null,this.originLng=null,this.gridXdeg=null,this.gridYdeg=null,this.vectorData=null,this.loopId&&window.cancelAnimationFrame(this.loopId),this.loopId=null,this.loopIndex=0}remove(){this.stop(),this.data=null,this.canvas=null,this.colorScale=null}buildGrid(){let a=this.gridData,b=this.bbx=a.bbx,c=this.options,d=c.nx,e=c.ny,f=this.originLng=b.minLng,g=this.originLat=b.maxLat,h=this.gridXdeg=(b.maxLng-b.minLng)/d,i=this.gridYdeg=(b.maxLat-b.minLat)/e,j=this.vectorData=a.data}interpolateField(){let a=this.options,b=this.bounds,c=this.mapBounds,d=this.columns=[];for(let a,e=b.x;e<b.width;e+=2){a=[];for(let d,f=b.y;f<=b.yMax;f+=2)if(d=this.invert(e,f,c),d){let b=d[0],g=d[1];if(isFinite(b)){let d=this.interpolate(b,g);d&&(d=this.distort(b,g,e,f,this.velocityScale,d,c),a[f+1]=a[f]=d)}}d[e+1]=d[e]=a}}animate(){let a=this.columns,b=this.gridData.data,c=this.options.nx,e=this.options.ny,f=this.bounds,g=this.options,h=g.maxParticleAge;const j=this.mapBounds;let i=this.colorStyles=this.windIntensityColorScale(g.slow.velocity,g.fast.velocity,g.velocityL),k=this.buckets=i.map(function(){return[]}),l=this.particles=[],m=this.originLat/180*Math.PI,n=this.originLng/180*Math.PI,o=this.gridXdeg/180*Math.PI,p=this.gridYdeg/180*Math.PI;for(let a=0,e=b.length;a<e;a++){let e=b[a],f=a%c,g=Math.floor(a/c),i=Math.floor((n-j.west+f*o)/(j.east-j.west)*j.width),k=Math.floor((n-j.west+(f+1)*o)/(j.east-j.west)*j.width),q=Math.floor((j.north-m+g*p)/(j.north-j.south)*j.height),r=Math.floor((j.north-m+(g+1)*p)/(j.north-j.south)*j.height),s=Math.floor(e.weight);if(!(i>j.width||q>j.height||0>k||0>r))for(let a=0;a<s;a++){let a=new d({maxParticleAge:h}),b=Math.round(Math.floor(Math.random()*(k-i))+i),c=Math.round(Math.floor(Math.random()*(r-q))+q);a.setPos(b,c),a.setAge(),a.setRange(i,k,q,r),l.push(a)}}let q=this.ctx=this.canvas.getContext("2d");q.lineWidth=g.lineWidth,q.fillStyle="rgba(0, 0, 0, 0.05)",q.globalAlpha=0.9,this.loop()}getField(a,b){let c=this.columns[Math.round(a)];return c&&c[Math.round(b)]||{u:NaN,v:NaN,m:null,weight:NaN}}evolve(){let a=this.bounds,b=this.options,c=b.maxParticleAge,d=this.buckets,e=this.particles,f=this.colorStyles,g=this;d.forEach(function(a){a.length=0}),e.forEach(function(a){if(a.age>c){let b=a.xLeft,c=a.xRight,d=a.yTop,e=a.yBottom,f=Math.round(Math.floor(Math.random()*(c-b))+b),g=Math.round(Math.floor(Math.random()*(e-d))+d);a.setPos(f,g),a.setAge()}let b=a.x,e=a.y,h=g.getField(b,e),i=h.m;if(null===i)a.age=c;else{let c=b+h.u,j=e+h.v;null===g.getField(c,j).m?(a.x=c,a.y=j):(a.xt=c,a.yt=j,d[f.indexFor(i)].push(a))}a.age+=1})}draw(){let a=this,b=this.buckets,c=this.ctx,d=this.bounds;c.globalCompositeOperation="destination-in",c.fillRect(d.x,d.y,d.width,d.height),c.globalCompositeOperation="lighter",c.globalAlpha=0.9,c.fillStyle="rgba(0, 0, 0, 0.05)",b.forEach(function(b,d){0<b.length&&(c.beginPath(),c.strokeStyle=a.colorStyles[d],b.forEach(function(a){c.moveTo(a.x,a.y),c.lineTo(a.xt,a.yt),a.x=a.xt,a.y=a.yt}),c.stroke())})}loop(){this.loopIndex++,this.loopIndex%=3,0===this.loopIndex&&(this.evolve(),this.draw()),this.loopId=window.requestAnimationFrame(this.loop.bind(this))}windIntensityColorScale(a,b,c){const d=this.colorScale;return d.indexFor=function(e){return Math.max(0,Math.min(d.length-1,Math.round((e/c-a)/(b-a)*(d.length-1))))},d}bilinearInterpolateVector(e,f,g,h,i,j){let k=1-e,l=1-f,m=k*l,a=e*l,b=k*f,c=e*f,d=g.u*m+h.u*a+i.u*b+j.u*c,n=g.v*m+h.v*a+i.v*b+j.v*c,o=g.weight*m+h.weight*a+i.weight*b+j.weight*c;return{u:d,v:n,m:Math.sqrt(d*d+n*n),weight:o}}interpolate(a,b){let c=this.options,d=c.nx,e=c.ny,f=this.vectorData;if(!f)return null;let g=this.floorMod(a-this.originLng,360)/this.gridXdeg,h=(this.originLat-b)/this.gridYdeg,i=Math.floor(g),j=i+1,k=Math.floor(h),l=k+1;if(i>d||k>e||0>i||0>k)return null;let m=f[i+(k-1)*d],n=f[j+(k-1)*d],o=f[i+(l-1)*d],p=f[j+(l-1)*d];return this.isValue(m)&&this.isValue(n)&&this.isValue(o)&&this.isValue(p)?this.bilinearInterpolateVector(g-i,h-k,m,n,o,p):null}isValue(a){return null!==a&&void 0!==a}floorMod(b,a){return b-a*Math.floor(b/a)}invert(a,b,c){let d=c.east-c.west,e=360*(c.width/this.rad2deg(d))/(2*Math.PI),f=e/2*Math.log((1+Math.sin(c.south))/(1-Math.sin(c.south))),g=c.height+f,h=180/Math.PI*(2*Math.atan(Math.exp((g-b)/e))-Math.PI/2),i=this.rad2deg(c.west)+a/c.width*this.rad2deg(d);return[i,h]}mercY(a){return Math.log(Math.tan(a/2+Math.PI/4))}project(a,b,c){let d=this.mercY(c.south),e=this.mercY(c.north),f=c.width/(c.east-c.west),g=c.height/(e-d),h=this.mercY(this.deg2rad(a)),i=(this.deg2rad(b)-c.west)*f;return h=(e-h)*g,[i,h]}distort(a,b,c,e,f,g,h){let i=g.u*f,j=g.v*f,k=this.distortion(a,b,c,e,h);return g.u=k[0]*i+k[2]*j,g.v=k[1]*i+k[3]*j,g}distortion(a,b,c,d,e){let f=2*Math.PI,g=Math.pow(10,-5.2),h=0>a?g:-g,i=0>b?g:-g,j=this.project(b,a+h,e),l=this.project(b+i,a,e),m=Math.cos(b/360*f);return[(j[0]-c)/h/m,(j[1]-d)/h/m,(l[0]-c)/i,(l[1]-d)/i]}},a.exports});;
Cube("datav:/com/datavmap-2d-layer-vectorfield/0.0.9/VectorField.js",[],function(a,b,c){const d=c("datav:/com/datavmap-2d-layer-vectorfield/0.0.9/utils"),e=d.distributionFunc,f=d.computeDistance,g=d.computeCos,h=d.computeTimeInterval,k=d.fixNumber,j=d.getCenter,i={intensityThreshold:5,velocityThreshold:500,directions:[0,180],maxIterations:100,gridW:100,gridH:100,weightL:1,velocityL:0.4};return a.exports=class{constructor(a){this.options=Object.assign(i,a),this.velocity=[],this.newVelocity=[],this.radius=[],this.dist=[]}setData(a){if(!a||1>a.length)return console.log("No data");this.bbx={minLat:a.bbx[0],maxLat:a.bbx[1],minLng:a.bbx[2],maxLng:a.bbx[3]},this.data=a.trajectories,this.gridCenter={x:[],y:[]};const{gridW:b,gridH:c}=this.options,{minLat:d,maxLat:e,minLng:f,maxLng:g}=this.bbx;for(let b=0;b<c;b++)this.gridCenter.y.push(k(e-(e-d)/c*(b+0.5)));for(let c=0;c<b;c++)this.gridCenter.x.push(k(f+(g-f)/b*(c+0.5)))}getVectorFields(){const{dataType:a}=this.options,b=1===a?this.genVectors():this.genVectors_GPS(),c=this.filterVectors(b),d=this.genMajorVectors(c),e=this.genVectorFields(d);return{bbx:this.bbx,data:e}}genVectors_GPS(){let a=new Map;const{data:b,bbx:c,gridCenter:d}=this,{gridW:e,gridH:g}=this.options;return b.forEach((b)=>{let k,i,l,m,n,o;for(let p=0;p<b.length;p++){const q=b[p][0],r=b[p][1],s=b[p][2],{x:t,y:u}=j(q,r,c,e,g),v=d.y[u],w=d.x[t];if(!k)k={gridLat:v,gridLng:w,time:s};else if(k.gridLat!==v||k.gridLng!==w){if(i=`${k.gridLat},${k.gridLng}|${v},${w}`,m=f(k.gridLat,k.gridLng,v,w),n=h(s,k.time),o=m/n,k={gridLat:v,gridLng:w,time:s},this.velocity.push(o),this.dist.push(m),0===m&&console.warn("Dist is 0"),o>this.options.velocityThreshold)continue;l=a.get(i),l?a.set(i,{peopleAmount:l.peopleAmount+1,timeSum:l.timeSum+n}):a.set(i,{peopleAmount:1,timeSum:n})}}}),a}genVectors(){let a=new Map,b=this.data;return b.forEach((b)=>{let c,d,e,g,j,k,l;for(let m=0;m<b.length;m++)if(!c)c=b[m];else{if(d=b[m],e=c.slice(0,2).join(",")+"|"+d.slice(0,2).join(","),j=f(d[0],d[1],c[0],c[1]),k=h(d[2],c[2]),l=j/k,c=d,this.velocity.push(l),this.dist.push(j),0===j&&console.warn("Dist is 0"),l>this.options.velocityThreshold)continue;g=a.get(e),g?a.set(e,{peopleAmount:g.peopleAmount+1,timeSum:g.timeSum+k}):a.set(e,{peopleAmount:1,timeSum:k})}}),a}filterVectors(a){let b=new Map,c=new Map;return a.forEach((a,d)=>{const{peopleAmount:e,timeSum:f}=a;if(e>=this.options.intensityThreshold){let e=d.split("|")[0],g=d.split("|")[1];const h=+g.split(",")[1],i=+g.split(",")[0],j=`${i},${h}`,k=+e.split(",")[1],l=+e.split(",")[0],m=`${l},${k}`;let n=a.peopleAmount,o={x:h-k,y:i-l,peopleAmount:n,timeSum:f},p=b.get(j),q=c.get(m);p?p.push(o):b.set(j,[o]),q?q.push(o):c.set(m,[o])}}),{inVectors:b,outVectors:c}}genMajorVectors(a){const b=this.calRanges(this.options.directions);let c=this.calMajorVectorsByDirection(a.inVectors,this.options.directions,b),d=this.calMajorVectorsByDirection(a.outVectors,this.options.directions,b);return{majorInVectors:c,majorOutVectors:d}}calRanges(a){let b=[];return a.forEach((c,d)=>{let e=0===d?a[a.length-1]+360:a[d-1],f=d===a.length-1?a[0]+360:a[d+1],g=0.5*(e+c)/180*Math.PI,h=0.5*(c+f)/180*Math.PI;g<h?b.push({min:g,max:h,index:d}):(b.push({min:g,max:2*Math.PI,index:d}),b.push({min:0,max:h,index:d}))}),b}calMajorVectorsByDirection(a,b,c){let d=Array.apply(0,Array(b.length)).map(()=>new Map);return a.forEach((a,e)=>{let h=Array.apply(0,Array(b.length)).map(()=>[]);a.forEach((a)=>{let b=Math.atan2(a.y,a.x);b=0>b?b+2*Math.PI:b;for(let d=0;d<c.length;d++)b>=c[d].min&&b<c[d].max&&h[c[d].index].push(a)}),h.forEach((a,b)=>{if(a.length){let c=0,h=0,i=0,j=a.map((a)=>(c+=a.peopleAmount,h+=a.timeSum,i+=a.peopleAmount*f(+e.split(",")[0],+e.split(",")[1],+e.split(",")[0]+a.y,+e.split(",")[1]+a.x),{x:a.peopleAmount*Math.cos(Math.atan2(a.y,a.x)),y:a.peopleAmount*Math.sin(Math.atan2(a.y,a.x))})),k=j.reduce((b,c)=>b+=c.x,0)/j.length,l=j.reduce((b,c)=>b+=c.y,0)/j.length;const m=i/c;this.radius.push(m);let n=j.reduce((b,c)=>{let a=(c.x*k+c.y*l)/(Math.sqrt(c.x*c.x+c.y*c.y)*Math.sqrt(k*k+l*l));a=1<a?1:a,a=-1>a?-1:a;let d=Math.acos(a);return b+=d},0)/j.length,o=15/180*Math.PI,p=Math.cos(n<o?o:n),q=a.reduce((a,b)=>{const c=g(b,{x:k,y:l});return a+=b.peopleAmount*f(0,0,b.y,b.x)*(isNaN(c)?0:c),a},0)/h;this.newVelocity.push(q),d[b].set(e,{x:k,y:l,radius:m,velocity:q,cosThreshold:p})}})}),d}genVectorFields(a){const b=this.options,c=this.bbx,d=b.gridW,e=b.gridH,f=b.weightL,g=b.velocityL;let h=[];for(let b,j=0;j<this.options.directions.length;j++)b=Array.apply(0,Array(d)).map(()=>Array.apply(0,Array(e)).map(()=>[])),this.diffusion(a.majorInVectors[j],b,c,d,e,f,g,!1),this.diffusion(a.majorOutVectors[j],b,c,d,e,f,g,!0),h.push(b);let i=this.aggregateVectors(h,d,e);return i}diffusion(a,b,c,d,h,i,j,k){let l=(c.maxLng-c.minLng)/d,o=(c.maxLat-c.minLat)/h;const p=e(0,0.5),q=e(0,2);a.forEach((a,e)=>{let r={lat:+e.split(",")[0],lng:+e.split(",")[1]};const s=a.radius,t=a.cosThreshold,u=function(a){return 2.4/(1-t)*(1-Math.abs(a))},v=function(a){return 5/s*a};for(let w=0;w<d;w++)for(let d=0;d<h;d++){let e=c.minLng+(w+0.5)*l,h=c.maxLat-(d+0.5)*o,m={x:e-r.lng,y:h-r.lat},n=g(m,a),x=f(0,0,m.x,m.y),y=k?n>t&&x<s:n<-t&&x<s;if(y){let c=this.computeWeight(a,n,x,i,p,q,u,v);0!==a.y||0!==a.x;let e={x:j*a.velocity*Math.cos(Math.atan2(a.y,a.x)),y:j*a.velocity*Math.sin(Math.atan2(a.y,a.x)),weight:c};b[w][d].push(e)}}})}computeWeight(a,b,c,d,e,f,g,h){const i=g(b),j=h(c);let k=e(i)*f(j)*d,l=k*Math.sqrt(a.x*a.x+a.y*a.y);return l}aggregateVectors(a,b,c){let d=Array.apply(0,Array(a.length)).map(()=>[]);for(let e=0;e<a.length;e++)for(let f=0;f<c;f++)for(let c=0;c<b;c++){if(0===a[e][c][f].length){a[e][c][f]={x:0,y:0},d[e].push({u:0,v:0,weight:0});continue}a[e][c][f]=this.getMeanVector(a[e][c][f]),d[e].push({u:a[e][c][f].x,v:a[e][c][f].y,weight:a[e][c][f].weight})}return d}getMeanVector(a){let b=a.map((a)=>Math.atan2(a.y,a.x)),c=0,d=0;b=b.map((a)=>{let b=(a+2*Math.PI)%(2*Math.PI);return c+=b,d+=b*b,b}),b.sort((c,a)=>c-a);let e=Infinity,f=b.length,g=0;for(let h=-1;h<f;h++){0<=h&&(c+=2*Math.PI,d+=4*Math.PI*b[h]+4*Math.PI*Math.PI);let a=c/f,i=d-2*c*a+f*a*a;i<e&&(g=a,e=i)}let h={x:Math.cos(g),y:Math.sin(g)},i=0,j=0;a.forEach((a)=>{let b=a.x*h.x+a.y*h.y,c=a.weight*b/Math.sqrt(a.x*a.x+a.y*a.y);i+=b,j+=c});let k={x:h.x*i/f,y:h.y*i/f,weight:j/f};return k}},a.exports});;
Cube("datav:/com/datavmap-2d-layer-vectorfield/0.0.9/VectorfieldLayer.js",[],function(a,b,c){const d=c("datav:/com/datavmap-2d-layer-vectorfield/0.0.9/Flow");let e=null,f=0;return a.exports=function(a){const b=a.datavUtils,c={displayValues:!0};return e||(e=class extends a.Layer{constructor(a){super(),this.options=b.mergeOptions(c,a),this.map=null,this.data=null,this.canvasLayer=null,this.flow=null}addTo(a){a&&(this.map=a,this.init())}init(){const b=this.map;this.canvasLayer=new a.CanvasLayer,this.canvasLayer.addTo(b),this.canvasLayer.canvas.classList.add("velocity-overlay"),this.canvasLayer.canvas.classList.add(`layer${f++}`)}createFlow(){this.flow&&(this.flow.remove(),this.flow=null);const{gridW:a,gridY:b,velocityL:c,slow:e,medium:f,fast:g}=this.options;this.flow=new d({nx:a,ny:b,slow:e,medium:f,fast:g,velocityL:c}),this.flow.addTo(this.map),this.flow.setCanvas(this.canvasLayer.canvas),this.flow.setData(this.data,this.options.gridW,this.options.gridH)}updateOptions(a){this.options=b.mergeOptions(this.options,a)}setData(a){a&&(this.data=a)}render(){this.options.displayValues?(this.map.L.DomUtil.setOpacity(this.canvasLayer.canvas,1),this.createFlow(),this.flow.render()):(this.map.L.DomUtil.setOpacity(this.canvasLayer.canvas,0),this.flow&&this.flow.remove(),this.flow=null)}remove(){this.flow&&this.flow.remove(),this.flow=null,this.map.removeLayer(this.canvasLayer)&&this.map.L.DomUtil.remove(this.canvasLayer.canvas)}})},a.exports});;
Cube("datav:/com/datavmap-2d-layer-vectorfield/0.0.9",["datav:/npm/bcore/0.0.21/event"],function(a,b,c){var d=c("datav:/npm/bcore/0.0.21/event"),e=c("datav:/com/datavmap-2d-layer-vectorfield/0.0.9/VectorField.js"),f=null,g=c("datav:/com/datavmap-2d-layer-vectorfield/0.0.9/VectorfieldLayer.js");let h=null;return a.exports=class extends d{constructor(a,b){super(),"string"===this.container?document.querySelector(a):a,this.apis=b.apis,this.options=b,this.map=null,this.data=null,this.vfdata=null,this.layer=[],this.colors=null}addTo(a){this.map=a,f=a.L.datavUtils,this.initCom()}initCom(){let a=this.map,b=this.options;h=new g(a.L),a.on("dragend",this.render,this),a.on("zoomend",this.render,this),a.on("resize",this.render,this)}updateOptions(a){if(a)if(a.directions.length===this.options.directions.length){let b=!1;for(let c=0;c<a.directions.length;c++)if(a.directions[c].show!==this.options.directions[c].show){b=!0;break}this.options=f.mergeOptions(this.options,a),this.directionsDistinctSort(),b||this.computeVF(),this.render()}else this.options=f.mergeOptions(this.options,a),this.directionsDistinctSort(),this.removeLayers(),this.setData(this.data)}computeVF(){const a=this.data;let b=Object.assign({},this.options);b.directions=this.options.directions.map((a)=>a.angle);let c=new e(b);c.setData(a),this.vfdata=c.getVectorFields()}render(){for(let a,b=0;b<this.layer.length;b++)a=this.layer[b],a.updateOptions(Object.assign({displayValues:this.options.directions[b].show},this.options)),a.setData({bbx:this.vfdata.bbx,data:this.vfdata.data[b]}),a.render()}setData(a){if(!a||!a.bbx||!a.trajectories)return console.log("No data");if(!this.map)return;let b=this.map;this.data=a,this.computeVF(this.data),this.layer.length||this.vfdata.data.forEach(()=>{let a=new h(this.options);this.layer.push(a),a.addTo(b)}),this.render()}remove(){this.removeLayers(),this.data=null,this.map.off("dragend",this.render,this),this.map.off("zoomend",this.render,this),this.map.off("resize",this.render,this)}removeLayers(){this.layer.length&&this.layer[0].remove&&this.layer.forEach((a)=>a.remove()),this.layer=[]}directionsDistinctSort(){let a=new Map;this.options.directions.forEach((b)=>{a.has(b.angle)||a.set(b.angle,b)}),this.options.directions=[...a.values()].sort((c,a)=>c.angle-a.angle)}},a.exports});