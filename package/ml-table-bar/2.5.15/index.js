// env=undefined => env=publish 
Cube("datav:/com/ml-table-bar/2.5.15",["datav:/npm/bcore/0.0.18/event","datav:/npm/jquery/2.1.4","datav:/npm/lodash/4.6.1","datav:/npm/animejs/3.1.0"],function(t,e,i,n,a,o){var r=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var i,n=arguments[e];for(i in n)Object.prototype.hasOwnProperty.call(n,i)&&(t[i]=n[i])}return t},s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};function f(t){t&&t.seek&&t.pause&&(t.complete=function(){},t.seek(t.duration),t.pause())}var l=i("datav:/npm/bcore/0.0.18/event"),w=i("datav:/npm/jquery/2.1.4"),S=i("datav:/npm/lodash/4.6.1"),d=i("datav:/npm/animejs/3.1.0"),A=S.template('<div class="table-line" style="position: relative;"><div class="rotate" style="display: flex; align-items: center;"><%= index %><%= content %><%= value %></div><%= bar %><div class="line-segment"><%= light %></div></div>'),z=S.template('<span class="table-index" style="<% _.forIn(innerStyle, function (val, key) { %><%- key %>:<%- val %>;<% })%>"><%= value %></span>'),q=S.template('<div class="table-content" style="position: relative;display: flex;vertical-align: bottom;<% _.forIn(innerStyle, function (val, key) { %><%- key %>:<%- val %>;<% })%>"><div class="inner"><%= value %></div></div>'),L=S.template('<div class="table-bar"><div class="light"></div></div>'),C={1:"<%= i %>",2:"NO.<%= i %>",3:"(<%= i %>)"};return t.exports=l.extend(function(t,e){this.config={rotate:!0,global:{duration:2e3,padding:8,quantity:5,animation:!0,sort:{show:!0,sort:"desc"}},index:{show:!0,format:null,fontSize:16,fontWeight:"normal",color:"#fff",padding:10},content:{format:null,fontSize:16,fontWeight:"normal",color:"#fff",marquee:{show:!0,duration:8e3}},number:{show:!1,fontSize:16,fontWeight:"normal",color:"#fff",prefixSuffix:{prefixContent:"",suffixContent:"",marginLeft:0,marginRight:0},separatingChart:!0},bar:{show:!0,color:"#1371FB",height:4},light:{show:!0,color:"#28f8ff",width:70,height:1},segment:{show:!0,color:"#1371fb"}},this.container=w(t).css("transform","translate3d(0,0,0)"),this.apis=e.apis,this._data=[],this.__data=[],this.chart=null,this.isFirst=!0,this.max=0,this.duration=500,this.rotateAnimates=[],this.rotateAnimate,this.marqueeAnimate,this.lightAnimate,this.rotates=null,this.index=0,this.fresh=!0,this.init(e)},{init:function(t){this.mergeConfig(t)},clear:function(t,e){var i=this.config;this.clearAnimates(),this.data()&&t&&t.length!==this.data().length&&(this.isFirst=!0,this.index=0),e&&e.global&&(e.global.quantity===i.global.quantity&&e.global.loop===i.global.loop||(this.isFirst=!0,this.index=0,this.fresh=!0),e.segment.show!==i.segment.show&&(this.isFirst=!0,this.index=0,this.fresh=0))},render:function(t,e){this.clear(t,e),this.fresh||!this.config.global.loop?this.rerender(t,e):(S.isEqual(e,this.config)||this.rerender(t,e),this.mergeConfig(e),this.data(t))},rerender:function(t,e){var i=this;t=this.data(t);var n=this.mergeConfig(e);if(this.container.css("font-family",'"'+n.global.fontFamily+'", Arial, sans-serif'),t){this.index+n.global.quantity>t.length&&(this.isFirst=!0);var a=this.container,o=n.index.textarea,r=n.content.textarea,s=n.content.marquee,l=Math.min(this.index+n.global.quantity,t.length);this.rotates&&l-this.index!==this.rotates.length&&(this.isFirst=!0);var h=S.template(C[n.index.format]),e=n.number.prefixSuffix,f=e.prefixContent,d=e.suffixContent,c=e.marginLeft,u=e.marginRight,e=n.number.separatingChart;if(t=e?this.switchThousandthsOrNum(t,1):this.switchThousandthsOrNum(t,2),this.isFirst){this.clearAnimates(),a.empty();for(var g="",m=this.index;m<l;m++){var p=t[m],b=n.index.show?z({value:n.index.format&&h({i:m+1})||m+1,innerStyle:S.defaultsDeep(n.index.innerStyle||{},{color:o.color,"font-size":o.fontSize+"px","font-weight":o.fontWeight,"padding-right":n.index.padding+"px",width:n.index.width||"auto",flex:"none"})}):"",v=q({value:n.content.format&&n.content.format.call(this,p,m)||p.content||"",innerStyle:S.defaultsDeep(n.content.innerStyle||{},{color:r.color,"font-size":r.fontSize+"px","font-weight":r.fontWeight,overflow:s.show?"hidden":"auto","white-space":s.show?"nowrap":"normal",flex:"auto"})}),x=n.number&&n.number.show&&'\n          <div\n            class="number"\n            style=" color: '+n.number.color+"; font-size: "+n.number.fontSize+"px; font-weight: "+n.number.fontWeight+'; white-space: nowrap;"\n            >'+f+'<span style="margin-left: '+c+"px; margin-right: "+u+'px;">'+p.value+"</span>"+d+"</div>\n          "||"",y=n.bar.show&&L()||"";g+=A({index:b,content:v,value:x,bar:y,light:n.bar.show?"":'<div class="light"></div>'})}a.append(g),this.isFirst=!1,a.find(".light").css({position:"absolute",left:"0",top:"0",width:n.light.width+"px",height:n.light.height+"px",background:"radial-gradient("+n.light.color+" 5%, rgba(0,0,0,0) 80%)",transform:"translateX(-"+n.light.width+"px)",transition:"none"}),this.rotates=a.find(".rotate"),this.tableLines=a.find(".table-line"),this.updateStyle(),this.cacheHeight(),setTimeout(this.loopLight.bind(this),500)}else{for(m=this.index;m<l;m++){p=t[m];b=n.index.show?z({value:n.index.format&&h({i:m+1})||m+1,innerStyle:S.defaultsDeep(n.index.innerStyle||{},{color:o.color,"font-size":o.fontSize+"px","font-weight":o.fontWeight,"padding-right":n.index.padding+"px",width:n.index.width||"auto",flex:"none"})}):"",v=q({value:n.content.format&&n.content.format.call(this,p,m)||p.content||"",innerStyle:S.defaultsDeep(n.content.innerStyle||{},{color:r.color,"font-size":r.fontSize+"px","font-weight":r.fontWeight,overflow:s.show?"hidden":"auto","white-space":s.show?"nowrap":"normal",flex:"auto"})}),x=n.number&&n.number.show&&'\n          <div\n            class="number"\n            style=" color: '+n.number.color+"; font-size: "+n.number.fontSize+"px; font-weight: "+n.number.fontWeight+"; padding-left: "+n.number.padding+'px; white-space: nowrap;"\n          >'+f+'<span style="margin-left: '+c+"px; margin-right: "+u+'px;">'+p.value+"</span>"+d+"</div>\n          "||"",w(i.rotates[m-this.index]).data("next",b+v+x)}this.updateStyle(),Math.max(n.index.textarea.fontSize,n.content.textarea.fontSize)!==Math.max(parseInt(i.rotates.find(".table-index").css("font-size")),parseInt(i.rotates.find(".table-content").css("font-size")))&&this.cacheHeight()}a.find(".table-line:gt("+(this.index+l)+")").remove(),n.rotate?this.rotate(this.tableLines):a.find(".table-line").find(".rotate").each(function(){var t=w(this);t.html(t.data("next")||t.html())})}i=this;this.fresh=!1,this.globalLoop&&clearTimeout(this.globalLoop),n.global.loop&&(this.globalLoop=setTimeout(function(){i.index=i.index+n.global.quantity>=(t&&t.length||0)?0:i.index+n.global.quantity,i.rerender()},n.global.looptime))},cacheHeight:function(){var t=this.config;this.rotates.each(function(){w(this).css("height",Math.max(t.index.textarea.fontSize,t.content.textarea.fontSize)+t.global.padding+"px")})},switchThousandthsOrNum:function(t,e){var i=this;return S.map(t,function(t){return r({},t,{value:1===e?i.formatData(t.value):S.replace(t.value,/,/g,"")})})},formatData:function(t){return S.includes(t+="",".")||(t+="."),S.replace(S.replace(t,/(\d)(?=(\d{3})+\.)/g,"$1,"),/\.$/,"")},resize:function(t,e){this.render()},data:function(t){var e=this.config,i=S.get(e,"global.sort"),e=i.show,i=i.sort,t=t||this.__data;return this.__data=this._data=e?S.orderBy(t,function(t){return S.toNumber(t.value)},[i]):t,this._data},mergeConfig:function(t){return t&&(t&&t.bar&&(t.bar.color=function(t){if(!t)return"#fff";if("string"==typeof t)return t;if("object"===(void 0===t?"undefined":s(t))&&t.type){var e=t.value,t=t.type;if("flat"===t)return e;if("linearGradient"===t){t=e.stops,e=e.angle;return t.sort(function(t,e){return t.offset-e.offset}),"linear-gradient("+e+"deg, "+t.map(function(t){return t.color+" "+t.offset+"%"}).join(",")+")"}}}(t.bar.color)),this.config=S.defaultsDeep(t||{},this.config)),this.config},updateLayout:function(){},updateStyle:function(t){var e=this.config;t=t||this.container,this.tableLines.css({perspective:"250px",perspectiveOrigin:"50% 100%"}),this.rotates.css({marginBottom:e.global.padding+"px",position:"relative",transformStyle:"preserve-3d",transformOrigin:"50% 50%",transform:"rotateX(0deg) translateZ(0)",width:"100%",willChange:"transform"}),e.bar.show&&t.find(".table-bar").each(function(t){w(this).css({height:e.bar.height+"px",background:e.bar.color,display:"inline-block",overflow:"hidden",position:"absolute",bottom:"0",left:"0","z-index":1})});t=t.find(".line-segment").css({height:e.segment.height+"px",background:e.segment.color,width:"100%",display:e.segment.show?"block":"none",overflow:"hidden",position:"relative",marginBottom:e.global.padding+"px"});e.light.show||e.bar.show||t.css({borderBottom:"1px solid "+e.segment.color,height:"0px"})},loopLight:function(){var t=this.config;this.lightAnimate&&f(this.lightAnimate),this.lightAnimate=d({targets:this.container.find(".light").get(),duration:t.global.duration+100,easing:"cubicBezier(0.42,0,0.58,1)",translateX:[-t.light.width,this.container.width()],delay:d.stagger(150)}),this.loopLightTimer&&clearTimeout(this.loopLightTimer),this.loopLightTimer=setTimeout(this.loopLight.bind(this),t.light.duration+t.global.duration)},rotate:function(t){var s=this,l=this.config,h=this.data(),h=this.switchThousandthsOrNum(h);this.rotateAnimate&&f(this.rotateAnimate),this.rotateAnimate=l.global.animation&&d.timeline({duration:l.global.animation?this.duration:0,delay:0}),this.max=Math.max.apply(Math,function(t){if(Array.isArray(t)){for(var e=0,i=Array(t.length);e<t.length;e++)i[e]=t[e];return i}return Array.from(t)}(h.map(function(t){return+t.value})))||0,t.get().forEach(function(t,i){function e(){o.css("width",r+"%");var t=n.find(".table-content"),e=t.find(".inner");t.removeClass("has-marquee"),l.content.marquee.show?(t.css({overflow:"hidden",whiteSpace:"nowrap"}),e.width()>e.parent().width()&&s.marquee(n,i)):t.css({overflow:"auto",whiteSpace:"normal"})}var n=w(t),a=n.find(".rotate"),o=n.find(".table-bar"),t=h[s.index+i].value/s.max*100,r=S.isFinite(t)&&-0!==t&&t.toFixed(2)||0;l.global.animation?s.rotateAnimate.add({targets:a[0],rotateX:[0,-80],easing:"cubicBezier(0.55,0.18,0.92,0.46)",delay:function(){return 120*i},changeBegin:function(){a.show()},changeComplete:function(){a.html(a.data("next")||a.html()),s.rotateAnimates[i]&&f(s.rotateAnimates[i]),s.rotateAnimates[i]=d({targets:a[0],rotateX:[80,0],easing:"cubicBezier(0.15,0.52,0.5,0.9)",duration:l.global.animation?s.duration:0,complete:e})}},0):(a.html(a.data("next")||a.html()),e())})},updateBar:function(t){this.config.bar.show!==t.show&&(this.isFirst=!0,this.index=0,this.fresh=!0),this.render(null,{bar:t})},marquee:function(t,e){var i=this.config,n=t.find(".table-content");n.addClass("has-marquee"),n.parent().css("display","flex");t=n.find(".inner").html(),t=n.html('<div class="inner" style="left: 0;position: relative;">'+t+'<i style="display:inline-block;width:5em;"></i>'+t+"</div>").find(".inner");this.marqueeAnimate=d({targets:t.get(),duration:i.content.marquee.duration,easing:"linear",translateX:[0,function(t){return-(w(t).outerWidth()/2+2.5*i.content.textarea.fontSize)}],loop:!0,delay:d.stagger(100)})},startAnimate:function(){this.rerender()},clearAnimates:function(){f(this.rotateAnimate),f(this.marqueeAnimate),f(this.lightAnimate),this.rotateAnimates&&this.rotateAnimates.forEach(function(t){f(t)});var t=this.container.find(".table-line");d.remove(t.find(".rotate").get()),d.remove(t.find(".inner").get()),d.remove(t.find(".light").get()),clearTimeout(this.globalLoop),clearTimeout(this.loopLightTimer)},destroy:function(){this.clearAnimates(),this.container.off("**"),this.container.empty(),this.isFirst=!0,this.max=0,this.rotates=null,this.index=0,this.fresh=!0,this._data=null}}),t.exports});