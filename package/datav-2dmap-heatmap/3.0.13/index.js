Cube("datav:/com/datav-2dmap-heatmap/3.0.13/src/heatmap",[],function(t,e,a,i,o,n){var u=function(t,e,a){return e&&s(t.prototype,e),a&&s(t,a),t};function s(t,e){for(var a=0;a<e.length;a++){var i=e[a];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return t.exports=function(t){var w=t.map,t=t.Utils,s=t.Chroma,r=t._,a=t.RBush,h=t.geojsonBBox,i=t.mergeOptions,I=w.options.offset;return u(o,[{key:"setData",value:function(t){for(var e,a,i=void 0,o=[],i=0,n=t.features.length;i<n;i++)e=t.features[i],a=h(e),o.push({minX:a[0],minY:a[1],maxX:a[2],maxY:a[3],feature:e});this.rbush.dirty=o.length,this.rbush.total=o.length,this.rbush.clear(),0<o.length&&this.rbush.load(o)}},{key:"setOptions",value:function(t){var e=i({},this.options);this.options=i(this.options,t),this.options.general.minZoom=t.general.zoomRange[0],this.options.general.maxZoom=t.general.zoomRange[1];var a=this.options.graph,t=a.radius,a=a.blur,e=e.graph;t==e.radius&&a==e.blur||this.setCircle(t,a),this.setGradient()}},{key:"onRender",value:function(t,e){e&&(this.getFeaturesInBounds(),this.getFeatures()),this.dataProcess(),this.draw(t)}},{key:"dataProcess",value:function(){for(var t,e=this._radius,a=void 0===this.options.general.maxZoom?w.getMaxZoom():this.options.general.maxZoom,i=(Math.pow(2,Math.max(0,Math.min(a-w.getZoom(),12))),e/2),e=w._getMapPanePos(),o=e.x%i,n=e.y%i,s=[],r=[],h=void 0,u=void 0,l=void 0,d=void 0,g=void 0,c=void 0,h=0,u=this.features.length;h<u;h++){var f=(l=this.features[h]).geometry,v=l.properties,f=f.coordinates,p=2+~~(((d=w.latLngToContainerPoint([f[1],f[0]])).x-o)/i),m=2+~~((d.y-n)/i),y=[f[0],f[1],+v.value][2]||1;s[m]=s[m]||[],(g=s[m][p])?(g[0]=(g[0]*g[2]+(d.x-I.x)*y)/(g[2]+y),g[1]=(g[1]*g[2]+(d.y-I.y)*y)/(g[2]+y),g[2]+=y):s[m][p]=[d.x-I.x,d.y-I.y,y]}var x=null,b=null;for(h=0,u=s.length;h<u;h++)if(s[h])for(c=0,t=s[h].length;c<t;c++)(g=s[h][c])&&(null!==x&&null!==b||(x=g[2],b=g[2]),x=Math.min(x,g[2]),b=Math.max(b,g[2]),r.push([~~(g[0]+.5),~~(g[1]+.5),g[2]]));var _=[];for(h=0;h<r.length;h++)g=r[h],_.push([g[0],g[1],+([g[2]-x]/[b-x]).toFixed(2)]);this._data=_}},{key:"draw",value:function(t){if(this._circle&&this._grad&&this._data){for(var e,a=.01*this.options.graph.minOpacity,i=void 0,i=0,o=this._data.length;i<o;i++)e=this._data[i],t.globalAlpha=a+e[2]*(1-a),t.drawImage(this._circle,e[0]-this._radius,e[1]-this._radius);var n=t.getImageData(0,0,t.canvas.width,t.canvas.height);this.colorize(n.data,this._grad),t.putImageData(n,0,0)}}},{key:"getFeaturesInBounds",value:function(){for(var t,e,a,i=w.options.paddingBoundsExtent,o=this.rbush.search(i),n=void 0,s=void 0,n=0;n<o.length;n++)e=(t=o[n].feature).geometry.coordinates,s=[],"Point"===t.geometry.type&&(a=w.latLngToContainerPoint([e[1],e[0]]))&&(s=[a.x-I.x,a.y-I.y]),o[n].feature.geometry._coordinates=s,o[n].minX=e[0],o[n].minY=e[1],o[n].maxX=e[0],o[n].maxY=e[1];this.rbushInBounds.clear(),this.rbushInBounds.load(o),this.featuresInBounds=o}},{key:"getFeatures",value:function(){for(var t,e=[],a=this.featuresInBounds,i=void 0,i=0;i<a.length;i++)t=a[i].feature,e.push(t);return this.features=e,this.features}},{key:"colorize",value:function(t,e){for(var a,i=0,o=t.length;i<o;i+=4)(a=4*t[i+3])&&(t[i]=e[a],t[i+1]=e[1+a],t[i+2]=e[2+a],t[i+3]=e[3+a])}},{key:"setCircle",value:function(t,e){e=void 0===e?15:e;var a=this._circle=document.createElement("canvas"),i=a.getContext("2d"),o=this._radius=t+e;a.width=a.height=2*o,i.shadowOffsetX=i.shadowOffsetY=2*o,i.shadowBlur=e,i.shadowColor="black",i.beginPath(),i.arc(-o,-o,t,0,2*Math.PI,!0),i.closePath(),i.fill()}},{key:"setGradient",value:function(){var t=document.createElement("canvas"),e=t.getContext("2d"),a=e.createLinearGradient(0,0,0,256);t.width=1,t.height=256;for(var i=r.get(this.options,"graph.colorMapping"),t=i.mapping?i.scale.range:[i.fixed,i.fixed],i=s(t[0]).rgba(),o=(o=["rgba("+i[0]+","+i[1]+","+i[2]+",0)"]).concat(t),n=0;n<o.length;n++)a.addColorStop((n+1)/o.length,o[n]);e.fillStyle=a,e.fillRect(0,0,1,256),this._grad=e.getImageData(0,0,1,256).data}}]),o;function o(t){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,o),this.options=i({zIndex:0,tolerance:3,smoothFactor:1},t);var e=this.options.graph,t=e.radius,e=e.blur;this.setCircle(t,e),this.setGradient(),this.rbush=new a,this.rbush.dirty=0,this.rbush.total=0,this.rbushInBounds=new a,this.featuresInBounds=[],this.features=[]}},t.exports});;
Cube("datav:/com/datav-2dmap-heatmap/3.0.13/config",[],function(a,o,e,i,r,n){return a.exports={DEFAULT_OPTIONS:{renderer:"canvas",visibility:!0,general:{zoomRange:[0,18],minZoom:0,maxZoom:22,opacity:100},graph:{radius:10,blur:10,minOpacity:50}}},a.exports});;
Cube("datav:/com/datav-2dmap-heatmap/3.0.13/src/heatmapLayer.js",[],function(t,e,l,o,n,i){var p=function(t,e,o){return e&&a(t.prototype,e),o&&a(t,o),t};function a(t,e){for(var o=0;o<e.length;o++){var n=e[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function h(t,e,o){null===t&&(t=Function.prototype);var n=Object.getOwnPropertyDescriptor(t,e);if(void 0!==n){if("value"in n)return n.value;n=n.get;return void 0!==n?n.call(o):void 0}if(null!==(t=Object.getPrototypeOf(t)))return h(t,e,o)}return t.exports=function(t){var o=t.map,e=t.Utils,n=t.Layer,i=e.mergeOptions,r=e.arr2geojson,a=l("datav:/com/datav-2dmap-heatmap/3.0.13/src/heatmap")(t);return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(s,n),p(s,[{key:"init",value:function(){var t=i({zIndex:0},this.options);this.heatmap=new a(t),this.heatmap.layer=this.layer,this.addLayer(this.heatmap)}},{key:"render",value:function(t){if(t&&t.length){for(var e=[],o=void 0,n=void 0,i=t.length,o=0;o<i;o++)(n=t[o]).hasOwnProperty("lng")&&n.hasOwnProperty("lat")&&e.push({lng:+n.lng,lat:+n.lat,value:+n.value||1});var a=r(e);this.heatmap.setData(a),this.onRender(!0)}}},{key:"updateOptions",value:function(t){this.options=i(this.options,t),this.options.general.minZoom=t.general.zoomRange[0],this.options.general.maxZoom=t.general.zoomRange[1],this.heatmap.setOptions(this.options),this.onRender()}},{key:"draw",value:function(t){var e=this.options.general;t.globalAlpha=.01*e.opacity,this.container&&t.drawImage(this.container,0,0,this.container.width,this.container.height)}},{key:"show",value:function(){this.onRender(!0),this.options.visibility=!0}},{key:"hide",value:function(){h(s.prototype.__proto__||Object.getPrototypeOf(s.prototype),"hide",this).call(this),this.options.visibility=!1}},{key:"destroy",value:function(){this.options=null,delete this.options}}]),s;function s(t){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,s);var e=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(s.__proto__||Object.getPrototypeOf(s)).call(this));return e.addTo(o),e.options=i({},t),e.options.general.minZoom=t.general.zoomRange[0],e.options.general.maxZoom=t.general.zoomRange[1],e.options.visibility=!0,e.init(),e}},t.exports});;
Cube("datav:/com/datav-2dmap-heatmap/3.0.13",["datav:/npm/eventemitter3/3.0.0","datav:/npm/safely-merge/1.0.1"],function(e,t,o,i,n,a){var r=function(e,t,o){return t&&s(e.prototype,t),o&&s(e,o),e};function s(e,t){for(var o=0;o<t.length;o++){var i=t[o];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var l=o("datav:/npm/eventemitter3/3.0.0"),h=o("datav:/npm/safely-merge/1.0.1"),p=o("datav:/com/datav-2dmap-heatmap/3.0.13/src/heatmapLayer.js"),y=o("datav:/com/datav-2dmap-heatmap/3.0.13/config").DEFAULT_OPTIONS,r=(function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(u,l),r(u,[{key:"addTo",value:function(e,t){this.options.id=t;e=p(e);this.layer=new e(this.options)}},{key:"onRender",value:function(e){this.layer&&this.layer.onRender&&this.layer.onRender(e)}},{key:"resize",value:function(e,t){this.layer&&this.layer.resize&&this.layer.resize(e,t)}},{key:"render",value:function(e){var t=[],o=0;if(e&&e.length){for(var i,n=void 0,n=0;n<e.length;n++)i=e[n],Number.isFinite(parseFloat(i.lng))&&Number.isFinite(parseFloat(i.lat))?t.push(i):o++;0<o&&console.log("点热力层：有 "+o+" 条异常数据。")}this.layer&&this.layer.render&&this.layer.render(t)}},{key:"draw",value:function(e){this.layer&&this.layer.draw&&this.layer.draw(e)}},{key:"updateOptions",value:function(e){e=e.options;this.options=h(this.options,e),this.options.general.minZoom=e.general.zoomRange[0],this.options.general.maxZoom=e.general.zoomRange[1],this.layer&&this.layer.updateOptions&&this.layer.updateOptions(this.options)}},{key:"show",value:function(){this.options.visibility=!0,this.layer&&this.layer.show&&this.layer.show()}},{key:"hide",value:function(){this.options.visibility=!1,this.layer&&this.layer.hide&&this.layer.hide()}},{key:"destroy",value:function(){this.layer&&this.layer.destroy&&this.layer.destroy(),this.options=null,this.layer=null,delete this.options,this.layer}}]),u);function u(e,t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,u);var o=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(u.__proto__||Object.getPrototypeOf(u)).call(this)),t=t.options;return o.options=h(y,t),o.options.general.minZoom=t.general.zoomRange[0],o.options.general.maxZoom=t.general.zoomRange[1],o.options.visibility=!0,o}return e.exports=r,e.exports});