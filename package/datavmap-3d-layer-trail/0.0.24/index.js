// env=undefined => env=publish 
Cube("datav:/com/datavmap-3d-layer-trail/0.0.24/tubeFrag.js",[],function(a){return a.exports="\n#ifdef GL_ES\n  precision highp float;\n#endif\n\nuniform float uTimeCounter;\nuniform float uTrailLength;\nuniform vec3 uColor;\nvarying vec2 vUv;\n\nfloat calculateTimeContrlOpacity(float timeCounter, vec2 vUv){\n  float uvGap = uTrailLength;\n  float uvTail = timeCounter - uvGap;\n\n  if((vUv.x < timeCounter) && (vUv.x > uvTail)) {\n    float opacity = (1.0 - (timeCounter - vUv.x) / uvGap);\n    opacity *= opacity;\n    opacity /= 1.3;\n\n    return opacity;\n  } else {\n    return 0.0;\n  }\n}\n\nvoid main() {\n  float currentOpacity = calculateTimeContrlOpacity(uTimeCounter, vUv);\n  // vec3 color = vec3(0.9, 0.3, 0.1);\n  // gl_FragColor = vec4(color, 1.0);\n  gl_FragColor = vec4(uColor, currentOpacity);\n}\n",a.exports});;
Cube("datav:/com/datavmap-3d-layer-trail/0.0.24/tubeVert.js",[],function(a){return a.exports="\nuniform vec2 offset;\nvarying vec2 vUv;\n\nvoid main() {\n  vUv = uv;\n  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n  // vec4 mvPosition = modelViewMatrix * vec4(position-vec3(offset, 0.0), 1.0);\n  // gl_Position = projectionMatrix * mvPosition;\n}\n",a.exports});;
Cube("datav:/com/datavmap-3d-layer-trail/0.0.24/TrailLayer.js",["datav:/npm/eventemitter3/2.0.3","datav:/npm/safely-merge/1.0.1","datav:/npm/chroma-js/1.3.4"],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"===typeof b||"function"===typeof b)?b:a}function f(a,b){if("function"!==typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=c("datav:/npm/eventemitter3/2.0.3"),i=c("datav:/npm/safely-merge/1.0.1"),j=c("datav:/npm/chroma-js/1.3.4"),k=c("datav:/com/datavmap-3d-layer-trail/0.0.24/tubeVert.js"),l=c("datav:/com/datavmap-3d-layer-trail/0.0.24/tubeFrag.js");return a.exports=function(a){var b=a.datavgl,c=b.THREE,m=a.glLayer||a,n=b.DataVModelTools.line2path,o=a.worldsize,p={trailColor:"#ffcc33",trailRadius:2,trailSpeed:2e-3,trailLength:0.1,depthTest:!1,depthWrite:!1};return function(a){function b(a){d(this,b);var c=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return a=i(p,a),c.options=i(c.options,a),c.animate=c.animate.bind(c),c.init(),window.hahah=c,c}return f(b,a),g(b,[{key:"init",value:function(){this.meshGroup=new c.Group,m.on("runAnimation",this.animate)}},{key:"pixelsPerMeter",value:function(a){return 512/(6378137*(2*Math.PI)*Math.abs(Math.cos(a*(Math.PI/180))))}},{key:"setData",value:function(a){var b=this;a&&a.features&&0==a.features.length&&this.meshGroup&&this.disposeMesh(),a&&a.features&&a.features.length&&(this.disposeMesh(),this.meshGroup=new c.Group,a.features=a.features.map(function(a){return a.properties||(a.properties={}),a}),this.latBench=a.features[0].geometry.coordinates[0][1],this.transformedData=n(a,{worldsize:o,offset:!1}),this.transformedData.paths.forEach(function(a){var c=b.createTrail(a,b.latBench);b.meshGroup.add(c)}),this.meshGroup.visible=this.options.visibility,m.offsetNode.add(this.meshGroup),m.emit("init-offset"))}},{key:"createTrail",value:function(a,b){var d=void 0,e=this.options,f=e.depthTest,g=e.depthWrite,h=e.verticlePosition;"lineCurve"==this.options.curveType?d=this.createCurvePath(a):"catMullRoom"==this.options.curveType&&(d=this.createCatMullRoomCurve(a));var i=d.path,m=d.segment,n=5*this.pixelsPerMeter(b),o={path:i,tubularSegments:m*this.options.tubularSegmentsFactor,radius:this.options.trailRadius*n,radiusSegments:6,closed:!1},p=new c.TubeBufferGeometry(o.path,o.tubularSegments,o.radius,o.radiusSegments,o.closed);p.translate(0,0,h*n),p.needsOffset=!0;var q=j(this.options.trailColor).gl(),r=this.generateRandomNumber(),s=new c.ShaderMaterial({uniforms:{uColor:{value:new c.Vector3(q[0],q[1],q[2])},uTrailLength:{value:this.options.trailLength},uTimeCounter:{value:r}},vertexShader:k,fragmentShader:l,side:c.DoubleSide,blending:c.AdditiveBlending,depthTest:f,depthWrite:g,transparent:!0});s.needsUpdate=!0;var t=new c.Mesh(p,s);return t.frustumCulled=!1,t.scale.setZ(1/n),t}},{key:"createCatMullRoomCurve",value:function(a){for(var b,d={},e=[],f=0;f<a.length;f+=3)b=new c.Vector3(a[f+0],a[f+1],a[f+2]),e.push(b);var g=new c.CatmullRomCurve3(e);return d.path=g,d.segment=e.length,d}},{key:"createCurvePath",value:function(a){for(var b,d={},e=new c.CurvePath,f=3;f<a.length;f+=3)b=new c.LineCurve3(new c.Vector3(a[f-3],a[f-2],a[f-1]),new c.Vector3(a[f+0],a[f+1],a[f+2])),e.add(b);return d.path=e,d.segment=e.curves.length,d}},{key:"generateRandomNumber",value:function(){return Math.random()}},{key:"animate",value:function(){var a=this;this.meshGroup&&this.meshGroup.children.forEach(function(b){b.material.uniforms.uTimeCounter.value+=a.options.trailSpeed,b.material.uniforms.uTimeCounter.value>1+a.options.trailLength&&(b.material.uniforms.uTimeCounter.value=0)})}},{key:"disposeMesh",value:function(){this.meshGroup&&m.disposeNode(this.meshGroup),this.meshGroup&&m.offsetNode.remove(this.meshGroup),this.meshGroup=null}},{key:"updateOptions",value:function(a){var b=this,d=void 0,e=void 0;{var f=this.options,g=f.trailRadius,h=f.tubularSegmentsFactor,k=f.curveType,l=f.verticlePosition;d=JSON.stringify({trailRadius:g,tubularSegmentsFactor:h,curveType:k,verticlePosition:l})}this.options=i(this.options,a);{var n=this.options,o=n.trailRadius,p=n.tubularSegmentsFactor,q=n.curveType,r=n.verticlePosition;e=JSON.stringify({trailRadius:o,tubularSegmentsFactor:p,curveType:q,verticlePosition:r})}var s=this.options,t=s.depthTest,u=s.depthWrite,v=s.verticlePosition;if(e===d){var w=j(this.options.trailColor).gl();this.meshGroup&&this.meshGroup.children.forEach(function(a){a.material.uniforms.uColor.value=new c.Vector3(w[0],w[1],w[2]),a.material.depthTest=t,a.material.depthWrite=u})}else this.disposeMesh(),this.meshGroup=new c.Group,this.transformedData.paths.forEach(function(a){var c=b.createTrail(a,b.latBench);b.meshGroup.add(c)}),m.offsetNode.add(this.meshGroup),m.emit("init-offset");this.meshGroup.visible=this.options.visibility}},{key:"show",value:function(){this.options.visibility=!0,this.meshGroup&&(this.meshGroup.visible=!0)}},{key:"hide",value:function(){this.options.visibility=!1,this.meshGroup&&(this.meshGroup.visible=!1)}},{key:"remove",value:function(){m.off("runAnimation",this.animate),m.disposeNode(this.meshGroup),m.offsetNode.remove(this.meshGroup),this.meshGroup=null}}]),b}(h)},a.exports});;
Cube("datav:/com/datavmap-3d-layer-trail/0.0.24",["datav:/npm/eventemitter3/2.0.3","datav:/npm/safely-merge/1.0.1"],function(a,b,c){function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"===typeof b||"function"===typeof b)?b:a}function f(a,b){if("function"!==typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=c("datav:/npm/eventemitter3/2.0.3"),i=c("datav:/npm/safely-merge/1.0.1"),j=c("datav:/com/datavmap-3d-layer-trail/0.0.24/TrailLayer.js"),k={},l=function(a){function b(a,c){d(this,b);var f=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return f.container="string"===typeof a?document.querySelector(a):a,f.apis=c.apis,f.map=null,f._data=null,f.config=c,f}return f(b,a),g(b,[{key:"initLayer",value:function(){var a=this.getOptions(),b=j(this.map);this.layer=new b(a),this.render(this.data)}},{key:"init",value:function(){var a=this;this.resetID&&clearTimeout(this.resetID),this.resetID=setTimeout(function(){a.map.glLayer.loaded?(a.resetID&&clearTimeout(a.resetID),a.initLayer()):a.init()},100)}},{key:"addTo",value:function(a){var b=this;this.map=a,this.init(),this.endID=setTimeout(function(){b.resetID&&clearTimeout(b.resetID)},300000)}},{key:"getOptions",value:function(){return this.config=i(k,this.config),this.config}},{key:"show",value:function(){this.config.visibility=!0,this.layer&&this.layer.show&&this.layer.show()}},{key:"hide",value:function(){this.config.visibility=!1,this.layer&&this.layer.hide&&this.layer.hide()}},{key:"remove",value:function(){this.endID&&clearTimeout(this.endID),this.resetID&&clearTimeout(this.resetID),this.layer&&this.layer.remove&&this.layer.remove(),this.layer=null,this._data=null,this.data=null}},{key:"render",value:function(a){this.data=a,this.layer&&this.layer.setData(a)}},{key:"updateOptions",value:function(a){this.config=i(this.config,a),a=this.getOptions(),this.layer&&this.layer.updateOptions(a)}}]),b}(h);return a.exports=l,a.exports});